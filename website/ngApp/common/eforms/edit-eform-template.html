<div class="page">
    <div class="loading-overlay" data-ng-show="$ctrl.isLoading"></div>

    <div>
        <h3 style="display: inline;">Edit E-form Template</h3>
        <span class="ms-4" style="color: blue; font-size: large; font-weight: bold;" title="We're looking for helpful feedback!">Beta</span>
        <a class="ms-4" href="https://help.communityally.org/e-forms/" target="_blank">Help</a>
    </div>

    <div class="alert alert-warning mb-4" role="alert">
        This is can be a complicated tool, but Community Ally support is happy to help. Reach out using the chat box in the bottom right or via the email address on <a href="/#!/Help">our help page</a>.
    </div>

    <div data-ng-if="$ctrl.template">
        <div class="text-end">
            <button type="button" class="btn btn-primary btn-lg" data-ng-click="$ctrl.saveTemplate()">Save Template</button>
        </div>

        <div class="mb-5">
            <div class="mb-3">
                <label for="templateName" class="form-label">Template Name</label>
                <input type="text" class="form-control" id="templateName" aria-describedby="emailHelp" data-ng-model="$ctrl.template.templateName" autocomplete="off" data-lpignore="true" data-form-type="other">
            </div>
            <div class="mb-3">
                <label for="whoCanCreateSelect" class="form-label">Who can create this form?</label>
                <select id="whoCanCreateSelect" class="form-select form-select" data-ng-model="$ctrl.template.whoCanCreate">
                    <option value="anyone">Anyone</option>
                    <!--<option value="owners">Owners (i.e. non-renters)</option>-->
                    <option value="anyBoard">Board Members</option>
                    <option value="anyBoardOrAdmin">Board Members or Site Admin</option>
                </select>
            </div>
            <!--<div class="mb-3">
        <label for="defaultAssigneeeSelect" class="form-label">Who gets assigned this form when it gets created?</label>
        <select id="defaultAssigneeeSelect" class="form-select form-select" data-ng-model="$ctrl.template.defaultAssigneee">
            <option value="anyBoard">Any Board Member</option>
            <option value="anyBoardOrAdmin">Any Board Member or Site Admin</option>
            <option value="president">Board President</option>
            <option value="secretary">Board Secretary</option>
            <option value="treasurer">Board Treasurer</option>
            <option value="committee:{{curCommittee.committeeId}}" data-ng-repeat="curCommittee in $ctrl.committeeOptions">Committee: {{curCommittee.name}}</option>
        </select>
        <small class="form-text text-muted">When a form is created or updated, this assignee will be notified.</small>
    </div>-->
            <div class="mb-3 form-check">
                <label for="isAnonymousCheckbox" class="form-label">Form submits anonymously</label>
                <input type="checkbox" class="form-check-input" id="isAnonymousCheckbox" aria-describedby="emailHelp" data-ng-model="$ctrl.template.isAnonymous">
                <br />
                <small class="form-text text-muted">The submitter of the form is hidden.</small>
            </div>

            <div class="mb-3 form-check" data-ng-if="$ctrl.isSuperAdmin">
                <label for="isCatalogTemplate" class="form-label">Is Catalog Template Form</label>
                <input type="checkbox" class="form-check-input" id="isCatalogTemplate" aria-describedby="emailHelp" data-ng-model="$ctrl.template.isCatalogTemplate" data-ng-change="$ctrl.onIsCatalogChange()">
            </div>

            <div class="mb-3" data-ng-if="$ctrl.isSuperAdmin && $ctrl.template.isCatalogTemplate">
                <label for="catalogDescriptionHtml" class="form-label">Catalog Template Description</label>
                <div class="form-control" id="catalogDescriptionHtml" data-ng-model="$ctrl.template.catalogDescriptionHtml" rows="5"></div>
            </div>

            <div>
                <label for="formInstructionsText" class="form-label">Instructions</label>
                <div class="form-control" id="formInstructionsText" data-ng-model="$ctrl.template.formInstructions" rows="5"></div>
            </div>

        </div>

        <h4 class="mt-4">Form Steps/Sections</h4>
        <div class="note-text">
            Each step can be assigned to a different person to complete, making it easy to organize the back-and-forth of common community forms.
        </div>

        <div class="text-end">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="shouldShowAdvancedPropertiesCheckbox" data-ng-model="$ctrl.shouldShowAdvancedProperties">
                <label class="form-check-label" for="shouldShowAdvancedPropertiesCheckbox">Show advanced field propertoes</label>
            </div>
        </div>

        <div data-ng-repeat="curSection in $ctrl.template.sections" class="mb-3 card">
            <div class="card-body">
                <h5 class="card-title">Step {{$index + 1}}</h5>
                <div class="mb-3">
                    <label for="sectionName{{$index}}" class="form-label">Step Name/Title</label>
                    <input type="text" class="form-control" id="sectionName{{$index}}" aria-describedby="emailHelp" data-ng-model="curSection.sectionName" autocomplete="off" data-lpignore="true" data-form-type="other">
                </div>

                <div class="mb-4">
                    <label for="whoCanFillOutSelect{{$index}}" class="form-label">Who fills out this step?</label>
                    <select id="whoCanFillOutSelect{{$index}}" class="form-select form-select" data-ng-model="curSection.whoFillsOut"
                            data-ng-readonly="$index === 0" data-ng-disabled="$index === 0"
                            data-ng-options="o.value as o.displayLabel for o in curSection.whoFillsOutOptions">
                    </select>
                    <small data-ng-if="$index === 0">The first step must always be filled out by the reporter</small>
                </div>

                <h5>Fields</h5>

                <div data-ng-repeat="curField in curSection.parsedFields" class="border rounded p-4 mb-4">
                    <h5>Field {{$index + 1}}</h5>

                    <div class="mb-3">
                        <label for="fieldLabel-{{curSection.sectionOrder}}-{{$index + 1}}" class="form-label">Label</label>
                        <input type="text" class="form-control" id="fieldLabel-{{curSection.sectionOrder}}-{{$index + 1}}" data-ng-model="curField.label" data-ng-blur="$ctrl.autoSetFieldSlug(curField)" maxlength="200" autocomplete="off" data-lpignore="true" data-form-type="other">
                    </div>
                    <div class="mb-3" data-ng-if="$ctrl.shouldShowAdvancedProperties">
                        <label for="fieldSlug-{{curSection.sectionOrder}}-{{$index + 1}}" class="form-label">Field Slug</label>
                        <input type="text" class="form-control" id="fieldSlug-{{curSection.sectionOrder}}-{{$index + 1}}" data-ng-model="curField.slug" data-ng-change="$ctrl.onSlugChange(curSection, curField)" maxlength="200" autocomplete="off" data-lpignore="true" data-form-type="other">
                        <small class="form-text text-muted">This is used to identify the field in logic like conditional display.</small>
                        <div data-ng-if="curField.duplicateSlugMessage" class="alert alert-danger" role="alert">{{curField.duplicateSlugMessage}}</div>
                    </div>
                    <div class="mb-3" data-ng-if="$ctrl.shouldShowAdvancedProperties">
                        <label for="fieldNoteText-{{curSection.sectionOrder}}-{{$index + 1}}" class="form-label">Note Text</label>
                        <!--<textarea class="form-control" id="fieldNoteText" data-ng-model="curField.noteText"></textarea>-->
                        <input type="text" class="form-control" id="fieldNoteText-{{curSection.sectionOrder}}-{{$index + 1}}" data-ng-model="curField.noteText" maxlength="500" />
                        <small class="form-text text-muted">Displays under the input field to provide helpful info to the submitter.</small>
                    </div>
                    <div class="mb-3">
                        <label for="fieldType-{{curSection.sectionOrder}}-{{$index + 1}}" class="form-label">Type</label>
                        <select id="fieldType-{{curSection.sectionOrder}}-{{$index + 1}}" style="max-width: 500px;" class="form-select" data-ng-model="curField.type" data-ng-change="$ctrl.onFieldTypeChange(curSection, curField)">
                            <!--<option value="allHomePicker">All Home Picker</option>-->
                            <option value="checkboxList">Checkbox List - A list of checkboxes</option>
                            <option value="dateOnly">Date Only - A date-only (no time) picker</option>
                            <option value="fileAttachment">File Attachment - Allows submitters to attach photos and files</option>
                            <option value="longText">Long Text - A multi-line text box</option>
                            <option value="number">Number - A numeric input field</option>
                            <!--<option value="ownerHomePicker">Owner's Home Picker</option>-->
                            <option value="radio">Radio - Single-select from multiple options</option>
                            <option value="memberPicker">{{$ctrl.memberTypeLabel}} Picker - Choose a member of this group</option>
                            <option value="shortText">Short Text - A single-line text box</option>
                            <option value="timeOnly">Time Only - A time picker</option>
                        </select>
                    </div>
                    <div class="mb-3" data-ng-if="false">
                        <label for="fieldTypeParam-{{curSection.sectionOrder}}-{{$index + 1}}" class="form-label">Field Type Parameter</label>
                        <input type="text" class="form-control" id="fieldTypeParam-{{curSection.sectionOrder}}-{{$index + 1}}" data-ng-model="curField.typeParam" autocomplete="off" data-lpignore="true" data-form-type="other">
                    </div>
                    <div class="mb-3" data-ng-if="$ctrl.shouldShowAdvancedProperties && (curField.type === 'longText' || curField.type === 'shortText')">
                        <label for="fieldDefaultValue-{{curSection.sectionOrder}}-{{$index + 1}}" class="form-label">Default Value</label>
                        <input type="text" class="form-control" id="fieldDefaultValue-{{curSection.sectionOrder}}-{{$index + 1}}" data-ng-model="curField.defaultValue" maxlength="200" autocomplete="off" data-lpignore="true" data-form-type="other">
                    </div>
                    <div class="mb-3" data-ng-if="curField.type === 'checkboxList' || curField.type === 'radio'">
                        <label for="fieldMultiValueOptions-{{curSection.sectionOrder}}-{{$index + 1}}" class="form-label">
                            <span data-ng-if="curField.type === 'checkboxList'">Checkbox</span>
                            <span data-ng-if="curField.type === 'radio'">Radio</span>
                            Options (comma-separated)
                        </label>
                        <input type="text" class="form-control" id="fieldMultiValueOptions-{{curSection.sectionOrder}}-{{$index + 1}}" data-ng-model="curField.multiValueOptionsString" maxlength="500" data-ng-change="$ctrl.onMultiValueOptionsChange(curField)" autocomplete="off" data-lpignore="true" data-form-type="other">
                        <small class="form-text text-muted">Enter the options you want the submitter to choose from, seperated by a comma. Do not include spaces before or after the comma.</small>
                    </div>
                    <div class="mb-3 form-check" data-ng-if="$ctrl.shouldShowAdvancedProperties">
                        <input type="checkbox" class="form-check-input" id="fieldIsRequired-{{curSection.sectionOrder}}-{{$index + 1}}" data-ng-model="curField.isRequired">
                        <label class="form-check-label" for="fieldIsRequired-{{curSection.sectionOrder}}-{{$index + 1}}">Is Required</label>
                    </div>
                    <!--<div class="mb-3">
                        <label for="fieldVisibleConditionJs" class="form-label">Visible Condition (JavaScript)</label>
                        <textarea class="form-control" id="fieldVisibleConditionJs" data-ng-model="curField.visibleConditionJs"></textarea>
                    </div>-->

                    <div class="text-end">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-ng-click="$ctrl.moveField(curSection,curField,-1)" data-ng-if="$index > 0">Move Up</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-ng-click="$ctrl.moveField(curSection,curField,1)" data-ng-if="$index < curSection.parsedFields.length - 1">Move Down</button>
                        <button type="button" class="btn btn-outline-danger btn-sm ms-3" data-ng-click="$ctrl.removeField(curSection,curField)">Remove Field {{$index + 1}}</button>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" data-ng-click="$ctrl.addField(curSection)">Add Field</button>

                <div class="text-end">
                    <button type="button" class="btn btn-danger btn-sm" data-ng-click="$ctrl.removeSection(curSection)">Remove Step {{$index + 1}}</button>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-primary" data-ng-click="$ctrl.addSection()">Add New Step</button>

        <div class="text-end">
            <button type="button" class="btn btn-primary btn-lg" data-ng-click="$ctrl.saveTemplate()">Save Template</button>
        </div>
    </div>
</div>