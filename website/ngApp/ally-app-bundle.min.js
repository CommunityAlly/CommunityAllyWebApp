/*! CommunityAllyWebApp 2024-05-26 */
!function(e){class t{constructor(e,t){this.$http=e,this.$q=t,this.isLoading=!1,this.includeAddresses=!1}$onInit(){this.refreshAddresses()}getPolyInfo(e,t){const i=this.$q.defer();return this.isLoading=!0,this.$http.get(e).then(e=>{this.isLoading=!1;e=e.data;_.each(e,e=>{"Group"===(e.polyType=t)&&(e.oneLiner=`${e.shortName}, ${e.appName} (ID: ${e.groupId})`,"Condo"===e.appName?e.visitUrl=`https://${e.shortName}.condoally.com/`:"Hoa"===e.appName&&(e.visitUrl=`https://${e.shortName}.hoaally.org/`))}),$.merge(this.addresses,e),i.resolve(this.addresses)},e=>{this.isLoading=!1;e=e.data.exceptionMessage||e.data;alert("Failed to retrieve addresses: "+e),i.reject()}),i.promise}getGroupBoundPolys(){return this.getPolyInfo("/api/AdminMap/GetGroupBounds?filter="+this.filterAddresses,"Group")}getAddressPolys(){return this.getPolyInfo("/api/AdminMap/GetAll?filter="+this.filterAddresses,"Address")}refreshAddresses(){this.isLoading=!0,this.addresses=[];var e=e=>{this.addressPoints=[],_.each(e,e=>{e.gpsPos&&(e.gpsPos.fullAddress=e.oneLiner,this.addressPoints.push(e.gpsPos))})};(this.includeAddresses?this.getAddressPolys().then(()=>this.getGroupBoundPolys()):this.getGroupBoundPolys()).then(e)}onSavePoly(){this.isLoading=!0;var e={vertices:this.selectedAddress.gpsBounds.vertices},t="Address"===this.selectedAddress.polyType?"/api/AdminMap/UpdateAddress/"+this.selectedAddress.addressId:"/api/AdminMap/UpdateGroup/"+this.selectedAddress.groupId;this.$http.put(t,e).then(()=>{this.isLoading=!1},()=>{this.isLoading=!1})}onAddressSelected(e){this.selectedAddress=e,this.selectedAddress.gpsBounds||(this.selectedAddress.gpsBounds={vertices:[]}),this.selectedAddress.gpsBounds.vertices||(this.selectedAddress.gpsBounds.vertices=[]),0==this.selectedAddress.gpsBounds.vertices.length&&e.gpsPos&&(e.gpsBounds.vertices=[{lat:e.gpsPos.lat,lon:e.gpsPos.lon},{lat:e.gpsPos.lat+.001,lon:e.gpsPos.lon},{lat:e.gpsPos.lat+.001,lon:e.gpsPos.lon+.001},{lat:e.gpsPos.lat,lon:e.gpsPos.lon+.001}]),this.selectedGpsPoly=e.gpsBounds}}t.$inject=["$http","$q"],e.ManageAddressPolysController=t}(Ally=Ally||{}),CA.angularApp.component("manageAddressPolys",{templateUrl:"/ngApp/admin/manage-address-polys.html",controller:Ally.ManageAddressPolysController}),function(e){class s{}class t{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.$timeout=i,this.newAssociation=new s,this.changeShortNameData={appName:"Condo"},this.sendTestFromInmail=!1,this.noReplyEmailInfo={to:"",subject:"",body:""},this.retrieveGroups=function(){this.isLoading=!0,this.$http.get("/api/Association/AdminList").then(e=>{this.isLoading=!1,this.groups=e.data,_.each(this.groups,function(e){0===e.appName?(e.appNameString="Condo",e.baseUrl="https://"+e.shortName+".CondoAlly.com/"):1===e.appName?(e.appNameString="NeighborhoodWatch",e.baseUrl="https://"+e.shortName+".WatchAlly.com/"):2===e.appName?(e.appNameString="Home",e.baseUrl="https://"+e.shortName+".HomeAlly.org/"):3===e.appName?(e.appNameString="Hoa",e.baseUrl="https://"+e.shortName+".HoaAlly.org/"):4===e.appName?(e.appNameString="Neighborhood",e.baseUrl="https://"+e.shortName+".NeighborhoodAlly.org/"):5===e.appName?(e.appNameString="PTA",e.baseUrl="https://"+e.shortName+".PTAAlly.org/"):6===e.appName&&(e.appNameString="BlockClub",e.baseUrl="https://"+e.shortName+".BlockClubAlly.org/")})},()=>{this.isLoading=!1,alert("Failed to retrieve groups")})}}$onInit(){this.curGroupApiUri=this.siteInfo.publicSiteInfo.baseApiUrl,this.curGroupId=this.curGroupApiUri.substring("https://".length,this.curGroupApiUri.indexOf(".")),this.curGroupCreationDate=this.siteInfo.privateSiteInfo.creationDate,this.stripeConnectAccountId=this.siteInfo.privateSiteInfo.stripeConnectAccountId,this.premiumUpdateGroupId=parseInt(this.curGroupId),"hoa"===AppConfig.appShortName&&(this.changeShortNameData.appName="Hoa"),this.changeShortNameData.old=this.siteInfo.publicSiteInfo.shortName,this.newAllyPaymentEntry={paymentId:0,groupId:parseInt(this.curGroupId),amount:0,netAmount:null,description:"Annual Premium Plan",entryDateUtc:new Date,paymentDateUtc:new Date,paymentMethod:"Check",paymentMethodId:"",status:"Complete"},this.$timeout(()=>this.loadAllyAppSettings(),100)}changeShortName(){this.changeShortNameResult=null,/[^a-zA-Z0-9]/.test(this.changeShortNameData.newShortName)?alert("The new short name must be alphanumeric"):this.changeShortNameData.newShortName!==this.changeShortNameData.newShortName.toLowerCase()?alert("The new short name must be lower-case"):0===this.changeShortNameData.newShortName.length?alert("New short name must not be empty"):(this.isLoading=!0,this.$http.put("/api/AdminHelper/ChangeShortName?oldShortName="+this.changeShortNameData.old+"&newShortName="+this.changeShortNameData.newShortName+"&appName="+this.changeShortNameData.appName,null).then(e=>{this.isLoading=!1,this.changeShortNameResult="Successfully changed"},e=>{this.isLoading=!1,this.changeShortNameResult="Failed to change: "+e.data.exceptionMessage}))}findAssociationsForUser(){this.isLoading=!0,this.$http.get("/api/AdminHelper/FindAssociationsForUser?email="+this.findUserAssociationsEmail).then(e=>{this.isLoading=!1,this.foundUserAssociations=e.data,_.forEach(this.foundUserAssociations,e=>{e.viewUrl=`https://${e.shortName}.condoally.com/`,2===e.appName?e.viewUrl=`https://${e.shortName}.homeally.org/`:3===e.appName?e.viewUrl=`https://${e.shortName}.hoaally.org/`:4===e.appName?e.viewUrl=`https://${e.shortName}.NeighborhoodAlly.org/`:6===e.appName?e.viewUrl=`https://${e.shortName}.BlockClubAlly.org/`:console.log("Unknown appName value: "+e.appName)})},()=>{this.isLoading=!1,alert("Failed to find associations for user")})}deleteAssociation(e){confirm(`Are you sure you want to delete this (${e.shortName}, ID: ${e.groupId}) association?`)&&(this.isLoading=!0,this.$http.delete("/api/Association/chtn/"+e.groupId).then(()=>{this.isLoading=!1,this.retrieveGroups()},e=>{this.isLoading=!1,console.log(e.data.exceptionMessage),alert("Failed to delete group: "+e.data.exceptionMessage)}))}addAddress(){this.newAddressId=null,this.isLoading=!0,this.$http.post("/api/AdminHelper/AddAddress?address="+encodeURIComponent(this.newAddress),null).then(e=>{this.isLoading=!1,this.newAddressId=e.data.newAddressId},e=>{this.isLoading=!1,alert("Failed to add address: "+e.data.exceptionMessage)})}onCreateAssociationClick(){this.isLoading=!0,this.$http.post("/api/Association",this.newAssociation).then(()=>{this.isLoading=!1,this.newAssociation=new s,this.retrieveGroups()},e=>{this.isLoading=!1,alert("Failed to create group: "+e.data.exceptionMessage)})}onSendTestEmail(){this.makeHelperRequest(`/api/AdminHelper/SendTestEmail?testEmailRecipient=${encodeURIComponent(this.testEmailRecipient)}&sendFromInmail=`+(this.sendTestFromInmail?"true":"false"))}onSendTaylorTestEmail(){this.makeHelperRequest("/api/AdminHelper/SendFromTaylorEmail?testEmailRecipient="+encodeURIComponent(this.testTaylorEmailRecipient))}onSendTaylorBulkUpdateEmail(){confirm("Are you sure you want to SEND TO EVERYONE?!?!")&&this.makeHelperRequest("/api/AdminHelper/SendBulkTaylorEmail3")}onSendTestPostmarkEmail(){this.isLoading=!0,this.$http.get("/api/AdminHelper/SendTestPostmarkEmail?email="+this.testPostmarkEmail).then(()=>{this.isLoading=!1,alert("Successfully sent email")},()=>{this.isLoading=!1,alert("Failed to send email")})}onSendTestCalendarEmail(){this.isLoading=!0,this.$http.get("/api/AdminHelper/SendTestCalendarEmail").then(()=>{this.isLoading=!1,alert("Successfully sent email")},()=>{this.isLoading=!1,alert("Failed to send email")})}onSendNoReplyEmail(){this.isLoading=!0,this.$http.post("/api/AdminHelper/SendNoReplyPostmarkEmail",this.noReplyEmailInfo).then(()=>{this.isLoading=!1,alert("Successfully sent email")},e=>{this.isLoading=!1,alert("Failed to send email: "+e.data.exceptionMessage)})}makeHelperRequest(e,t=null){this.isLoadingHelper=!0;let i;(i=t?this.$http.post(e,t):this.$http.get(e)).then(()=>this.isLoadingHelper=!1,e=>{this.isLoadingHelper=!1;e=e.data?e.data.exceptionMessage:"";alert("Failed: "+e)})}onTestException(){this.makeHelperRequest("/api/AdminHelper/TestException")}onClearElmahLogs(){this.makeHelperRequest("/api/AdminHelper/ClearElmah")}onClearCurrentAppGroupCache(){this.makeHelperRequest("/api/AdminHelper/ClearCurrentGroupFromCache")}onClearEntireAppGroupCache(){this.makeHelperRequest("/api/AdminHelper/ClearGroupCache")}onSendInactiveGroupsMail(){var e={shortNameLines:this.inactiveShortNames};this.makeHelperRequest("/api/AdminHelper/SendInactiveGroupsMail",e)}logInAs(){this.isLoading=!0,this.$http.get("/api/AdminHelper/LogInAs?email="+this.logInAsEmail).then(e=>{this.siteInfo.setAuthToken(e.data),window.location.href="/#!/Home",window.location.reload()},e=>{alert("Failed to perform login: "+e.data.exceptionMessage)}).finally(()=>this.isLoading=!1)}populateEmptyDocumentUsage(){this.isLoading=!0;let e="/api/AdminHelper/FillInMissingDocumentUsage?numGroups=10";this.populateDocUsageGroupId&&(e+="&groupId="+this.populateDocUsageGroupId),this.$http.get(e).then(e=>{this.isLoading=!1,alert("Succeeded: "+e.data)},e=>{this.isLoading=!1,alert("Failed: "+e.data.exceptionMessage)})}refreshCurGroupDocumentUsage(){this.isLoading=!0;var e="/api/AdminHelper/RecalcGroupDocumentUsage?groupId="+this.curGroupId;this.$http.get(e).then(e=>{this.isLoading=!1,console.log("Recalc Succeeded",e.data),alert("Succeeded: "+e.data)},e=>{this.isLoading=!1,alert("Failed: "+e.data.exceptionMessage)})}onAddAllyPayment(){this.isLoading=!0,this.$http.post("/api/AdminHelper/AddAllyPaymentEntry",this.newAllyPaymentEntry).then(e=>{this.isLoading=!1,this.newAllyPaymentEntry.amount=0,this.newAllyPaymentEntry.netAmount=null,this.newAllyPaymentEntry.paymentMethodId="",alert("Succeeded")},e=>{this.isLoading=!1,alert("Failed: "+e.data.exceptionMessage)})}updatePremiumCost(){this.isLoading=!0;var e=`/api/AdminHelper/SetPremiumCost/${this.premiumUpdateGroupId}?cost=`+this.premiumNewCost;this.$http.put(e,null).then(e=>{this.isLoading=!1,this.premiumNewCost=0,alert("Succeeded")},e=>{this.isLoading=!1,alert("Failed: "+e.data.exceptionMessage)})}updatePremiumExpiration(){var e;this.premiumNewExpiration?(this.isLoading=!0,e=`/api/AdminHelper/SetPremiumExpiration/${this.premiumUpdateGroupId}?expirationDate=`+encodeURIComponent(this.premiumNewExpiration.toISOString()),this.$http.put(e,null).then(e=>{this.isLoading=!1,this.premiumNewExpiration=null,alert("Succeeded")},e=>{this.isLoading=!1,alert("Failed: "+e.data.exceptionMessage)})):alert("Hey, dummy, enter a date. Ha!")}onDeactivateGroup(){this.isLoading=!0;var e="/api/AdminHelper/DeactivateGroups?groupIdsCsv="+this.deactivateGroupIdsCsv;this.$http.get(e).then(e=>{this.isLoading=!1,this.deactivateGroupIdsCsv=null,alert("Deactivate Group Succeeded: "+e.data)},e=>{this.isLoading=!1,alert("Deactivate Group Failed: "+e.data.exceptionMessage)})}onReactivateGroup(){this.isLoading=!0;var e="/api/AdminHelper/ReactivateGroup?groupId="+this.reactivateGroupId;this.$http.get(e).then(e=>{this.isLoading=!1,this.reactivateGroupId=null,alert("Reactivate Group Succeeded: "+e.data)},e=>{this.isLoading=!1,alert("Reactivate Group Failed: "+e.data.exceptionMessage)})}loadAllyAppSettings(){this.allAllyAppSettings=[],this.isLoadingAllyAppSettings=!0,this.$http.get("/api/AllyAppSettings/All").then(e=>{this.isLoadingAllyAppSettings=!1,this.allAllyAppSettings=e.data},e=>{this.isLoadingAllyAppSettings=!1,alert("Failed to retrieve settings: "+e.data.exceptionMessage)})}saveAllyAppSetting(){this.$http.post("",this.editAllyAppSetting)}onReactivateEmail(){this.isLoading=!0;var e="/api/AdminHelper/ClearBadEmailStatus?emailAddress="+this.reactivateEmail;this.$http.get(e).then(e=>{this.isLoading=!1,this.reactivateEmail=null,alert("Reactivate Email Succeeded: "+e.data)},e=>{this.isLoading=!1,alert("Reactivate Failed: "+e.data.exceptionMessage)})}}t.$inject=["$http","SiteInfo","$timeout"],e.ManageGroupsController=t;e.AllyAppSetting=class{}}(Ally=Ally||{}),CA.angularApp.component("manageGroups",{templateUrl:"/ngApp/admin/manage-groups.html",controller:Ally.ManageGroupsController}),function(i){class e{constructor(e,t){this.$http=e,this.siteInfo=t,this.isLoading=!1,this.unitToEdit=new i.Unit,this.isEdit=!1,this.isHoaAlly=!1,this.isCondoAlly=!1}$onInit(){this.isAdmin=this.siteInfo.userInfo.isAdmin,this.homeName=AppConfig.homeName||"Unit",this.isCondoAlly="condo"===AppConfig.appShortName,this.isHoaAlly="hoa"===AppConfig.appShortName,this.refresh()}refresh(){this.isLoading=!0,this.$http.get("/api/Unit?includeAddressData=true").then(e=>{this.isLoading=!1,this.units=e.data},e=>{this.isLoading=!1,alert("Failed to load homes: "+e.data.exceptionMessage)})}onCreateUnitClick(){var e,t;$("#AddUnitForm").validate(),$("#AddUnitForm").valid()&&(this.isLoading=!0,e=()=>{this.isLoading=!1,this.isEdit=!1,this.unitToEdit=new i.Unit,this.refresh()},t=e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)},(this.isEdit?this.$http.put("/api/Unit",this.unitToEdit):this.$http.post("/api/Unit/AddSingle",this.unitToEdit)).then(e,t))}onEditUnitClick(e){this.isEdit=!0,this.unitToEdit=_.clone(e),e.fullAddress&&(this.unitToEdit.streetAddress=e.fullAddress.oneLiner),document.getElementById("unit-edit-panel").scrollIntoView()}onRefreshUnitFromGoogle(e){this.isLoading=!0,this.$http.put("/api/Unit/ForceRefreshAddressFromGoogle?unitId="+e.unitId,null).then(()=>{this.isLoading=!1,this.refresh()},e=>{this.isLoading=!1,alert("Failed to refresh: "+e.data.exceptionMessage)})}onDeleteUnitClick(e){this.isLoading=!0,this.$http.delete("/api/Unit/"+e.unitId).then(()=>{this.isLoading=!1,this.refresh()},e=>{this.isLoading=!1,alert("Failed to delete: "+e.data.exceptionMessage)})}onFastAddUnits(){this.isLoading=!0,this.$http.post("/api/Unit/FastAdd?fastAdd="+this.lastFastAddName,null).then(()=>{this.isLoading=!1,this.refresh()},e=>{this.isLoading=!1,alert("Failed fast add: "+e.data.exceptionMessage)})}onAddUnitsPerLine(){var e={action:"onePerLine",lines:this.unitNamePerLine};this.isLoading=!0,this.$http.post("/api/Unit/Multiline",e).then(()=>{this.isLoading=!1,this.refresh()},()=>{this.isLoading=!1,alert("Failed")})}onAddUnitsByAddressPerLine(){var e={action:"onePerLine",lines:this.unitAddressPerLine};this.isLoading=!0,this.$http.post("/api/Unit/FromAddresses",e).then(()=>{this.isLoading=!1,this.unitAddressPerLine="",this.refresh()},e=>{this.isLoading=!1,alert("Failed to add: "+e.data.exceptionMessage)})}onDeleteAllClick(){confirm("This will delete every unit! This should only be used for new sites!")&&(this.isLoading=!0,this.$http.delete("/api/Unit/DeleteAll?deleteAction=all").then(()=>{this.isLoading=!1,this.refresh()},e=>{this.isLoading=!1,alert("Failed to delete units: "+e.data.exceptionMessage)}))}exportHomesCsv(){"undefined"!=typeof analytics&&analytics.track("exportHomesCsv");var e=i.createCsvString(this.units,[{headerText:"Name/Label",fieldName:"name"},{headerText:"Address",fieldName:"fullAddress",dataMapper:e=>e.oneLiner},{headerText:"Notes",fieldName:"notes"}]);i.HtmlUtil2.downloadCsv(e,this.siteInfo.publicSiteInfo.shortName+"-homes.csv")}}e.$inject=["$http","SiteInfo"],i.ManageHomesController=e}(Ally=Ally||{}),CA.angularApp.component("manageHomes",{templateUrl:"/ngApp/admin/manage-homes.html",controller:Ally.ManageHomesController}),function(e){class t{constructor(e){this.$http=e,this.isLoading=!1,this.shouldHideLoginAndEmailMessages=!1}$onInit(){this.shouldHideLoginAndEmailMessages="true"===window.localStorage.activityLog_hideLoginAndEmailMessages,this.retrieveEntries()}onHideLoginAndEmailMessagesChange(){window.localStorage.activityLog_hideLoginAndEmailMessages=this.shouldHideLoginAndEmailMessages,this.filterMessages()}retrieveEntries(){this.isLoading=!0,this.$http.get("/api/ActivityLog").then(e=>{this.isLoading=!1,this.allLogEntries=e.data,_.each(this.allLogEntries,e=>e.entryDateUtc=moment(e.entryDateUtc).toDate()),this.filterMessages()},e=>{this.isLoading=!1,alert("Failed to load activity log: "+e.data.exceptionMessage)})}filterMessages(){this.shouldHideLoginAndEmailMessages?this.filteredLogEntries=_.filter(this.allLogEntries,e=>"Logged in"!==e.activityMessage&&0!==e.activityMessage.indexOf("Group email sent")):this.filteredLogEntries=this.allLogEntries}}t.$inject=["$http"],e.ViewActivityLogController=t}(Ally=Ally||{}),CA.angularApp.component("viewActivityLog",{templateUrl:"/ngApp/admin/view-activity-log.html",controller:Ally.ViewActivityLogController}),function(e){class t{constructor(e){this.$http=e,this.isLoading=!1}$onInit(){this.refreshAddresses()}findCenter(e){for(var t={lat:0,lng:0},i=0;i<e.length;++i){var s=e[i];if(s){for(var a={lat:0,lng:0},n=0;n<s.vertices.length;++n){var o=s.vertices[n];a.lat+=o.lat,a.lng+=o.lng}a.lat/=s.vertices.length,a.lng/=s.vertices.length,t.lat+=a.lat,t.lng+=a.lng}}return t.lat/=e.length,t.lng/=e.length,t}refreshAddresses(){this.isLoading=!0,this.neighborhoodPolys=[];var t=this;this.$http.get("/api/Neighborhood/GetAll").then(e=>{t.isLoading=!1,t.neighborhoods=e.data,t.neighborhoodPolys=_.select(t.neighborhoods,function(e){return e.Bounds}),t.mapCenter=t.findCenter(this.neighborhoodPolys)},e=>{t.isLoading=!1,alert("Failed to retrieve neighborhoods: "+e.data.exceptionMessage)})}}t.$inject=["$http","$q"],e.ViewPolysController=t}(Ally=Ally||{}),CA.angularApp.component("viewPolys",{templateUrl:"/ngApp/admin/view-polys.html",controller:Ally.ViewPolysController}),function(e){class t{constructor(e){this.$http=e,this.isLoading=!1}$onInit(){this.mapCenter={lat:41.99114,lng:-87.690425},this.refreshCells()}addLine(e,t,i,s,a){new google.maps.Polyline({path:[{lat:t,lng:i},{lat:s,lng:a}],geodesic:!1,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2}).setMap(e)}onBuildingSelected(e){}onCellSelected(t){t.gpsBounds.mapShapeObject.setOptions({fillOpacity:.1}),this.selectedCell&&this.selectedCell.gpsBounds.mapShapeObject.setOptions({fillOpacity:.35}),this.selectedCell=t,_.each(this.selectedCell.streets,function(e){0!=e.minLat&&this.addLine(t.gpsBounds.mapShapeObject.map,e.minLat,e.minLon,e.maxLat,e.maxLon)})}refreshCells(){this.isLoading=!0;var t=this;this.$http.get("/api/ResearchMap").then(e=>{t.isLoading=!1,t.cells=e.data,t.isLoading=!0,t.$http.get("/api/ResearchMap/Buildings").then(function(e){t.isLoading=!1,t.buildings=e.data,t.buildingPoints=_.map(t.buildings,function(e){var t=e.addressPos;return t.ownerBuilding=e,t.onClick=function(){},t})})},function(e){t.isLoading=!1,alert("Failed to retrieve cells: "+e.data.exceptionMessage)})}onAddressSelected(e){this.selectedAddress=e,this.selectedAddress.gpsBounds||(this.selectedAddress.gpsBounds={vertices:[]}),this.selectedAddress.gpsBounds.vertices||(this.selectedAddress.gpsBounds.vertices=[]),0==this.selectedAddress.gpsBounds.vertices.length&&e.gpsPos&&(new google.maps.LatLng(e.gpsPos.lat,e.gpsPos.lon),new google.maps.LatLng(e.gpsPos.lat+.001,e.gpsPos.lon+.001),e.gpsBounds.vertices=[{lat:e.gpsPos.lat,lon:e.gpsPos.lon},{lat:e.gpsPos.lat+.001,lon:e.gpsPos.lon},{lat:e.gpsPos.lat+.001,lon:e.gpsPos.lon+.001},{lat:e.gpsPos.lat,lon:e.gpsPos.lon+.001}]),this.selectedGpsPoly=e.gpsBounds}}t.$inject=["$http"],e.ViewResearchController=t}(Ally=Ally||{}),CA.angularApp.component("viewResearch",{templateUrl:"/ngApp/admin/view-research.html",controller:Ally.ViewResearchController});var OverrideBaseApiPath=null,OverrideOriginalUrl=null;const StripeApiKey="pk_live_fV2yERkfAyzoO9oWSfORh5iH";function RoutePath(e,t,i,s,a=null){"/"!==e[0]&&(e="/"+e),this.path=e,this.templateUrl=t,this.controller=i,this.menuTitle=s,this.role=a||Role_Authorized,this.controllerAs="function"==typeof i?"vm":null}function RoutePath_v2(e){"/"!==e.path[0]&&(e.path="/"+e.path),this.path=e.path,this.templateUrl=e.templateUrl,this.templateHtml=e.templateHtml,this.controller=e.controller,this.menuTitle=e.menuTitle,this.role=e.role||Role_Authorized,this.controllerAs="function"==typeof e.controller?"vm":null}CA.angularApp.config(["$routeProvider","$httpProvider","$provide","SiteInfoProvider","$locationProvider",function(i,e,t,s,a){a.hashPrefix("!");const n={app:["$q","$http","$rootScope","$sce","$location","xdLocalStorage","appCacheService",function(n,e,t,i,o,s,r){return Ally.SiteInfoHelper.loginInit(n,e,t,i,s).then(e=>{return t=o,e=e,s=r,i=(i=n).defer(),a="/Home"===t.path()||"/Login"===t.path()||AppConfig.isPublicRoute(t.path()),e.userInfo||a?i.resolve():("/Home"===t.path()&&"/Login"===t.path()||(s.set(AppCacheService.Key_AfterLoginRedirect,t.path()),s.set(AppCacheService.Key_WasLoggedIn401,"true")),i.reject(),t.path("/Login")),i.promise;var t,i,s,a},e=>{console.log("Failed to get site info, redirecting to generic login",e),Ally.HtmlUtil2.globalRedirect("https://login."+AppConfig.baseTld+"/#!/Login")})}]},o={app:["$q","$http","$rootScope","$sce","xdLocalStorage",Ally.SiteInfoHelper.loginInit]};var r=angular.extend({},i,{when:function(e,t){return t.resolve=t.resolve||{},t.allyRole===Role_All?angular.extend(t.resolve,o):angular.extend(t.resolve,n),i.when(e,t),this}});for(let e=0;e<AppConfig.menu.length;++e){var l=AppConfig.menu[e],h={controller:l.controller,allyRole:l.role,reloadOnSearch:l.reloadOnSearch};l.templateUrl?h.templateUrl=l.templateUrl:h.template=l.templateHtml,l.controllerAs&&(h.controllerAs=l.controllerAs),r.when(l.path,h)}i.otherwise({redirectTo:"/Home"}),t.factory("http403Interceptor",["$q","$location","$rootScope","appCacheService","$injector",function(n,o,r,l,h){return{response:function(e){return e},responseError:function(e){var t=e.status;if(401===t||403===t){if(403===t&&r.dontHandle403)return n.reject(e);if(403===t&&r.isLoggedIn&&l.set(AppCacheService.Key_WasLoggedIn403,"true"),401===t&&HtmlUtil.isValidString(window.localStorage.rememberMe_Email)){const i=h.get("$http");if(!r.retryLoginDeffered){r.retryLoginDeffered=n.defer();const a={emailAddress:window.localStorage.rememberMe_Email,password:atob(window.localStorage.rememberMe_Password)};setTimeout(function(){i.post("/api/Login",a).then(function(e){e=e.data;h.get("SiteInfo").setAuthToken(e.authToken),r.retryLoginDeffered.resolve()},function(){var e=r.retryLoginDeffered;r.onLogOut_ClearData(),e.reject()}).finally(function(){r.retryLoginDeffered=null})},1e3)}const s=n.defer();return r.retryLoginDeffered.promise.then(function(){s.resolve(i(e.config))},function(){s.reject(e)}),s.promise}401===t&&"/Home"!==o.path()&&"/Login"!==o.path()&&(l.set(AppCacheService.Key_AfterLoginRedirect,o.path()),l.set(AppCacheService.Key_WasLoggedIn401,"true")),r.onLogOut_ClearData()}return n.reject(e)}}}]),e.interceptors.push("http403Interceptor"),e.defaults.transformResponse.push(function(e){return Ally.HtmlUtil2.isString(e)&&30<e.length||Ally.HtmlUtil2.convertStringsToDates(e),e}),t.factory("apiUriInterceptor",["$rootScope","SiteInfo",function(a,n){return"string"!=typeof a.authToken&&window.localStorage&&(a.authToken=window.localStorage.getItem("ApiAuthToken")),{request:function(e){var t="https://0.webappapi.mycommunityally.org/api/",i="https://0.webappapi.communityally.org/api/",s=HtmlUtil.startsWith(e.url,t)||HtmlUtil.startsWith(e.url,i);return(HtmlUtil.startsWith(e.url,"/api/")||s)&&(HtmlUtil.startsWith(e.url,"http")?s&&!HtmlUtil.isNullOrWhitespace(OverrideBaseApiPath)&&(HtmlUtil.startsWith(e.url,t)?e.url=OverrideBaseApiPath+e.url.substring(t.length):HtmlUtil.startsWith(e.url,i)&&(e.url=OverrideBaseApiPath+e.url.substring(i.length))):HtmlUtil.isNullOrWhitespace(OverrideBaseApiPath)?n.publicSiteInfo.baseApiUrl&&(e.url=n.publicSiteInfo.baseApiUrl+e.url.substring("/api/".length)):e.url=OverrideBaseApiPath+e.url.substring("/api/".length),e.headers.Authorization="Bearer "+a.authToken,e.headers.ReferrerOverride=OverrideOriginalUrl||window.location.href),e}}}]),e.interceptors.push("apiUriInterceptor")}]),CA.angularApp.run(["$rootScope","$http","$sce","$location","$templateCache","$cacheFactory","xdLocalStorage",function(r,e,t,l,i,s,a){var n;r.bgImagePath="/assets/images/Backgrounds/",r.appConfig=AppConfig,r.isLoggedIn=!1,r.publicSiteInfo={},r.shouldHideMenu=!1,r.isAdmin=!1,r.isSiteManager=!1,r.menuItems=_.where(AppConfig.menu,function(e){return!HtmlUtil.isNullOrWhitespace(e.menuTitle)}),r.mainMenuItems=_.where(r.menuItems,function(e){return e.role===Role_Authorized}),r.manageMenuItems=_.where(r.menuItems,function(e){return e.role===Role_Manager}),r.adminMenuItems=_.where(r.menuItems,function(e){return e.role===Role_Admin}),r.publicMenuItems=null,r.siteDesignSettings=Ally.SiteDesignSettings.GetDefault(),window.localStorage&&window.localStorage.getItem(Ally.SiteDesignSettings.SettingsCacheKey)&&(n=window.localStorage.getItem(Ally.SiteDesignSettings.SettingsCacheKey),Ally.SiteDesignSettings.ApplySiteDesignSettingsFromJson(r,n)),r.populatePublicPageMenu=()=>{var e;r.publicMenuItems=null,r.publicSiteInfo&&r.publicSiteInfo.customPages&&0!=(e=r.publicSiteInfo.customPages).length&&(e.forEach(e=>e.path="/Page/"+e.pageSlug),r.publicMenuItems=e)},HtmlUtil.isLocalStorageAllowed()&&window.localStorage&&(r.publicSiteInfo=angular.fromJson(window.localStorage.getItem("siteInfo")),r.authToken=window.localStorage.getItem("ApiAuthToken"),null!==r.publicSiteInfo&&void 0!==r.publicSiteInfo||(r.publicSiteInfo={}),r.populatePublicPageMenu()),a.init({iframeUrl:"https://www.communityally.org/xd-local-storage.html"}).then(()=>{},()=>{console.log("Failed to initialize xdomain")}),r.onLogOut_ClearData=function(){if(r.userInfo={},r.isLoggedIn=!1,r.isAdmin=!1,r.isSiteManager=!1,r.authToken="",window.localStorage&&(window.localStorage.removeItem("rememberMe_Email"),window.localStorage.removeItem("rememberMe_Password"),window.localStorage.removeItem("ApiAuthToken")),a.removeItem("allyApiAuthToken"),s)for(const e of Object.keys(s.info()))"templates"!==e&&s.get(e).removeAll();window.localStorage&&window.localStorage.removeItem("siteInfo"),l.path("/Login")},r.onLogOut=function(){e.get("/api/Login/Logout").then(r.onLogOut_ClearData,r.onLogOut_ClearData)},r.$on("$routeChangeStart",function(){CA.clearTemplateCacheIfNeeded&&CA.clearTemplateCacheIfNeeded(i)}),r.$on("$routeChangeSuccess",function(e,t,i,s){r.curPath=l.path();let a="";var n=l.path();-1!==n.indexOf("?")&&(a=n.substring(n.indexOf("?"),n.length));let o="";s&&s.name&&(o=l.protocol()+"://"+l.host()+"/#"+s.url),analytics.page({path:n,referrer:o,search:a,url:l.absUrl()}),r.publicSiteInfo&&r.publicSiteInfo.fullName&&(document.title=r.publicSiteInfo.fullName,t.$$route)&&t.$$route.originalPath&&(s=_.find(AppConfig.menu,e=>e.path===t.$$route.originalPath))&&(s.pageTitle?document.title=r.publicSiteInfo.fullName+" - "+s.pageTitle:s.menuTitle&&(document.title=r.publicSiteInfo.fullName+" - "+s.menuTitle))})}]),function(e){e.MenuItem_v3=class{}}(Ally=Ally||{}),function(e){e.RouteOptions_v3=class{};e.RoutePath_v3=class{constructor(e){this.reloadOnSearch=!0,"/"!==e.path[0]&&(e.path="/"+e.path),this.path=e.path,this.templateHtml=e.templateHtml,this.menuTitle=e.menuTitle,this.role=e.role||Role_Authorized,this.reloadOnSearch=void 0!==e.reloadOnSearch&&e.reloadOnSearch,this.pageTitle=e.pageTitle}};class t{}t.dwollaPreviewShortNames=["qa","dwollademo","dwollademo1","900wainslie","elingtonvillagepoa"],t.dwollaEnvironmentName="prod",e.AppConfigInfo=t;e.PeriodicPaymentFrequency=class{}}(Ally=Ally||{});var Role_Authorized="authorized",Role_All="all",Role_Manager="manager",Role_Admin="admin",PeriodicPaymentFrequencies=[{name:"Monthly",intervalName:"month",id:50,signUpNote:"Billed on the 1st of each month"},{name:"Quarterly",intervalName:"quarter",id:51,signUpNote:"Billed on January 1, April 1, July 1, October 1"},{name:"Semiannually",intervalName:"half-year",id:52,signUpNote:"Billed on January 1 and July 1"},{name:"Annually",intervalName:"year",id:53,signUpNote:"Billed on January 1"}];function FrequencyIdToInfo(e){return isNaN(e)||e<50?null:PeriodicPaymentFrequencies[e-50]}function GetLongPayPeriodNames(e){return"month"===e?["January","February","March","April","May","June","July","August","September","October","November","December"]:"quarter"===e?["Q1","Q2","Q3","Q4"]:"half-year"===e?["First Half","Second Half"]:null}function GetShortPayPeriodNames(e){return"month"===e?["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]:"quarter"===e?["Q1","Q2","Q3","Q4"]:"half-year"===e?["1st Half","2nd Half"]:null}const CondoAllyAppConfig={appShortName:"condo",appName:"Condo Ally",baseTld:"condoally.com",baseUrl:"https://condoally.com/",isChtnSite:!0,homeName:"Unit",memberTypeLabel:"Resident",menu:[new Ally.RoutePath_v3({path:"Home",templateHtml:"<chtn-home></chtn-home>",menuTitle:"Home"}),new Ally.RoutePath_v3({path:"Home/DiscussionThread/:discussionThreadId",templateHtml:"<chtn-home></chtn-home>",pageTitle:"Discussion Thread"}),new Ally.RoutePath_v3({path:"Info/Docs",templateHtml:"<association-info></association-info>",menuTitle:"Documents & Info",reloadOnSearch:!1,pageTitle:"Documents"}),new Ally.RoutePath_v3({path:"Info/:viewName",templateHtml:"<association-info></association-info>",pageTitle:"Info"}),new Ally.RoutePath_v3({path:"Logbook",templateHtml:"<logbook-page></logbook-page>"}),new Ally.RoutePath_v3({path:"Calendar",templateHtml:"<logbook-page></logbook-page>",menuTitle:"Calendar"}),new Ally.RoutePath_v3({path:"Map",templateHtml:"<chtn-map></chtn-map>",menuTitle:"Map"}),new Ally.RoutePath_v3({path:"BuildingResidents",templateHtml:"<group-members></group-members>",menuTitle:"Directory"}),new Ally.RoutePath_v3({path:"Committee/:committeeId/:viewName",templateHtml:"<committee-parent></committee-parent>",pageTitle:"Committee"}),new Ally.RoutePath_v3({path:"Committee/:committeeId/Home/DiscussionThread/:discussionThreadId",templateHtml:"<committee-parent></committee-parent>"}),new Ally.RoutePath_v3({path:"EmailChangeConfirm/:emailChangeId",templateHtml:"<email-change-confirm></email-change-confirm>"}),new Ally.RoutePath_v3({path:"MyProfile",templateHtml:"<my-profile></my-profile>",pageTitle:"My Profile"}),new Ally.RoutePath_v3({path:"ForgotPassword",templateHtml:"<forgot-password></forgot-password>",menuTitle:null,role:Role_All,pageTitle:"Forgot Password"}),new Ally.RoutePath_v3({path:"Login",templateHtml:"<login-page></login-page>",menuTitle:null,role:Role_All,pageTitle:"Login"}),new Ally.RoutePath_v3({path:"Help",templateHtml:"<help-form></help-form>",menuTitle:null,role:Role_All,pageTitle:"Help"}),new Ally.RoutePath_v3({path:"SignUp",templateHtml:"<condo-sign-up-wizard></condo-sign-up-wizard>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"EmailAbuse/:idValue",templateHtml:"<email-abuse></email-abuse>",role:Role_All}),new Ally.RoutePath_v3({path:"DiscussionManage/:idValue",templateHtml:"<discussion-manage></discussion-manage>"}),new Ally.RoutePath_v3({path:"NeighborSignUp",templateHtml:"<neighbor-sign-up></neighbor-sign-up>",role:Role_All}),new Ally.RoutePath_v3({path:"GroupRedirect/:appName/:shortName",templateHtml:"<group-redirect></group-redirect>",role:Role_All}),new Ally.RoutePath_v3({path:"MemberSignUp",templateHtml:"<pending-member-sign-up></pending-member-sign-up>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"Page/:slug",templateHtml:"<custom-page-view></custom-page-view>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"ManageResidents",templateHtml:"<manage-residents></manage-residents>",menuTitle:"Residents",role:Role_Manager}),new Ally.RoutePath_v3({path:"ManageCommittees",templateHtml:"<manage-committees></manage-committees>",menuTitle:"Committees",role:Role_Manager}),new Ally.RoutePath_v3({path:"ManagePolls",templateHtml:"<manage-polls></manage-polls>",menuTitle:"Polls",role:Role_Manager}),new Ally.RoutePath_v3({path:"Financials/OnlinePayments",templateHtml:"<financial-parent></financial-parent>",menuTitle:"Financials",role:Role_Manager}),new Ally.RoutePath_v3({path:"Financials/StripeLinkRefresh",templateHtml:"<stripe-link-refresh></stripe-link-refresh>",role:Role_Manager}),new Ally.RoutePath_v3({path:"Mailing/Invoice",templateHtml:"<mailing-parent></mailing-parent>",menuTitle:"Mailing",role:Role_Manager,pageTitle:"Send Invoice"}),new Ally.RoutePath_v3({path:"ManageCustomPages",templateHtml:"<manage-custom-pages></manage-custom-pages>",menuTitle:"Custom Pages",role:Role_Manager}),new Ally.RoutePath_v3({path:"Mailing/:viewName",templateHtml:"<mailing-parent></mailing-parent>",role:Role_Manager,pageTitle:"Mailing"}),new Ally.RoutePath_v3({path:"Settings/SiteSettings",templateHtml:"<settings-parent></settings-parent>",menuTitle:"Settings",role:Role_Manager}),new Ally.RoutePath_v3({path:"Settings/:viewName",templateHtml:"<settings-parent></settings-parent>",role:Role_Manager,pageTitle:"Settings"}),new Ally.RoutePath_v3({path:"Financials/:viewName",templateHtml:"<financial-parent></financial-parent>",role:Role_Manager,pageTitle:"Financials"}),new Ally.RoutePath_v3({path:"GroupAmenities",templateHtml:"<group-amenities></group-amenities>",role:Role_Manager,pageTitle:"Survey"}),new Ally.RoutePath_v3({path:"Admin/ManageGroups",templateHtml:"<manage-groups></manage-groups>",menuTitle:"All Groups",role:Role_Admin}),new Ally.RoutePath_v3({path:"Admin/ManageHomes",templateHtml:"<manage-homes></manage-homes>",menuTitle:"Homes",role:Role_Admin}),new Ally.RoutePath_v3({path:"Admin/ViewActivityLog",templateHtml:"<view-activity-log></view-activity-log>",menuTitle:"Activity Log",role:Role_Admin}),new Ally.RoutePath_v3({path:"Admin/ManageAddressPolys",templateHtml:"<manage-address-polys></manage-address-polys>",menuTitle:"View Groups on Map",role:Role_Admin}),new Ally.RoutePath_v3({path:"Admin/ViewPolys",templateHtml:"<view-polys></view-polys>",menuTitle:"View Polygons",role:Role_Admin}),new Ally.RoutePath_v3({path:"Admin/ViewResearch",templateHtml:"<view-research></view-research>",menuTitle:"View Research",role:Role_Admin})]},HomeAppConfig={appShortName:"home",appName:"Home Ally",baseTld:"homeally.org",baseUrl:"https://homeally.org/",isChtnSite:!1,homeName:"Home",memberTypeLabel:"User",menu:[new Ally.RoutePath_v3({path:"SignUp",templateHtml:"<home-sign-up></home-sign-up>",role:Role_All}),new Ally.RoutePath_v3({path:"ForgotPassword",templateHtml:"<forgot-password></forgot-password>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"Login",templateHtml:"<login-page></login-page>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"Help",templateHtml:"<help-form></help-form>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"CPView/:slug",templateHtml:"<custom-page-view></custom-page-view>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"MyProfile",templateHtml:"<my-profile></my-profile>"}),new Ally.RoutePath_v3({path:"Home",templateHtml:"<home-group-home></home-group-home>",menuTitle:"Home"}),new Ally.RoutePath_v3({path:"Info/Docs",templateHtml:"<association-info></association-info>",menuTitle:"Documents & Info"}),new Ally.RoutePath_v3({path:"Info/:viewName",templateHtml:"<association-info></association-info>"}),new Ally.RoutePath_v3({path:"Logbook",templateHtml:"<logbook-page></logbook-page>"}),new Ally.RoutePath_v3({path:"Calendar",templateHtml:"<logbook-page></logbook-page>",menuTitle:"Calendar"}),new Ally.RoutePath_v3({path:"Users",templateHtml:"<home-users></home-users>",menuTitle:"Users",role:Role_Manager}),new Ally.RoutePath_v3({path:"Admin/ViewActivityLog",templateHtml:"<view-activity-log></view-activity-log>",menuTitle:"View Activity Log",role:Role_Admin}),new Ally.RoutePath_v3({path:"HomeSignUp",templateHtml:"<neighbor-sign-up></neighbor-sign-up>",role:Role_All})]},HOAAppConfig=_.clone(CondoAllyAppConfig),NeighborhoodAppConfig=(HOAAppConfig.appShortName="hoa",HOAAppConfig.appName="HOA Ally",HOAAppConfig.baseTld="hoaally.org",HOAAppConfig.baseUrl="https://hoaally.org/",HOAAppConfig.homeName="Home",HOAAppConfig.menu.push(new Ally.RoutePath_v3({path:"HoaSignUp",templateHtml:"<hoa-sign-up-wizard></hoa-sign-up-wizard>",role:Role_All})),_.clone(CondoAllyAppConfig)),BlockClubAppConfig=(NeighborhoodAppConfig.appShortName="neighborhood",NeighborhoodAppConfig.appName="Neighborhood Ally",NeighborhoodAppConfig.baseTld="neighborhoodally.org",NeighborhoodAppConfig.baseUrl="https://neighborhoodally.org/",NeighborhoodAppConfig.homeName="Home",NeighborhoodAppConfig.menu=_.reject(NeighborhoodAppConfig.menu,function(e){return"Residents"===e.menuTitle||"Directory"===e.menuTitle}),NeighborhoodAppConfig.menu.push(new Ally.RoutePath_v3({path:"BuildingResidents",templateHtml:"<group-members></group-members>",menuTitle:"Members"})),NeighborhoodAppConfig.menu.splice(0,0,new Ally.RoutePath_v3({path:"ManageResidents",templateHtml:"<manage-residents></manage-residents>",menuTitle:"Members",role:Role_Manager})),NeighborhoodAppConfig.menu=_.reject(NeighborhoodAppConfig.menu,function(e){return"Assessment History"===e.menuTitle}),NeighborhoodAppConfig.menu.splice(3,0,new Ally.RoutePath_v3({path:"DuesHistory",menuTitle:"Dues History",templateHtml:"<dues-history></dues-history>",role:Role_Manager})),NeighborhoodAppConfig.menu.push(new Ally.RoutePath_v3({path:"NeighborhoodSignUp",templateHtml:"<neighborhood-sign-up-wizard></neighborhood-sign-up-wizard>",role:Role_All})),_.clone(CondoAllyAppConfig)),PtaAppConfig=(BlockClubAppConfig.appShortName="block-club",BlockClubAppConfig.appName="Block Club Ally",BlockClubAppConfig.baseTld="blockclubally.org",BlockClubAppConfig.baseUrl="https://blockclubally.org/",BlockClubAppConfig.homeName="Home",BlockClubAppConfig.memberTypeLabel="Member",BlockClubAppConfig.menu=_.reject(BlockClubAppConfig.menu,function(e){return"Residents"===e.menuTitle||"Directory"===e.menuTitle}),BlockClubAppConfig.menu.push(new Ally.RoutePath_v3({path:"BuildingResidents",templateHtml:"<group-members></group-members>",menuTitle:"Members"})),BlockClubAppConfig.menu.splice(0,0,new Ally.RoutePath_v3({path:"ManageResidents",templateHtml:"<manage-residents></manage-residents>",menuTitle:"Members",role:Role_Manager})),BlockClubAppConfig.menu=_.reject(BlockClubAppConfig.menu,function(e){return"Assessment History"===e.menuTitle}),BlockClubAppConfig.menu.splice(3,0,new Ally.RoutePath_v3({path:"AssessmentHistory",menuTitle:"Membership Dues History",templateHtml:"<assessment-history></assessment-history>",role:Role_Manager})),BlockClubAppConfig.menu.push(new Ally.RoutePath_v3({path:"NeighborhoodSignUp",templateHtml:"<neighborhood-sign-up-wizard></neighborhood-sign-up-wizard>",role:Role_All})),_.clone(CondoAllyAppConfig));PtaAppConfig.appShortName="pta",PtaAppConfig.appName="PTA Ally",PtaAppConfig.baseTld="ptaally.org",PtaAppConfig.baseUrl="https://ptaally.org/",PtaAppConfig.isChtnSite=!1,PtaAppConfig.homeName="Home",PtaAppConfig.memberTypeLabel="Member",PtaAppConfig.menu=[new Ally.RoutePath_v3({path:"Home",templateHtml:"<chtn-home></chtn-home>",menuTitle:"Home"}),new Ally.RoutePath_v3({path:"Info/Docs",templateHtml:"<association-info></association-info>",menuTitle:"Documents & Info"}),new Ally.RoutePath_v3({path:"Info/:viewName",templateHtml:"<association-info></association-info>"}),new Ally.RoutePath_v3({path:"Logbook",templateHtml:"<logbook-page></logbook-page>"}),new Ally.RoutePath_v3({path:"Calendar",templateHtml:"<logbook-page></logbook-page>",menuTitle:"Calendar"}),new Ally.RoutePath_v3({path:"BuildingResidents",templateHtml:"<group-members></group-members>",menuTitle:"Members"}),new Ally.RoutePath_v3({path:"Committee/:committeeId/:viewName",templateHtml:"<committee-parent></committee-parent>"}),new Ally.RoutePath_v3({path:"ForgotPassword",templateHtml:"<forgot-password></forgot-password>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"Login",templateHtml:"<login-page></login-page>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"Help",templateHtml:"<help-form></help-form>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"MemberSignUp",templateHtml:"<pending-member-sign-up></pending-member-sign-up>",menuTitle:null,role:Role_All}),new Ally.RoutePath_v3({path:"MyProfile",templateHtml:"<my-profile></my-profile>"}),new Ally.RoutePath_v3({path:"ManageResidents",templateHtml:"<manage-residents></manage-residents>",menuTitle:"Members",role:Role_Manager}),new Ally.RoutePath_v3({path:"ManageCommittees",templateHtml:"<manage-committees></manage-committees>",menuTitle:"Committees",role:Role_Manager}),new Ally.RoutePath_v3({path:"ManagePolls",templateHtml:"<manage-polls></manage-polls>",menuTitle:"Polls",role:Role_Manager}),new Ally.RoutePath_v3({path:"AssessmentHistory",templateHtml:"<assessment-history></assessment-history>",menuTitle:"Membership Dues History",role:Role_Manager}),new Ally.RoutePath_v3({path:"Settings",templateHtml:"<chtn-settings></chtn-settings>",menuTitle:"Settings",role:Role_Manager}),new Ally.RoutePath_v3({path:"Admin/ManageGroups",templateHtml:"<manage-groups></manage-groups>",menuTitle:"All Groups",role:Role_Admin}),new Ally.RoutePath_v3({path:"Admin/ViewActivityLog",templateHtml:"<view-activity-log></view-activity-log>",menuTitle:"Activity Log",role:Role_Admin}),new Ally.RoutePath_v3({path:"Admin/ManageAddressPolys",templateHtml:"<manage-address-polys></manage-address-polys>",menuTitle:"View Groups on Map",role:Role_Admin}),new Ally.RoutePath_v3({path:"PtaSignUp",templateHtml:"<neighbor-sign-up></neighbor-sign-up>",role:Role_All})];var Ally,AppConfig=null;let lowerDomain=document.domain.toLowerCase();(lowerDomain=HtmlUtil.isNullOrWhitespace(OverrideOriginalUrl)&&"localhost"!==lowerDomain?lowerDomain:OverrideOriginalUrl)||console.log("Unable to find domain, make sure to set OverrideBaseApiPath and OverrideOriginalUrl at the top of ally-app.ts"),AppConfig=-1!==lowerDomain.indexOf("condo")?CondoAllyAppConfig:-1!==lowerDomain.indexOf("homeally")||-1!==lowerDomain.indexOf("helloathome")?HomeAppConfig:-1!==lowerDomain.indexOf("hoa")?HOAAppConfig:-1!==lowerDomain.indexOf("neighborhoodally")||-1!==lowerDomain.indexOf("helloneighborhood")?NeighborhoodAppConfig:-1!==lowerDomain.indexOf("chicagoblock")||-1!==lowerDomain.indexOf("blockclub")?BlockClubAppConfig:-1!==lowerDomain.indexOf("ptaally")?PtaAppConfig:(console.log("Unknown ally app"),CondoAllyAppConfig),(window.AppConfig=AppConfig).isPublicRoute=function(i){i=i||window.location.hash;const s=-1!==(i=HtmlUtil.startsWith(i,"#!")?i.substr(2):i).indexOf("/",1);s&&(i=i.substr(0,i.indexOf("/",1)));var e=_.find(AppConfig.menu,function(e){let t=e.path;return!!t&&(t=s&&-1!==t.indexOf("/",1)?t.substr(0,t.indexOf("/",1)):t)===i});return!!e&&e.role===Role_All},document.title=AppConfig.appName,function(t){t.AssessmentPayment=class extends class{constructor(){this.isEmptyEntry=!1}}{};class e{}class l{constructor(e,t,i,s){this.$http=e,this.$location=t,this.siteInfo=i,this.appCacheService=s,this.LocalStorageKey_ShowPaymentInfo="AssessmentHistory_ShowPaymentInfo",this.LocalStorageKey_ShouldColorCodePayments="AssessmentHistory_ColorCodePayment",this.LocalStorageKey_ShowBalanceCol="AssessmentHistory_ShowBalanceCol",this.numPeriodsVisible=l.ChtnDefaultNumPeriodsVisible,this.shouldShowBalanceCol=!1,this.showRowType="unit",this.isForMemberGroup=!1,this.isSavingPayment=!1,this.shouldColorCodePayments=!1,this.shouldShowFillInSection=!1,this.selectedFillInPeriod=null,this.shouldShowNeedsAssessmentSetup=!1,this.hasAssessments=null,this.shouldShowAllUnits=!1,this.hasUnitsWithoutOwners=!1,this.shouldShowQuickFilter=!1,this.quickFilterText="",window.localStorage.assessmentHistory_showAllUnits&&(this.shouldShowAllUnits="true"===window.localStorage.assessmentHistory_showAllUnits)}$onInit(){var e;this.baseApiUri=this.siteInfo.publicSiteInfo.baseApiUrl,this.isForMemberGroup="neighborhood"===AppConfig.appShortName||"block-club"===AppConfig.appShortName||"pta"===AppConfig.appShortName,this.isForMemberGroup?this.pageTitle="Membership Dues Payment History":this.pageTitle="Assessment Payment History",this.numPeriodsVisible=l.ChtnDefaultNumPeriodsVisible,this.isForMemberGroup&&(this.numPeriodsVisible=l.MemberDefaultNumPeriodsVisible),this.shouldShowBalanceCol&&--this.numPeriodsVisible,this.authToken=window.localStorage.getItem("ApiAuthToken"),this.isForMemberGroup?this.showRowType="member":AppConfig.isChtnSite?(this.showRowType="unit",this.shouldShowQuickFilter=10<this.siteInfo.privateSiteInfo.numUnits):console.log("Unhandled app type for payment history: "+AppConfig.appShortName),this.showPaymentInfo="true"===window.localStorage[this.LocalStorageKey_ShowPaymentInfo],this.shouldColorCodePayments="true"===window.localStorage[this.LocalStorageKey_ShouldColorCodePayments],this.shouldShowBalanceCol="true"===window.localStorage[this.LocalStorageKey_ShowBalanceCol],this.siteInfo.privateSiteInfo.assessmentFrequency?(this.assessmentFrequency=this.siteInfo.privateSiteInfo.assessmentFrequency,this.isForMemberGroup&&(this.assessmentFrequency=l.PeriodicPaymentFrequency_Annually),this.payPeriodName="month",this.assessmentFrequency===l.PeriodicPaymentFrequency_Quarterly?this.payPeriodName="quarter":this.assessmentFrequency===l.PeriodicPaymentFrequency_Semiannually?this.payPeriodName="half-year":this.assessmentFrequency===l.PeriodicPaymentFrequency_Annually&&(this.payPeriodName="year"),this.maxPeriodRange=12,this.assessmentFrequency===l.PeriodicPaymentFrequency_Quarterly?this.maxPeriodRange=4:this.assessmentFrequency===l.PeriodicPaymentFrequency_Semiannually?this.maxPeriodRange=2:this.assessmentFrequency===l.PeriodicPaymentFrequency_Annually&&(this.maxPeriodRange=1),this.todaysPayPeriod=this.getTodaysPayPeriod(),e=FrequencyIdToInfo(this.assessmentFrequency),this.periodNames=GetLongPayPeriodNames(e.intervalName),this.shortPeriodNames=GetShortPayPeriodNames(e.intervalName),this.periodNames||(this.periodNames=[""],this.shortPeriodNames=[""]),this.startPeriodValue=(new Date).getMonth()+2,this.startYearValue=(new Date).getFullYear(),this.assessmentFrequency===l.PeriodicPaymentFrequency_Quarterly?this.startPeriodValue=Math.floor((new Date).getMonth()/4)+2:this.assessmentFrequency===l.PeriodicPaymentFrequency_Semiannually?this.startPeriodValue=Math.floor((new Date).getMonth()/6)+2:this.assessmentFrequency===l.PeriodicPaymentFrequency_Annually&&(this.startPeriodValue=1,this.startYearValue=(new Date).getFullYear()+1),this.startPeriodValue>this.maxPeriodRange&&(this.startPeriodValue=1,this.startYearValue+=1),this.isPeriodicPaymentTrackingEnabled=this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled,this.retrievePaymentHistory(),window.setTimeout(()=>this.$http.get("/api/DocumentLink/0").then(e=>this.viewExportViewId=e.data.vid),250),window.setTimeout(()=>$('[data-toggle="tooltip"]').tooltip(),1e3)):(this.hasAssessments=this.siteInfo.privateSiteInfo.hasAssessments,this.shouldShowNeedsAssessmentSetup=!0)}getTodaysPayPeriod(){let e=(new Date).getMonth()+1,t=(new Date).getFullYear();return this.assessmentFrequency===l.PeriodicPaymentFrequency_Quarterly?e=Math.floor((new Date).getMonth()/4)+1:this.assessmentFrequency===l.PeriodicPaymentFrequency_Semiannually?e=Math.floor((new Date).getMonth()/6)+1:this.assessmentFrequency===l.PeriodicPaymentFrequency_Annually&&(e=1,t=(new Date).getFullYear()),{periodValue:e,year:t}}onChangePeriodicPaymentTracking(){this.isPeriodicPaymentTrackingEnabled!==this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled&&(this.isPeriodicPaymentTrackingEnabled,this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled=this.isPeriodicPaymentTrackingEnabled,this.isLoading=!0,this.$http.put("/api/Association/updatePeriodicPaymentTracking?isPeriodicPaymentTrackingEnabled="+this.isPeriodicPaymentTrackingEnabled,null).then(()=>{this.isLoading=!1},()=>{alert("Failed to update the payment tracking"),this.isLoading=!1}))}populateVisiblePaymentsForUnit(s){var a,n=null!==s.owners&&0<s.owners.length?s.owners[0].userId:null,o=[];for(let i=0;i<this.visiblePeriodEntries.length;++i){const r=this.visiblePeriodEntries[i];let e,t=s.assessment;r.specialAssessmentId?(e=_.find(s.allPayments,e=>e.specialAssessmentId===r.specialAssessmentId),(a=this.specialAssessments.find(e=>e.specialAssessmentId===r.specialAssessmentId))&&(t=a.amount)):e=_.find(s.allPayments,e=>e.period===r.periodValue&&e.year===r.year),void 0!==e&&!e.isEmptyEntry||(e={paymentId:0,isPaid:!1,period:r.periodValue,year:r.year,amount:t,payerUserId:n,paymentDate:new Date,isEmptyEntry:!0,checkNumber:null,wePayCheckoutId:null,groupId:this.siteInfo.publicSiteInfo.groupId,notes:null,payerNotes:null,paymentsInfoId:null,wePayStatus:null,specialAssessmentId:r.specialAssessmentId,unitId:s.unitId}),o.push(e)}return o}fillInEmptyPaymentsForMember(i){var s=[];for(let t=0;t<this.visiblePeriodEntries.length;++t){const a=this.visiblePeriodEntries[t];let e;void 0!==(e=a.specialAssessmentId?_.find(i.enteredPayments,e=>e.specialAssessmentId===a.specialAssessmentId):_.find(i.enteredPayments,e=>e.period===a.periodValue&&e.year===a.year))&&!e.isEmptyEntry||(e={isPaid:!1,paymentId:null,period:a.periodValue,year:a.year,amount:0,payerUserId:i.userId,paymentDate:new Date,isEmptyEntry:!0,wePayCheckoutId:null,checkNumber:null,notes:null,payerNotes:null,wePayStatus:null,groupId:null,paymentsInfoId:null,specialAssessmentId:null}),s.push(e)}return s}viewWePayDetails(e){this.appCacheService.set("hwpid",e),this.$location.path("/Financials/OnlinePayments")}viewOnlinePaymentDetails(e){this.appCacheService.set("onpayid",e.toString()),this.$location.path("/Financials/OnlinePayments")}onSaveSpecialAssessment(){this.isLoading=!0,(this.editSpecialAssessment.specialAssessmentId?this.$http.put:this.$http.post)("/api/PaymentHistory/SpecialAssessment",this.editSpecialAssessment).then(()=>{this.isLoading=!1,this.editSpecialAssessment=null,this.retrievePaymentHistory()},e=>{this.isLoading=!1;e=e.data.exceptionMessage||e.data;alert("Failed to save special assessment: "+e)})}showCreateSpecialAssessment(){this.editSpecialAssessment=new e,this.editSpecialAssessment.assessmentDate=new Date,setTimeout(()=>{$("#specialAssessmentName").focus()},10)}browsePast(){for(this.startPeriodValue=this.startPeriodValue-6;this.startPeriodValue<1;)this.startPeriodValue=this.maxPeriodRange+this.startPeriodValue,--this.startYearValue;this.displayPaymentsForRange(this.startYearValue,this.startPeriodValue)}browseFuture(){for(this.startPeriodValue=this.startPeriodValue+6;this.startPeriodValue>this.maxPeriodRange;)this.startPeriodValue-=this.maxPeriodRange,++this.startYearValue;this.displayPaymentsForRange(this.startYearValue,this.startPeriodValue)}getSpecialAssessmentBetweenDates(t,i){if(!this.specialAssessments||0===this.specialAssessments.length)return null;let e=!1;i<t&&(s=i,i=t,t=s,e=!0);var s=this.specialAssessments.filter(e=>e.assessmentDate.getTime()>=t.getTime()&&e.assessmentDate.getTime()<i.getTime());return e&&s.reverse(),s}periodToDate(e){let t;return t=this.assessmentFrequency===l.PeriodicPaymentFrequency_Quarterly?3*e.periodValue:this.assessmentFrequency===l.PeriodicPaymentFrequency_Semiannually?6*e.periodValue:this.assessmentFrequency===l.PeriodicPaymentFrequency_Annually?0:e.periodValue-1,new Date(e.year,t,1)}displayPaymentsForRange(e,t){this.startYearValue=e,this.startPeriodValue=t,this.visiblePeriodEntries=[];var i=new h(this.startPeriodValue,this.startYearValue);let s=null;for(let t=0;t<this.numPeriodsVisible;++t){if(i.periodValue<1&&(i.periodValue=this.maxPeriodRange,--i.year),s){var a=this.periodToDate(i),n=this.periodToDate(s),n=this.getSpecialAssessmentBetweenDates(n,a);if(n&&0<n.length)for(const r of n){var o={name:r.assessmentName,periodValue:l.PeriodValueSpecial,arrayIndex:t++,year:r.assessmentDate.getFullYear(),isTodaysPeriod:!1,specialAssessmentId:r.specialAssessmentId};this.visiblePeriodEntries.push(o)}}let e=this.shortPeriodNames[i.periodValue-1];1!==i.periodValue&&i.periodValue!==this.maxPeriodRange||(e+=" "+i.year);a={name:e=this.isForMemberGroup?i.year+" - "+(i.year+1):e,periodValue:i.periodValue,arrayIndex:t,year:i.year,isTodaysPeriod:i.year===this.todaysPayPeriod.year&&i.periodValue===this.todaysPayPeriod.periodValue};this.visiblePeriodEntries.push(a),s=new h(i.periodValue,i.year),--i.periodValue}this.visiblePeriodEntries.length>this.numPeriodsVisible&&(this.visiblePeriodEntries=this.visiblePeriodEntries.slice(0,this.numPeriodsVisible)),this.isForMemberGroup?_.each(this.payers,e=>e.displayPayments=this.fillInEmptyPaymentsForMember(e)):this.unitPayments.forEach(e=>e.displayPayments=this.populateVisiblePaymentsForUnit(e))}retrievePaymentHistory(){this.isLoading=!0;let e="/api/PaymentHistory/FullHistory?oldestDate=";this.shouldShowAllUnits&&(e+="&showAllUnits=true"),window.localStorage.assessmentHistory_showAllUnits=this.shouldShowAllUnits,this.$http.get(e).then(e=>{const i=e.data;this.specialAssessments=e.data.specialAssessments,this.hasUnitsWithoutOwners=i.hasUnitsWithoutOwners,this.shouldShowFillInSection=this.siteInfo.userInfo.isAdmin||i.payments.length<2&&3<i.units.length,this.unitPayments=new Map,_.each(i.units,e=>{this.unitPayments.set(e.unitId,e);var t=this.unitPayments.get(e.unitId);for(t.displayOwners=_.first(e.owners,2);t.displayOwners.length<2;)t.displayOwners.push({name:""});t.displayPayments=[]}),this.isForMemberGroup&&e.data.payers&&_.each(e.data.payers,t=>{t.enteredPayments=_.filter(i.payments,e=>e.payerUserId===t.userId)}),_.each(i.payments,e=>{this.unitPayments.has(e.unitId)&&this.unitPayments.get(e.unitId).displayPayments.push(e)}),_.each(i.units,e=>{e.displayPayments=_.sortBy(e.displayPayments,e=>100*e.year+e.period),e.displayPayments.reverse(),e.allPayments=e.displayPayments,e.estBalance=this.getEstimatedBalance(e)}),i.units&&(this.totalEstBalance=i.units.filter(e=>void 0!==e.estBalance&&!isNaN(e.estBalance)).map(e=>e.estBalance||0).reduce((e,t)=>e+t,0));e=Array.from(this.unitPayments.values());this.nameSortedUnitPayments=t.HtmlUtil2.smartSortStreetAddresses(e,"name"),this.filteredUnitRows=this.nameSortedUnitPayments,this.payers=_.sortBy(i.payers,e=>e.name),this.displayPaymentsForRange(this.startYearValue,this.startPeriodValue),this.isLoading=!1,this.quickFilterText&&this.onQuickFilterChange()},e=>{this.isLoading=!1,alert("Failed to retrieve payment history: "+e.data.exceptionMessage)})}getNumPaymentsBetween(e,t){var i;return e.year===t.year?t.periodValue-e.periodValue:(i=(t.year-e.year-1)*this.maxPeriodRange,e=this.maxPeriodRange-e.periodValue,t.periodValue+i+e-1)}getEstimatedBalance(e){var t,i,s;if(e.allPayments.find(e=>e.isPaid))return s=(i=e.allPayments.filter(e=>e.isPaid))[i.length-1],s=new h(s.period,s.year),t=this.getNumPaymentsBetween(s,this.todaysPayPeriod)+2,i=i.length,"C"===e.name&&console.log("unit c",s,this.todaysPayPeriod,t,i),(s=(t-i)*e.assessment)<0?0:s}getPaymentSumForPayPeriod(t){let i=0;if(AppConfig.isChtnSite){var s=Array.from(this.unitPayments.keys());for(let e=0;e<s.length;++e){var a=s[e],a=this.unitPayments.get(a).displayPayments[t];a&&a.isPaid&&(i+=a.amount)}}else for(let e=0;e<this.payers.length;++e){var n=this.payers[e].displayPayments[t];n&&n.isPaid&&(i+=n.amount)}return i}onShowPaymentInfo(){window.localStorage[this.LocalStorageKey_ShowPaymentInfo]=this.showPaymentInfo,window.localStorage[this.LocalStorageKey_ShouldColorCodePayments]=this.shouldColorCodePayments}onshowBalanceCol(){window.localStorage[this.LocalStorageKey_ShowBalanceCol]=this.shouldShowBalanceCol,this.isForMemberGroup?this.numPeriodsVisible=l.MemberDefaultNumPeriodsVisible:this.numPeriodsVisible=l.ChtnDefaultNumPeriodsVisible,this.shouldShowBalanceCol&&--this.numPeriodsVisible,this.displayPaymentsForRange(this.startYearValue,this.startPeriodValue)}onUnitPaymentCellClick(e,t){t.unitId=e.unitId;let i="";var s;t.specialAssessmentId?(s=this.specialAssessments.find(e=>e.specialAssessmentId===t.specialAssessmentId))&&(i=s.assessmentName):i=this.periodNames[t.period-1],this.editPayment={unit:e,payment:_.clone(t),periodName:i,filteredPayers:_.filter(this.payers,t=>!_.some(e.owners,e=>e.userId===t.userId))},setTimeout(()=>{$("#paid-amount-textbox").focus()},10)}onMemberPaymentCellClick(e,t){t.payerUserId=e.userId,this.editPayment={unit:null,payment:_.clone(t),periodName:this.periodNames[t.period-1],filteredPayers:null},setTimeout(()=>{$("#paid-amount-textbox").focus()},10)}onSavePayment(e){e&&(event.preventDefault(),event.stopPropagation());var e=()=>{this.isSavingPayment=!1,this.editPayment=null,this.retrievePaymentHistory()},t=e=>{this.isSavingPayment=!1,alert(e.data.message),this.editPayment=null};return this.editPayment.payment.amount||(this.editPayment.payment.amount=0),this.isSavingPayment=!0,(this.editPayment.payment.paymentId?(analytics.track("editAssessmentHistoryPayment"),this.$http.put("/api/PaymentHistory/UpdatePaymentEntry",this.editPayment.payment)):(analytics.track("addAssessmentHistoryPayment"),this.$http.post("/api/PaymentHistory/NewPaymentEntry",this.editPayment.payment))).then(e,t),!1}populatePaidForPeriod(){if(this.selectedFillInPeriod){var i=Array.from(this.unitPayments.keys());this.isLoading=!0;let t=0;for(let e=0;e<i.length;++e){var s=this.unitPayments.get(i[e]),a=_.find(s.displayPayments,e=>e.year===this.selectedFillInPeriod.year&&e.period===this.selectedFillInPeriod.periodValue);if(!a||!a.isPaid){const n={Year:this.selectedFillInPeriod.year,Period:this.selectedFillInPeriod.periodValue,IsPaid:!0,Amount:s.assessment||0,PaymentDate:new Date,PayerUserId:this.siteInfo.userInfo.userId,Notes:"Auto-marking all entries for "+this.selectedFillInPeriod.name.trim(),unitId:s.unitId};++t,window.setTimeout(()=>this.$http.post("/api/PaymentHistory/NewPaymentEntry",n),350*t)}}window.setTimeout(()=>{this.isLoading=!1,this.retrievePaymentHistory()},350*(t+1))}}onExportClick(e){return window.setTimeout(()=>this.$http.get("/api/DocumentLink/0").then(e=>this.viewExportViewId=e.data.vid),500),analytics.track("exportAssessment"+e),!0}showBulkSet(){this.shouldShowFillInSection=!0,window.scrollTo(0,0)}onPeriodHeaderClick(t){t.specialAssessmentId&&(this.editSpecialAssessment=this.specialAssessments.find(e=>e.specialAssessmentId===t.specialAssessmentId),setTimeout(()=>{$("#specialAssessmentName").focus()},10))}onDeleteSpecialAssessment(){this.editSpecialAssessment.specialAssessmentId?confirm("Are you sure you want to delete this special assessment entry? This will delete any associated payment entires and CANNOT BE UNDONE.")&&(this.isLoading=!0,this.$http.delete("/api/PaymentHistory/SpecialAssessment/"+this.editSpecialAssessment.specialAssessmentId).then(()=>{this.isLoading=!1,this.editSpecialAssessment=null,this.retrievePaymentHistory()},e=>{this.isLoading=!1;e=e.data.exceptionMessage||e.data;alert("Failed to delete special assessment entry: "+e)})):this.editSpecialAssessment=null}onQuickFilterChange(){if(this.quickFilterText){const t=this.quickFilterText.toLowerCase();this.filteredUnitRows=this.nameSortedUnitPayments.filter(e=>{return-1!==(e=e).name.toLowerCase().indexOf(t)||!!(e.displayOwners&&0<e.displayOwners.length&&e.displayOwners.some(e=>-1!==e.name.toLowerCase().indexOf(t)))})}else this.filteredUnitRows=this.nameSortedUnitPayments}}l.$inject=["$http","$location","SiteInfo","appCacheService"],l.PeriodicPaymentFrequency_Monthly=50,l.PeriodicPaymentFrequency_Quarterly=51,l.PeriodicPaymentFrequency_Semiannually=52,l.PeriodicPaymentFrequency_Annually=53,l.PeriodValueSpecial=254,l.ChtnDefaultNumPeriodsVisible=9,l.MemberDefaultNumPeriodsVisible=8,t.AssessmentHistoryController=l;class h{constructor(e,t){this.periodValue=e,this.year=t}}}(Ally=Ally||{}),CA.angularApp.component("assessmentHistory",{templateUrl:"/ngApp/chtn/manager/financial/assessment-history.html",controller:Ally.AssessmentHistoryController}),function(l){class h{constructor(e,t,i,s,a){this.$http=e,this.uiGridConstants=t,this.$q=i,this.$timeout=s,this.siteInfo=a,this.isLoading=!1,this.financialCategoryMap=new Map,this.totalExpense=0,this.totalIncome=0,this.shouldRenderForPrint=!1,this.shouldShowPrintPreviewButton=!1,this.EditAmountTemplate="<div class='ui-grid-cell-contents'><span data-ng-if='row.entity.hasChildren'>{{row.entity.amount | currency}}</span><span data-ng-if='!row.entity.hasChildren'>$<input type='number' style='width: 85%;' data-ng-model='row.entity.amount' data-ng-change='grid.appScope.$ctrl.onAmountChange(row.entity)' /></span></div>"}$onInit(){this.expenseGridOptions={columnDefs:[{field:"categoryTreeLabel",displayName:"Category",width:"*"},{field:"amount",displayName:"Amount",width:120,type:"number",cellFilter:"currency",cellTemplate:this.EditAmountTemplate}],enableHorizontalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableColumnMenus:!1,enableRowHeaderSelection:!1,showTreeExpandNoChildren:!1,treeIndent:20,enableSorting:!1,enableTreeView:!0,showTreeRowHeader:!0,onRegisterApi:e=>{this.expenseGridApi=e,HtmlUtil.uiGridFixScroll()}},this.incomeGridOptions=_.clone(this.expenseGridOptions),this.incomeGridOptions.onRegisterApi=e=>{this.incomeGridApi=e,HtmlUtil.uiGridFixScroll()},this.refreshData(),this.shouldShowPrintPreviewButton="hampshirevillageatmeadow"===HtmlUtil.getSubdomain()||"qa"===HtmlUtil.getSubdomain(),this.groupName=this.siteInfo.publicSiteInfo.fullName,this.loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"),this.loadScript("https://html2canvas.hertzen.com/dist/html2canvas.min.js")}loadScript(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,document.body.appendChild(t)}refreshData(){return this.isLoading=!0,this.$http.get("/api/Budget/PageData").then(e=>{this.isLoading=!1,this.budgets=e.data.budgets,this.rootFinancialCategory=e.data.rootFinancialCategory,this.financialCategoryMap.clear();const i=t=>{if(this.financialCategoryMap.set(t.financialCategoryId,t),t.childCategories)for(let e=0;e<t.childCategories.length;++e)i(t.childCategories[e])};i(this.rootFinancialCategory)},e=>{this.isLoading=!1,alert("Failed to retrieve data, try refreshing the page. If the problem persists, contact support: "+e.data.exceptionMessage)})}onAmountChange(t){if(t){let e=t.parentRow;for(;e;)e.amount=_.reduce(e.childRows,(e,t)=>e+t.amount,0),e=e.parentRow}t=_.find(this.curBudget.budgetRows,e=>!e.parentRow&&"Income"===e.category.displayName),this.totalIncome=t.amount,t=this.curBudget.budgetRows.filter(e=>!e.parentRow&&"Income"!==e.category.displayName);this.totalExpense=_.reduce(t,(e,t)=>e+t.amount,0)}createBudget(){this.curBudget=new e,this.curBudget.budgetName="Unnamed",this.curBudget.budgetRows=[],this.expenseGridOptions.columnDefs.find(e=>"amount"===e.field).cellTemplate=this.EditAmountTemplate;const r=(t,i,s)=>{var e,a,n,o=null!=t.childCategories&&0<t.childCategories.length;if(s=0===i&&"Income"===t.displayName||s,t.displayName&&(e=s?i-1:i,n=h.catToTreePrefix(e),a=_.find(this.curBudget.budgetRows,e=>e.category.financialCategoryId===t.parentFinancialCategoryId),n={financialCategoryId:t.financialCategoryId,categoryDisplayName:t.displayName,categoryTreeLabel:n+t.displayName,amount:0,$$treeLevel:e,hasChildren:o,category:t,parentRow:a,childRows:[],isIncomeRow:s,parentBudgetRowId:null},a&&n.parentRow.childRows.push(n),this.curBudget.budgetRows.push(n)),o)for(let e=0;e<t.childCategories.length;++e)r(t.childCategories[e],i+1,s)};r(this.rootFinancialCategory,-1,!1),this.refreshGridsFromCurBudget()}static catToTreePrefix(e){return e<1?"":Array(4*(e-1)).join(String.fromCharCode(160))+"|--"}loadBudget(e){const a=(e,t=0)=>e&&(e.parentFinancialCategoryId&&this.financialCategoryMap.has(e.parentFinancialCategoryId))?a(this.financialCategoryMap.get(e.parentFinancialCategoryId),t+1):t;var t=this.expenseGridOptions.columnDefs.find(e=>"amount"===e.field),i=(e.finalizedDateUtc?t.cellTemplate=null:t.cellTemplate=this.EditAmountTemplate,e.rows.map(e=>{var t=this.financialCategoryMap.has(e.financialCategoryId)?this.financialCategoryMap.get(e.financialCategoryId):void 0,i=a(t),s=i,s=h.catToTreePrefix(s);return{amount:e.amount,categoryDisplayName:e.categoryDisplayName,financialCategoryId:e.financialCategoryId,budgetId:e.budgetId,budgetRowId:e.budgetRowId,$$treeLevel:i,category:t,childRows:[],categoryTreeLabel:s+(t?t.displayName:e.categoryDisplayName),hasChildren:!1,isIncomeRow:!1,parentRow:null,parentBudgetRowId:e.parentBudgetRowId}}));for(let e=0;e<i.length;++e){const o=i[e],r=o.category;if(r){if(o.hasChildren=r.childCategories&&0<r.childCategories.length,o.hasChildren){const l=_.map(r.childCategories,e=>e.financialCategoryId);o.childRows=i.filter(e=>0<=l.indexOf(e.financialCategoryId))}r.parentFinancialCategoryId&&(o.parentRow=_.find(i,e=>e.financialCategoryId===r.parentFinancialCategoryId))}else o.parentBudgetRowId&&(o.parentRow=_.find(i,e=>e.budgetRowId===o.parentBudgetRowId),o.childRows=i.filter(e=>e.parentBudgetRowId===o.budgetRowId))}const s=this.rootFinancialCategory.childCategories.find(e=>"Income"===e.displayName);t=i.find(e=>e.financialCategoryId===s.financialCategoryId);const n=e=>{e.isIncomeRow=!0,--e.$$treeLevel,e.categoryTreeLabel=h.catToTreePrefix(e.$$treeLevel)+e.categoryDisplayName,e.childRows&&e.childRows.forEach(e=>n(e))};n(t),this.curBudget={budgetId:e.budgetId,budgetName:e.budgetName,budgetRows:i},this.refreshGridsFromCurBudget()}refreshGridsFromCurBudget(){var e=this.curBudget.budgetRows.filter(e=>0<=e.$$treeLevel&&e.isIncomeRow),e=(this.incomeGridOptions.data=e,this.incomeGridOptions.minRowsToShow=e.length,this.incomeGridOptions.virtualizationThreshold=e.length,this.curBudget.budgetRows.filter(e=>!e.isIncomeRow));this.expenseGridOptions.data=e,this.expenseGridOptions.minRowsToShow=e.length,this.expenseGridOptions.virtualizationThreshold=e.length,this.$timeout(()=>{this.expenseGridApi.treeBase.expandAllRows(),this.incomeGridApi.treeBase.expandAllRows()},50),this.onAmountChange(null)}closeBudget(){this.curBudget=null,this.selectedBudget=null,this.incomeGridOptions.data=[],this.expenseGridOptions.data=[]}saveBudget(){this.curBudget.budgetId?this.saveExistingBudget():this.saveNewBudget()}saveExistingBudget(e=!0){this.isLoading=!0;var t={budgetId:this.curBudget.budgetId,budgetName:this.curBudget.budgetName,rows:_.map(this.curBudget.budgetRows,e=>({budgetRowId:e.budgetRowId,amount:e.amount,financialCategoryId:e.financialCategoryId}))};return this.$http.put("/api/Budget",t).then(()=>{this.isLoading=!1,e&&this.completeRefresh()},e=>(this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage),Promise.reject(e)))}saveNewBudget(){this.isLoading=!0;var e={budgetId:0,budgetName:this.curBudget.budgetName,rows:_.map(this.curBudget.budgetRows,e=>({budgetRowId:0,amount:e.amount,financialCategoryId:e.financialCategoryId}))};this.$http.post("/api/Budget",e).then(()=>{this.isLoading=!1,this.completeRefresh()},e=>{this.isLoading=!1,alert("Failed to retrieve data, try refreshing the page. If the problem persists, contact support: "+e.data.exceptionMessage)})}onBudgetSelected(){this.selectedBudget&&this.loadBudget(this.selectedBudget)}deleteBudget(){confirm("Are you sure you want to deleted this budget?")&&(this.isLoading=!0,this.$http.delete("/api/Budget/"+this.curBudget.budgetId).then(()=>{this.isLoading=!1,this.completeRefresh()},e=>{this.isLoading=!1,alert("Failed to delete, try refreshing the page. If the problem persists, contact support: "+e.data.exceptionMessage)}))}completeRefresh(){return this.curBudget=null,this.selectedBudget=null,this.incomeGridOptions.data=[],this.expenseGridOptions.data=[],this.refreshData()}finalizeBudget(){confirm("This makes the budget permanently read-only. Are you sure you want to finalize the budget?")&&(this.isLoading=!0,this.saveExistingBudget(!1).then(()=>{this.$http.put("/api/Budget/Finalize/"+this.curBudget.budgetId,null).then(()=>{this.isLoading=!1,this.curBudget=null,this.selectedBudget=null,this.incomeGridOptions.data=[],this.expenseGridOptions.data=[],this.completeRefresh()},e=>{this.isLoading=!1,alert("Failed to finalize, try refreshing the page. If the problem persists, contact support: "+e.data.exceptionMessage)})},()=>{this.isLoading=!1}))}exportToCsv(){var t=this.expenseGridOptions.data,i=this.incomeGridOptions.data,s=Math.max(t.length,i.length),a=[];a.push(new d("Budget:",this.curBudget.budgetName)),a.push(new d),a.push(new d("Expenses","","","Income"));const n=e=>e.parentRow?n(e.parentRow)+"/"+e.categoryDisplayName:e.categoryDisplayName;for(let e=0;e<s;++e){var o=new d;e<t.length&&(o.col0=n(t[e]),o.col1=(t[e].amount||0).toString()),e<i.length&&(o.col3=n(i[e]),o.col3.startsWith("Income/")&&(o.col3=o.col3.substring("Income/".length)),o.col4=(i[e].amount||0).toString()),a.push(o)}a.push(new d("Expense Total",this.totalExpense.toString(),"","Income Total",this.totalIncome.toString())),a.push(new d),a.push(new d("","Net",(this.totalIncome-this.totalExpense).toString()));var e=l.createCsvString(a,[{headerText:"",fieldName:"col0"},{headerText:"",fieldName:"col1"},{headerText:"",fieldName:"col2"},{headerText:"",fieldName:"col3"},{headerText:"",fieldName:"col4"}],!1),r="budget-"+l.HtmlUtil2.removeNonAlphanumeric(this.curBudget.budgetName)+".csv";l.HtmlUtil2.downloadCsv(e,r)}cloneBudget(){var e=prompt("Enter the new, cloned budget's name:");e&&(e={newName:e,budgetId:this.curBudget.budgetId},this.isLoading=!0,this.$http.put("/api/Budget/Clone",e).then(t=>{this.isLoading=!1,this.completeRefresh().then(()=>{this.selectedBudget=this.budgets.find(e=>e.budgetId===t.data),this.onBudgetSelected()})},e=>{this.isLoading=!1,alert("Failed to clone, try refreshing the page. If the problem persists, contact support: "+e.data.exceptionMessage)}))}static generatePdfForElement(e,t){const d=t.defer();return html2canvas(document.getElementById(e)).then(e=>{var t=e.toDataURL("image/jpeg",.98),i=new window.jspdf.jsPDF({orientation:"p",unit:"mm",format:"letter",putOnlyUsedFonts:!0,floatPrecision:16,title:"care-team-dashboard"}),s=i.internal.pageSize.getWidth(),a=i.internal.pageSize.getHeight(),n=s-14,o=e.height*n/e.width,r=(s-n)/2,l=Math.ceil(o/a);i.addImage(t,"JPEG",r,7,n,o);for(let e=1;e<l;++e){i.addPage("letter","portrait");var h=a*-e+7;i.addImage(t,"JPEG",r,h,n,o)}d.resolve(i)},e=>{d.reject(e)}),d.promise}generatePdf(){this.isLoading=!0,this.shouldRenderForPrint=!0,this.$timeout(()=>{h.generatePdfForElement("budget-data-container",this.$q).then(e=>{this.isLoading=!1,this.shouldRenderForPrint=!1,window.open(URL.createObjectURL(e.output("blob")))},()=>{this.isLoading=!1,this.shouldRenderForPrint=!1,alert("Failed to generated PDF locally, please contact support")})},10)}}h.$inject=["$http","uiGridConstants","$q","$timeout","SiteInfo"],l.BudgetToolController=h;class d{constructor(e="",t="",i="",s="",a=""){this.col0=e,this.col1=t,this.col2=i,this.col3=s,this.col4=a}}class e{}}(Ally=Ally||{}),CA.angularApp.component("budgetTool",{bindings:{},templateUrl:"/ngApp/chtn/manager/financial/budget-tool.html",controller:Ally.BudgetToolController}),function(e){class t{constructor(e,t,i,s){this.$http=e,this.siteInfo=t,this.appCacheService=i,this.$rootScope=s,this.isLoading=!1,this.selectedCategory=null,this.newCategoryParent=null,this.deleteCategoryRessignTo=null,this.shouldShowNewCategoryArea=!1,this.shouldShowDeleteCategoryArea=!1,this.didMakeChanges=!1,this.preselectById=null}$onInit(){this.refresh()}refresh(){this.isLoading=!0,this.$http.get("/api/Ledger/FinancialCategories").then(e=>{this.isLoading=!1,this.rootFinancialCategory=e.data,this.flatCategoryList=[];const s=(t,i)=>{if(t.displayName){let e="";1<i&&(e=Array(4*(i-2)).join(String.fromCharCode(160))+"|--"),t.dropDownLabel=e+t.displayName,this.flatCategoryList.push(t)}if(null!=t.childCategories&&0!=t.childCategories.length)for(let e=0;e<t.childCategories.length;++e)s(t.childCategories[e],i+1)};s(this.rootFinancialCategory,0),this.selectedCategory=this.flatCategoryList[0],this.preselectById&&((e=this.flatCategoryList.filter(e=>e.financialCategoryId===this.preselectById))&&0<e.length&&(this.selectedCategory=e[0]),this.preselectById=null),this.onCategorySelected()},e=>{this.isLoading=!1,alert("Failed to retrieve data, try refreshing the page. If the problem persists, contact support: "+e.data.exceptionMessage)})}onCategorySelected(){this.editName=this.selectedCategory?this.selectedCategory.displayName:""}closeManager(){this.onClosed({didMakeChanges:this.didMakeChanges})}showNewCategoryArea(){this.shouldShowNewCategoryArea=!0,this.shouldShowDeleteCategoryArea=!1,this.newName="",this.newCategoryParent=null}updateCategoryName(){var e;this.editName?(this.isLoading=!0,e=`/api/Ledger/FinancialCategory/UpdateName/${this.selectedCategory.financialCategoryId}?newName=`+encodeURIComponent(this.editName),this.$http.put(e,null).then(e=>{this.isLoading=!1,this.didMakeChanges=!0,this.shouldShowNewCategoryArea=!1,this.newName="",this.preselectById=this.selectedCategory.financialCategoryId,this.refresh()},e=>{this.isLoading=!1,alert("Failed to update: "+e.data.exceptionMessage)})):alert("Please enter a name")}saveNewCategory(){if(this.newName){this.isLoading=!0;let e="/api/Ledger/FinancialCategory/Add?name="+encodeURIComponent(this.newName);this.newCategoryParent&&(e+="&parentCategoryId="+this.newCategoryParent.financialCategoryId),this.$http.post(e,null).then(e=>{this.isLoading=!1,this.didMakeChanges=!0,this.preselectById=e.data,this.shouldShowNewCategoryArea=!1,this.refresh()},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})}else alert("Please enter a name")}deleteCategory(){if("Income"===this.selectedCategory.displayName)alert("You cannot delete the income category");else{this.isLoading=!0;let e="/api/Ledger/FinancialCategory/"+this.selectedCategory.financialCategoryId;this.deleteCategoryRessignTo&&(e+="?reassignToCategoryId="+this.deleteCategoryRessignTo.financialCategoryId),this.$http.delete(e).then(e=>{this.isLoading=!1,this.didMakeChanges=!0,this.shouldShowDeleteCategoryArea=!1,this.refresh()},e=>{this.isLoading=!1,alert("Failed to delete: "+e.data.exceptionMessage)})}}}t.$inject=["$http","SiteInfo","appCacheService","$rootScope"],e.FinancialCategoryManagerController=t}(Ally=Ally||{}),CA.angularApp.component("financialCategoryManager",{bindings:{onClosed:"&"},templateUrl:"/ngApp/chtn/manager/financial/financial-category-manager.html",controller:Ally.FinancialCategoryManagerController}),function(e){class t{constructor(e,t,i,s,a){this.$http=e,this.siteInfo=t,this.$routeParams=i,this.$cacheFactory=s,this.$rootScope=a,this.selectedView=null,this.isLoading=!1}$onInit(){HtmlUtil.isValidString(this.$routeParams.viewName)?this.selectedView=this.$routeParams.viewName:this.selectedView="OnlinePayments"}}t.$inject=["$http","SiteInfo","$routeParams","$cacheFactory","$rootScope"],e.FinancialParentController=t}(Ally=Ally||{}),CA.angularApp.component("financialParent",{templateUrl:"/ngApp/chtn/manager/financial/financial-parent.html",controller:Ally.FinancialParentController}),function(e){class t{constructor(e,t,i,s){this.$http=e,this.siteInfo=t,this.appCacheService=i,this.$location=s,this.isLoading=!1,this.incomeByCategoryData=null,this.incomeByCategoryLabels=null,this.incomeByCategoryCatIds=null,this.expenseByCategoryData=null,this.expenseByCategoryLabels=null,this.expenseByCategoryCatIds=null}$onInit(){window.sessionStorage.getItem("financialReport_startDate")&&(this.startDate=new Date(parseInt(window.sessionStorage.getItem("financialReport_startDate")))),this.startDate&&!isNaN(this.startDate.getTime())||(this.startDate=moment().subtract(1,"year").toDate()),window.sessionStorage.getItem("financialReport_endDate")&&(this.endDate=new Date(parseInt(window.sessionStorage.getItem("financialReport_endDate")))),this.endDate&&!isNaN(this.endDate.getTime())||(this.endDate=moment().toDate());const s=this;this.doughnutChartOptions={onClick:function(t){var i=this.getElementAtEvent(t);if(i.length){i=i[0],t="expense-category-chart"===t.target.id;let e;e=(t?s.expenseByCategoryCatIds:(console.log("Clicked on income category: "+s.incomeByCategoryLabels[i._index]),s.incomeByCategoryCatIds))[i._index],s.appCacheService.set("ledger_preselect_start",s.startDate.getTime().toString()),s.appCacheService.set("ledger_preselect_end",s.endDate.getTime().toString()),s.appCacheService.set("ledger_preselect_categoryId",e.toString()),window.location.href="/#!/Financials/BankTransactions"}}},this.refreshData()}refreshData(){this.isLoading=!0,this.$http.get(`/api/FinancialReports/ChartData?startDate=${encodeURIComponent(this.startDate.toISOString())}&endDate=`+encodeURIComponent(this.endDate.toISOString())).then(e=>{this.isLoading=!1,this.reportData=e.data,this.reportData.incomeByCategory=_.sortBy(this.reportData.incomeByCategory,e=>e.amount),this.incomeByCategoryData=_.map(this.reportData.incomeByCategory,e=>Math.abs(e.amount)),this.incomeByCategoryLabels=_.map(this.reportData.incomeByCategory,e=>e.parentFinancialCategoryName),this.incomeByCategoryCatIds=_.map(this.reportData.incomeByCategory,e=>e.parentFinancialCategoryId),this.reportData.expenseByCategory=_.sortBy(this.reportData.expenseByCategory,e=>e.amount),this.expenseByCategoryData=_.map(this.reportData.expenseByCategory,e=>Math.abs(e.amount)),this.expenseByCategoryLabels=_.map(this.reportData.expenseByCategory,e=>e.parentFinancialCategoryName),this.expenseByCategoryCatIds=_.map(this.reportData.expenseByCategory,e=>e.parentFinancialCategoryId),window.sessionStorage.setItem("financialReport_startDate",this.startDate.getTime().toString()),window.sessionStorage.setItem("financialReport_endDate",this.endDate.getTime().toString())},e=>{this.isLoading=!1,alert("Failed to retrieve report data: "+e.data.exceptionMessage)})}onByCategoryClickChart(e,t){var i;e&&0!==e.length&&(i="expense-category-chart"===e[0]._chart.canvas.id,console.log("Clicked",i,e[0],t),i?console.log("Clicked on expense category: "+this.expenseByCategoryLabels[e[0]._index]):console.log("Clicked on income category: "+this.incomeByCategoryLabels[e[0]._index]))}}t.$inject=["$http","SiteInfo","appCacheService","$location"],e.FinancialReportsController=t}(Ally=Ally||{}),CA.angularApp.component("financialReports",{templateUrl:"/ngApp/chtn/manager/financial/financial-reports.html",controller:Ally.FinancialReportsController}),function(i){class o{constructor(e,t,i,s,a,n){this.$http=e,this.siteInfo=t,this.appCacheService=i,this.uiGridConstants=s,this.$rootScope=a,this.$timeout=n,this.isLoading=!1,this.isLoadingEntries=!1,this.shouldExpandPending=!1,this.ledgerAccounts=[],this.accountsNeedingLogin=[],this.shouldShowAddTransaction=!1,this.editAccount=null,this.editingTransaction=null,this.createAccountInfo=null,this.HistoryPageSize=50,this.plaidHandler=null,this.newPlaidAccounts=[],this.hasPlaidAccounts=!1,this.filter=new r,this.isPremiumPlanActive=!1,this.ManageCategoriesDropId=-15,this.shouldShowCategoryEditModal=!1,this.spendingChartData=null,this.spendingChartLabels=null,this.showDonut=!0,this.isSuperAdmin=!1,this.shouldShowImportModal=!1,this.shouldShowOwnerFinanceTxn=!1,this.hasActiveTxGridColFilter=!1,this.uiGridCategoryDropDown=[],this.shouldShowFullCatPathInGrid=!1,window.localStorage&&window.localStorage[o.StoreKeyShouldShowFullCatPathInGrid]&&(this.shouldShowFullCatPathInGrid="true"===window.localStorage[o.StoreKeyShouldShowFullCatPathInGrid])}$onInit(){this.isPremiumPlanActive=this.siteInfo.privateSiteInfo.isPremiumPlanActive,this.isSuperAdmin=this.siteInfo.userInfo.isAdmin,this.homeName=AppConfig.homeName||"Unit",this.shouldShowOwnerFinanceTxn=this.siteInfo.privateSiteInfo.shouldShowOwnerFinanceTxn;this.ledgerGridOptions={columnDefs:[{field:"transactionDate",displayName:"Date",width:70,type:"date",cellFilter:"date:'shortDate'",enableFiltering:!1,enableColumnMenu:!1},{field:"accountName",filter:{type:this.uiGridConstants.filter.SELECT,selectOptions:[]},displayName:"Account",enableCellEdit:!1,width:140,enableFiltering:!0,enableColumnMenu:!1},{field:"description",displayName:"Description",enableCellEditOnFocus:!0,enableFiltering:!0,filter:{placeholder:"search"},enableColumnMenu:!1},{field:"categoryDisplayName",editModelField:"financialCategoryId",displayName:"Category",width:220,editableCellTemplate:"ui-grid/dropdownEditor",editDropdownOptionsArray:[],enableFiltering:!0,enableColumnMenu:!0,menuItems:[{title:"Full Category Path",active:()=>this.shouldShowFullCatPathInGrid,action:()=>{this.shouldShowFullCatPathInGrid=!this.shouldShowFullCatPathInGrid,window.localStorage&&(window.localStorage[o.StoreKeyShouldShowFullCatPathInGrid]=this.shouldShowFullCatPathInGrid),this.refreshCategoryLabels()}}]},{field:"unitGridLabel",editModelField:"associatedUnitId",displayName:this.homeName,width:120,editableCellTemplate:"ui-grid/dropdownEditor",editDropdownOptionsArray:[],enableFiltering:!0,enableColumnMenu:!1},{field:"amount",displayName:"Amount",width:140,type:"number",cellFilter:"currency",enableFiltering:!0,aggregationType:()=>{var e=this.ledgerGridApi.grid.rows.filter(e=>e.visible&&e.entity&&!isNaN(e.entity.amount));let t=0;return e.forEach(e=>t+=e.entity.amount||0),t},footerCellTemplate:'<div class="ui-grid-cell-contents">Total: {{col.getAggregationValue() | currency }}</div>',enableColumnMenu:!1},{field:"id",displayName:"Actions",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,width:90,cellTemplate:'<div class="ui-grid-cell-contents text-center"><img style="cursor: pointer;" data-ng-click="grid.appScope.$ctrl.editEntry( row.entity )" src="/assets/images/pencil-active.png" /><span class="close-x mt-0 mb-0 ml-3" data-ng-click="grid.appScope.$ctrl.deleteEntry( row.entity )" style="color: red; margin-left: 18px;">&times;</span></div>',enableColumnMenu:!1}],enableFiltering:!0,enableSorting:!0,showColumnFooter:!0,enableHorizontalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableColumnMenus:!0,enablePaginationControls:!0,paginationPageSize:this.HistoryPageSize,paginationPageSizes:[this.HistoryPageSize],enableRowSelection:!0,enableSelectAll:!0,enableFullRowSelection:!1,enableRowHeaderSelection:!0,onRegisterApi:i=>{this.ledgerGridApi=i,HtmlUtil.uiGridFixScroll(),i.edit.on.afterCellEdit(this.$rootScope,(t,e,i,s)=>{console.log("edited row amount:"+t.amount+" Column",e," newValue:"+i+" oldValue:"+s),s!==i&&("categoryDisplayName"===e.field&&t.financialCategoryId===this.ManageCategoriesDropId?(t.financialCategoryId=s,this.shouldShowCategoryEditModal=!0):(t.categoryDisplayName=this.getCategoryDisplayLabel(t.financialCategoryId),i=this.unitListEntries.find(e=>e.unitId===t.associatedUnitId),t.unitGridLabel=i?i.unitWithOwnerLast:null,this.$http.put("/api/Ledger/UpdateEntry",t).then(()=>this.regenerateDateDonutChart())))}),i.core.on.filterChanged(this.$rootScope,()=>{let t=!1;for(let e=0;e<i.grid.columns.length;++e)if(i.grid.columns[e].filters&&0<i.grid.columns[e].filters.length&&i.grid.columns[e].filters[0].term){t=!0;break}console.log("filterChanged","hasFilter",t);var e=this.hasActiveTxGridColFilter!==t;this.hasActiveTxGridColFilter=t,e&&this.updateLocalData()});const e=()=>{this.selectedEntries=_.clone(i.selection.getSelectedRows());let e=!1;for(const t of this.selectedEntries)t.isSplit&&(i.selection.unSelectRow(t),e=!0);this.selectedEntries=_.clone(i.selection.getSelectedRows()),e&&alert("You cannot bulk recategorize split transactions. Split rows have been deslected.")};i.selection.on.rowSelectionChanged(this.$rootScope,()=>e()),i.selection.on.rowSelectionChangedBatch(this.$rootScope,()=>e())}},this.pendingGridOptions={columnDefs:[{field:"transactionDate",displayName:"Date",width:70,type:"date",cellFilter:"date:'shortDate'",enableFiltering:!1},{field:"accountName",filter:{type:this.uiGridConstants.filter.SELECT,selectOptions:[]},displayName:"Account",enableCellEdit:!1,width:140,enableFiltering:!0},{field:"description",displayName:"Description",enableCellEditOnFocus:!0,enableFiltering:!0,filter:{placeholder:"search"}},{field:"amount",displayName:"Amount",width:140,type:"number",cellFilter:"currency",enableFiltering:!0,aggregationType:this.uiGridConstants.aggregationTypes.sum,footerCellTemplate:'<div class="ui-grid-cell-contents" >Total: {{col.getAggregationValue() | currency }}</div>'}],enableSorting:!0,enableHorizontalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableColumnMenus:!1,enablePaginationControls:!1,enableRowHeaderSelection:!1},this.previewImportGridOptions={columnDefs:[{field:"transactionDate",displayName:"Date",width:70,type:"date",cellFilter:"date:'shortDate'",enableFiltering:!1},{field:"description",displayName:"Description",enableCellEditOnFocus:!0,enableFiltering:!0,filter:{placeholder:"search"}},{field:"categoryDisplayName",editModelField:"financialCategoryId",displayName:"Category",width:170,editableCellTemplate:"ui-grid/dropdownEditor",editDropdownOptionsArray:[],enableFiltering:!0},{field:"unitGridLabel",editModelField:"associatedUnitId",displayName:this.homeName,width:120,editableCellTemplate:"ui-grid/dropdownEditor",editDropdownOptionsArray:[],enableFiltering:!0},{field:"amount",displayName:"Amount",width:140,type:"number",cellFilter:"currency",enableFiltering:!0,aggregationType:this.uiGridConstants.aggregationTypes.sum,footerCellTemplate:'<div class="ui-grid-cell-contents" >Total: {{col.getAggregationValue() | currency }}</div>'},{field:"id",displayName:"",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,width:40,cellTemplate:'<div class="ui-grid-cell-contents text-center"><span class="close-x mt-0 mb-0 ml-3" data-ng-click="grid.appScope.$ctrl.removeImportRow( row.entity )" style="color: red;">&times;</span></div>'}],enableSorting:!0,showColumnFooter:!1,enableHorizontalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableColumnMenus:!1};const t=parseInt(this.appCacheService.getAndClear("ledger_preselect_start"));isNaN(t)?(this.filter.startDate=moment().subtract(30,"days").toDate(),this.filter.endDate=moment().toDate(),this.fullRefresh()):window.setTimeout(()=>{this.filter.startDate=new Date(t);var e=parseInt(this.appCacheService.getAndClear("ledger_preselect_end"));this.filter.endDate=new Date(e),this.preselectCategoryId=parseInt(this.appCacheService.getAndClear("ledger_preselect_categoryId")),isNaN(this.preselectCategoryId)&&(this.preselectCategoryId=void 0),this.fullRefresh()},100),this.$timeout(()=>this.loadImportHistory(),1500),this.$http.get("/api/Ledger/OwnerTxNote").then(e=>this.ownerFinanceTxNote=e.data.ownerFinanceTxNote,e=>console.log("Failed to load owner tx note: "+e.data.exceptionMessage))}getCategoryDisplayLabel(t){if(!t)return"";var e=this.flatCategoryList.find(e=>e.financialCategoryId===t);if(!e)return"[N/A]";if(!this.shouldShowFullCatPathInGrid)return e.displayName;let s;return(s=(t,e)=>{var i;return t.parentFinancialCategoryId&&(i=this.flatCategoryList.find(e=>e.financialCategoryId===t.parentFinancialCategoryId))?s(i,i.displayName+"/"+e):e})(e,e.displayName)}fullRefresh(){this.isLoading=!0;let e=`/api/Ledger/PageInfo?startDate=${encodeURIComponent(this.filter.startDate.toISOString())}&endDate=`+encodeURIComponent(this.filter.endDate.toISOString());3<this.filter.description.length&&(e+="&descriptionSearch="+encodeURIComponent(this.filter.description)),this.$http.get(e).then(e=>{this.isLoading=!1,this.selectedEntries=[];var e=e.data,t=(this.ledgerAccounts=e.accounts,_.forEach(this.ledgerAccounts,e=>e.shouldShowInGrid=!0),this.ledgerGridOptions.columnDefs.find(e=>"accountName"===e.field));t&&(t.visible=1<this.ledgerAccounts.length);const i=this.ledgerAccounts.filter(e=>e.plaidNeedsRelogin);this.accountsNeedingLogin=[];for(let t=0;t<i.length;++t)this.accountsNeedingLogin.find(e=>e.plaidItemId===i[t].plaidItemId)||this.accountsNeedingLogin.push(i[t]);t.filter.selectOptions=this.ledgerAccounts.map(e=>({value:e.accountName,label:e.accountName})),this.hasPlaidAccounts=_.any(this.ledgerAccounts,e=>"plaid"===e.syncType),this.allEntries=e.entries,this.pendingGridOptions.data=e.pendingEntries,this.flatCategoryList=[];const s=(t,i)=>{if(t.displayName){let e="";1<i&&(e=Array(4*(i-2)).join(String.fromCharCode(160))+"|--"),t.dropDownLabel=e+t.displayName,this.flatCategoryList.push(t)}if(null!=t.childCategories&&0!=t.childCategories.length)for(let e=0;e<t.childCategories.length;++e)s(t.childCategories[e],i+1)};s(e.rootFinancialCategory,0),this.updateLocalData(),this.uiGridCategoryDropDown=[],this.uiGridCategoryDropDown.push({id:null,value:""});for(let e=0;e<this.flatCategoryList.length;++e)this.uiGridCategoryDropDown.push({id:this.flatCategoryList[e].financialCategoryId,value:this.flatCategoryList[e].dropDownLabel});this.uiGridCategoryDropDown.push({id:this.ManageCategoriesDropId,value:"Manage Categories..."});this.ledgerGridOptions.columnDefs.find(e=>"categoryDisplayName"===e.field).editDropdownOptionsArray=this.uiGridCategoryDropDown,this.preselectCategoryId&&window.setTimeout(()=>{var e=this.flatCategoryList.filter(e=>e.financialCategoryId===this.preselectCategoryId)[0];this.preselectCategoryId=void 0,this.ledgerGridApi.grid.columns.filter(e=>"Category"===e.displayName)[0].filters[0]={term:e.displayName}},100),this.unitListEntries=e.unitListEntries;var a=[];a.push({id:null,value:""});for(let e=0;e<this.unitListEntries.length;++e)a.push({id:this.unitListEntries[e].unitId,value:this.unitListEntries[e].unitWithOwnerLast});this.ledgerGridOptions.columnDefs.find(e=>"unitGridLabel"===e.field).editDropdownOptionsArray=a,this.populateGridUnitLabels(this.allEntries)},e=>{this.isLoading=!1,alert("Failed to retrieve data, try refreshing the page. If the problem persists, contact support: "+e.data.exceptionMessage)})}refreshCategoryLabels(){this.allEntries&&0!==this.allEntries.length&&_.each(this.allEntries,e=>{e.isSplit?e.categoryDisplayName="(split)":e.categoryDisplayName=this.getCategoryDisplayLabel(e.financialCategoryId)})}populateGridUnitLabels(e){e&&0!==e.length&&_.each(e,t=>{var e;t.isSplit?t.categoryDisplayName="(split)":t.categoryDisplayName=this.getCategoryDisplayLabel(t.financialCategoryId),t.associatedUnitId&&(e=this.unitListEntries.find(e=>e.unitId===t.associatedUnitId),t.unitGridLabel=e?e.unitWithOwnerLast:"UNK"),t.splitEntries&&0<t.splitEntries.length&&this.populateGridUnitLabels(t.splitEntries)})}refreshEntries(){this.isLoadingEntries=!0;let e=`/api/Ledger/PageInfo?startDate=${encodeURIComponent(this.filter.startDate.toISOString())}&endDate=`+encodeURIComponent(this.filter.endDate.toISOString());3<this.filter.description.length&&(e+="&descriptionSearch="+encodeURIComponent(this.filter.description)),this.$http.get(e).then(e=>{this.isLoadingEntries=!1,this.allEntries=e.data.entries,this.updateLocalData(),this.populateGridUnitLabels(this.allEntries)})}getLocalFilteredRows(e){const t=this.ledgerAccounts.filter(e=>e.shouldShowInGrid).map(e=>e.ledgerAccountId);let i=this.allEntries.filter(e=>-1<t.indexOf(e.ledgerAccountId));if(e){var s=[];for(let e=0;e<i.length;++e)if(i[e].isSplit&&i[e].splitEntries&&0<i[e].splitEntries.length){var a=i[e];for(let e=0;e<a.splitEntries.length;++e){var n=_.clone(a.splitEntries[e]);n.description="[SPLIT] "+n.description,n.accountName=a.accountName,s.push(n)}}else s.push(i[e]);i=s}return i}updateLocalData(){var e=this.getLocalFilteredRows(this.hasActiveTxGridColFilter);this.ledgerGridOptions.data=e,this.ledgerGridOptions.enablePaginationControls=e.length>this.HistoryPageSize,this.ledgerGridOptions.minRowsToShow=Math.min(e.length,this.HistoryPageSize),this.ledgerGridOptions.virtualizationThreshold=this.ledgerGridOptions.minRowsToShow,this.regenerateDateDonutChart()}regenerateDateDonutChart(){if(this.spendingChartData=null,0!==this.allEntries.length){const i=t=>{var e=this.flatCategoryList.filter(e=>e.financialCategoryId===t);return e&&0<e.length?e[0].parentFinancialCategoryId?i(e[0].parentFinancialCategoryId):e[0].financialCategoryId:0};var t=[];for(let e=0;e<this.allEntries.length;++e)if(this.allEntries[e].isSplit)for(const l of this.allEntries[e].splitEntries)t.push(l);else t.push(this.allEntries[e]);var a=_.groupBy(t,e=>i(e.financialCategoryId));let s=[];var n=_.keys(a);for(let i=0;i<n.length;++i){const h=+n[i];var o=a[h],r=this.flatCategoryList.filter(e=>e.financialCategoryId===h);let e=null,t=(r&&0<r.length&&(e=r[0]),0);for(let e=0;e<o.length;++e)t+=o[e].amount;r={parentCategoryId:h,parentCategoryDisplayName:e?e.displayName:"Uncategorized",sumTotal:Math.abs(t),numLedgerEntries:o.length};s.push(r)}s=_.sortBy(s,e=>e.sumTotal).reverse(),this.spendingChartData=[],this.spendingChartLabels=[];for(let e=0;e<s.length;++e)this.spendingChartData.push(s[e].sumTotal),this.spendingChartLabels.push(s[e].parentCategoryDisplayName);this.showDonut=!1,this.$timeout(()=>this.showDonut=!0,100)}}onAddTransaction(){0===this.ledgerAccounts.length?alert("Please add at least one account first"):(this.editingTransaction=new t,this.editingTransaction.ledgerAccountId=this.ledgerAccounts[0].ledgerAccountId,this.editingTransaction.transactionDate=new Date,window.setTimeout(()=>document.getElementById("transaction-amount-input").focus(),50))}completePlaidSync(e,t,i){this.isLoading=!0,this.plaidSuccessProgressMsg="Contacting Plaid server for selected account information",this.$http.post(t?"/api/Plaid/UpdateAccessToken":"/api/Plaid/ProcessNewAccessToken",{accessToken:e,updatePlaidItemId:t,selectedAccountIds:i}).then(e=>{this.isLoading=!1,this.plaidSuccessProgressMsg="Account information successfully retrieved",this.newPlaidAccounts=e.data,t&&window.location.reload()},e=>{this.isLoading=!1,this.plaidSuccessProgressMsg="Failed to retrieve account information from Plaid: "+e.data.exceptionMessage,alert("Failed to link: "+e.data.exceptionMessage)})}showAddAccount(){this.createAccountInfo=new e,this.createAccountInfo.type=null}updateAccountLink(t){this.isPremiumPlanActive?(this.isLoading=!0,this.$http.get("/api/Plaid/UpdateLinkToken/"+t.plaidItemId).then(e=>{this.isLoading=!1;e=e.data;e?(this.plaidHandler=Plaid.create({token:e,onSuccess:e=>{console.log("Plaid update onSuccess"),this.completePlaidSync(e,t.plaidItemId,null)},onLoad:()=>{},onExit:(e,t)=>{console.log("onExit.err",e,t)},onEvent:(e,t)=>{console.log("onEvent.eventName",e,t)},receivedRedirectUri:null}),this.plaidHandler.open()):alert("Something went wrong on the server. Please contact support.")},e=>{this.isLoading=!1,alert("Failed to update account link: "+e.data.exceptionMessage)})):alert("We cannot refresh your bank account connection while on our free plan. Sorry for the inconvenience.")}editEntry(t){var e;t.parentLedgerEntryId?(e=this.allEntries.find(e=>e.ledgerEntryId===t.parentLedgerEntryId),this.editingTransaction=_.clone(e)):this.editingTransaction=_.clone(t),this.editingTransaction.isSplit&&this.onSplitAmountChange()}deleteEntry(e){confirm("Are you sure you want to delete this entry? Deletion is permanent.")&&(this.isLoading=!0,this.$http.delete("/api/Ledger/DeleteEntry/"+e.ledgerEntryId).then(()=>{this.isLoading=!1,this.editAccount=null,this.editingTransaction=null,this.fullRefresh()},e=>{this.isLoading=!1,alert("Failed to delete: "+e.data.exceptionMessage)}))}onSaveEntry(){if(this.editingTransaction.isSplit){for(let e=0;e<this.editingTransaction.splitEntries.length;++e)if(!this.editingTransaction.splitEntries[e].amount)return void alert("A non-zero amount is required for all split transaction entries")}else{if(!this.editingTransaction.description)return void alert("Description is required");if(!this.editingTransaction.amount)return void alert("Non-zero amount is required")}this.isLoading=!0;var e=()=>{this.isLoading=!1,this.editingTransaction=null,this.refreshEntries()},t=e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)};(this.editingTransaction.ledgerEntryId?this.$http.put("/api/Ledger/UpdateEntry",this.editingTransaction):this.$http.post("/api/Ledger/NewManualEntry",this.editingTransaction)).then(e,t)}onSaveNewAccount(){this.isLoading=!0;this.$http.post("/api/Ledger/NewBankAccount",this.createAccountInfo).then(()=>{this.isLoading=!1,this.createAccountInfo=null,this.fullRefresh()},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})}startPlaidFlow(){this.createAccountInfo&&(this.createAccountInfo.type="plaid"),this.isPremiumPlanActive&&(this.isLoading=!0,this.$http.get("/api/Plaid/NewLinkToken").then(e=>{this.isLoading=!1,e.data&&(e={token:e.data,onSuccess:(e,t)=>{console.log("Plaid onSuccess",t);let i=null;t&&t.accounts&&0<t.accounts.length&&(i=t.accounts.map(e=>e.id)),this.completePlaidSync(e,null,i)},onLoad:()=>{},onExit:(e,t)=>{console.log("update onExit.err",e,t)},onEvent:(e,t)=>{console.log("update onEvent.eventName",e,t)},receivedRedirectUri:null},this.plaidHandler=Plaid.create(e),this.plaidHandler.open())},e=>{this.isLoading=!1,alert("Failed to start Plaid sign-up: "+e.data.exceptionMessage),this.closeAccountAndReload()}))}openEditAccountModal(e){this.editAccount=_.clone(e)}closeAccountAndReload(){this.createAccountInfo=null,this.fullRefresh()}onEditAccount(){var e=`/api/Ledger/UpdateAccount/${this.editAccount.ledgerAccountId}?newName=${encodeURIComponent(this.editAccount.accountName)}&newType=`+encodeURIComponent(this.editAccount.accountType);this.isLoading=!0,this.$http.put(e,null).then(()=>{this.isLoading=!1,this.editAccount=null,this.fullRefresh()},e=>{this.isLoading=!1,alert("Failed to update: "+e.data.exceptionMessage)})}syncPlaidAccounts(e){this.isLoading=!0,this.$http.get(e?"/api/Plaid/SyncRecentTransactions":"/api/Plaid/SyncTwoYearTransactions").then(()=>{this.isLoading=!1,this.refreshEntries()},e=>{this.isLoading=!1,alert("Failed to sync: "+e.data.exceptionMessage),e.data.exceptionMessage&&-1<e.data.exceptionMessage.indexOf("login credentials")&&window.location.reload()})}onFilterDescriptionChange(){(2<this.filter.description.length||0==this.filter.description.length)&&this.refreshEntries()}onEditTransactionCategoryChange(){}onCategoryManagerClosed(e){this.shouldShowCategoryEditModal=!1,e&&this.fullRefresh()}deleteAccount(){confirm("Are you sure you want to remove this account?")&&(this.isLoading=!0,this.$http.delete("/api/Ledger/DeleteAccount/"+this.editAccount.ledgerAccountId).then(()=>{this.isLoading=!1,this.editAccount=null,this.fullRefresh()},e=>{this.isLoading=!1,alert("Failed to delete: "+e.data.exceptionMessage)}))}splitTransaction(){this.editingTransaction.splitEntries||(this.editingTransaction.splitEntries=[]),this.editingTransaction.splitEntries.push(new t),this.editingTransaction.isSplit=!0}onSplitAmountChange(){this.splitAmountTotal=this.editingTransaction.splitEntries.reduce((e,t)=>e+t.amount,0);var e=Math.round(100*this.splitAmountTotal),t=Math.round(100*this.editingTransaction.amount);this.isSplitAmountEqual=e===t}removeSplit(e){this.editingTransaction.splitEntries.splice(this.editingTransaction.splitEntries.indexOf(e),1),this.onSplitAmountChange()}openImportFilePicker(){document.getElementById("importTransactionFileInput").click()}openImportModal(){this.shouldShowImportModal=!0,this.previewImportGridOptions.data=null}onImportFileSelected(e){e=e.target.files[0];if(e){this.isLoading=!0,this.importTxNotes="";var t=new FormData,e=(t.append("importFile",e),{headers:{"Content-Type":void 0}});const s=document.getElementById("importTransactionFileInput");this.$http.post("/api/Ledger/PreviewImport",t,e).then(e=>{this.isLoading=!1,s.value="",this.previewImportGridOptions.data=e.data;for(let e=0;e<this.previewImportGridOptions.data.length;++e){const i=this.previewImportGridOptions.data[e];i.ledgerEntryId=e;var t=this.unitListEntries.find(e=>e.unitId===i.associatedUnitId),t=(t&&(i.unitGridLabel=t.unitWithOwnerLast),this.flatCategoryList.find(e=>e.financialCategoryId===i.financialCategoryId));i.categoryDisplayName=t?t.displayName:null}this.previewImportGridOptions.minRowsToShow=e.data.length,this.previewImportGridOptions.virtualizationThreshold=this.previewImportGridOptions.minRowsToShow},e=>{this.isLoading=!1,s.value="",alert("Failed to upload document: "+e.data.exceptionMessage)})}}selectManualAccount(){this.createAccountInfo.type="manual",setTimeout(()=>document.getElementById("new-account-name-field").focus(),100)}importPreviewTransactions(){if(this.bulkImportAccountId){this.isLoading=!0;var t=this.previewImportGridOptions.data;for(let e=0;e<t.length;++e)t[e].ledgerAccountId=this.bulkImportAccountId;var e={notes:this.importTxNotes,entries:this.previewImportGridOptions.data};this.$http.post("/api/Ledger/BulkImport",e).then(()=>{this.previewImportGridOptions.data=null,this.shouldShowImportModal=!1,this.isLoading=!1,this.refreshEntries(),this.$timeout(()=>this.loadImportHistory(),1e3)},e=>{this.isLoading=!1,alert("Failed to import: "+e.data.exceptionMessage)})}else alert("Please select the account into which these transactions will be imported using the drop-down above the grid.")}removeImportRow(e){var t=this.previewImportGridOptions.data;t.splice(e.ledgerEntryId,1);for(let e=0;e<t.length;++e)t[e].ledgerEntryId=e}exportTransactionsCsv(){var e=[{headerText:"Date",fieldName:"transactionDate",dataMapper:function(e){return e?moment(e).format("YYYY-MM-DD"):""}},{headerText:"Description",fieldName:"description"},{headerText:"Category",fieldName:"categoryDisplayName"},{headerText:AppConfig.homeName,fieldName:"unitGridLabel"},{headerText:"Amount",fieldName:"amount"},{headerText:"Account",fieldName:"accountName"}],t=this.getLocalFilteredRows(!0),t=i.createCsvString(t,e);i.HtmlUtil2.downloadCsv(t,"Transactions.csv")}onShowOwnerTxnsChange(){this.isLoading=!0;var e="/api/Ledger/SetOwnerTxnViewing?shouldAllow="+this.shouldShowOwnerFinanceTxn;this.$http.put(e,null).then(()=>{this.isLoading=!1,this.siteInfo.privateSiteInfo.shouldShowOwnerFinanceTxn=this.shouldShowOwnerFinanceTxn},e=>{this.isLoading=!1,alert("Failed to change setting: "+e.data.exceptionMessage)})}loadImportHistory(){this.$http.get("/api/Ledger/TxImportHistory").then(e=>{this.importHistoryEntries=e.data},e=>{console.log("Failed to retrieve tx history: "+e.data.exceptionMessage)})}saveOwnerTxNote(){var e={ownerFinanceTxNote:this.ownerFinanceTxNote};this.isLoading=!0,this.$http.put("/api/Ledger/OwnerTxNote",e).then(()=>{this.isLoading=!1},e=>{this.isLoading=!1,alert("Failed to save note: "+e.data.exceptionMessage)})}bulkRecategorize(){var e;0!==this.selectedEntries.length&&(e={entryIds:this.selectedEntries.map(e=>e.ledgerEntryId),financialCategoryId:this.bulkRecategorizeCategoryId},this.isLoading=!0,this.$http.put("/api/Ledger/BulkRecategorize",e).then(()=>{this.isLoading=!1,this.fullRefresh()},e=>{this.isLoading=!1,alert("Failed to update: "+e.data.exceptionMessage)}))}disconnectFromPlaid(){this.ledgerAccounts.some(e=>!!e.plaidItemId)?!confirm("Are you sure? The group could be pissed!")||this.siteInfo.privateSiteInfo.isPremiumPlanActive&&!confirm("HOLD UP! This group is on the premium plan, you should leave their Plaid accounts alone! Are you sure you want to continue.")||(this.isLoading=!0,this.$http.put("/api/Ledger/DisconnectPlaidForGroup",null).then(()=>{this.isLoading=!1,alert("Accounts successfully disconnected"),window.location.reload()},e=>{this.isLoading=!1,alert("Failed to disconnect: "+e.data.exceptionMessage)})):alert("This group has no Plaid-synced accounts")}}o.$inject=["$http","SiteInfo","appCacheService","uiGridConstants","$rootScope","$timeout"],o.StoreKeyShouldShowFullCatPathInGrid="LedgerShouldShowFullCatPathInGrid",i.LedgerController=o;i.UiGridRow=class{};class e{}class t{}i.LedgerEntry=t;class r{constructor(){this.description="",this.startDate=new Date,this.endDate=new Date,this.category=""}}i.FinancialCategory=class{}}(Ally=Ally||{}),CA.angularApp.component("ledger",{templateUrl:"/ngApp/chtn/manager/financial/ledger.html",controller:Ally.LedgerController}),function(s){s.ElectronicPayment=class{};class e{constructor(e,t,i,s,a,n){this.$http=e,this.siteInfo=t,this.appCacheService=i,this.uiGridConstants=s,this.$scope=a,this.$timeout=n,this.PaymentHistory=[],this.errorMessage="",this.showPaymentPage=!0,this.periodicPaymentFrequencies=PeriodicPaymentFrequencies,this.AssociationPaysAch=!0,this.AssociationPaysCC=!1,this.lateFeeInfo={},this.hasLoadedPage=!1,this.isLoading=!1,this.isLoadingUnits=!1,this.isLoadingPayment=!1,this.isLoadingLateFee=!1,this.isLoadingCheckoutDetails=!1,this.allowNewWePaySignUp=!1,this.shouldShowDwollaAddAccountModal=!1,this.shouldShowDwollaModalClose=!1,this.shouldShowPaymentSignupModal=!1,this.shouldShowMicroDepositModal=!1,this.shouldShowPlaidTestSignUpButton=!1,this.shouldShowStripePrefaceModal=!1,this.shouldShowNewStripeSignUpMessage=!1,this.isDwollaIavDone=!1,this.shouldShowCustomInstructions=!1,this.hasMultipleProviders=!1,this.stripePayoutAccounts=null,this.exampleFeeService="stripe",this.isPremiumPlanActive=!1,this.customInstructionsText="",this.HistoryPageSize=50}$onInit(){this.homeName=AppConfig.homeName,this.highlightWePayCheckoutId=this.appCacheService.getAndClear("hwpid");var e=this.appCacheService.getAndClear("onpayid");HtmlUtil.isNumericString(e)&&(this.highlightPaymentsInfoId=parseInt(e)),this.isAssessmentTrackingEnabled=this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled;this.isPremiumPlanActive=this.siteInfo.privateSiteInfo.isPremiumPlanActive,this.payments=[{Date:"",Unit:"",Resident:"",Amount:"",Status:""}],this.testFee={amount:200},this.signUpStep=0,this.signUpInfo={hasAssessments:null,assessmentFrequency:PeriodicPaymentFrequencies[0].name,frequencyIndex:0,allPayTheSame:!0,allPayTheSameAmount:0,units:[]},this.paymentsGridOptions={columnDefs:[{field:"submitDateUtc",displayName:"Date",width:140,type:"date",cellFilter:"date:'short'"},{field:"unitName",displayName:this.homeName,width:80},{field:"resident",displayName:"Resident",width:160},{field:"amount",displayName:"Amount",width:100,type:"number",cellFilter:"currency"},{field:"status",displayName:"Status",width:110},{field:"notes",displayName:"Notes"},{field:"id",displayName:"",width:140,cellTemplate:'<div class="ui-grid-cell-contents"><span class="text-link" data-ng-if="row.entity.wePayCheckoutId" data-ng-click="grid.appScope.$ctrl.showWePayCheckoutInfo( row.entity.wePayCheckoutId )">WePay Details</span><span class="text-link" data-ng-if="row.entity.payPalCheckoutId" data-ng-click="grid.appScope.$ctrl.showPayPalCheckoutInfo( row.entity.payPalCheckoutId )">PayPal Details</span><span class="text-link" data-ng-if="row.entity.paragonReferenceNumber" data-ng-click="grid.appScope.$ctrl.showParagonCheckoutInfo( row.entity.paragonReferenceNumber )">Paragon Details</span><span class="text-link" data-ng-if="row.entity.dwollaTransferUri" data-ng-click="grid.appScope.$ctrl.showDwollaTransferInfo( row.entity )">Dwolla Details</span><span class="text-link" data-ng-if="row.entity.stripePaymentIntentId" data-ng-click="grid.appScope.$ctrl.showStripeTransferInfo( row.entity )">Stripe Details</span></div>'}],enableSorting:!0,enableHorizontalScrollbar:window.innerWidth<996?this.uiGridConstants.scrollbars.ALWAYS:this.uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableColumnMenus:!1,enablePaginationControls:!0,paginationPageSize:this.HistoryPageSize,paginationPageSizes:[this.HistoryPageSize],enableRowHeaderSelection:!1,onRegisterApi:()=>{HtmlUtil.uiGridFixScroll()}},this.refresh()}refresh(){this.isLoading=!0,this.$http.get("/api/OnlinePayment").then(e=>{this.isLoading=!1,this.hasLoadedPage=!0,this.hasAssessments=this.siteInfo.privateSiteInfo.hasAssessments,this.hasAssessments&&(t=PeriodicPaymentFrequencies.find(e=>e.id===this.siteInfo.privateSiteInfo.assessmentFrequency))&&(this.assessmentFrequencyLabel=t.name);var t=e.data;this.paymentInfo=t,this.paymentInfo.isWePaySetup=!1,this.paymentInfo.isDwollaSetup=!1,this.paymentsGridOptions.data=this.paymentInfo.electronicPayments,this.paymentsGridOptions.enablePaginationControls=this.paymentInfo.electronicPayments.length>this.HistoryPageSize,this.paymentsGridOptions.minRowsToShow=Math.min(this.paymentInfo.electronicPayments.length,this.HistoryPageSize),this.paymentsGridOptions.virtualizationThreshold=this.paymentsGridOptions.minRowsToShow;let i=0;this.paymentInfo.isDwollaSetup&&++i,this.paymentInfo.isWePaySetup&&++i,this.paymentInfo.isStripeSetup&&++i,this.hasMultipleProviders=1<i,e.data.stripeConnectEnabledDateUtc&&(this.shouldShowNewStripeSignUpMessage=moment().subtract(2,"days").isBefore(moment(e.data.stripeConnectEnabledDateUtc))),this.stripePayoutAccounts=e.data.stripeConnectExternalAccountHints,s.HtmlUtil2.isValidString(this.paymentInfo.customFinancialInstructions)&&this.showCustomInstructionsEditor(),this.lateFeeInfo={lateFeeDayOfMonth:t.lateFeeDayOfMonth,lateFeeAmount:t.lateFeeAmount},HtmlUtil.isNullOrWhitespace(this.lateFeeInfo.lateFeeAmount)||HtmlUtil.endsWith(this.lateFeeInfo.lateFeeAmount,"%")||(this.lateFeeInfo.lateFeeAmount="$"+this.lateFeeInfo.lateFeeAmount),this.refreshUnits(),this.updateTestFee(),this.highlightPaymentsInfoId&&((e=t.electronicPayments.filter(e=>e.paymentId===this.highlightPaymentsInfoId))&&0<e.length&&(e[0].wePayCheckoutId?this.showWePayCheckoutInfo(e[0].wePayCheckoutId):e[0].paragonReferenceNumber?this.showParagonCheckoutInfo(e[0].paragonReferenceNumber):e[0].dwollaTransferUri?this.showDwollaTransferInfo(e[0]):e[0].stripePaymentIntentId&&this.showStripeTransferInfo(e[0])),this.highlightPaymentsInfoId=null)},e=>{this.isLoading=!1,alert(`Failed to load page, please contact technical support. (${e.data.exceptionMessage})`)})}refreshUnits(){this.isLoadingUnits=!0,this.$http.get("/api/Unit").then(e=>{this.units=e.data,_.each(this.units,function(e){null===e.adjustedAssessment&&(e.adjustedAssessment=e.assessment)}),this.assessmentSum=_.reduce(this.units,function(e,t){return e+t.assessment},0),this.adjustedAssessmentSum=_.reduce(this.units,function(e,t){return e+(t.adjustedAssessment||0)},0),this.isLoadingUnits=!1},e=>{this.isLoading=!1,alert(`Failed to load units, please contact technical support. (${e.data.exceptionMessage})`)})}getLateFeeDateSuper(){let e=this.lateFeeInfo.lateFeeDayOfMonth;if("string"==typeof e){if(HtmlUtil.isNullOrWhitespace(e))return"";e=parseInt(e),this.lateFeeInfo.lateFeeDayOfMonth=e}var t;return isNaN(e)||e<1||31<e?e="":10<=e&&e<=20?"th":1==(t=e%10)?"st":2==t?"nd":3==t?"rd":"th"}updatePayPalCredentials(){this.isUpdatingPayPalCredentials=!0,this.payPalSignUpClientSecret="",this.payPalSignUpErrorMessage=""}saveAllowSetting(){if(!this.paymentInfo.areOnlinePaymentsAllowed&&this.paymentInfo.usersWithAutoPay&&0<this.paymentInfo.usersWithAutoPay.length){var e=_.map(this.paymentInfo.usersWithAutoPay,e=>e.fullName).join(",");if(!confirm(`For any members (${e}) using auto-pay, this will disable those automatic payments and will send them an email saying online payment has been disabled. Would you like to continue?`))return void this.$timeout(()=>this.paymentInfo.areOnlinePaymentsAllowed=!0,100)}this.isLoading=!0,this.$http.put("/api/OnlinePayment/SaveAllow?allowPayments="+this.paymentInfo.areOnlinePaymentsAllowed,null).then(()=>{window.location.reload()},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})}enablePayPal(){this.isLoading=!0,this.payPalSignUpErrorMessage=null;var e={clientId:this.payPalSignUpClientId,clientSecret:this.payPalSignUpClientSecret};this.$http.put("/api/OnlinePayment/EnablePayPal",e).then(()=>{this.payPalSignUpClientId="",this.payPalSignUpClientSecret="",window.location.reload()},e=>{this.isLoading=!1,this.payPalSignUpErrorMessage=e.data.exceptionMessage})}selectText(){setTimeout(function(){$(".editable-input").select()},50)}onWithdrawalClick(){this.errorMessage="",this.$http.get("/api/OnlinePayment/PerformAction?action=withdrawal").then(e=>{e=e.data;e.redirectUri?window.location.href=e.redirectUri:this.errorMessage=e.message},e=>{e.data&&e.data.exceptionMessage&&(this.errorMessage=e.data.exceptionMessage)})}onUnitAssessmentChanged(e){this.isLoadingUnits=!0,"string"==typeof e.adjustedAssessment&&(e.adjustedAssessment=parseFloat(e.adjustedAssessment));e={unitId:e.unitId,assessment:e.adjustedAssessment,assessmentNote:e.adjustedAssessmentReason};this.$http.put("/api/Unit/UpdateAssessment",e).then(()=>{this.isLoadingUnits=!1,this.assessmentSum=_.reduce(this.units,function(e,t){return e+t.assessment},0),this.adjustedAssessmentSum=_.reduce(this.units,function(e,t){return e+(t.adjustedAssessment||0)},0)},e=>{alert("Failed to update: "+e.data.exceptionMessage)})}setAllUnitAssessments(){var e;!this.setAllAssessmentAmount||isNaN(this.setAllAssessmentAmount)||this.setAllAssessmentAmount<0?alert("Enter a valid assessment amount"):(this.isLoading=!0,e={unitId:-1,assessment:this.setAllAssessmentAmount,assessmentNote:null},this.$http.put("/api/Unit/SetAllAssessments",e).then(()=>{this.isLoading=!1,this.refreshUnits()},e=>{this.isLoading=!1,alert("Failed to update: "+e.data.exceptionMessage)}))}onChangeFeePayerInfo(i){let s=!1,a=!1;if(this.paymentInfo.usersWithAutoPay&&0<this.paymentInfo.usersWithAutoPay.length){let e=[];if("ach"===i?e=_.where(this.paymentInfo.usersWithAutoPay,e=>"ACH"===e.wePayAutoPayFundingSource):"cc"===i&&(e=_.where(this.paymentInfo.usersWithAutoPay,e=>"Credit Card"===e.wePayAutoPayFundingSource)),0<e.length){a=void 0!==_.find(e,e=>e.userId===this.siteInfo.userInfo.userId),s=!0;let t="Adjusting the fee payer type will cause the follow units to have their auto-pay canceled and they will be informed by email:\n";if(_.each(e,e=>t+=e.ownerName+"\n"),t+="\nDo you want to continue?",!confirm(t))return void("ach"===i?this.paymentInfo.payerPaysAchFee=!this.paymentInfo.payerPaysAchFee:this.paymentInfo.payerPaysCCFee=!this.paymentInfo.payerPaysCCFee)}}this.isLoadingPayment=!0,a=!0,this.$http.put("/api/OnlinePayment",this.paymentInfo).then(()=>{a?window.location.reload():(this.isLoadingPayment=!1,s&&this.refresh())},e=>{alert("Failed to update: "+e.data.exceptionMessage)}),this.updateTestFee()}getSignUpSum(){return _.reduce(this.signUpInfo.units,function(e,t){return e+parseFloat(t.assessment)},0)}signUp_HasAssessments(e){this.signUpInfo.hasAssessments=e,this.signUpInfo.hasAssessments?(this.signUpInfo.units=[],_.each(this.units,e=>{this.signUpInfo.units.push({unitId:e.unitId,name:e.name,assessment:0})}),this.signUpStep=1):this.signUp_Commit()}signUp_AssessmentFrequency(e){this.signUpInfo.frequencyIndex=e,this.signUpInfo.assessmentFrequency=PeriodicPaymentFrequencies[e].name,this.signUpStep=2}saveLateFee(){this.isLoadingLateFee=!0,this.$http.put("/api/OnlinePayment/LateFee?dayOfMonth="+this.lateFeeInfo.lateFeeDayOfMonth+"&lateFeeAmount="+this.lateFeeInfo.lateFeeAmount,null).then(e=>{this.isLoadingLateFee=!1;e=e.data;e&&e.feeAmount&&0!==e.feeType?(this.lateFeeInfo.lateFeeAmount=e.feeAmount,1===e.feeType?this.lateFeeInfo.lateFeeAmount="$"+this.lateFeeInfo.lateFeeAmount:2===e.feeType&&(this.lateFeeInfo.lateFeeAmount=this.lateFeeInfo.lateFeeAmount+"%")):(""!==this.lateFeeInfo.lateFeeDayOfMonth&&alert("Failed to save the late fee. Please enter only a number for the date (ex. 5) and an amount (ex. 12.34) or percent (ex. 5%) for the fee. To disable late fees, clear the date field and hit save."),this.lateFeeInfo.lateFeeDayOfMonth="",this.lateFeeInfo.lateFeeAmount=null)},e=>{this.isLoadingLateFee=!1;e=e.data.exceptionMessage||e.data;alert("Failed to update late fee: "+e)})}showPayPalCheckoutInfo(e){this.viewingPayPalCheckoutId=e,this.viewingPayPalCheckoutId&&(this.isLoadingCheckoutDetails=!0,this.checkoutInfo={},this.$http.get("/api/OnlinePayment/PayPalCheckoutInfo?checkoutId="+e,{cache:!0}).then(e=>{this.isLoadingCheckoutDetails=!1,this.checkoutInfo=e.data},e=>{this.isLoadingCheckoutDetails=!1,alert("Failed to retrieve checkout details: "+e.data.exceptionMessage)}))}showWePayCheckoutInfo(e){this.viewingWePayCheckoutId=e,this.viewingWePayCheckoutId&&(this.isLoadingCheckoutDetails=!0,this.checkoutInfo={},this.$http.get("/api/OnlinePayment/WePayCheckoutInfo?checkoutId="+e,{cache:!0}).then(e=>{this.isLoadingCheckoutDetails=!1,this.checkoutInfo=e.data},e=>{this.isLoadingCheckoutDetails=!1,alert("Failed to retrieve checkout details: "+e.data.exceptionMessage)}))}showParagonCheckoutInfo(e){this.viewingParagonReferenceNumber=e,this.viewingParagonReferenceNumber&&(this.isLoadingCheckoutDetails=!0,this.checkoutInfo={},this.$http.get("/api/OnlinePayment/ParagonCheckoutInfo?paymentReferenceNumber="+e,{cache:!0}).then(e=>{this.isLoadingCheckoutDetails=!1,this.checkoutInfo=e.data},e=>{this.isLoadingCheckoutDetails=!1,alert("Failed to retrieve checkout details: "+e.data.exceptionMessage)}))}showDwollaTransferInfo(t){this.viewingDwollaEntry=t,this.viewingDwollaEntry&&(this.isLoadingCheckoutDetails=!0,this.checkoutInfo={},this.$http.get("/api/OnlinePayment/DwollaCheckoutInfo/"+t.paymentId).then(e=>{this.isLoadingCheckoutDetails=!1,this.checkoutInfo=e.data,this.checkoutInfo.payerNotes=t.notes},e=>{this.isLoadingCheckoutDetails=!1,alert("Failed to retrieve checkout details: "+e.data.exceptionMessage)}))}showStripeTransferInfo(t){this.viewingStripeEntry=t,this.viewingStripeEntry&&(this.isLoadingCheckoutDetails=!0,this.checkoutInfo={},this.$http.get("/api/OnlinePayment/StripeCheckoutInfo/"+t.paymentId).then(e=>{this.isLoadingCheckoutDetails=!1,this.checkoutInfo=e.data,this.checkoutInfo.payerNotes=t.notes,t.status=e.data.status},e=>{this.isLoadingCheckoutDetails=!1,alert("Failed to retrieve checkout details: "+e.data.exceptionMessage)}))}cancelDwollaTransfer(){this.viewingDwollaEntry&&(this.isLoadingCheckoutDetails=!0,this.checkoutInfo={},this.$http.get("/api/Dwolla/CancelTransfer/"+this.viewingDwollaEntry.paymentId).then(e=>{this.isLoadingCheckoutDetails=!1,this.checkoutInfo=e.data,window.location.reload()},e=>{this.isLoadingCheckoutDetails=!1,alert("Failed to cancel transfer: "+e.data.exceptionMessage)}))}signUp_Commit(){this.isLoading=!0,this.$http.post("/api/OnlinePayment/BasicInfo",this.signUpInfo).then(()=>{this.refreshUnits(),this.hasAssessments=this.signUpInfo.hasAssessments,this.siteInfo.privateSiteInfo.hasAssessments=this.hasAssessments,window.location.reload()},e=>{this.isLoading=!1,e.data&&e.data.exceptionMessage&&(this.errorMessage=e.data.exceptionMessage)})}updateTestFee(){var e,t=parseFloat(this.testFee.amount);"wepay"===this.exampleFeeService?(this.paymentInfo.payerPaysAchFee?(this.testFee.achResidentPays=t+1.5,this.testFee.achAssociationReceives=t):(this.testFee.achResidentPays=t,this.testFee.achAssociationReceives=t-1.5),e=1.3+.029*t,this.paymentInfo.payerPaysCCFee?(this.testFee.ccResidentPays=t+e,this.testFee.ccAssociationReceives=t):(this.testFee.ccResidentPays=t,this.testFee.ccAssociationReceives=t-e)):(e=s.HtmlUtil2.getStripeFeeInfo(t,this.paymentInfo.payerPaysAchFee,this.siteInfo.privateSiteInfo.isPremiumPlanActive),this.testFee.achResidentPays=e.totalAmountPaid,this.testFee.achAssociationReceives=e.groupReceives)}clearWePayAccessToken(){this.isLoading=!0,this.$http.get("/api/OnlinePayment/ClearWePayAuthToken").then(()=>{window.location.reload()},e=>{this.isLoading=!1,alert("Failed to disable WePay: "+e.data.exceptionMessage)})}showDwollaSignUpModal(){this.shouldShowDwollaAddAccountModal=!0,window.setTimeout(()=>{grecaptcha.render("recaptcha-check-elem")},200)}startDwollaSignUp(){var e=grecaptcha.getResponse();if(HtmlUtil.isNullOrWhitespace(e))alert("Please complete the reCAPTCHA field");else{this.shouldShowDwollaModalClose=!1,this.isDwollaIavDone=!1,this.isLoading=!0;const t=e=>{dwolla.configure(s.AppConfigInfo.dwollaEnvironmentName),dwolla.iav.start(e,{container:"dwolla-iav-container",stylesheets:["https://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext"],microDeposits:!0,fallbackToMicroDeposits:!0},(e,t)=>{console.log("Error: "+JSON.stringify(e)+" -- Response: "+JSON.stringify(t)),t&&t._links&&t._links["funding-source"]&&t._links["funding-source"].href&&(e=t._links["funding-source"].href,this.$http.put("/api/Dwolla/SetGroupFundingSourceUri",{fundingSourceUri:e}).then(()=>{this.isDwollaIavDone=!0},e=>{this.isLoading=!1,this.shouldShowDwollaModalClose=!0,alert("Failed to complete sign-up: "+e.data.exceptionMessage)}))})};this.$http.get("/api/Dwolla/GroupIavToken?token="+encodeURIComponent(e)).then(e=>{this.isLoading=!1,this.dwollaIavToken=e.data.iavToken,t(this.dwollaIavToken)},e=>{this.isLoading=!1,this.shouldShowDwollaAddAccountModal=!1,grecaptcha.reset(),alert("Failed to start instant account verification: "+e.data.exceptionMessage)})}}hideDwollaAddAccountModal(){this.shouldShowDwollaAddAccountModal=!1,this.dwollaIavToken=null,this.isDwollaIavDone&&(this.isLoading=!0,window.location.reload())}disconnectDwolla(){confirm("Are you sure you want to disconnect the bank account? Residents will no longer be able to make payments.")&&(this.isLoading=!0,this.$http.put("/api/Dwolla/DisconnectGroupFundingSource",null).then(()=>{window.location.reload()},e=>{this.isLoading=!1,alert("Failed to disconnect account"+e.data.exceptionMessage)}))}showMicroDepositModal(){this.shouldShowMicroDepositModal=!0,this.dwollaMicroDepositAmount1String="0.01",this.dwollaMicroDepositAmount2String="0.01"}submitDwollaMicroDepositAmounts(){this.isLoading=!0;var e={amount1String:this.dwollaMicroDepositAmount1String,amount2String:this.dwollaMicroDepositAmount2String,isForGroup:!0};this.$http.post("/api/Dwolla/VerifyMicroDeposit",e).then(()=>{window.location.reload()},e=>{this.isLoading=!1,alert("Failed to verify: "+e.data.exceptionMessage)})}addDwollaAccountViaPlaid(){this.isLoading=!0,this.$http.post("/api/Dwolla/SignUpGroupFromPlaid/81",null).then(()=>{window.location.reload()},e=>{this.isLoading=!1,alert("Failed to use Plaid account: "+e.data.exceptionMessage)})}showCustomInstructionsEditor(){this.shouldShowCustomInstructions=!0,window.setTimeout(()=>{s.HtmlUtil2.initTinyMce("tiny-mce-editor",220,{menubar:!1}).then(e=>{this.pageContentTinyMce=e,this.pageContentTinyMce?this.pageContentTinyMce.setContent(this.paymentInfo.customFinancialInstructions||""):this.customInstructionsText=this.paymentInfo.customFinancialInstructions||""})},25)}saveCustomInstructions(){this.isLoading=!0;const e={newInstructions:this.pageContentTinyMce?this.pageContentTinyMce.getContent():this.customInstructionsText};this.$http.put("/api/OnlinePayment/UpdateCustomFinancialInstructions",e).then(()=>{this.isLoading=!1,e.newInstructions||(this.shouldShowCustomInstructions=!1),this.siteInfo.privateSiteInfo.customFinancialInstructions=e.newInstructions},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})}signUpForStripe(){this.isLoading=!0,this.$http.get("/api/StripePayments/StartSignUp").then(e=>{window.location.href=e.data},e=>{this.isLoading=!1,alert("Failed to start Stripe sign-up: "+e.data.exceptionMessage)})}}e.$inject=["$http","SiteInfo","appCacheService","uiGridConstants","$scope","$timeout"],s.ManagePaymentsController=e}(Ally=Ally||{}),CA.angularApp.component("managePayments",{templateUrl:"/ngApp/chtn/manager/financial/manage-payments.html",controller:Ally.ManagePaymentsController});class PaymentBasicInfoUnitAssessment{}class PaymentBasicInfo{}!function(e){class t{constructor(e,t,i,s){this.$http=e,this.siteInfo=t,this.appCacheService=i,this.$location=s,this.isLoading=!1,this.statusMessage="Refreshing Stripe Connection..."}$onInit(){this.refreshLink()}refreshLink(){this.isLoading=!0,this.$http.get("/api/StripePayments/StartSignUp").then(e=>{this.statusMessage="Refreshed, redirecting to Stripe now...",window.location.href=e.data},e=>{this.isLoading=!1,this.statusMessage=`Failed to restart Stripe sign-up, please refresh the page or contact support (Error: ${e.data.exceptionMessage})`,alert(this.statusMessage)})}}t.$inject=["$http","SiteInfo","appCacheService","$location"],e.StripeLinkRefreshController=t}(Ally=Ally||{}),CA.angularApp.component("stripeLinkRefresh",{templateUrl:"/ngApp/chtn/manager/financial/stripe-link-refresh.html",controller:Ally.StripeLinkRefreshController}),function(e){class t{constructor(){this.isPrivate=!1}}e.Committee=t;class i{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.$cacheFactory=i,this.includeInactive=!1,this.activeCommittees=[],this.inactiveCommittees=[],this.showInactiveCommittees=!1,this.editCommittee=null,this.isLoading=!1}$onInit(){this.retrieveCommittees()}startEditCommittee(e){this.editCommittee=e}showCreateModal(){this.editCommittee=new t,this.editCommittee.committeeType="Ongoing"}toggleCommitteeActive(e){this.isLoading=!0;e=(e.deactivationDateUtc?"/api/Committee/Reactivate/":"/api/Committee/Deactivate/")+e.committeeId;this.$http.put(e,null).then(()=>{this.isLoading=!1,this.retrieveCommittees()},e=>{this.isLoading=!1,alert("Failed to retrieve the modify committee: "+e.data.exceptionMessage)})}retrieveCommittees(){this.isLoading=!0,this.$http.get("/api/Committee?includeInactive=true").then(e=>{e=e.data;this.isLoading=!1,this.activeCommittees=_.filter(e,e=>!e.deactivationDateUtc),this.inactiveCommittees=_.filter(e,e=>!!e.deactivationDateUtc),this.activeCommittees=_.sortBy(this.activeCommittees,e=>e.name.toLowerCase()),this.inactiveCommittees=_.sortBy(this.inactiveCommittees,e=>e.name.toLowerCase())},e=>{this.isLoading=!1,alert("Failed to retrieve the committee listing: "+e.data.exceptionMessage)})}saveCommittee(){var e;HtmlUtil.isNullOrWhitespace(this.editCommittee.name)?alert("Please enter a name for the new committee."):this.editCommittee.committeeType?(this.isLoading=!0,e=`/api/Committee${this.editCommittee.committeeId?"/"+this.editCommittee.committeeId.toString():""}?name=${encodeURIComponent(this.editCommittee.name)}&type=${encodeURIComponent(this.editCommittee.committeeType)}&isPrivate=`+this.editCommittee.isPrivate.toString(),(this.editCommittee.committeeId?this.$http.put:this.$http.post)(e,null).then(()=>{this.isLoading=!1,this.editCommittee=null,this.retrieveCommittees()},e=>{this.isLoading=!1,alert("Failed to save the committee: "+e.data.exceptionMessage)})):alert("Please select a type for the new committee.")}}i.$inject=["$http","SiteInfo","$cacheFactory"],e.ManageCommitteesController=i}(Ally=Ally||{}),CA.angularApp.component("manageCommittees",{templateUrl:"/ngApp/chtn/manager/manage-committees.html",controller:Ally.ManageCommitteesController}),function(t){class e{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.$scope=i,this.isLoading=!1,this.includeInactive=!1,this.allPageListings=[],this.menuPageListings=[],this.selectedPageEntry=null,this.editPage=null,this.selectedLandingPageId=null,this.pageSizeString="0 bytes",this.pageSizeBytes=0,this.groupBaseUrl=this.siteInfo.publicSiteInfo.baseUrl}$onInit(){this.retrievePages(),t.HtmlUtil2.initTinyMce("tiny-mce-editor",900).then(e=>{this.pageContentTinyMce=e,this.pageContentTinyMce?this.pageContentTinyMce.on("change",e=>{this.$scope.$apply(()=>{this.updatePageSizeLabel()})}):alert(t.HtmlUtil2.NoTinyMceErrorMsg)}),this.$http.get("/api/CustomPage/GroupLandingPage").then(e=>{this.selectedLandingPageId=e.data||null},e=>{console.log("Failed to retrieve current landing page: "+e.data.exceptionMessage)})}updatePageSizeLabel(){var e;this.pageContentTinyMce&&(e=this.pageContentTinyMce.getContent()||"",this.pageSizeBytes=e.length,this.pageSizeString=(this.pageSizeBytes/1048576).toFixed(2)+" MB")}retrievePages(){this.isLoading=!0,this.$http.get("/api/CustomPage/AllPages").then(e=>{this.isLoading=!1,this.allPageListings=e.data,this.menuPageListings=_.clone(e.data);e=new i;e.customPageId=-5,e.title="Add New Page...",this.menuPageListings.push(e)},e=>{this.isLoading=!1,alert("Failed to retrieve the custom pages: "+e.data.exceptionMessage)})}savePage(){HtmlUtil.isNullOrWhitespace(this.editPage.title)?alert("Please enter a title for the page"):HtmlUtil.isNullOrWhitespace(this.editPage.pageSlug)?alert("Please enter a slug for the page"):(this.editPage.markupHtml=this.pageContentTinyMce.getContent(),this.isLoading=!0,(this.editPage.customPageId?this.$http.put:this.$http.post)("/api/CustomPage",this.editPage).then(()=>{this.isLoading=!1,this.selectedPageEntry=null,this.editPage=null,this.pageContentTinyMce.setContent(""),this.updatePageSizeLabel(),this.retrievePages()},e=>{this.isLoading=!1,alert("Failed to save the page: "+e.data.exceptionMessage)}))}deletePage(){confirm("Are you sure you want to permanently delete this page? This action CANNOT BE UNDONE.")&&(this.isLoading=!0,this.$http.delete("/api/CustomPage/"+this.editPage.customPageId).then(()=>{this.isLoading=!1,this.selectedPageEntry=null,this.editPage=null,this.pageContentTinyMce.setContent(""),this.updatePageSizeLabel(),this.retrievePages()},e=>{this.isLoading=!1,alert("Failed to delete the page: "+e.data.exceptionMessage)}))}onTitleBlur(){this.editPage&&!this.editPage.pageSlug&&this.editPage.title&&(this.editPage.pageSlug=(this.editPage.title||"").trim(),this.editPage.pageSlug=this.editPage.pageSlug.replace(/[^0-9a-z- ]/gi,""),this.editPage.pageSlug=this.editPage.pageSlug.replace(/ /g,"-"))}onSlugBlur(){this.editPage&&(this.editPage.pageSlug=(this.editPage.pageSlug||"").trim(),this.editPage.pageSlug=this.editPage.pageSlug.replace(/ /g,"-"))}onPageSelected(){0<this.selectedPageEntry.customPageId?(this.isLoading=!0,this.$http.get("/api/CustomPage/"+this.selectedPageEntry.customPageId).then(e=>{this.isLoading=!1,this.editPage=e.data,this.pageContentTinyMce.setContent(this.editPage.markupHtml),this.updatePageSizeLabel()},e=>{this.isLoading=!1,alert("Failed to retrieve custom page: "+e.data.exceptionMessage)})):(this.editPage=new i,this.pageContentTinyMce.setContent(""),this.updatePageSizeLabel())}onLandingPageSelected(){let e="/api/CustomPage/SetGroupLandingPage";this.selectedLandingPageId&&(e+="?customPageId="+this.selectedLandingPageId),this.isLoading=!0,this.$http.put(e,null).then(e=>{var t;this.isLoading=!1,this.selectedLandingPageId?this.siteInfo.publicSiteInfo.customLandingPagePath=null:(t=this.allPageListings.find(e=>e.customPageId===this.selectedLandingPageId))&&(this.siteInfo.publicSiteInfo.customLandingPagePath="#!/Page/"+t.pageSlug)},e=>{this.isLoading=!1,alert("Failed to update landing page: "+e.data.exceptionMessage)})}}e.$inject=["$http","SiteInfo","$scope"],t.ManageCustomPagesController=e;class i{}t.PublicCustomPageEntry=class{}}(Ally=Ally||{}),CA.angularApp.component("manageCustomPages",{templateUrl:"/ngApp/chtn/manager/manage-custom-pages.html",controller:Ally.ManageCustomPagesController}),function(i){class e{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.fellowResidents=i,this.editingItem=new s,this.pollHistory=[],this.isLoading=!1,this.isSuperAdmin=!1,this.shouldAllowMultipleAnswers=!1,this.isPremiumPlanActive=!1}$onInit(){this.isSuperAdmin=this.siteInfo.userInfo.isAdmin,this.isPremiumPlanActive=this.siteInfo.privateSiteInfo.isPremiumPlanActive;var e=new Date;e.setDate((new Date).getDate()+3),this.defaultPoll=new s,this.defaultPoll.expirationDate=e,this.defaultPoll.votingGroupShortName="everyone",this.defaultPoll.answers=[new t("Yes"),new t("No")],this.editingItem=angular.copy(this.defaultPoll),this.shouldAllowMultipleAnswers=!1,this.isLoading=!0,this.fellowResidents.getGroupEmailObject().then(e=>{this.groupEmails=_.sortBy(e,e=>e.displayName.toUpperCase()),this.retrievePolls()},()=>this.retrievePolls())}retrievePolls(){this.isLoading=!0,this.$http.get("/api/Poll").then(e=>{this.pollHistory=e.data;for(let e=0;e<this.pollHistory.length;++e)this.pollHistory[e].expirationDate=new Date(this.pollHistory[e].expirationDate),this.pollHistory[e].fullResultAnswers=this.pollHistory[e].answers,this.pollHistory[e].answers=_.reject(this.pollHistory[e].answers,function(e){return 101===e.sortOrder});this.isLoading=!1})}addAnswer(){this.editingItem.answers||(this.editingItem.answers=[]),19<this.editingItem.answers.length?alert("You can only have 20 answers maxiumum per poll."):(this.editingItem.answers.push(new t("")),window.setTimeout(()=>document.getElementById("poll-answer-textbox-"+(this.editingItem.answers.length-1)).focus(),100))}cancelEdit(){this.editingItem=angular.copy(this.defaultPoll),this.shouldAllowMultipleAnswers=!1}onSavePoll(){var e,t;null!==this.editingItem&&(this.isLoading=!0,e=()=>{this.isLoading=!1,this.editingItem=angular.copy(this.defaultPoll),this.shouldAllowMultipleAnswers=!1,this.retrievePolls()},t=e=>{this.isLoading=!1,alert("Failed to save poll: "+e.data.exceptionMessage)},("number"==typeof this.editingItem.pollId?(analytics.track("editPoll"),this.$http.put("/api/Poll",this.editingItem)):(analytics.track("addPoll"),this.$http.post("/api/Poll",this.editingItem))).then(e,t))}onEditItem(e){this.editingItem=angular.copy(e),window.scrollTo(0,0),this.shouldAllowMultipleAnswers=1<this.editingItem.maxNumResponses}onDeleteItem(e){this.isLoading=!0,this.$http.delete("/api/Poll?pollId="+e.pollId).then(()=>{this.retrievePolls()},e=>{this.isLoading=!1,403===e.status?alert("You cannot authorized to delete this poll."):alert("Failed to delete: "+e.data.exceptionMessage)})}onViewResults(t){if(t){var e=i.FellowResidentsService.pollReponsesToChart(t,this.siteInfo);t.chartData=e.chartData,t.chartLabels=e.chartLabels,t.answerCounts=[];for(let e=0;e<t.chartLabels.length;++e)t.answerCounts.push({label:t.chartLabels[e],count:t.chartData[e]});this.chartLabels=t.chartLabels,this.chartData=t.chartData,this.viewingPollResults=t}else this.viewingPollResults=null}formatVoteGroupName(t){var e;return this.groupEmails&&(e=this.groupEmails.find(e=>e.recipientTypeName.toLowerCase()===t))?e.displayName:t}onMultiAnswerChange(){this.shouldAllowMultipleAnswers?this.editingItem.maxNumResponses=2:this.editingItem.maxNumResponses=1}}e.$inject=["$http","SiteInfo","fellowResidents"],i.ManagePollsController=e;class s{constructor(){this.isAnonymous=!0}}i.Poll=s;class t{constructor(e){this.answerText=e}}i.PollAnswer=t;i.PollResponse=class{}}(Ally=Ally||{}),CA.angularApp.component("managePolls",{templateUrl:"/ngApp/chtn/manager/manage-polls.html",controller:Ally.ManagePollsController}),function(s){class e{}s.Unit=e;s.PayerInfo=class{};class t extends e{}s.UnitWithOwner=t;s.UnitDisplayOwner=class{};s.UnitWithPayment=class extends t{};s.HomeEntry=class{};class i extends s.HomeEntry{}s.HomeEntryWithName=i;class a{}s.Member=a;class n extends a{}s.MemberWithBoard=n;class o extends n{}s.Resident=o;class r extends o{}s.UpdateResident=r;class l{}s.PendingMember=class{};class h{constructor(e,t,i,s,a,n){this.$http=e,this.$rootScope=t,this.fellowResidents=i,this.uiGridConstants=s,this.siteInfo=a,this.appCacheService=n,this.isAdmin=!1,this.showEmailSettings=!0,this.shouldShowHomePicker=!0,this.showKansasPtaExport=!1,this.multiselectMulti="single",this.isSavingUser=!1,this.isLoading=!1,this.isLoadingSettings=!1,this.shouldSortUnitsNumerically=!1,this.showEmailHistory=!1,this.emailHistorySinceDate=new Date,this.emailHistoryNumMonths=6,this.bulkParseNormalizeNameCase=!1,this.showLaunchSite=!0,this.showPendingMembers=!1,this.isLoadingPending=!1,this.selectedResidentDetailsView="Primary",this.showAddHomeLink=!1,this.hasMemberNotOwnerRenter=!1,this.didLoadResidentGridState=!1,this.shouldSaveResidentGridState=!0}$onInit(){this.isAdmin=this.siteInfo.userInfo.isAdmin,this.siteLaunchedDateUtc=this.siteInfo.privateSiteInfo.siteLaunchedDateUtc,this.bulkImportRows=[new l],this.multiselectOptions="",this.allUnits=null,this.homeName=AppConfig.homeName||"Unit",this.showIsRenter="condo"===AppConfig.appShortName||"hoa"===AppConfig.appShortName,this.shouldShowResidentPermissions=this.showIsRenter||"block-club"===AppConfig.appShortName,this.shouldShowHomePicker="pta"!==AppConfig.appShortName,this.showKansasPtaExport="pta"===AppConfig.appShortName&&"KS"===this.siteInfo.privateSiteInfo.groupAddress.state,this.showEmailSettings=!this.siteInfo.privateSiteInfo.isEmailSendingRestricted,this.memberTypeLabel=AppConfig.memberTypeLabel,this.showLaunchSite="pta"!==AppConfig.appShortName,this.showPendingMembers="pta"===AppConfig.appShortName||"block-club"===AppConfig.appShortName||"neighborhood"===AppConfig.appShortName,this.hasMemberNotOwnerRenter="pta"===AppConfig.appShortName||"block-club"===AppConfig.appShortName||"neighborhood"===AppConfig.appShortName;var e=moment(this.siteInfo.privateSiteInfo.creationDate).add(14,"days");this.showAddHomeLink=!this.siteInfo.privateSiteInfo.siteLaunchedDateUtc&&moment().isBefore(e),this.showPendingMembers&&(this.pendingMemberSignUpUrl=`https://${HtmlUtil.getSubdomain()}.${AppConfig.baseTld}/#!/MemberSignUp`,setTimeout(()=>{var e=new ClipboardJS(".clipboard-button");e.on("success",e=>{s.HtmlUtil2.showTooltip(e.trigger,"Copied!"),e.clearSelection()}),e.on("error",e=>{s.HtmlUtil2.showTooltip(e.trigger,"Auto-copy failed, press CTRL+C now")})},750)),this.boardPositions=s.FellowResidentsService.BoardPositionNames,this.newResident={boardPosition:0,isRenter:!1},this.editUser=null;const i="residentSort_v2";var e={field:"lastName",direction:this.uiGridConstants.ASC},t=(this.residentSortInfo=e,window.localStorage&&((t=window.localStorage.getItem(i))&&(this.residentSortInfo=JSON.parse(t)),this.residentSortInfo.field||(this.residentSortInfo=e)),"hoa"===AppConfig.appShortName?140:this.showIsRenter?62:175);if(this.residentGridOptions={data:[],enableFiltering:!1,columnDefs:[{field:"firstName",displayName:"First Name",cellClass:"resident-cell-first",enableFiltering:!0},{field:"lastName",displayName:"Last Name",cellClass:"resident-cell-last",enableFiltering:!0},{field:"email",displayName:"Email",cellTemplate:'<div class="ui-grid-cell-contents" ng-class="col.colIndex()"><span ng-cell-text class="resident-cell-email" data-ng-style="{ \'color\': row.entity.postmarkReportedBadEmailUtc ? \'#F00\' : \'auto\' }">{{ row.entity.email }}</span></div>',enableFiltering:!0},{field:"phoneNumber",displayName:"Cell Phone",width:150,cellClass:"resident-cell-phone",cellTemplate:'<div class="ui-grid-cell-contents" ng-class="col.colIndex()"><span ng-cell-text>{{ row.entity.phoneNumber | tel }}</span></div>',enableFiltering:!0},{field:"unitGridLabel",displayName:"condo"===AppConfig.appShortName?"Unit":"Residence",cellClass:"resident-cell-unit",width:t,visible:AppConfig.isChtnSite,sortingAlgorithm:(e,t)=>this.shouldSortUnitsNumerically?parseInt(e)-parseInt(t):e.toString().localeCompare(t.toString()),enableFiltering:!0},{field:"isRenter",displayName:"Renter",width:80,cellClass:"resident-cell-is-renter",visible:this.showIsRenter,cellTemplate:'<div class="ui-grid-cell-contents" style="text-align:center; padding-top: 8px;"><input type="checkbox" disabled="disabled" data-ng-checked="row.entity.isRenter"></div>',enableFiltering:!1},{field:"boardPosition",displayName:"Board",width:125,cellClass:"resident-cell-board",cellTemplate:'<div class="ui-grid-cell-contents" ng-class="col.colIndex()"><span ng-cell-text>{{ grid.appScope.$ctrl.getBoardPositionName(row.entity.boardPosition) }}</span></div>',enableFiltering:!1},{field:"isSiteManager",displayName:"Admin",width:80,cellClass:"resident-cell-site-manager",cellTemplate:'<div class="ui-grid-cell-contents" style="text-align:center; padding-top: 8px;"><input type="checkbox" disabled="disabled" data-ng-checked="row.entity.isSiteManager"></div>',enableFiltering:!1},{field:"lastLoginDateUtc",displayName:"Last Login",width:140,enableFiltering:!1,visible:!1,type:"date",cellFilter:"date:'short'"},{field:"alternatePhoneNumber",displayName:"Alt Phone",width:140,enableFiltering:!1,visible:!1},{field:"addedDateUtc",displayName:"Added Date",width:140,enableFiltering:!1,visible:!1,type:"date",cellFilter:"date:'short'"},{field:"lotNumberLabel",displayName:"Lot#",width:140,enableFiltering:!0,visible:!1}],multiSelect:!1,enableSorting:!0,enableHorizontalScrollbar:window.innerWidth<996?this.uiGridConstants.scrollbars.ALWAYS:this.uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableFullRowSelection:!0,enableColumnMenus:!1,enableGridMenu:!0,enableRowHeaderSelection:!1,onRegisterApi:e=>{(this.residentsGridApi=e).selection.on.rowSelectionChanged(this.$rootScope,e=>{this.setEdit(e.entity)}),e.core.on.sortChanged(this.$rootScope,(e,t)=>{t&&0!==t.length&&(this.residentSortInfo={field:t[0].field,direction:t[0].sort.direction},window.localStorage.setItem(i,JSON.stringify(this.residentSortInfo)))}),HtmlUtil.uiGridFixScroll()}},this.residentGridOptions.gridMenuShowHideColumns=!0,this.pendingMemberGridOptions={data:[],columnDefs:[{field:"firstName",displayName:"First Name"},{field:"lastName",displayName:"Last Name"},{field:"email",displayName:"Email"},{field:"phoneNumber",displayName:"Phone Number",width:150,cellClass:"resident-cell-phone",cellTemplate:'<div class="ui-grid-cell-contents" ng-class="col.colIndex()"><span ng-cell-text>{{ row.entity.phoneNumber | tel }}</span></div>'}],multiSelect:!1,enableSorting:!0,enableHorizontalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableFullRowSelection:!0,enableColumnMenus:!1,enableRowHeaderSelection:!1,onRegisterApi:e=>{(this.pendingMemberGridApi=e).selection.on.rowSelectionChanged(this.$rootScope,e=>{this.selectPendingMember(e.entity)}),HtmlUtil.uiGridFixScroll()}},window.innerWidth<769)for(let e=2;e<this.residentGridOptions.columnDefs.length;++e)this.residentGridOptions.columnDefs[e].visible=!1;this.emailHistoryGridOptions={columnDefs:[{field:"senderName",displayName:"Sender",width:150},{field:"recipientGroup",displayName:"Sent To",width:100},{field:"messageSource",displayName:"Source",width:100},{field:"subject",displayName:"Subject"},{field:"sendDateUtc",displayName:"Send Date",width:140,type:"date",cellFilter:"date:'short'"},{field:"numRecipients",displayName:"#Recip.",width:70},{field:"numAttachments",displayName:"#Attach.",width:80}],enableSorting:!0,enableHorizontalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableColumnMenus:!1,enablePaginationControls:!0,paginationPageSize:20,paginationPageSizes:[20],enableRowHeaderSelection:!1,onRegisterApi:e=>{(this.emailHistoryGridApi=e).selection.on.rowSelectionChanged(this.$rootScope,e=>{this.viewingRecentEmailBody=e.entity.messageBody}),HtmlUtil.uiGridFixScroll()}},this.refreshResidents().then(()=>this.loadSettings()).then(()=>{var e;"true"===this.appCacheService.getAndClear("goToEmailHistory")&&(document.getElementById("toggle-email-history-link").scrollIntoView(),this.toggleEmailHistoryVisible()),this.residentsGridApi&&window.localStorage[h.StoreKeyResidentGridState]&&(e=JSON.parse(window.localStorage[h.StoreKeyResidentGridState]))&&"object"==typeof e&&(this.residentsGridApi.saveState.restore(this,e),this.residentsGridApi.grid.clearAllFilters(!0,!0,!1),this.didLoadResidentGridState=!0),this.showPendingMembers&&this.loadPendingMembers()})}$onDestroy(){var e;this.shouldSaveResidentGridState&&(e=this.residentsGridApi.saveState.save(),window.localStorage[h.StoreKeyResidentGridState]=JSON.stringify(e))}getBoardPositionName(i){var e;return i&&(e=jQuery.grep(s.FellowResidentsService.BoardPositionNames,(e,t)=>e.id===i)[0])?e.name:""}selectPendingMember(e){this.pendingMemberGridApi.selection.clearSelectedRows();var t=new r;t.firstName=e.firstName,t.lastName=e.lastName,t.email=e.email,t.phoneNumber=e.phoneNumber,t.pendingMemberId=e.pendingMemberId,t.boardPosition=0,t.shouldSendWelcomeEmail=!1,this.setEdit(t)}closeViewingEmail(){this.viewingRecentEmailBody=null,this.emailHistoryGridApi.selection.clearSelectedRows()}setEdit(e){this.sentWelcomeEmail=!1,null===e?this.editUser=null:(this.selectedResidentDetailsView="Primary",this.editUserForm.$setPristine(),e=jQuery.extend({},e),this.editUser=e,this.editUser.showAdvancedHomePicker=!!this.allUnits&&20<this.allUnits.length,this.multiselectMulti="single","object"==typeof this.editUser.units&&(0<this.editUser.units.length&&(this.editUser.singleUnitId=this.editUser.units[0].unitId),1<this.editUser.units.length)&&(this.editUser.showAdvancedHomePicker=!0,this.multiselectMulti="multiple"),this.allUnits&&20<this.allUnits.length&&"single"===this.multiselectMulti&&-5!==this.allUnits[0].unitId&&((e=new s.Unit).name="None Selected",e.unitId=-5,this.allUnits.unshift(e)),_.each(this.allUnits,t=>{var e=void 0!==_.find(this.editUser.units,e=>e.unitId===t.unitId);t.isSelectedForEditUser=e}),this.editUser.postmarkReportedBadEmailUtc&&s.HtmlUtil2.isValidString(this.editUser.postmarkReportedBadEmailReason)&&(this.editUser.badEmailDate=this.editUser.postmarkReportedBadEmailUtc,"SpamComplaint"===this.editUser.postmarkReportedBadEmailReason||"SpamComplaint"===this.editUser.postmarkReportedBadEmailReason?this.editUser.friendlyBadEmailReason="SpamReport":"InactiveRecipient"===this.editUser.postmarkReportedBadEmailReason?this.editUser.friendlyBadEmailReason="Inactive":"HardBounce"===this.editUser.postmarkReportedBadEmailReason?this.editUser.friendlyBadEmailReason="Bounce":"FailedDuringSend"===this.editUser.postmarkReportedBadEmailReason?this.editUser.friendlyBadEmailReason="FailedSend":this.editUser.friendlyBadEmailReason=this.editUser.postmarkReportedBadEmailReason),this.residentsGridApi.selection.clearSelectedRows(),setTimeout("$( '#edit-user-first-text-box' ).focus();",100))}onSendWelcome(){this.isSavingUser=!0,this.$http.put("/api/Residents/"+this.editUser.userId+"/SendWelcome",null).then(()=>{this.isSavingUser=!1,this.sentWelcomeEmail=!0},()=>{this.isSavingUser=!1,alert("Failed to send the welcome email, please contact support if this problem persists.")})}populateGridUnitLabels(){_.each(this.residentGridOptions.data,e=>{var t=_.reduce(e.units,(e,t)=>0<e.length?e+","+t.name:t.name,""),i=_.reduce(e.units,(e,t)=>t.lotNumber?0<e.length?e+","+(t.lotNumber||""):t.lotNumber||"":e,"");e.unitGridLabel=t,e.lotNumberLabel=i})}refreshResidents(){return this.isLoading=!0,this.$http.get("/api/Residents").then(e=>{this.isLoading=!1;var t,e=e.data;e.forEach(e=>{e.addedDateUtc&&moment(e.addedDateUtc).isBefore(this.siteInfo.privateSiteInfo.creationDate)&&(e.addedDateUtc=this.siteInfo.privateSiteInfo.creationDate)}),this.residentGridOptions.data=e,this.residentGridOptions.minRowsToShow=e.length,this.residentGridOptions.virtualizationThreshold=e.length,this.residentGridOptions.enableFiltering=15<e.length,this.residentsGridApi.core.notifyDataChange(this.uiGridConstants.dataChange.COLUMN),this.hasOneAdmin=1===_.filter(e,e=>e.isSiteManager).length&&1<e.length,this.residentSortInfo&&(t=_.find(this.residentsGridApi.grid.columns,e=>e.field===this.residentSortInfo.field))&&this.residentsGridApi.grid.sortColumn(t,this.residentSortInfo.direction,!1),_.forEach(e,e=>{e.fullName=e.firstName+" "+e.lastName,"string"==typeof e.email&&-1!==e.email.indexOf("@condoally.com")&&(e.email=""),e.lastLoginDateUtc&&(e.lastLoginDateUtc=moment.utc(e.lastLoginDateUtc).toDate())}),this.populateGridUnitLabels(),!this.allUnits&&AppConfig.isChtnSite&&(this.isLoading=!0,this.$http.get("/api/Unit").then(e=>{this.isLoading=!1,this.allUnits=e.data,this.shouldSortUnitsNumerically=_.every(this.allUnits,e=>HtmlUtil.isNumericString(e.name)),this.shouldSortUnitsNumerically&&(this.allUnits=_.sortBy(this.allUnits,e=>parseFloat(e.name))),this.multiselectOptions=20<this.allUnits.length?"filter":"";e=moment(this.siteInfo.privateSiteInfo.creationDate).add(2,"months");this.showAddHomeLink=this.allUnits.length<3&&moment().isBefore(e)},()=>{this.isLoading=!1,alert("Failed to retrieve your association's home listing, please contact support.")}))})}loadPendingMembers(){this.isLoadingPending=!0,this.$http.get("/api/Member/Pending").then(e=>{this.isLoadingPending=!1,this.pendingMemberGridOptions.data=e.data,this.pendingMemberGridOptions.minRowsToShow=e.data.length,this.pendingMemberGridOptions.virtualizationThreshold=e.data.length},e=>{this.isLoadingPending=!1,console.log("Failed to load pending members: "+e.data.exceptionMessage)})}enableMultiHomePicker(){this.editUser&&(this.editUser.showAdvancedHomePicker=!0),this.multiselectMulti="multiple",this.allUnits&&0<this.allUnits.length&&null===this.allUnits[0].unitId&&this.allUnits.shift()}rejectPendingMember(){this.editUser.pendingMemberId&&confirm("Are you sure you want to remove this pending member? This action cannot be undone.")&&(this.isLoading=!1,this.$http.put("/api/Member/Pending/Deny/"+this.editUser.pendingMemberId,null).then(()=>{this.isLoading=!1,this.editUser=null,this.loadPendingMembers()},e=>{this.isLoading=!1,alert("Failed to reject pending member: "+e.data.exceptionMessage)}))}onSaveResident(){if(this.editUser&&($("#editUserForm").validate(),$("#editUserForm").valid())){var e=moment(this.editUser.addedDateUtc),t=moment().subtract(2,"weeks");if(e.isBefore(t)){e=this.residentGridOptions.data.find(e=>e.userId===this.editUser.userId);if(e.firstName!==this.editUser.firstName||e.email!==this.editUser.email)if(!confirm("You're editing a resident's information in a way that looks like you're actually trying to add a new resident to your group. It's VERY IMPORTANT that new residents are added via the 'Add Resident' button rather than edit an existing resident. Hit cancel if you're trying to add a new resident and we'll automatically pop-up a new window to add a resident with this data."))return(t=new r).shouldSendWelcomeEmail=!1,t.firstName=this.editUser.firstName,t.lastName=this.editUser.lastName,t.email=this.editUser.email,t.phoneNumber=this.editUser.phoneNumber,t.boardPosition=this.editUser.boardPosition,t.isRenter=this.editUser.isRenter,t.singleUnitId=this.editUser.singleUnitId,t.units=_.clone(this.editUser.units),t.units.forEach(e=>delete e.userId),t.showAdvancedHomePicker=this.editUser.showAdvancedHomePicker,void this.setEdit(t)}if(this.editUser.userId!==this.$rootScope.userInfo.userId||!this.siteInfo.userInfo.isSiteManager||this.editUser.isSiteManager||confirm("If you remove yourself as a site admin you won't be able to continue making changes. Are you sure you want to remove yourself as a site admin?")){this.editUser.showAdvancedHomePicker||(this.editUser.singleUnitId?this.editUser.units=[{unitId:this.editUser.singleUnitId,name:null,memberHomeId:null,userId:this.editUser.userId,isRenter:!1,lotNumber:null}]:this.editUser.units=[]);e=e=>{this.isSavingUser=!1,"string"==typeof e.data.errorMessage?alert("Failed to add resident: "+e.data.errorMessage):(this.editUser.pendingMemberId&&this.loadPendingMembers(),this.editUser=null,this.refreshResidents())};let i=!(this.isSavingUser=!0);t=e=>{this.isSavingUser=!1;let t=i?"Failed to add new resident":"Failed to update resident";e&&e.data&&e.data.exceptionMessage&&(t+=": "+e.data.exceptionMessage),alert(t)};(this.editUser.userId?(i=!1,analytics.track("editResident"),this.$http.put("/api/Residents/UpdateUser",this.editUser)):(i=!0,analytics.track("addNewResident"),this.$http.post("/api/Residents",this.editUser))).then(e,t),this.fellowResidents.clearResidentCache()}}}OnAdminSetPassword(){var e={userName:this.adminSetPass_Username,password:this.adminSetPass_Password};this.$http.post("/api/AdminHelper/SetPassword",e).then(e=>{this.adminSetPass_ResultMessage=e.data},e=>{alert("Failed to set password: "+e.data.exceptionMessage)})}loadSettings(){this.isLoadingSettings=!0,this.$http.get("/api/Settings").then(e=>{this.isLoadingSettings=!1,this.residentSettings=e.data,this.siteInfo.privateSiteInfo.rentersCanViewDocs=this.residentSettings.rentersCanViewDocs,this.siteInfo.privateSiteInfo.whoCanCreateDiscussionThreads=this.residentSettings.whoCanCreateDiscussionThreads},e=>{this.isLoadingSettings=!1,console.log("Failed to retrieve settings: "+e.data.exceptionMessage)})}exportResidentCsv(){"undefined"!=typeof analytics&&analytics.track("exportResidentCsv");var e=s.createCsvString(this.residentGridOptions.data,[{headerText:"First Name",fieldName:"firstName"},{headerText:"Last Name",fieldName:"lastName"},{headerText:"CellPhone",fieldName:"phoneNumber"},{headerText:"Email",fieldName:"email"},{headerText:"Unit",fieldName:"unitGridLabel"},{headerText:"Lot#",fieldName:"lotNumberLabel"},{headerText:"Is Renter",fieldName:"isRenter"},{headerText:"Is Admin",fieldName:"isSiteManager"},{headerText:"Board Position",fieldName:"boardPosition",dataMapper:e=>this.getBoardPositionName(e)},{headerText:"Alternate Mailing",fieldName:"mailingAddressObject",dataMapper:e=>e?e.recipientName?e.recipientName+" "+e.oneLiner:e.oneLiner:""},{headerText:"Alternate Phone",fieldName:"alternatePhoneNumber"},{headerText:"Manager Notes",fieldName:"managerNotes"},{headerText:"Last Login Date",fieldName:"lastLoginDateUtc",dataMapper:e=>e?moment(e).format("YYYY-MM-DD HH:mm:00"):"Has not logged-in"}]);s.HtmlUtil2.downloadCsv(e,"Residents.csv")}exportKansasPtaCsv(){if(this.siteInfo.privateSiteInfo.ptaUnitId){"undefined"!=typeof analytics&&analytics.track("exportKansasPtaCsv");for(const i of _.clone(this.residentGridOptions.data))i.Local_Unit=this.siteInfo.privateSiteInfo.ptaUnitId.toString(),i.Membership_Name=i.firstName&&"N/A"!==i.firstName?i.firstName:i.lastName,0!==i.boardPosition&&(i.Position=this.getBoardPositionName(i.boardPosition));var e="data:text/csv;charset=utf-8,"+s.createCsvString(this.residentGridOptions.data,[{headerText:"Local_Unit",fieldName:"Local_Unit"},{headerText:"First_Name",fieldName:"firstName"},{headerText:"Last_Name",fieldName:"lastName"},{headerText:"Number_of_Members",fieldName:"Number_of_Members"},{headerText:"Membership_Name",fieldName:"Membership_Name"},{headerText:"Name_Prefix",fieldName:"Name_Prefix"},{headerText:"Middle_Name",fieldName:"Middle_Name"},{headerText:"Name_Suffix",fieldName:"Name_Suffix"},{headerText:"Email",fieldName:"email"},{headerText:"Address_1",fieldName:"Address_1"},{headerText:"Address_2",fieldName:"Address_2"},{headerText:"Address_3",fieldName:"Address_3"},{headerText:"City",fieldName:"City"},{headerText:"State",fieldName:"State"},{headerText:"Zip",fieldName:"Zip"},{headerText:"Home_Telephone",fieldName:"phoneNumber"},{headerText:"Work_Telephone",fieldName:"Work_Telephone"},{headerText:"Mobile_Number",fieldName:"Mobile_Number"},{headerText:"Position",fieldName:"Position"},{headerText:"Begin_Date",fieldName:"Begin_Date"},{headerText:"End_Date",fieldName:"End_Date"},{headerText:"Second_Name",fieldName:"Second_Name"},{headerText:"Second_Email",fieldName:"Second_Email"},{headerText:"Teacher1",fieldName:"Teacher1"},{headerText:"Teacher2",fieldName:"Teacher2"},{headerText:"Teacher3",fieldName:"Teacher3"},{headerText:"Children_Names",fieldName:"Children_Names"}]),e=encodeURI(e);const t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download","pta-members.csv"),document.body.appendChild(t),t.click(),setTimeout(()=>document.body.removeChild(t),500)}else alert("You must first set your PTA unit ID in Manage -> Settings before you can export in this format.")}saveResidentSettings(){analytics.track("editResidentSettings"),this.isLoadingSettings=!0,this.$http.put("/api/Settings",this.residentSettings).then(()=>{this.isLoadingSettings=!1,this.fellowResidents.clearResidentCache(),this.siteInfo.privateSiteInfo.canHideContactInfo=this.residentSettings.canHideContactInfo,this.siteInfo.privateSiteInfo.isDiscussionEmailGroupEnabled=this.residentSettings.isDiscussionEmailGroupEnabled},()=>{this.isLoadingSettings=!1,alert("Failed to update settings, please try again or contact support.")})}onDeleteResident(){!confirm("Are you sure you want to remove this person from your building?")||this.siteInfo.userInfo.userId===this.editUser.userId&&!confirm("If you remove your own account you won't be able to login anymore. Are you still sure?")||(this.isSavingUser=!0,this.$http.delete("/api/Residents?userId="+this.editUser.userId).then(()=>{this.isSavingUser=!1,this.editUser=null,this.fellowResidents.clearResidentCache(),this.refreshResidents()},()=>{alert("Failed to remove the resident. Please let support know if this continues to happen."),this.isSavingUser=!1,this.editUser=null}))}onSendAllWelcome(){confirm("This will email all of the residents in your association. Do you want to proceed?")&&(this.isLoading=!0,this.$http.put("/api/Residents/UserAction?userId&action=launchsite",null).then(()=>{this.isLoading=!1,this.sentWelcomeEmail=!0,this.allEmailsSent=!0},()=>{this.isLoading=!1,alert("Failed to send welcome email, please contact support if this problem persists.")}))}parseBulkCsv(){var t=$.csv.toArrays(this.bulkImportCsv),i=(this.bulkImportRows=[],e=>{let t=(e=e||"").toLowerCase();return t=(t=(t=(t=(t=(t=(t=(t=t.replace(/0th /g,"0 ").replace(/1st /g,"1 ")).replace(/2nd /g,"2 ").replace(/3rd /g,"3 ")).replace(/4th /g,"4 ").replace(/5th /g,"5 ")).replace(/6th /g,"6 ").replace(/7th /g,"7 ")).replace(/8th /g,"8 ").replace(/9th /g,"9 ")).replace(/\./g,"").replace(/ /g,"")).replace(/street/g,"st").replace(/road/g,"rd").replace(/drive/g,"dr")).replace(/place/g,"pl").replace(/avenue/g,"ave")});if(this.allUnits)for(let e=0;e<this.allUnits.length;++e)this.allUnits[e].csvTestName=i(this.allUnits[e].name);for(let e=0;e<t.length;++e){for(var s,a,n=t[e];n.length<10;)n.push("");if("Address/Unit"!==n[0]||"Email"!==n[1]||"First Name"!==n[2]){for(let e=0;e<n.length;++e)HtmlUtil.isNullOrWhitespace(n[e])?n[e]=null:n[e]=n[e].trim();const o={unitName:n[0]||null,unitId:void 0,email:n[1],firstName:n[2],lastName:n[3],phoneNumber:n[4],isRenter:!HtmlUtil.isNullOrWhitespace(n[5]),isAdmin:!HtmlUtil.isNullOrWhitespace(n[6]),csvTestName:"",mailingAddress:n[7],alternatePhone:n[8],managerNotes:n[9],emailHasDupe:!1};HtmlUtil.isNullOrWhitespace(o.unitName)?o.unitId=null:(o.csvTestName=i(o.unitName),s=_.find(this.allUnits,e=>e.csvTestName===o.csvTestName),o.unitId=s?s.unitId:void 0);let e=null;o.firstName&&-1!==o.firstName.toLowerCase().indexOf(" & ")&&(o.firstName=o.firstName.replace(" & "," and  ")),o.firstName&&-1!==o.firstName.toLowerCase().indexOf(" and ")&&(e=_.clone(o),s=o.firstName.split(" and "),o.firstName=s[0],e.firstName=s[1],o.email&&-1!==o.email.indexOf(" / ")?(a=o.email.split(" / "),o.email=a[0],e.email=a[1]):e.email="",e.phoneNumber=""),this.bulkParseNormalizeNameCase&&(a=e=>e&&(1===e.length?e.toUpperCase():e.charAt(0).toUpperCase()+e.substring(1).toLowerCase()),o.firstName=a(o.firstName),o.lastName=a(o.lastName),e)&&(e.firstName=a(e.firstName),e.lastName=a(e.lastName)),this.bulkImportRows.push(o),e&&this.bulkImportRows.push(e)}}for(const r of this.bulkImportRows)r.emailHasDupe=r.email&&1<this.bulkImportRows.filter(e=>e.email===r.email).length}submitBulkRows(){this.isLoading=!0,this.$http.post("/api/Residents/BulkLoad",this.bulkImportRows,{timeout:6e5}).then(()=>{this.isLoading=!1,this.bulkImportRows=[new l],this.bulkImportCsv="",alert("Success"),this.refreshResidents()},()=>{this.isLoading=!1,alert("Bulk upload failed")})}addBulkRow(){var e={unitName:"",unitId:null,email:"",firstName:"",lastName:"",phoneNumber:"",isRenter:!1,isAdmin:!1,csvTestName:void 0,mailingAddress:"",alternatePhone:"",managerNotes:"",emailHasDupe:!1};if(this.allUnits&&0<this.bulkImportRows.length){const i=this.bulkImportRows[this.bulkImportRows.length-1].unitId;var t=_.findIndex(this.allUnits,e=>e.unitId===i);++t<this.allUnits.length&&(e.unitName=this.allUnits[t].name,e.unitId=this.allUnits[t].unitId)}this.bulkImportRows.push(e)}toggleEmailHistoryVisible(){this.showEmailHistory=!this.showEmailHistory,this.viewingRecentEmailBody=null,this.showEmailHistory&&!this.emailHistoryGridOptions.data&&(this.isLoadingSettings=!0,this.$http.get("/api/Email/RecentGroupEmails").then(e=>{this.isLoadingSettings=!1,this.emailHistoryGridOptions.data=e.data},e=>{this.isLoadingSettings=!1,alert("Failed to load emails: "+e.data.exceptionMessage)}))}loadMoreRecentEmails(){this.isLoadingSettings=!0;this.emailHistoryNumMonths+=6,this.emailHistorySinceDate=moment(this.emailHistorySinceDate).subtract(6,"months").toDate(),this.$http.get("/api/Email/RecentGroupEmails?sinceDateUtc="+this.emailHistorySinceDate.toISOString()).then(e=>{this.isLoadingSettings=!1,this.emailHistoryGridOptions.data=this.emailHistoryGridOptions.data.concat(e.data)},e=>{this.isLoadingSettings=!1,alert("Failed to load emails: "+e.data.exceptionMessage)})}resetResidentGridState(){window.localStorage.removeItem(h.StoreKeyResidentGridState),this.shouldSaveResidentGridState=!1,window.location.reload()}onAddNewMember(){var e=new r;e.boardPosition=0,e.shouldSendWelcomeEmail=!1,this.setEdit(e)}}h.$inject=["$http","$rootScope","fellowResidents","uiGridConstants","SiteInfo","appCacheService"],h.StoreKeyResidentGridState="AllyResGridState",s.ManageResidentsController=h}(Ally=Ally||{}),CA.angularApp.component("manageResidents",{templateUrl:"/ngApp/chtn/manager/manage-residents.html",controller:Ally.ManageResidentsController}),function(e){class t{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.$location=i,this.isLoading=!1,this.appShortName=AppConfig.appShortName}$onInit(){this.isLoading=!0,this.$http.get("/api/Association/GroupAmenities").then(e=>{this.isLoading=!1,this.groupAmenities=e.data},e=>{this.isLoading=!1,alert("Failed to retrieve amenity data: "+e.data.exceptionMessage)})}saveForm(){this.isLoading=!0,this.$http.put("/api/Association/GroupAmenities",this.groupAmenities).then(e=>{this.$location.path("/Home")},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})}}t.$inject=["$http","SiteInfo","$location"],e.GroupAmenitiesController=t}(Ally=Ally||{}),CA.angularApp.component("groupAmenities",{templateUrl:"/ngApp/chtn/manager/settings/group-amenities.html",controller:Ally.GroupAmenitiesController}),function(n){class e{constructor(e,t,i,s,a){this.$http=e,this.siteInfo=t,this.appCacheService=i,this.$timeout=s,this.$scope=a,this.settings=new n.ChtnSiteSettings,this.isLoading=!1,this.isLoadingUsage=!1,this.shouldShowPremiumPlanSection=!0,this.shouldShowPaymentForm=!1,this.stripeApi=null,this.stripeCardElement=null,this.isActivatingAnnual=!0,this.monthlyDisabled=!1,this.planExpirationColor="red",this.groupEmailChartData=[],this.groupEmailAverage=0,this.genInvoiceNumMonths=1,this.genInvoiceShouldIncludeWireInfo=!1,this.emailUsageChartData=[],this.emailUsageChartLabels=[],this.emailUsageChartOptions={},this.emailUsageAverageNumMonths=0,this.emailUsageAverageSent=0,this.showInvoiceSection=!1,this.paymentType="ach",this.shouldShowTrialNote=!1,this.shouldShowHomeSetupNote=!1,this.shouldShowPremiumPlanSection="condo"===AppConfig.appShortName||"hoa"===AppConfig.appShortName,this.homeNamePlural=AppConfig.homeName.toLowerCase()+"s",this.showInvoiceSection=t.userInfo.isAdmin;try{this.stripeApi=Stripe(StripeApiKey)}catch(e){console.log(e)}}$onInit(){this.monthlyDisabled=this.siteInfo.privateSiteInfo.numUnits<=10,this.refreshData(),this.showInvoiceSection&&this.$timeout(()=>this.$http.get("/api/DocumentLink/0").then(e=>this.viewPremiumInvoiceViewId=e.data.vid),250),this.shouldShowTrialNote=this.siteInfo.privateSiteInfo.isPremiumPlanActive&&moment().isBefore(moment(this.siteInfo.privateSiteInfo.creationDate).add(3,"months"));var e=moment().isBefore(moment(this.siteInfo.privateSiteInfo.creationDate).add(6,"months"));this.shouldShowHomeSetupNote=1===this.settings.premiumPlanCostDollars||this.settings.premiumPlanCostDollars<3&&e}cancelPremiumAutoRenew(){confirm("Are you sure?")&&(this.isLoading=!0,this.$http.put("/api/Settings/CancelPremium",null).then(()=>{this.isLoading=!1,this.settings.premiumPlanIsAutoRenewed=!1,this.shouldShowPaymentForm=!1,this.refreshData()},()=>{this.isLoading=!1,alert("Failed to cancel the premium plan. Refresh the page and try again or contact support if the problem persists.")}))}showStripeError(e){var t=document.getElementById("card-errors");HtmlUtil.isNullOrWhitespace(e)?t.textContent=null:t.textContent=e}initStripePayment(){var e=this.stripeApi.elements();this.stripeCardElement=e.create("card",{style:{base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}}}),this.stripeCardElement.mount("#stripe-card-element");this.stripeCardElement.on("change",e=>{e.error?this.showStripeError(e.error.message):this.showStripeError(null)})}submitCardToStripe(){return this.isLoading=!0,this.stripeApi.createPaymentMethod({type:"card",card:this.stripeCardElement}).then(e=>{e.error?(this.isLoading=!1,this.showStripeError(e.error.message)):(e={stripePaymentMethodId:e.paymentMethod.id,shouldPayAnnually:this.isActivatingAnnual},this.$http.put("/api/Settings/ActivatePremium",e).then(()=>{this.isLoading=!1,this.settings.premiumPlanIsAutoRenewed=!0,this.shouldShowPaymentForm=!1,this.refreshData()},e=>{this.isLoading=!1,alert("Failed to activate the premium plan. Refresh the page and try again or contact support if the problem persists: "+e.data.exceptionMessage)})),this.$scope.$apply()})}generateStripeInvoice(e,t){e=`PublicSettings/ViewPremiumInvoice?vid=${this.viewPremiumInvoiceViewId}&numMonths=${e}&shouldIncludeWireInfo=`+t;window.open(this.siteInfo.publicSiteInfo.baseApiUrl+e,"_blank"),this.$timeout(()=>{this.$http.get("/api/DocumentLink/0").then(e=>this.viewPremiumInvoiceViewId=e.data.vid)},1250)}activatePremiumRenewal(){this.shouldShowPaymentForm=!0,this.updateCheckoutDescription(),this.onPaymentTypeChange()}updateCheckoutDescription(){var e=moment(this.premiumPlanRenewDate).isBefore();let t;this.isActivatingAnnual?(t=11*this.settings.premiumPlanCostDollars,this.checkoutDescription="Once you click this button, you will be charged $"+t+" ",this.checkoutDescription+=e?" today and you will be charged annually on this date thereafter.":" on "+moment(this.premiumPlanRenewDate).format("dddd, MMMM Do YYYY")+" and you will be charged annually on that date thereafter."):(t=this.settings.premiumPlanCostDollars,this.checkoutDescription="Once you click this button, you will be charged $"+this.settings.premiumPlanCostDollars+" ",this.checkoutDescription+=e?" today and you will be charged monthly on this date thereafter.":" on "+moment(this.premiumPlanRenewDate).format("dddd, MMMM Do YYYY")+" and you will be charged monthly on that date thereafter."),this.payButtonText=e?"Pay $"+t:"Schedule Payment"}createSubscription(e){return fetch("/create-subscription",{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify({paymentMethodId:e})}).then(e=>e.json()).then(e=>{if(e.error)throw e;return e}).then(e=>({paymentMethodId:e.paymentMethodId,priceId:e.priceId,subscription:e.subscription})).catch(e=>{this.showStripeError(e)})}handlePaymentThatRequiresCustomerAction({subscription:t,invoice:i,priceId:s,paymentMethodId:a,isRetry:e}){var n;return(!t||"active"!==t.status)&&("requires_action"===(n=(i||t.latest_invoice).payment_intent).status||!0===e&&"requires_payment_method"===n.status)?this.stripeApi.confirmCardPayment(n.client_secret,{payment_method:a}).then(e=>{if(e.error)throw e;if("succeeded"===e.paymentIntent.status)return{priceId:s,subscription:t,invoice:i,paymentMethodId:a}}).catch(e=>{this.showStripeError(e)}):{subscription:t,priceId:s,paymentMethodId:a}}handleRequiresPaymentMethod({subscription:e,paymentMethodId:t,priceId:i}){if("active"!==e.status&&"requires_payment_method"===e.latest_invoice.payment_intent.status)throw localStorage.setItem("latestInvoiceId",e.latest_invoice.id),localStorage.setItem("latestInvoicePaymentIntentStatus",e.latest_invoice.payment_intent.status),{error:{message:"Your card was declined."}};return{subscription:e,priceId:i,paymentMethodId:t}}refreshMeteredUsage(){this.isLoadingUsage=!0,this.$http.get("/api/Settings/MeteredFeaturesUsage").then(t=>{this.isLoadingUsage=!1,this.meteredUsage=t.data,this.meteredUsage.months=_.sortBy(this.meteredUsage.months,e=>e.year.toString()+"_"+(9<e.month?"":"0")+e.month),this.emailUsageChartLabels=[];var i=[],s=[];let a=0,n=0;for(let e=0;e<t.data.months.length;++e){var o=t.data.months[e],r=moment([o.year,o.month-1,1]).format("MMMM");0===e||e===this.meteredUsage.months.length-1?this.emailUsageChartLabels.push(r+" "+o.year):this.emailUsageChartLabels.push(r),i.push(o.numEmailsSent),s.push(o.numGroupEmailsProcessed),a+=o.numEmailsSent,n+=o.numGroupEmailsProcessed}this.emailUsageChartData=[i],this.groupEmailChartData=[s],this.emailUsageAverageNumMonths=t.data.months.length,1<this.emailUsageAverageNumMonths&&(this.emailUsageAverageSent=Math.round(a/this.emailUsageAverageNumMonths),this.groupEmailAverage=Math.round(n/this.emailUsageAverageNumMonths))}),this.emailUsageChartOptions={scales:{yAxes:[{id:"y-axis-1",type:"linear",display:!0,position:"left",ticks:{suggestedMin:0,beginAtZero:!0}}]}}}refreshData(){this.isLoading=!0,this.$http.get("/api/Settings").then(e=>{this.isLoading=!1,this.settings=e.data,this.isPremiumPlanActive=this.siteInfo.privateSiteInfo.isPremiumPlanActive,this.premiumPlanRenewDate=new Date,this.premiumPlanRenewDate=moment(this.settings.premiumPlanExpirationDate).add(1,"days").toDate(),this.settings.premiumPlanIsAutoRenewed?(this.planExpirationColor="green",this.$http.get("/api/Settings/StripeBillingPortal").then(e=>this.stripePortalUrl=e.data.portalUrl)):(e=moment(this.settings.premiumPlanExpirationDate).add(-2,"months"),moment().isBefore(e)?this.planExpirationColor="green":this.planExpirationColor="red"),this.refreshMeteredUsage()})}goToEmailHistory(){return this.appCacheService.set("goToEmailHistory","true"),window.location.hash="#!/ManageResidents",!0}startPlaidAchConnection(){this.isLoading=!0,this.$http.get("/api/Plaid/StripeLinkToken").then(e=>{this.isLoading=!1,e.data?(e={token:e.data,onSuccess:(e,t)=>{console.log("Plaid StripeLinkToken onSuccess",t),this.completePlaidAchConnection(e,t.account_id)},onLoad:()=>{},onExit:(e,t)=>{console.log("update onExit.err",e,t)},onEvent:(e,t)=>{console.log("update onEvent.eventName",e,t)},receivedRedirectUri:null},Plaid.create(e).open()):alert("Failed to start Plaid connection. Please contact support.")},e=>{this.isLoading=!1,alert("Failed to start Plaid connection: "+e.data.exceptionMessage)})}completePlaidAchConnection(e,t){this.isLoading=!0,this.$http.post("/api/Plaid/ProcessStripeAccessToken",{accessToken:e,selectedAccountIds:[t]}).then(()=>{this.isLoading=!1,this.checkoutDescription="Account successfully linked, reloading...",window.location.reload()},e=>{this.isLoading=!1,alert("Failed to link account: "+e.data.exceptionMessage)})}makeAchStripePayment(){this.isLoading=!0;var e={shouldPayAnnually:this.isActivatingAnnual,payViaAch:!0};this.$http.put("/api/Settings/ActivatePremium",e).then(()=>{this.isLoading=!1,this.settings.premiumPlanIsAutoRenewed=!0,this.shouldShowPaymentForm=!1,this.refreshData()},e=>{this.isLoading=!1,alert("Failed to activate the premium plan. Refresh the page and try again or contact support if the problem persists: "+e.data.exceptionMessage)})}onPaymentTypeChange(){"creditCard"===this.paymentType&&this.$timeout(()=>this.initStripePayment(),250)}disconnectBankAccount(){this.isLoading=!0,this.$http.put("/api/Settings/ClearPremiumBankAccount",null).then(()=>{window.location.reload()},e=>{this.isLoading=!1,alert("Failed to disconnect bank account: "+e.data.exceptionMessage)})}completeStripeMicroDeposits(){this.isLoading=!0,this.$http.get("/api/Plaid/PremiumMicroDepositLinkToken").then(e=>{this.isLoading=!1;e=e.data;e?Plaid.create({token:e,onSuccess:(e,t)=>{console.log("Plaid micro-deposits update onSuccess"),this.completePlaidAchConnection(e,t.account_id)},onLoad:()=>{},onExit:(e,t)=>{console.log("onExit.err",e,t)},onEvent:(e,t)=>{console.log("onEvent.eventName",e,t)},receivedRedirectUri:null}).open():alert("Something went wrong on the server. Please contact support.")},e=>{this.isLoading=!1,alert("Failed to start verification: "+e.data.exceptionMessage)})}}e.$inject=["$http","SiteInfo","appCacheService","$timeout","$scope"],n.PremiumPlanSettingsController=e;n.GroupMonthEmails=class{}}(Ally=Ally||{}),CA.angularApp.component("premiumPlanSettings",{templateUrl:"/ngApp/chtn/manager/settings/premium-plan-settings.html",controller:Ally.PremiumPlanSettingsController});class MeteredFeaturesUsage{}!function(e){class t{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.$routeParams=i,this.shouldShowPremiumPlanSection=!0,this.selectedView=this.$routeParams.viewName||"SiteSettings",this.shouldShowPremiumPlanSection="condo"===AppConfig.appShortName||"hoa"===AppConfig.appShortName,this.shouldShowPremiumPlanSection||(this.selectedView="SiteSettings")}$onInit(){}}t.$inject=["$http","SiteInfo","$routeParams"],e.SettingsParentController=t}(Ally=Ally||{}),CA.angularApp.component("settingsParent",{templateUrl:"/ngApp/chtn/manager/settings/settings-parent.html",controller:Ally.SettingsParentController}),function(n){class e{constructor(e,t,i,s,a){this.$http=e,this.siteInfo=t,this.$rootScope=i,this.$timeout=s,this.$scope=a,this.isLoading=!1,this.siteDesignSettings=new n.SiteDesignSettings,this.isCustomLoaded=!1,this.headerBgType="classic",this.headerBgColor="#eee",this.isSaving=!1}$onInit(){this.siteInfo.publicSiteInfo.siteDesignSettingsJson?this.siteDesignSettings=JSON.parse(this.siteInfo.publicSiteInfo.siteDesignSettingsJson):this.siteDesignSettings=n.SiteDesignSettings.GetDefault(),this.previousChangeSiteDesignSettings={...this.siteDesignSettings},this.loginImageUrl=this.siteInfo.publicSiteInfo.loginImageUrl,this.$timeout(()=>this.hookUpLoginImageUpload(),200),this.$http.get("/api/Settings/GetSiteDesignSettings").then(e=>{this.isLoading=!1,this.isCustomLoaded=!0,this.customSiteDesignSettingsJson=e.data.customSiteDesignSettingsJson},e=>{this.isLoading=!1,alert("Failed to load custom settings: "+e.data.exceptionMessage)})}selectPreset(e){this.siteDesignSettings.presetTemplateName=e,this.siteDesignSettings="custom"!==e?n.SiteDesignSettings.GetPreset(e):JSON.parse(this.customSiteDesignSettingsJson),this.$rootScope.siteDesignSettings=this.siteDesignSettings,window.localStorage.setItem(n.SiteDesignSettings.SettingsCacheKey,JSON.stringify(this.siteDesignSettings)),this.siteDesignSettings.headerBg===n.SiteDesignSettings.HeaderBgClassic?this.headerBgType="classic":this.siteDesignSettings.headerBg===n.SiteDesignSettings.HeaderBgPink?this.headerBgType="pink":(this.headerBgType="color",this.headerBgColor=this.siteDesignSettings.headerBg),n.SiteDesignSettings.ApplySiteDesignSettings(this.siteDesignSettings),this.previousChangeSiteDesignSettings={...this.siteDesignSettings},this.saveSettings()}saveSettings(){this.isSaving=!0;const e={siteDesignSettingsJson:JSON.stringify(this.siteDesignSettings),customSiteDesignSettingsJson:this.customSiteDesignSettingsJson};this.$http.put("/api/Settings/UpdateSiteDesignSettings",e).then(()=>{this.isSaving=!1,this.siteInfo.publicSiteInfo.siteDesignSettingsJson=e.siteDesignSettingsJson},e=>{this.isSaving=!1,alert("Failed to save: "+e.data.exceptionMessage)})}removeLoginImage(){analytics.track("clearLoginImage"),this.isLoading=!0,this.$http.get("/api/Settings/ClearLoginImage").then(()=>{this.isLoading=!1,this.siteInfo.publicSiteInfo.loginImageUrl="",this.loginImageUrl=""},e=>{this.isLoading=!1,alert("Failed to remove loading image: "+e.data.exceptionMessage)})}hookUpLoginImageUpload(){$(()=>{$("#JQLoginImageFileUploader").fileupload({dropZone:null,pasteZone:null,autoUpload:!0,add:(e,t)=>{this.$scope.$apply(()=>{this.isLoading=!0}),analytics.track("setLoginImage"),$("#FileUploadProgressContainer").show(),t.url="api/DocumentUpload/LoginImage",this.siteInfo.publicSiteInfo.baseApiUrl&&(t.url=this.siteInfo.publicSiteInfo.baseApiUrl+"DocumentUpload/LoginImage");t=t.submit();t.done(e=>{this.$scope.$apply(()=>{this.isLoading=!1,this.loginImageUrl=e.newUrl+"?cacheBreaker="+(new Date).getTime(),this.siteInfo.publicSiteInfo.loginImageUrl=this.loginImageUrl}),$("#FileUploadProgressContainer").hide()}),t.error(e=>{alert("Upload failed: "+e.responseJSON.exceptionMessage),this.$scope.$apply(()=>this.isLoading=!1)})},beforeSend:e=>{this.siteInfo.publicSiteInfo.baseApiUrl?e.setRequestHeader("Authorization","Bearer "+this.$rootScope.authToken):e.setRequestHeader("ApiAuthToken",this.$rootScope.authToken)},progressall:(e,t)=>{t=Math.floor(100*t.loaded/t.total);$("#FileUploadProgressBar").css("width",t+"%"),100===t?$("#FileUploadProgressLabel").text("Finalizing Upload..."):$("#FileUploadProgressLabel").text(t+"%")},fail:(e,t)=>{}})})}onCustomSettingChanged(){"custom"!==this.previousChangeSiteDesignSettings.presetTemplateName&&this.customSiteDesignSettingsJson&&!confirm("You're about to create a new custom design that will overwrite you're previous custom design. Are you sure you want to make this change?")?(this.siteDesignSettings=this.previousChangeSiteDesignSettings,this.$rootScope.siteDesignSettings=this.siteDesignSettings):(this.siteDesignSettings.presetTemplateName="custom",console.log("In onCustomSettingChanged",this.siteDesignSettings),n.SiteDesignSettings.ApplySiteDesignSettings(this.siteDesignSettings),this.$rootScope.siteDesignSettings=this.siteDesignSettings,this.previousChangeSiteDesignSettings={...this.siteDesignSettings},this.customSiteDesignSettingsJson=JSON.stringify(this.siteDesignSettings),this.saveSettings())}onCustomHeaderBgChanged(){"classic"===this.headerBgType?(this.siteDesignSettings.headerBg=n.SiteDesignSettings.HeaderBgClassic,this.siteDesignSettings.headerBgSize="auto 100%"):("pink"===this.headerBgType?this.siteDesignSettings.headerBg=n.SiteDesignSettings.HeaderBgPink:this.siteDesignSettings.headerBg=this.headerBgColor,this.siteDesignSettings.headerBgSize="auto"),this.onCustomSettingChanged()}}e.$inject=["$http","SiteInfo","$rootScope","$timeout","$scope"],n.SiteDesignSettingsController=e}(Ally=Ally||{}),CA.angularApp.component("siteDesignSettings",{templateUrl:"/ngApp/chtn/manager/settings/site-design-settings.html",controller:Ally.SiteDesignSettingsController}),function(t){class e{}t.BaseSiteSettings=e;class a extends e{}t.ChtnSiteSettings=a;class i{constructor(e,t,i,s){this.$http=e,this.siteInfo=t,this.$scope=i,this.$rootScope=s,this.settings=new a,this.originalSettings=new a,this.isLoading=!1,this.showRightColumnSetting=!0,this.showLocalNewsSetting=!1,this.isPta=!1,this.shouldShowWelcomeTooLongError=!1,this.shouldShowLoginMoved=!1,this.tinyMceDidNotLoad=!1}$onInit(){this.frontEndVersion=appVer.toString(),this.defaultBGImage=$(document.documentElement).css("background-image"),this.shouldShowQaButton="president@mycondoally.com"===this.siteInfo.userInfo.emailAddress||"219eb985-613b-4fc0-a523-7474adb706bd"===this.siteInfo.userInfo.userId,this.showRightColumnSetting=this.siteInfo.privateSiteInfo.creationDate<t.SiteInfoService.AlwaysDiscussDate,this.showLocalNewsSetting=!this.showRightColumnSetting,this.isPta="pta"===AppConfig.appShortName,this.shouldShowLoginMoved=this.siteInfo.privateSiteInfo.creationDate<i.MovedLoginImageDate,this.refreshData()}refreshData(){this.isLoading=!0,this.$http.get("/api/Settings").then(e=>{this.isLoading=!1,this.settings=e.data,this.originalSettings=_.clone(e.data),this.tinyMceEditor||t.HtmlUtil2.initTinyMce("tiny-mce-editor",400,{menubar:"edit format table",toolbar:"styleselect | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link | checklist code formatpainter table"}).then(e=>{this.tinyMceEditor=e,this.tinyMceEditor?(this.settings.welcomeMessage&&this.tinyMceEditor.setContent(this.settings.welcomeMessage),this.tinyMceEditor.on("keyup",()=>{this.$scope.$apply(()=>{this.onWelcomeMessageEdit()})})):this.tinyMceDidNotLoad=!0})})}static isEmptyHtml(e){return!!HtmlUtil.isNullOrWhitespace(e)||(e=(e=(e=e.replaceAll("<p>","")).replaceAll("&nbsp;","")).replaceAll("</p>",""),HtmlUtil.isNullOrWhitespace(e))}saveAllSettings(){analytics.track("editSettings"),this.settings.welcomeMessage=this.tinyMceEditor.getContent(),this.isLoading=!0,this.$http.put("/api/Settings/UpdateSiteSettings",this.settings).then(()=>{this.isLoading=!1,this.siteInfo.privateSiteInfo.homeRightColumnType=this.settings.homeRightColumnType,this.siteInfo.privateSiteInfo.welcomeMessage=this.settings.welcomeMessage,i.isEmptyHtml(this.siteInfo.privateSiteInfo.welcomeMessage)&&(this.siteInfo.privateSiteInfo.welcomeMessage=null),this.siteInfo.privateSiteInfo.ptaUnitId=this.settings.ptaUnitId,this.settings.fullName!==this.originalSettings.fullName&&location.reload()},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})}onImageClick(e){this.settings.bgImageFileName=e,this.$http.put("/api/Settings/NOTUSED",{BGImageFileName:this.settings.bgImageFileName}).then(()=>{$(".test-bg-image").removeClass("test-bg-image-selected"),this.isLoading=!1},e=>{this.isLoading=!1,alert("Failed to save: "+e.data)})}onImageHoverOver(e){}onImageHoverOut(){}onQaDeleteSite(){this.$http.get("/api/QA/DeleteThisAssociation").then(function(){location.reload()},function(e){alert("Failed to delete site: "+e.data.exceptionMessage)})}forceRefresh(){window.location.reload()}onWelcomeMessageEdit(){var e=this.tinyMceEditor.getContent();this.shouldShowWelcomeTooLongError=1e4<e.length}}i.$inject=["$http","SiteInfo","$scope","$rootScope"],i.MovedLoginImageDate=new Date(2024,3,25),t.ChtnSettingsController=i}(Ally=Ally||{}),CA.angularApp.component("chtnSiteSettings",{templateUrl:"/ngApp/chtn/manager/settings/site-settings.html",controller:Ally.ChtnSettingsController}),function(e){class t{constructor(e,t){this.siteInfo=e,this.$routeParams=t,this.hideDocuments=!1,this.hideVendors=!1,this.showMaintenance=!1,this.showVendors=!0,this.faqMenuText="Info/FAQs","home"===AppConfig.appShortName&&(this.faqMenuText="Notes"),this.frontEndVersion=appVer.toString()}$onInit(){this.hideDocuments=this.siteInfo.userInfo.isRenter&&!this.siteInfo.privateSiteInfo.rentersCanViewDocs,this.hideVendors="neighborhood"===AppConfig.appShortName||"block-club"===AppConfig.appShortName,this.showMaintenance="home"===AppConfig.appShortName||"condo"===AppConfig.appShortName||"hoa"===AppConfig.appShortName,this.showVendors="pta"!==AppConfig.appShortName,this.hideDocuments?this.selectedView="Info":this.selectedView="Docs",HtmlUtil.isValidString(this.$routeParams.viewName)&&(this.selectedView=this.$routeParams.viewName)}forceRefresh(){window.location.reload()}}t.$inject=["SiteInfo","$routeParams"],e.AssociationInfoController=t}(Ally=Ally||{}),CA.condoAllyControllers.directive("contenteditable",["$sce",function(n){return{restrict:"A",require:"?ngModel",link:function(e,t,i,s){function a(){let e=t.html();i.stripBr&&"<br>"===e&&(e=""),s.$setViewValue(e)}s&&(s.$render=function(){t.html(n.getTrustedHtml(s.$viewValue||""))},t.on("blur keyup change",function(){e.$evalAsync(a)}),a())}}}]),CA.angularApp.filter("highlight",["$sce",function(i){return function(e,t){return e=e||"",t&&(e=e.replace(new RegExp("("+t+")","gi"),'<span class="fileSearchHighlight">$1</span>')),i.trustAsHtml(e)}}]),CA.angularApp.component("associationInfo",{templateUrl:"/ngApp/chtn/member/association-info.html",controller:Ally.AssociationInfoController}),function(i){class e{constructor(e,t,i,s,a,n,o){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.$timeout=s,this.$scope=a,this.$routeParams=n,this.$sce=o,this.showDiscussionThreads=!1,this.showLocalNews=!1,this.testPay_ShouldShow=!1,this.testPay_isValid=!1,this.shouldShowOwnerFinanceTxn=!1,this.userFirstName=""}$onInit(){this.testPay_ShouldShow=!1,this.testPay_ShouldShow&&(this.testPay_ReturnUrl=window.location.href,this.testPay_IpnUrl=this.siteInfo.publicSiteInfo.baseUrl+"/api/PayPalIpn",this.testPay_UserFirst=this.siteInfo.userInfo.firstName,this.testPay_UserLast=this.siteInfo.userInfo.lastName,this.testPay_Description="Assessment for "+this.siteInfo.publicSiteInfo.fullName),this.userFirstName=this.siteInfo.userInfo.firstName,this.welcomeMessage=this.siteInfo.privateSiteInfo.welcomeMessage,this.isWelcomeMessageHtml=this.welcomeMessage&&-1<this.welcomeMessage.indexOf("<"),this.isWelcomeMessageHtml&&(this.welcomeMessage=this.$sce.trustAsHtml(this.welcomeMessage),i.RichTextHelper.makeLinksOpenNewTab("welcome-message-panel")),this.canMakePayment=this.siteInfo.privateSiteInfo.isPaymentEnabled&&!this.siteInfo.userInfo.isRenter,this.shouldShowOwnerFinanceTxn=this.siteInfo.privateSiteInfo.shouldShowOwnerFinanceTxn&&!this.siteInfo.userInfo.isRenter,this.isFirstVisit=null===this.siteInfo.userInfo.lastLoginDateUtc,this.isSiteManager=this.siteInfo.userInfo.isSiteManager,this.showFirstVisitModal=this.isFirstVisit&&!this.$rootScope.hasClosedFirstVisitModal&&null===this.siteInfo.privateSiteInfo.siteLaunchedDateUtc,this.allyAppName=AppConfig.appName;var e=this.siteInfo.privateSiteInfo.homeRightColumnType||"",t=(this.siteInfo.privateSiteInfo.creationDate>i.SiteInfoService.AlwaysDiscussDate?this.showDiscussionThreads=!0:this.showDiscussionThreads=-1<e.indexOf("chatwall"),this.showLocalNews=-1<e.indexOf("localnews"),this.showDiscussionThreads&&this.$routeParams&&HtmlUtil.isNumericString(this.$routeParams.discussionThreadId)&&(this.autoOpenDiscussionThreadId=parseInt(this.$routeParams.discussionThreadId)),this);this.$scope.$on("homeHasActivePolls",()=>t.shouldShowAlertSection=!0),this.$http.get("/api/Committee/MyCommittees",{cache:!0}).then(e=>{this.usersCommittees=e.data,this.usersCommittees&&(this.usersCommittees=_.sortBy(this.usersCommittees,e=>e.name.toLowerCase()))}),"condo"!==AppConfig.appShortName&&"hoa"!==AppConfig.appShortName||this.$timeout(()=>this.checkForSurveys(),250)}checkForSurveys(){this.allySurvey=null,this.$http.get("/api/AllySurvey/AnySurvey").then(e=>{this.allySurvey=e.data},e=>{console.log("Failed to load ally survey",e.data.exceptionMessage)})}onTestPayAmtChange(){this.testPay_isValid=5<this.testPay_Amt&&this.testPay_Amt<5e3}hideFirstVisit(){this.$rootScope.hasClosedFirstVisitModal=!0,this.showFirstVisitModal=!1}}e.$inject=["$http","$rootScope","SiteInfo","$timeout","$scope","$routeParams","$sce"],i.ChtnHomeController=e}(Ally=Ally||{}),CA.angularApp.component("chtnHome",{templateUrl:"/ngApp/chtn/member/chtn-home.html",controller:Ally.ChtnHomeController}),function(e){class n{}class t{constructor(e,t,i,s,a){this.$scope=e,this.$timeout=t,this.$http=i,this.siteInfo=s,this.appCacheService=a,this.editingTip=new n,this.hoaHomes=[],this.tips=[],this.isLoading=!1}$onInit(){this.isSiteManager=this.siteInfo.userInfo.isSiteManager;var e=void 0,t=(this.siteInfo.privateSiteInfo.googleGpsPosition&&(e={bounds:new google.maps.Circle({center:this.siteInfo.privateSiteInfo.googleGpsPosition,radius:40234}).getBounds()}),document.getElementById("edit-location-address-text-box")),i=(this.addressAutocomplete=new google.maps.places.Autocomplete(t,e),this),i=(google.maps.event.addListener(this.addressAutocomplete,"place_changed",function(){var e=i.addressAutocomplete.getPlace();i.editingTip.address=e.formatted_address}),this.retrieveHoaHomes(),this);this.$timeout(()=>i.getWalkScore(),1e3),MapCtrlMapMgr.Init(this.siteInfo,this.$scope,this)}refresh(){this.isLoading=!0,this.$http.get("/api/WelcomeTip").then(e=>{this.tips=e.data,MapCtrlMapMgr.ClearAllMarkers(),"condo"===AppConfig.appShortName&&MapCtrlMapMgr.AddMarker(MapCtrlMapMgr._homeGpsPos.lat(),MapCtrlMapMgr._homeGpsPos.lng(),"Home",MapCtrlMapMgr.MarkerNumber_Home,null);for(var t=0;t<this.tips.length;++t){var i=this.tips[t];null!==i.gpsPos&&(i.markerIndex=MapCtrlMapMgr.AddMarker(i.gpsPos.lat,i.gpsPos.lon,i.name,i.markerNumber,null))}_.each(this.hoaHomes,t=>{var e,i;t.fullAddress&&t.fullAddress.gpsPos&&(e=MapCtrlMapMgr.MarkerNumber_Home,i=t.name,_.any(this.siteInfo.userInfo.usersUnits,e=>e.unitId===t.unitId)&&(e=MapCtrlMapMgr.MarkerNumber_MyHome,i="Your home: "+i),MapCtrlMapMgr.AddMarker(t.fullAddress.gpsPos.lat,t.fullAddress.gpsPos.lon,i,e,t.unitId))}),MapCtrlMapMgr.OnMarkersReady(),this.isLoading=!1})}onEditTip(e){this.editingTip=jQuery.extend({},e),window.scrollTo(0,document.body.scrollHeight)}onMoveMarker(e){MapCtrlMapMgr.SetMarkerDraggable(e.markerIndex,!0)}onDeleteTip(e){confirm("Are you sure you want to delete this item?")&&(this.isLoading=!0,this.$http.delete("/api/WelcomeTip/"+e.itemId).then(()=>{this.isLoading=!1,this.refresh()}))}onSaveTip(){var e,t;null!==this.editingTip&&(e=()=>{this.isLoading=!1,this.editingTip=new n,this.refresh()},t=e=>{this.isLoading=!1,alert("Failed to save item: "+e.data.exceptionMessage)},this.isLoading=!0,(this.editingTip.itemId?this.$http.put("/api/WelcomeTip",this.editingTip):this.$http.post("/api/WelcomeTip",this.editingTip)).then(e,t))}isLocationTip(e){return null!==e.gpsPos}isNotLocationTip(e){return null===e.gpsPos}getMarkerIconUrl(e){var t="/assets/images/MapMarkers/";return t=t+(1<=e&&e<=10?"green_"+e:-2===e?"MapMarker_Home":-3===e?"MapMarker_Hospital":-4===e?"MapMarker_PostOffice":"green_blank")+".png"}updateItemGpsLocation(t,e,i){var e={itemId:_.find(this.tips,function(e){return e.markerIndex===t}).itemId,newLat:e,newLon:i},s=(this.isLoading=!0,this);this.$http.put("/api/WelcomeTip/UpdateGpsLocation",e).then(function(){s.isLoading=!1})}getWalkScore(){function e(e){e&&e.data&&"Error"!==e.data?$("#WalkScorePanel").html(e.data):($("#WalkScorePanel").html("Failed to load Walk Score."),$("#WalkScorePanel").hide())}this.$http.get("/api/WelcomeTip/GetWalkScore").then(e,e)}retrieveHoaHomes(){this.$http.get("/api/BuildingResidents/FullUnits").then(e=>{var t;e.data&&("condo"===AppConfig.appShortName?(t=_.filter(e.data,e=>e.addressId&&!!e.fullAddress),0<(t=_.filter(t,e=>e.fullAddress.oneLiner!=this.siteInfo.privateSiteInfo.groupAddress.oneLiner)).length&&(this.hoaHomes=e.data)):"hoa"===AppConfig.appShortName&&(this.hoaHomes=e.data)),this.refresh()},()=>{this.refresh()})}}t.$inject=["$scope","$timeout","$http","SiteInfo","appCacheService"],e.ChtnMapController=t}(Ally=Ally||{}),CA.angularApp.component("chtnMap",{templateUrl:"/ngApp/chtn/member/chtn-map.html",controller:Ally.ChtnMapController});class MapCtrlMapMgr{static Init(e,t,i){MapCtrlMapMgr.ngScope=t,MapCtrlMapMgr.mapCtrl=i,"undefined"!=typeof google&&(MapCtrlMapMgr._homeGpsPos=e.privateSiteInfo.googleGpsPosition,MapCtrlMapMgr._groupGpsBounds=e.privateSiteInfo.gpsBounds,t={center:MapCtrlMapMgr._homeGpsPos,zoom:25,mapTypeId:google.maps.MapTypeId.ROADMAP},MapCtrlMapMgr._mainMap=new google.maps.Map(document.getElementById("map_canvas"),t),"condo"===AppConfig.appShortName&&MapCtrlMapMgr.AddMarker(MapCtrlMapMgr._homeGpsPos.lat(),MapCtrlMapMgr._homeGpsPos.lng(),"Home",MapCtrlMapMgr.MarkerNumber_Home,null),MapCtrlMapMgr.OnMapReady())}static OnMapReady(){MapCtrlMapMgr._isMapReady=!0,MapCtrlMapMgr._areMarkersReady&&MapCtrlMapMgr.OnMapAndMarkersReady()}static OnMarkersReady(){MapCtrlMapMgr._areMarkersReady=!0,MapCtrlMapMgr._isMapReady&&MapCtrlMapMgr.OnMapAndMarkersReady()}static OnMapAndMarkersReady(){for(var e,t=0;t<MapCtrlMapMgr._tempMarkers.length;++t){var i=MapCtrlMapMgr._tempMarkers[t],s=null,s=1<=i.markerNumber&&i.markerNumber<=10?"/assets/images/MapMarkers/green_"+i.markerNumber+".png":i.markerNumber===MapCtrlMapMgr.MarkerNumber_Home?"/assets/images/MapMarkers/MapMarker_Home.png":i.markerNumber===MapCtrlMapMgr.MarkerNumber_Hospital?"/assets/images/MapMarkers/MapMarker_Hospital.png":i.markerNumber===MapCtrlMapMgr.MarkerNumber_PostOffice?"/assets/images/MapMarkers/MapMarker_PostOffice.png":i.markerNumber===MapCtrlMapMgr.MarkerNumber_MyHome?"/assets/images/MapMarkers/MapMarker_MyHome.png":"/assets/images/MapMarkers/green_blank.png",s=new google.maps.Marker({position:new google.maps.LatLng(i.lat,i.lon),map:MapCtrlMapMgr._mainMap,animation:google.maps.Animation.DROP,title:i.name,icon:s});s.markerIndex=t,google.maps.event.addListener(s,"dragend",function(){var e=this,t=e.getPosition();MapCtrlMapMgr.ngScope.$apply(function(){MapCtrlMapMgr.mapCtrl.updateItemGpsLocation(e.markerIndex,t.lat(),t.lng())})}),i.unitId&&(s.unitId=i.unitId,s.addListener("click",function(e){return function(){MapCtrlMapMgr.mapCtrl.appCacheService.set("scrollToUnitId",e.unitId.toString()),window.location.hash="#!/BuildingResidents"}}(s))),MapCtrlMapMgr._markers.push(s)}MapCtrlMapMgr._tempMarkers=[],MapCtrlMapMgr._groupGpsBounds&&(e={paths:Ally.MapUtil.gpsBoundsToGooglePoly(MapCtrlMapMgr._groupGpsBounds),map:MapCtrlMapMgr._mainMap,strokeColor:"#0000FF",strokeOpacity:.5,strokeWeight:1,fillColor:"#0000FF",fillOpacity:.15,zIndex:-1},MapCtrlMapMgr._groupBoundsShape=new google.maps.Polygon(e)),MapCtrlMapMgr.ZoomMapToFitMarkers()}static ClearAllMarkers(){for(var e=0;e<MapCtrlMapMgr._markers.length;e++)MapCtrlMapMgr._markers[e].setMap(null);MapCtrlMapMgr._markers=[]}static SetMarkerDraggable(e,t){MapCtrlMapMgr._markers[e].setDraggable(t)}static AddMarker(e,t,i,s,a){return MapCtrlMapMgr._tempMarkers.push({lat:e,lon:t,name:i,markerNumber:s,unitId:a}),MapCtrlMapMgr._tempMarkers.length-1}static ZoomMapToFitMarkers(){for(var e=new google.maps.LatLngBounds,t=0;t<MapCtrlMapMgr._markers.length;++t)e.extend(MapCtrlMapMgr._markers[t].getPosition());if(MapCtrlMapMgr._groupBoundsShape)for(var i=MapCtrlMapMgr._groupBoundsShape.getPath(),s=0;s<i.getLength();++s)e.extend(i.getAt(s));MapCtrlMapMgr._mainMap.fitBounds(e)}}MapCtrlMapMgr._mainMap=null,MapCtrlMapMgr._homeGpsPos=null,MapCtrlMapMgr._groupGpsBounds=null,MapCtrlMapMgr._groupBoundsShape=null,MapCtrlMapMgr._markers=[],MapCtrlMapMgr.MarkerNumber_Home=-2,MapCtrlMapMgr.MarkerNumber_MyHome=-5,MapCtrlMapMgr.MarkerNumber_Hospital=-3,MapCtrlMapMgr.MarkerNumber_PostOffice=-4,MapCtrlMapMgr._isMapReady=!1,MapCtrlMapMgr._areMarkersReady=!1,MapCtrlMapMgr._tempMarkers=[],MapCtrlMapMgr.ngScope=null,MapCtrlMapMgr.mapCtrl=null,function(e){class t{constructor(e,t,i,s){this.$http=e,this.siteInfo=t,this.appCacheService=i,this.$routeParams=s,this.isLoading=!1,this.confirmationResultMessage="Loading...",this.isError=void 0}$onInit(){this.confirmChangeId()}confirmChangeId(){this.isLoading=!0,this.$http.put("/api/MyProfile/ConfirmEmailChange?emailChangeId="+this.$routeParams.emailChangeId,null).then(e=>{this.isLoading=!1,this.confirmationResultMessage="Email successfully updated.",this.isError=!1},e=>{this.isLoading=!1,this.isError=!0,e.data?this.confirmationResultMessage=e.data.exceptionMessage:this.confirmationResultMessage="Invalid URL, please check your email link again."})}}t.$inject=["$http","SiteInfo","appCacheService","$routeParams"],e.EmailChangeConfirmController=t}(Ally=Ally||{}),CA.angularApp.component("emailChangeConfirm",{templateUrl:"/ngApp/chtn/member/email-change-confirm.html",controller:Ally.EmailChangeConfirmController}),function(i){class e{constructor(e,t){this.$http=e,this.appCacheService=t,this.isLoading=!1,this.loginInfo=new i.LoginInfo,this.shouldHideControls=!1}$onInit(){this.loginInfo.emailAddress=this.appCacheService.getAndClear("forgotEmail")}onSubmitEmail(){this.isLoading=!0,this.$http.post("/api/Login/Forgot",this.loginInfo).then(()=>{this.shouldHideControls=!0,this.isLoading=!1,this.resultText="Please check your email for updated login information.",this.resultTextColor="#00F"},e=>{this.isLoading=!1,this.resultText="Failed to process your request: "+e.data.exceptionMessage,this.resultTextColor="#F00"})}}e.$inject=["$http","appCacheService"],i.ForgotPasswordController=e}(Ally=Ally||{}),CA.angularApp.component("forgotPassword",{templateUrl:"/ngApp/chtn/member/forgot-password.html",controller:Ally.ForgotPasswordController}),function(a){class s{constructor(e,t,i,s){this.fellowResidents=e,this.siteInfo=t,this.appCacheService=i,this.$http=s,this.isLoading=!0,this.isLoadingGroupEmails=!1,this.isLoadingSaveEmailGroup=!1,this.emailLists=[],this.customEmailList=[],this.unitPrefix="Unit ",this.groupEmailDomain="",this.shouldShowNewCustomEmailModal=!1,this.isPremiumPlanActive=!1,this.shouldShowQuickFilter=!1,this.quickFilterText="",this.allyAppName=AppConfig.appName,this.groupShortName=t.publicSiteInfo.shortName,this.showMemberList="neighborhood"===AppConfig.appShortName||"block-club"===AppConfig.appShortName||"pta"===AppConfig.appShortName,this.groupEmailDomain="inmail."+AppConfig.baseTld,this.unitPrefix="condo"===AppConfig.appShortName?"Unit ":""}$onInit(){this.isSiteManager=this.siteInfo.userInfo.isSiteManager,this.isPremiumPlanActive=this.siteInfo.privateSiteInfo.isPremiumPlanActive,AppConfig.isChtnSite&&(this.shouldShowQuickFilter=10<this.siteInfo.privateSiteInfo.numUnits),this.fellowResidents.getByUnitsAndResidents().then(e=>{this.isLoading=!1,this.allUnitList=e.byUnit,this.allResidents=e.residents,this.committees=e.committees,!this.allResidents&&e.ptaMembers&&(this.allResidents=e.ptaMembers),this.showMemberList?this.allResidents=_.sortBy(this.allResidents,e=>(e.lastName||"").toLowerCase()):this.allResidents=_.sortBy(this.allResidents,e=>(e.fullName||"").toLowerCase()),this.boardMembers=_.filter(this.allResidents,e=>e.boardPosition!==a.FellowResidentsService.BoardPos_None&&e.boardPosition!==a.FellowResidentsService.BoardPos_PropertyManager),this.boardPropMgrs=_.filter(this.allResidents,e=>e.boardPosition===a.FellowResidentsService.BoardPos_PropertyManager),this.boardMessageRecipient=null,0<this.boardMembers.length&&_.some(this.boardMembers,function(e){return e.hasEmail})&&(this.boardMessageRecipient={fullName:"Entire Board",firstName:"everyone on the board",hasEmail:!0,userId:s.AllBoardUserId}),"neighborhood"!==AppConfig.appShortName&&"block-club"!==AppConfig.appShortName||(this.allResidents=_.filter(this.allResidents,function(e){return 0===e.boardPosition}));for(let t=0;t<this.boardMembers.length;++t)this.boardMembers[t].boardPositionName=_.find(a.FellowResidentsService.BoardPositionNames,e=>e.id===this.boardMembers[t].boardPosition).name;this.boardPropMgrs.forEach(t=>t.boardPositionName=_.find(a.FellowResidentsService.BoardPositionNames,e=>e.id===t.boardPosition).name);const i=[1,64,16,2,4,8,32];this.boardMembers=_.sortBy(this.boardMembers,function(e){let t=_.indexOf(i,e.boardPosition);return t=-1===t?100:t});this.allOwners=_.reduce(this.allUnitList,function(e,t){return Array.prototype.push.apply(e,t.owners),e},[]),this.allOwners=_.map(_.groupBy(this.allOwners,function(e){return e.email}),function(e){return e[0]}),this.allOwnerEmails=_.reduce(this.allOwners,function(e,t){return HtmlUtil.isValidString(t.email)&&e.push(t.email),e},[]),this.allUnitList&&0<this.allUnitList.length&&(this.allUnitList=a.HtmlUtil2.smartSortStreetAddresses(this.allUnitList,"name")),this.filteredUnitList=this.allUnitList,this.committees&&(this.committees=_.sortBy(this.committees,e=>e.committeeName.toLowerCase()));e=this.appCacheService.getAndClear("scrollToUnitId");if(e){const t="unit-id-"+e;setTimeout(()=>{document.getElementById(t).scrollIntoView(),$("#"+t).effect("pulsate",{times:3},2e3)},300)}setTimeout(()=>this.loadGroupEmails(),500)},e=>{alert("Failed to retrieve group members. Please let tech support know via the contact form in the bottom right."),console.log("Failed to retrieve group members: "+e.data.exceptionMessage)})}updateMemberFilter(){(this.memberSearchTerm||"").toLowerCase()}loadGroupEmails(){this.hasMissingEmails=_.some(this.allResidents,function(e){return!e.hasEmail}),this.groupEmailsLoadError=null,this.isLoadingGroupEmails=!0,this.fellowResidents.getAllGroupEmails().then(e=>{if(this.isLoadingGroupEmails=!1,this.emailLists=e.standardGroups,this.customEmailList=e.customGroups,this.customEmailList)for(const i of this.customEmailList){i.usersFullNames=[];for(const s of i.members){var t=this.allResidents.find(e=>e.userId===s.userId);t&&i.usersFullNames.push(t.fullName)}}setTimeout(function(){var e=new ClipboardJS(".clipboard-button");e.on("success",function(e){a.HtmlUtil2.showTooltip(e.trigger,"Copied!"),e.clearSelection()}),e.on("error",function(e){a.HtmlUtil2.showTooltip(e.trigger,"Auto-copy failed, press CTRL+C now")})},750)},e=>{this.isLoadingGroupEmails=!1,this.groupEmailsLoadError="Failed to load group email addresses: "+e.data.exceptionMessage})}onAddNewCustomEmailGroup(){this.shouldShowNewCustomEmailModal=!0,this.editGroupEmailInfo=new t,this.allResidents.forEach(e=>e.isAssociated=!1),window.setTimeout(()=>document.getElementById("custom-group-email-short-name-text").focus(),50)}onGroupEmailMemberClicked(e){var t=this.editGroupEmailInfo.memberUserIds.indexOf(e.userId);-1===t?this.editGroupEmailInfo.memberUserIds.push(e.userId):this.editGroupEmailInfo.memberUserIds.splice(t,1)}saveCustomGroupEmailInfo(){this.isLoadingSaveEmailGroup=!0,this.groupEmailSaveError=null;var e=()=>{this.isLoadingSaveEmailGroup=!1,this.shouldShowNewCustomEmailModal=!1,this.editGroupEmailInfo=null,this.fellowResidents.clearResidentCache(),this.loadGroupEmails()},t=e=>{this.isLoadingSaveEmailGroup=!1,this.groupEmailSaveError="Failed to process your request: "+e.data.exceptionMessage};(this.editGroupEmailInfo.existingGroupEmailId?this.$http.put("/api/BuildingResidents/EditCustomGroupEmail",this.editGroupEmailInfo):this.$http.post("/api/BuildingResidents/NewCustomGroupEmail",this.editGroupEmailInfo)).then(e,t)}editCustomGroupEmail(e){this.shouldShowNewCustomEmailModal=!0,this.editGroupEmailInfo=new t,this.editGroupEmailInfo.existingGroupEmailId=e.customGroupEmailId,this.editGroupEmailInfo.description=e.description,this.editGroupEmailInfo.shortName=e.shortName,this.editGroupEmailInfo.memberUserIds=e.members.map(e=>e.userId),this.editGroupEmailInfo.allowPublicIncoming=e.allowPublicIncoming,this.allResidents.forEach(e=>e.isAssociated=-1!==this.editGroupEmailInfo.memberUserIds.indexOf(e.userId)),window.setTimeout(()=>document.getElementById("custom-group-email-short-name-text").focus(),50)}deleteGroupEmail(e){confirm("Are you sure you want to delete this group email address? Emails sent to this address will no longer be delivered.")&&(this.isLoadingGroupEmails=!0,this.$http.delete("/api/BuildingResidents/DeleteCustomGroupEmail/"+e.customGroupEmailId).then(()=>{this.isLoadingGroupEmails=!1,this.fellowResidents.clearResidentCache(),this.loadGroupEmails()},e=>{this.isLoadingGroupEmails=!1,this.groupEmailSaveError="Failed to process your request: "+e.data.exceptionMessage}))}onQuickFilterChange(){if(this.quickFilterText){const t=this.quickFilterText.toLowerCase();this.filteredUnitList=this.allUnitList.filter(e=>{return-1!==e.name.toLowerCase().indexOf(t)||!!(e.owners&&0<e.owners.length&&e.owners.filter(e=>!!e.fullName).map(e=>e.fullName.toLowerCase()).some(e=>-1!==e.indexOf(t)))||!!(e.renters&&0<e.renters.length&&e.renters.filter(e=>!!e.fullName).map(e=>e.fullName.toLowerCase()).some(e=>-1!==e.indexOf(t)))})}else this.filteredUnitList=this.allUnitList}}s.$inject=["fellowResidents","SiteInfo","appCacheService","$http"],s.AllBoardUserId="af615460-d92f-4878-9dfa-d5e4a9b1f488",a.GroupMembersController=s;class t{constructor(){this.memberUserIds=[]}}}(Ally=Ally||{}),CA.angularApp.component("groupMembers",{templateUrl:"/ngApp/chtn/member/group-members.html",controller:Ally.GroupMembersController}),function(e){class s{constructor(){this.emailAddress=""}}class t{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.$sce=i,this.sendInfo=new s,this.isLoading=!1,this.wasMessageSent=!1,this.isPageEnabled=null,this.shouldShowGroupNameField=!1,this.freshdeskFormUrl=null,this.numZohoChecks=0,this.onSendHelp=function(){$("#help-form").validate(),$("#help-form").valid()&&(this.isLoading=!0,this.$http.post("/api/Help",this.sendInfo).then(()=>{this.isLoading=!1,this.sendInfo={},this.sendInfo.clientUrl=window.location.href,this.wasMessageSent=!0,this.resultStyle.color="#00F",this.sendResult="Your message has been sent. We'll do our best to get back to you within 24 hours."},()=>{this.isLoading=!1,this.resultStyle.color="#F00",this.sendResult="Failed to send message."}))},this.resultStyle={"text-align":"center","font-size":"large","font-weight":"bold"}}$onInit(){this.$http.get("/api/PublicAllyAppSettings/IsHelpPageEnabled").then(e=>this.isPageEnabled=e.data,e=>{this.isPageEnabled=!0,console.log("Failed to get sign-up enabled status: "+e.data.exceptionMessage)}),this.freshdeskFormUrl="https://communityally.freshdesk.com/widgets/feedback_widget/new?&widgetType=embedded&submitTitle=Send+Message&submitThanks=Thank+you+for+your+message%2C+we'll+get+back+to+you+as+soon+as+possible.&searchArea=no",this.siteInfo.isLoggedIn&&(this.sendInfo.emailAddress=this.siteInfo.userInfo.emailAddress),this.freshdeskFormUrl=this.$sce.trustAsResourceUrl(this.freshdeskFormUrl),this.sendInfo.clientUrl=window.location.href,this.shouldShowGroupNameField="login"===HtmlUtil.getSubdomain(window.location.host)}prePopulateZohoForm(){console.log("In populateZohoForm This is me writing good thinks about time.");var e=document.getElementById("feedbNameTxtField");if(!e)return++this.numZohoChecks,5<this.numZohoChecks?void 0:void setTimeout(()=>this.prePopulateZohoForm(),250);HtmlUtil.isNullOrWhitespace(this.siteInfo.userInfo.fullName)||(e.value=this.siteInfo.userInfo.fullName,e.readOnly=!0,e.disabled=!0,e.style.setProperty("background-color","#eee","important")),this.siteInfo.userInfo.emailAddress&&((e=document.getElementById("feedbEmailTxtField")).value=this.siteInfo.userInfo.emailAddress,e.readOnly=!0,e.disabled=!0,e.style.setProperty("background-color","#eee","important"))}}t.$inject=["$http","SiteInfo","$sce"],e.HelpFormController=t}(Ally=Ally||{}),CA.angularApp.component("helpForm",{templateUrl:"/ngApp/chtn/member/help.html",controller:Ally.HelpFormController}),function(i){class o{constructor(e,t,i,s,a,n,o){this.$scope=e,this.$timeout=t,this.$http=i,this.$rootScope=s,this.$q=a,this.fellowResidents=n,this.siteInfo=o,this.showBadNotificationDateWarning=!1,this.isLoadingNews=!1,this.isLoadingLogbookForCalendar=!1,this.isLoadingPolls=!1,this.isLoadingCalendarEvents=!1,this.onlyRefreshCalendarEvents=!1,this.showExpandedCalendarEventModel=!1,this.currentTimeZoneAbbreviation="CT",this.localTimeZoneDiffersFromGroup=!1,this.descriptionText="",this.associatedGroups=[],this.canEditEvents=!1,this.GroupShortNameIndividuals="Individuals",this.clearViewEvent=function(){this.viewEvent=null}}getTimezoneAbbreviation(e=null){var t=moment();e=e||moment.tz.guess();t=t.tz(e).format("z");return"EST"===t||"EDT"===t?"ET":"CST"===t||"CDT"===t?"CT":"MST"===t||"MDT"===t?"MT":"PST"===t||"PDT"===t?"PT":t}$onInit(){this.currentTimeZoneAbbreviation=this.getTimezoneAbbreviation(),this.canEditEvents=this.siteInfo.userInfo.isSiteManager,this.siteInfo.privateSiteInfo.groupAddress&&this.siteInfo.privateSiteInfo.groupAddress.timeZoneIana&&(this.groupTimeZoneAbbreviation=this.getTimezoneAbbreviation(this.siteInfo.privateSiteInfo.groupAddress.timeZoneIana),this.groupTimeZoneAbbreviation!=this.currentTimeZoneAbbreviation)&&(this.localTimeZoneDiffersFromGroup=!0),AppConfig.isChtnSite&&this.fellowResidents.getResidents().then(e=>{this.residents=e,this.residents=_.sortBy(this.residents,e=>e.lastName)});const e={height:600,editable:!1,header:{left:"prevYear prev next nextYear today",center:"title",right:"month listYear"},viewRender:(e,t)=>{$(t).css("cursor","pointer")},dayClick:e=>{var t;this.$rootScope.isSiteManager&&(t=moment(moment.utc(e).format(o.DateFormat)).toDate(),this.$scope.$apply(()=>{this.setEditEvent({date:t,dateOnly:t,associatedUserIds:[],notificationEmailDaysBefore:null},!1)}))},eventClick:e=>{this.$scope.$apply(()=>{e.calendarEventObject?this.viewEvent=e.calendarEventObject:alert("This is an informational entry that does not have data to display")})},eventRender:(e,t)=>{$(t).qtip({style:{classes:"qtip-light qtip-shadow"},content:{text:e.fullDescription,title:e.toolTipTitle}})},eventSources:[{events:(e,t,i,s)=>{this.getAssociationEvents(e,t,i,s)}},{events:(e,t,i,s)=>{this.getCalendarEvents(e,t,i,s)}}]};$(document).ready(function(){$(".EditableEntry").editable("<%= Request.Url %>",{id:"EditEntryId",type:"textarea",cancel:"Cancel",submit:"Ok"}),$("#log-calendar").fullCalendar(e),$("#calendar-event-time").timepicker({scrollDefault:"10:00am"}),$(".fc-bg td.fc-today").append("<div class='today-note'>Today</div>")}),this.fellowResidents.getGroupEmailObject().then(e=>{this.associatedGroups=e.map(e=>{return{groupShortName:e.recipientType.toUpperCase()===i.FellowResidentsService.CustomRecipientType?"custom:"+e.recipientTypeName:e.recipientType,displayLabel:e.displayName,isAssociated:!1}}),this.associatedGroups.push({displayLabel:this.GroupShortNameIndividuals,groupShortName:this.GroupShortNameIndividuals,isAssociated:!1})})}getAllEvents(e,t){var i=AppConfig.isChtnSite,e=e.format(o.DateFormat),t=t.format(o.DateFormat);const s=this.$q.defer(),a=this.$q.defer(),n=this.$q.defer();return s.resolve(),a.resolve(),i?(this.isLoadingPolls=!0,this.$http.get("/api/Poll/DateRange?startDate="+e+"&endDate="+t).then(e=>{e=e.data;this.isLoadingPolls=!1,_.each(e,e=>{var t=e.text,i=(10<t.length&&(t=t.substring(0,10)+"..."),"Posted by: "+e.authorName+"<br><p>"+e.text+"</p>");this.calendarEvents.push({title:"Poll: "+t,start:moment(e.postDate).toDate(),calendarEventObject:null,toolTipTitle:"Poll Added",fullDescription:i,allDay:!1})}),n.resolve()},()=>{this.isLoadingPolls=!1,n.resolve()})):n.resolve(),this.$q.all([s.promise,a.promise,n.promise])}getAssociationEvents(e,t,i,s){this.onlyRefreshCalendarEvents?(this.onlyRefreshCalendarEvents=void 0,s(this.calendarEvents)):(this.calendarEvents=[],this.getAllEvents(e,t).then(()=>{s(this.calendarEvents)}))}getCalendarEvents(e,t,i,s){this.isLoadingCalendarEvents=!0;e=e.format(o.DateFormat),t=t.format(o.DateFormat);this.$http.get("/api/CalendarEvent?startDate="+e+"&endDate="+t).then(e=>{var n=[];this.isLoadingCalendarEvents=!1,_.each(e.data,e=>{var t=moment.utc(e.eventDateUtc),i=t.format(o.TimeFormat)==o.NoTime;let s;s=i?(e.timeOnly="",e.dateOnly=new Date(t.year(),t.month(),t.date()),new Date(t.year(),t.month(),t.date())):(t=moment.utc(e.eventDateUtc).local(),e.timeOnly=t.format(o.TimeFormat),e.dateOnly=t.clone().startOf("day").toDate(),t.toDate());var t=e.title,a=(t&&10<t.length&&(t=t.substring(0,10)+"..."),"Posted by: "+e.authorName+"<br><p>"+e.title+"</p>");n.push({title:t,start:s,toolTipTitle:"Event",fullDescription:a,calendarEventObject:e,allDay:i})}),s(n)},()=>{this.isLoadingCalendarEvents=!1})}onResidentClicked(e){e.hasEmail?_.contains(this.editEvent.associatedUserIds,e.userId)?this.editEvent.associatedUserIds=_.without(this.editEvent.associatedUserIds,e.userId):this.editEvent.associatedUserIds.push(e.userId):(alert("That user cannot be included because they do not have an email address on file."),e.isAssociated=!1)}isDateInPast(e){var e=moment(e),t=moment();return e.isBefore(t,"day")||e.isSame(t,"day")}onShouldSendChange(){this.editEvent.shouldSendNotification&&this.isDateInPast(this.editEvent.dateOnly)?this.editEvent.shouldSendNotification=!1:this.editEvent.notificationEmailDaysBefore||(this.editEvent.notificationEmailDaysBefore=1)}onChangeEmailDaysBefore(){var e=moment(this.editEvent.dateOnly).subtract(this.editEvent.notificationEmailDaysBefore,"day"),t=moment();this.showBadNotificationDateWarning=e.isBefore(t,"day")||e.isSame(t,"day"),this.showBadNotificationDateWarning&&(this.maxDaysBack=moment(this.editEvent.dateOnly).diff(t,"day"),this.editEvent.notificationEmailDaysBefore=this.maxDaysBack,this.$timeout(function(){this.showBadNotificationDateWarning=!1},1e4))}expandCalendarEventModel(){this.showExpandedCalendarEventModel=!0,this.hookUpWysiwyg()}hookUpWysiwyg(){this.$timeout(()=>{i.HtmlUtil2.initTinyMce("tiny-mce-editor",200,{menubar:!1,toolbar:"styleselect | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent link | code"}).then(e=>{this.tinyMceEditor=e,this.tinyMceEditor&&(this.editEvent&&this.editEvent.description?this.tinyMceEditor.setContent(this.editEvent.description):this.tinyMceEditor.setContent(""))})},100)}setEditEvent(e,t){this.showExpandedCalendarEventModel=t||!1,this.editEvent=e,this.viewEvent=null,this.showBadNotificationDateWarning=!1,this.editEvent&&(this.residents&&(this.residents.forEach(e=>e.isAssociated=!1),this.editEvent.associatedUserIds)&&this.residents.filter(e=>-1!==this.editEvent.associatedUserIds.indexOf(e.userId)).forEach(e=>e.isAssociated=!0),this.editEvent.associatedGroupShortNames?this.associatedGroups.forEach(e=>{e.isAssociated=-1!==this.editEvent.associatedGroupShortNames.indexOf(e.groupShortName)}):this.associatedGroups.forEach(e=>e.isAssociated=!1),this.editEvent.associatedGroupShortNames=this.associatedGroups.filter(e=>e.isAssociated).map(e=>e.groupShortName),this.editEvent.shouldSendNotification=null!==this.editEvent.notificationEmailDaysBefore,setTimeout(function(){$("#calendar-event-title").focus()},10),this.showExpandedCalendarEventModel)&&this.hookUpWysiwyg()}deleteCalendarEvent(e){confirm("Are you sure you want to remove this event?")&&(this.isLoadingCalendarEvents=!0,this.$http.delete("/api/CalendarEvent?eventId="+e).then(()=>{this.isLoadingCalendarEvents=!1,this.editEvent=null,this.onlyRefreshCalendarEvents=!0,$("#log-calendar").fullCalendar("refetchEvents")},()=>{this.isLoadingCalendarEvents=!1,alert("Failed to delete the calendar event.")}))}getDaysBeforeValue(){let e=null;return null!==this.editEvent.notificationEmailDaysBefore&&void 0!==this.editEvent.notificationEmailDaysBefore&&("string"==typeof this.editEvent.notificationEmailDaysBefore?(e=parseInt(this.editEvent.notificationEmailDaysBefore),isNaN(e)&&(e=null)):"number"==typeof this.editEvent.notificationEmailDaysBefore&&(e=this.editEvent.notificationEmailDaysBefore)),e=null!==e&&e<0?null:e}saveCalendarEvent(){if(i.HtmlUtil2.isValidString(this.editEvent.title)){if(this.tinyMceEditor&&(this.editEvent.description=this.tinyMceEditor.getContent()),this.editEvent.shouldSendNotification)if(null===this.getDaysBeforeValue())return void alert("Please enter a valid number for the 'days before' email send date");this.residents&&(t=_.filter(this.residents,function(e){return e.isAssociated}),this.editEvent.associatedUserIds=_.map(t,function(e){return e.userId}));var t="";"string"==typeof this.editEvent.timeOnly&&1<this.editEvent.timeOnly.length?(t=moment(this.editEvent.dateOnly).format(o.DateFormat)+" "+this.editEvent.timeOnly,this.editEvent.eventDateUtc=moment(t,o.DateFormat+" "+o.TimeFormat).utc().toDate()):(t=moment(this.editEvent.dateOnly).format(o.DateFormat)+" "+o.NoTime,this.editEvent.eventDateUtc=moment.utc(t,o.DateFormat+" "+o.TimeFormat).toDate()),this.editEvent.shouldSendNotification||(this.editEvent.notificationEmailDaysBefore=null),this.editEvent.associatedGroupShortNames=this.associatedGroups.filter(e=>e.isAssociated).map(e=>e.groupShortName);let e;e=this.editEvent.eventId?this.$http.put:this.$http.post,analytics.track("addCalendarEvent"),this.isLoadingCalendarEvents=!0,e("/api/CalendarEvent",this.editEvent).then(()=>{this.isLoadingCalendarEvents=!1,this.editEvent=null,this.onlyRefreshCalendarEvents=!0,$("#log-calendar").fullCalendar("refetchEvents")},e=>{this.isLoadingCalendarEvents=!1;e=e.data.exceptionMessage||e.data;alert("Failed to save the calendar event: "+e)})}else alert("Please enter a title in the 'what' field")}getNumSelectedIndividuals(){return this.residents.filter(e=>e.isAssociated).length}getNumSelectedGroups(){return this.associatedGroups.filter(e=>e.isAssociated).length}editViewingEvent(){this.setEditEvent(this.viewEvent,!0)}onIcsFileSelected(e){console.log("In onIcsFileSelected",e.target.files[0]);const t=new FormData,i=(t.append("IcsFile",e.target.files[0]),this.isLoadingCalendarEvents=!0,{headers:{"Content-Type":void 0}}),s=()=>{document.getElementById("ics-file-input").value=null},a=()=>{this.isLoadingCalendarEvents=!0,this.$http.post("/api/CalendarEvent/ImportIcs",t,i).then(e=>{this.isLoadingCalendarEvents=!1,s(),this.onlyRefreshCalendarEvents=!0,$("#log-calendar").fullCalendar("refetchEvents")},e=>{this.isLoadingCalendarEvents=!1,alert("Failed to import file: "+e.data.exceptionMessage),s()})};this.$http.post("/api/CalendarEvent/PreviewIcs",t,i).then(e=>{this.isLoadingCalendarEvents=!1,(confirm(e.data.resultMessage)?a:s)()},e=>{this.isLoadingCalendarEvents=!1,alert("Failed to parse file: "+e.data.exceptionMessage),s()})}}o.$inject=["$scope","$timeout","$http","$rootScope","$q","fellowResidents","SiteInfo"],o.DateFormat="YYYY-MM-DD",o.TimeFormat="h:mma",o.NoTime="12:37am",i.LogbookController=o}(Ally=Ally||{}),CA.angularApp.component("logbookPage",{templateUrl:"/ngApp/chtn/member/logbook.html",controller:Ally.LogbookController}),function(e){class o{constructor(){this.emailAddress="",this.password=""}}e.LoginInfo=o;class t{constructor(e,t,i,s,a,n){this.$http=e,this.$rootScope=t,this.$location=i,this.appCacheService=s,this.siteInfo=a,this.xdLocalStorage=n,this.isDemoSite=!1,this.loginInfo=new o,this.showNeedAccessModal=!1}$onInit(){HtmlUtil.isLocalStorageAllowed()||(this.loginResultMessage="You have cookies/local storage disabled. Condo Ally requires these features, please enable to continue. You may be in private browsing mode.");var e=navigator.userAgent.toLowerCase(),e=-1!=e.indexOf("msie")?parseInt(e.split("msie")[1]):0;0<e&&e<10&&(document.getElementById("bad-browser-panel").style.display="block"),this.isDemoSite="demosite"===HtmlUtil.getSubdomain(),"1"===HtmlUtil.GetQueryStringParameter("s")&&(this.isDemoSite=!1),this.loginImageUrl=this.siteInfo.publicSiteInfo.loginImageUrl,this.sectionStyle={position:"relative"},this.isDemoSite||(this.welcomeImageContainerStyle={"margin-bottom":"21px","max-width":"100%"},(e=window.localStorage.welcomeImage_width)&&"0"!=e&&!HtmlUtil.isNullOrWhitespace(this.loginImageUrl)&&(this.welcomeImageContainerStyle.width=e+"px",this.welcomeImageContainerStyle.height=window.localStorage.welcomeImage_height+"px"),HtmlUtil.isNullOrWhitespace(this.loginImageUrl)?this.sectionStyle["max-width"]="500px":this.sectionStyle["max-width"]="760px",this.sectionStyle["margin-left"]="auto",this.sectionStyle["margin-right"]="auto"),"true"===this.appCacheService.getAndClear(AppCacheService.Key_WasLoggedIn403)?this.$rootScope.isSiteManager?this.loginResultMessage="You are not authorized to perform that action. Please contact support.":this.loginResultMessage="You are not authorized to perform that action. Please contact an admin.":"true"===this.appCacheService.getAndClear(AppCacheService.Key_WasLoggedIn401)&&(this.loginResultMessage="Please login first."),setTimeout(function(){$("#login-email-textbox").focus()},200)}onWelcomeImageLoaded(){var e=document.getElementById("welcome-image");window.localStorage.welcomeImage_width=e.naturalWidth,window.localStorage.welcomeImage_height=e.naturalHeight,this.welcomeImageContainerStyle.width=e.naturalWidth+"px",this.welcomeImageContainerStyle.height="auto"}onWelcomeImageError(){console.log("Welcome image error"),window.localStorage.removeItem("welcomeImage_width"),window.localStorage.removeItem("welcomeImage_height")}onForgotPassword(){this.appCacheService.set("forgotEmail",this.loginInfo.emailAddress),this.$location.path("/ForgotPassword")}demoLogin(){this.loginInfo={emailAddress:"testuser",password:"demosite"},this.onLogin(null)}onLogin(e){e&&e.preventDefault(),this.isLoading=!0,this.$http.post("/api/Login",this.loginInfo).then(e=>{this.isLoading=!1;e=e.data;let t=this.appCacheService.getAndClear(AppCacheService.Key_AfterLoginRedirect);!t&&e.redirectUrl&&(t=e.redirectUrl),this.siteInfo.setAuthToken(e.authToken),this.rememberMe?(window.localStorage.rememberMe_Email=this.loginInfo.emailAddress,window.localStorage.rememberMe_Password=btoa(this.loginInfo.password)):(window.localStorage.rememberMe_Email=null,window.localStorage.rememberMe_Password=null),this.siteInfo.handleSiteInfo(e.siteInfo,this.$rootScope)||(!e.siteInfo.userInfo.acceptedTermsDate&&!this.isDemoSite?this.$location.path("/MyProfile"):(HtmlUtil.isValidString(t)||"/Login"===t||(t="/Home"),this.$location.path(t)))},e=>{this.isLoading=!1,this.loginResultMessage="Failed to log in: "+e.data.exceptionMessage})}}t.$inject=["$http","$rootScope","$location","appCacheService","SiteInfo","xdLocalStorage"],e.LoginController=t}(Ally=Ally||{}),CA.angularApp.component("loginPage",{templateUrl:"/ngApp/chtn/member/login.html",controller:Ally.LoginController}),function(e){class t{}e.SimpleUserEntry=t;class i extends t{}e.SimpleUserEntryWithTerms=i;e.PtaMember=class extends t{};class s{constructor(e,t,i,s,a,n){this.$rootScope=e,this.$http=t,this.$location=i,this.appCacheService=s,this.siteInfo=a,this.$scope=n,this.isResultMessageGood=!1,this.showPassword=!1,this.shouldShowPassword=!1,this.selectedProfileView="Primary",this.passwordComplexity="short",this.emailFlagsNonBoard=!0,this.emailFlagsDiscussion=!0}$onInit(){this.isDemoSite="demosite"===HtmlUtil.getSubdomain(),this.siteInfo.privateSiteInfo&&(this.canHideContactInfo=this.siteInfo.privateSiteInfo.canHideContactInfo),this.retrieveProfileData();setTimeout(()=>{$("#JQFileUploader").fileupload({dropZone:null,pasteZone:null,add:(e,t)=>{t.url="api/DocumentUpload/ProfileImage?ApiAuthToken="+this.siteInfo.authToken,this.siteInfo.publicSiteInfo.baseApiUrl&&(t.url=this.siteInfo.publicSiteInfo.baseApiUrl+"DocumentUpload/ProfileImage"),this.$scope.$apply(()=>this.isLoading=!0),t.submit().done(e=>{this.$scope.$apply(()=>{window.location.reload()})})},beforeSend:e=>{this.siteInfo.publicSiteInfo.baseApiUrl?e.setRequestHeader("Authorization","Bearer "+this.$rootScope.authToken):e.setRequestHeader("ApiAuthToken",this.$rootScope.authToken)},fail:(e,t)=>{this.$scope.$apply(()=>{this.isLoading=!1,alert("Upload Failed: "+t.jqXHR.responseJSON.exceptionMessage)})}})},500)}saveProfilePhoto(e){"upload"!==this.initialProfileImageType||confirm("Are you sure you want to change your profile image away from your uploaded photo? Your uploaded photo will be deleted.")?(this.isLoading=!0,this.$http.put("/api/MyProfile/ProfileImage?type="+e,null).then(()=>{this.isLoading=!1,this.initialProfileImageType=this.profileImageType},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})):this.profileImageType=this.initialProfileImageType}onShowPassword(){document.getElementById("passwordTextBox").type=this.shouldShowPassword?"text":"password"}retrieveProfileData(){this.isLoading=!0,this.$http.get("/api/MyProfile").then(e=>{this.isLoading=!1,this.profileInfo=e.data,this.initialProfileImageType="blank",this.profileInfo.avatarUrl&&-1===this.profileInfo.avatarUrl.indexOf("blank-headshot")?this.profileInfo.avatarUrl&&-1!==this.profileInfo.avatarUrl.indexOf("gravatar")?this.initialProfileImageType="gravatar":this.profileInfo.avatarUrl&&0<this.profileInfo.avatarUrl.length&&(this.initialProfileImageType="upload"):this.initialProfileImageType="blank","upload"!==this.initialProfileImageType&&(this.profileInfo.avatarUrl=null),this.profileImageType=this.initialProfileImageType,this.gravatarUrl="https://www.gravatar.com/avatar/"+md5((this.profileInfo.email||"").toLowerCase())+"?s=80&d=identicon",HtmlUtil.endsWith(this.profileInfo.email,"@condoally.com")&&(this.profileInfo.email=""),this.needsToAcceptTerms=null===this.profileInfo.acceptedTermsDate&&!this.isDemoSite,this.hasAcceptedTerms=!this.needsToAcceptTerms,this.$rootScope.shouldHideMenu=this.needsToAcceptTerms,this.emailFlagsNonBoard=2==(2&this.profileInfo.enabledEmailsFlags),this.emailFlagsDiscussion=4==(4&this.profileInfo.enabledEmailsFlags),this.saveButtonStyle={width:"100px","font-size":"1em"}})}onSaveInfo(){this.isLoading=!0,this.resultMessage="",this.$http.put("/api/MyProfile",this.profileInfo).then(e=>{this.isLoading=!1,this.profileInfo.password=null,this.isResultMessageGood=!0,this.resultMessage="Your changes have been saved.",e.data.failedToUpdateEmail?this.resultMessage="Profile changes have been saved, except we were unable to update your email address: "+e.data.failureDetails:e.data.emailUpdatedWasInitiated&&(this.profileInfo.pendingEmailAddress=this.profileInfo.email,this.resultMessage="Your changes have been saved. An email has been sent to confirm your email address change before it can take effect."),this.$rootScope.shouldHideMenu&&(this.$rootScope.shouldHideMenu=!1,this.$location.path("/Home"))},e=>{this.isLoading=!1,this.resultMessage=e.data.exceptionMessage,this.isResultMessageGood=!1,alert("Failed to save: "+e.data.exceptionMessage)})}onPasswordChange(){var e,t,i;!this.profileInfo.password||this.profileInfo.password.length<6?this.passwordComplexity="short":(i=!!this.profileInfo.password.match(/[a-z]+/i),e=!!this.profileInfo.password.match(/[0-9]+/),t=!!this.profileInfo.password.match(/[^a-z0-9]+/i),i=12<=this.profileInfo.password.length&&i&&e&&t,this.passwordComplexity=i?"complex":"simple")}onEmailFlagsChanged(){this.profileInfo.enabledEmailsFlags=1|(this.emailFlagsNonBoard?2:0)|(this.emailFlagsDiscussion?4:0)}}s.$inject=["$rootScope","$http","$location","appCacheService","SiteInfo","$scope"],e.MyProfileController=s}(Ally=Ally||{}),CA.angularApp.component("myProfile",{templateUrl:"/ngApp/chtn/member/my-profile.html",controller:Ally.MyProfileController}),function(e){class t{constructor(e,t,i,s){this.$scope=e,this.$http=t,this.$timeout=i,this.WizardHandler=s,this.unitNumberingType="Numbered",this.numUnits=3,this.placeWasSelected=!1,this.shouldCheckAddress=!1,this.shouldShowHoaMessage=!1,this.isLoading=!1,this.map=null,this.isLoadingMap=!1,this.hideWizard=!1,this.isPageEnabled=null,this.signUpInfo={buildings:[{units:[]}],signerUpInfo:{buildingIndex:0,boardPositionValue:"1"},recaptchaKey:""}}$onInit(){const t=e=>{this.isPageEnabled=e,this.$timeout(()=>this.initPage(),300)};this.$scope.$on("wizard:stepChanged",(e,t)=>{2===t.index&&this.$timeout(()=>grecaptcha.render("recaptcha-check-elem"),50)}),this.$http.get("/api/PublicAllyAppSettings/IsSignUpEnabled").then(e=>t(e.data),e=>{t(!0),console.log("Failed to get sign-up enabled status: "+e.data.exceptionMessage)})}onNumUnitsChanged(){if(this.numUnits){this.numUnits<1?this.numUnits=1:100<this.numUnits&&(this.numUnits=100);var t=this.numUnits-this.signUpInfo.buildings[0].units.length;if(this.signUpInfo.buildings[0].units.length=this.numUnits,0<t)for(let e=this.numUnits-t;e<this.numUnits;++e)this.signUpInfo.buildings[0].units[e]={name:this.getUnitName(e),residents:[{}]}}}onAssociationNameChanged(){this.signUpInfo&&this.signUpInfo.name?this.shouldShowHoaMessage=-1!==this.signUpInfo.name.toLowerCase().indexOf("hoa")||-1!==this.signUpInfo.name.toLowerCase().indexOf("home"):this.shouldShowHoaMessage=!1}addResident(e){e.residents||(e.residents=[]),e.residents.push({})}getUnitName(t){if("Numbered"===this.unitNumberingType)return(t+1).toString();if("Lettered"!==this.unitNumberingType)return"EW"===this.unitNumberingType||"NS"===this.unitNumberingType?t%2==0?(t/2+1).toString()+("EW"===this.unitNumberingType?"E":"N"):Math.ceil(t/2).toString()+("EW"===this.unitNumberingType?"W":"S"):(t+1).toString();{let e="";var i=Math.floor(t/26),i=(0<i&&(e+=String.fromCharCode("A".charCodeAt(0)+(i-1))),t%26);return e+=String.fromCharCode("A".charCodeAt(0)+i)}}onNumberingTypeChange(){for(let e=0;e<this.signUpInfo.buildings[0].units.length;++e)this.signUpInfo.buildings[0].units[e]||(this.signUpInfo.buildings[0].units[e]={}),this.signUpInfo.buildings[0].units[e].name=this.getUnitName(e)}centerMap(e){e.viewport?this.map.fitBounds(e.viewport):(this.map.setCenter(e.location),this.map.setZoom(17)),this.mapMarker.setPosition(e.location),this.mapMarker.setVisible(!0)}setPlaceWasSelected(){this.placeWasSelected=!0,this.shouldCheckAddress=!1,setTimeout(()=>this.placeWasSelected=!0,500)}initPage(){void 0!==window.analytics&&window.analytics.track("condoSignUpStarted",{category:"SignUp",label:"Started"});var e=document.getElementById("address-map"),e=(this.map=new google.maps.Map(e,{center:{lat:41.869638,lng:-87.657423},zoom:9}),document.getElementById("building-0-address-text-box"));this.addressAutocomplete=new google.maps.places.Autocomplete(e),this.addressAutocomplete.bindTo("bounds",this.map),this.mapMarker=new google.maps.Marker({map:this.map,position:null,anchorPoint:new google.maps.Point(41.969638,-87.657423),icon:"/assets/images/MapMarkers/MapMarker_Home.png"}),this.addressAutocomplete.addListener("place_changed",()=>{this.setPlaceWasSelected(),this.mapMarker.setVisible(!1);const e=this.addressAutocomplete.getPlace();let t=e.formatted_address;t.indexOf(", USA")===t.length-", USA".length&&(t=t.substring(0,t.length-", USA".length)),this.signUpInfo.buildings[0].streetAddress=t,HtmlUtil.isNullOrWhitespace(this.signUpInfo.name)&&this.$scope.$apply(()=>{this.signUpInfo.name=e.name+" Condo Association"}),e.geometry&&(this.centerMap(e.geometry),$("#association-name-text-box").focus())}),this.onNumUnitsChanged()}checkAddress(){!this.placeWasSelected&&this.shouldCheckAddress&&(this.shouldCheckAddress=!1,this.refreshMapForBuildingAddress())}refreshMapForBuildingAddress(){this.isLoadingMap=!0,HtmlUtil.geocodeAddress(this.signUpInfo.buildings[0].streetAddress,(i,e)=>{this.$scope.$apply(()=>{if(this.isLoadingMap=!1,e==google.maps.GeocoderStatus.OK){let e=i[0].formatted_address;var t;e.indexOf(", USA")===e.length-", USA".length&&(e=e.substring(0,e.length-", USA".length)),this.signUpInfo.buildings[0].streetAddress=e,this.centerMap(i[0].geometry),HtmlUtil.isNullOrWhitespace(this.signUpInfo.name)&&(t=HtmlUtil.getStringUpToFirst(e,","),this.signUpInfo.name=t+" Condo Association")}})})}addBuilding(){25<=this.signUpInfo.buildings.length+1?alert("We do not support more than 25 buildings."):this.signUpInfo.buildings.push({})}onFinishedWizard(){this.signUpInfo.recaptchaKey=grecaptcha.getResponse(),HtmlUtil.isNullOrWhitespace(this.signUpInfo.recaptchaKey)?alert("Please complete the reCAPTCHA field"):(this.isLoading=!0,this.$http.post("/api/SignUpWizard",this.signUpInfo).then(e=>{this.isLoading=!1;e=e.data;HtmlUtil.isNullOrWhitespace(e.errorMessage)?(void 0!==window.analytics&&window.analytics.track("condoSignUpComplete",{category:"SignUp",label:"Success"}),"object"==typeof window.fathom&&window.fathom.trackGoal("FIEMVITM",100*this.numUnits),HtmlUtil.isNullOrWhitespace(e.createUrl)?(this.hideWizard=!0,this.resultMessage="Great work! We just sent you an email with instructions on how access your new site."):window.location.href=e.createUrl):(alert("Failed to complete sign-up: "+e.errorMessage),this.WizardHandler.wizard().goTo(e.stepIndex),grecaptcha.reset())},e=>{this.isLoading=!1,alert("Failed to complete sign-up: "+e.data.exceptionMessage),grecaptcha.reset()}))}}t.$inject=["$scope","$http","$timeout","WizardHandler"],e.CondoSignUpWizardController=t}(Ally=Ally||{}),CA.angularApp.component("condoSignUpWizard",{templateUrl:"/ngApp/chtn/public/condo-sign-up-wizard.html",controller:Ally.CondoSignUpWizardController}),function(e){e.DiscussionThread=class{};class t{constructor(e,t){this.$http=e,this.$routeParams=t,this.isLoading=!1,this.activeView="loading"}$onInit(){this.unsubscribeUser()}loadDiscussion(){var e=decodeURIComponent(this.$routeParams.idValue),t=(this.isLoading=!0,this);this.$http.get("/Discussion/"+e).then(e=>{t.isLoading=!1,t.discussion=e.data},e=>{t.isLoading=!1,t.errorMessage="Failed to find the discussion details. Please contact support to alert them to the issue."})}unsubscribeUser(){var e=decodeURIComponent(this.$routeParams.idValue),t=(this.isLoading=!0,this.activeView="loading",this);this.$http.put("/api/Discussion/Unsubscribe/"+e,null).then(e=>{t.isLoading=!1,t.activeView="unsubscribed",t.discussion=e.data},e=>{t.isLoading=!1,t.activeView="error",t.errorMessage="Failed to unsubscribe you from the discussion due to a server error."})}resubscribeUser(){var e=decodeURIComponent(this.$routeParams.idValue),t=(this.isLoading=!0,this.activeView="loading",this);this.$http.put("/api/Discussion/Resubscribe/"+e,null).then(e=>{t.isLoading=!1,t.activeView="resubscribed"},e=>{t.isLoading=!1,t.activeView="error",t.errorMessage="Failed to unsubscribe you from the discussion due to a server error."})}}t.$inject=["$http","$routeParams"],e.DiscussionManageController=t}(Ally=Ally||{}),CA.angularApp.component("discussionManage",{templateUrl:"/ngApp/chtn/public/discussion-manage.html",controller:Ally.DiscussionManageController}),function(e){class t{constructor(e,t){this.$http=e,this.$routeParams=t,this.isLoading=!1,this.showButtons=!0}$onInit(){this.boardEmail=`board.${HtmlUtil.getSubdomain()}@inmail.`+AppConfig.baseTld}reportAbuse(e){"not-member"===e&&!confirm("You should reach out to the board rather than contact technical support. Click 'OK' to still proceed with contacting technical support anyway.")||(e={abuseReason:e,idVal:decodeURIComponent(this.$routeParams.idValue),otherReasonText:this.otherReasonText},this.isLoading=!0,this.$http.post("/api/EmailAbuse/v3",e).then(()=>{this.isLoading=!1,this.showButtons=!1}))}}t.$inject=["$http","$routeParams"],e.EmailAbuseController=t}(Ally=Ally||{}),CA.angularApp.component("emailAbuse",{templateUrl:"/ngApp/chtn/public/email-abuse.html",controller:Ally.EmailAbuseController}),function(a){class e{constructor(){this.boardPositionValue=1}}a.HoaSignerUpInfo=e;a.HoaSignUpInfo=class{constructor(){this.name="",this.streetAddress="",this.isResident=!0,this.signerUpInfo=new e,this.referralSource="",this.recaptchaKey=""}};class t{constructor(e,t,i,s){this.$scope=e,this.$http=t,this.$timeout=i,this.WizardHandler=s,this.placeWasSelected=!1,this.shouldCheckAddress=!1,this.isLoading=!1,this.shouldShowCondoMessage=!1,this.map=null,this.isLoadingMap=!1,this.hideWizard=!1,this.hoaPoly={vertices:[]},this.showMap=!1,this.didSignUpForHoaAlert=!1,this.isPageEnabled=null,this.signUpInfo=new a.HoaSignUpInfo}$onInit(){this.signUpInfo.referralSource=HtmlUtil.GetQueryStringParameter("utm_sourcecapterra"),HtmlUtil.isNullOrWhitespace(this.signUpInfo.referralSource)&&(this.signUpInfo.referralSource=null),this.$scope.$on("wizard:stepChanged",(e,t)=>{1===t.index?this.$timeout(()=>this.showMap=!0,50):2===t.index?this.$timeout(()=>grecaptcha.render("recaptcha-check-elem"),50):this.showMap=!1}),this.$http.get("/api/PublicAllyAppSettings/IsSignUpEnabled").then(e=>this.isPageEnabled=e.data,e=>{this.isPageEnabled=!0,console.log("Failed to get sign-up enabled status: "+e.data.exceptionMessage)})}onHoaNameChanged(){var e;this.signUpInfo&&this.signUpInfo.name?((e=-1!==this.signUpInfo.name.toLowerCase().indexOf("condo"))&&!this.shouldShowCondoMessage&&$("#suggestCondoMessageLabel").css("font-size","1.3em").css("margin","25px auto").addClass("alert alert-warning").fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeIn(200).fadeOut(200).fadeIn(200),this.shouldShowCondoMessage=e):this.shouldShowCondoMessage=!1}centerMap(e){e.viewport?this.map.fitBounds(e.viewport):(this.map.setCenter(e.location),this.map.setZoom(17)),this.mapMarker.setPosition(e.location),this.mapMarker.setVisible(!0)}initMapStep(){void 0!==window.analytics&&window.analytics.track("condoSignUpStarted"),this.showMap=!0;var e=document.getElementById("association-address-text-box");if(e&&(this.addressAutocomplete=new google.maps.places.Autocomplete(e),this.addressAutocomplete.bindTo("bounds",this.map)),this.mapMarker=new google.maps.Marker({map:this.map,position:null,anchorPoint:new google.maps.Point(41.969638,-87.657423),icon:"/assets/images/MapMarkers/MapMarker_Home.png"}),this.addressAutocomplete){const t=()=>{this.setPlaceWasSelected(),this.mapMarker.setVisible(!1);var e=this.addressAutocomplete.getPlace();let t=e.formatted_address;t.indexOf(", USA")===t.length-", USA".length&&(t=t.substring(0,t.length-", USA".length)),this.signUpInfo.streetAddress=t,e.geometry&&(this.setEditPolyForAddress(e.geometry.location),this.centerMap(e.geometry))};this.addressAutocomplete.addListener("place_changed",()=>{this.$scope.$apply(t)})}}onMapEditorReady(e){this.map=e,this.initMapStep()}checkAddress(){!this.placeWasSelected&&this.shouldCheckAddress&&(this.shouldCheckAddress=!1,this.refreshMapForAddress())}setPlaceWasSelected(){this.placeWasSelected=!0,this.shouldCheckAddress=!1,setTimeout(()=>{this.placeWasSelected=!0},500)}setEditPolyForAddress(e){var t=.0014;this.hoaPoly={vertices:[{lat:e.lat()-.001,lon:e.lng()-t},{lat:e.lat()+.001,lon:e.lng()-t},{lat:e.lat()+.001,lon:e.lng()+t},{lat:e.lat()-.001,lon:e.lng()+t}]}}refreshMapForAddress(){this.isLoadingMap=!0,HtmlUtil.geocodeAddress(this.signUpInfo.streetAddress,(t,e)=>{this.$scope.$apply(()=>{if(this.isLoadingMap=!1,e==google.maps.GeocoderStatus.OK){let e=t[0].formatted_address;e.indexOf(", USA")===e.length-", USA".length&&(e=e.substring(0,e.length-", USA".length)),this.signUpInfo.streetAddress=e,t[0].geometry&&(this.setEditPolyForAddress(t[0].geometry.location),this.centerMap(t[0].geometry))}})})}onFinishedWizard(){this.signUpInfo.recaptchaKey=grecaptcha.getResponse(),HtmlUtil.isNullOrWhitespace(this.signUpInfo.recaptchaKey)?alert("Please complete the reCAPTCHA field"):(this.isLoading=!0,this.signUpInfo.boundsGpsVertices=this.hoaPoly.vertices,this.$http.post("/api/SignUpWizard/Hoa",this.signUpInfo).then(e=>{this.isLoading=!1;const t=e.data;if(HtmlUtil.isNullOrWhitespace(t.errorMessage)){if(void 0!==window.analytics&&window.analytics.track("condoSignUpComplete"),void 0!==window.goog_report_conversion&&window.goog_report_conversion(),this.signUpInfo.referralSource&&void 0!==window.capterra_trackingListener_v2&&window.capterra_trackingListener_v2(),"object"==typeof window.fathom){let e=parseInt(this.signUpInfo.numHomes);isNaN(e)?e=0:e*=100,window.fathom.trackGoal("I6WZZSMM",e)}HtmlUtil.isNullOrWhitespace(t.createUrl)?(this.hideWizard=!0,this.resultMessage="Great work! We just sent you an email with instructions on how access your new site."):window.setTimeout(()=>window.location.href=t.createUrl,50)}else alert("Failed to complete sign-up: "+t.errorMessage),this.WizardHandler.wizard().goTo(t.stepIndex),grecaptcha.reset()},e=>{this.isLoading=!1,alert("Failed to complete sign-up: "+e.data.exceptionMessage),grecaptcha.reset()}))}submitEmailForHoaNotify(){HtmlUtil.isNullOrWhitespace(this.hoaAlertEmail)?alert("Please enter a valid email address"):(this.isLoading=!0,this.$http.get("/api/PublicEmail/SignUpForHoaAllyAlert?email="+encodeURIComponent(this.hoaAlertEmail)+"&numHomes="+encodeURIComponent(this.hoaAlertNumHomes)).then(e=>{this.isLoading=!1,this.didSignUpForHoaAlert=!0},e=>{this.isLoading=!1,alert("Failed to submit: "+e.data.exceptionMessage)}))}}t.$inject=["$scope","$http","$timeout","WizardHandler"],a.HoaSignUpWizardController=t}(Ally=Ally||{}),CA.angularApp.component("hoaSignUpWizard",{templateUrl:"/ngApp/chtn/public/hoa-sign-up-wizard.html",controller:Ally.HoaSignUpWizardController}),function(e){class i{}class t{constructor(e,t){this.$http=e,this.siteInfo=t,this.isLoading=!1,this.signUpInfo=new i,this.resultIsError=!1}$onInit(){setTimeout(()=>{var e=document.getElementById("address-text-box");new google.maps.places.Autocomplete(e,void 0)},750)}onSubmitInfo(){HtmlUtil.isNullOrWhitespace(this.signUpInfo.emailAddress)?alert("Please enter an email address"):(this.signUpInfo.requestFromUrl=window.location.href,this.isLoading=!0,this.$http.post("/api/NeighborSignUp/SignUpNewUser",this.signUpInfo).then(()=>{this.isLoading=!1,this.resultIsError=!1,this.resultMessage="Your information has been successfully submitted. Look for a welcome email soon."},()=>{this.isLoading=!1,this.resultIsError=!0,this.resultMessage="There was an error submitting your information. Please try again."}))}goBack(){this.resultMessage=null}}t.$inject=["$http"],e.NeighborSignUpController=t}(Ally=Ally||{}),CA.angularApp.component("neighborSignUp",{templateUrl:"/ngApp/chtn/public/neighbor-sign-up.html",controller:Ally.NeighborSignUpController}),function(a){class n{constructor(){this.fullName="",this.email="",this.address="",this.neighborhoodName="",this.notes=""}}class e{constructor(e,t,i,s){this.$scope=e,this.$http=t,this.$timeout=i,this.WizardHandler=s,this.placeWasSelected=!1,this.shouldCheckAddress=!1,this.isLoading=!1,this.map=null,this.isLoadingMap=!1,this.hideWizard=!1,this.hoaPoly={vertices:[]},this.showMap=!1,this.tempSignUpInfo=new n,this.signUpInfo=new a.HoaSignUpInfo}$onInit(){this.$scope.$on("wizard:stepChanged",(e,t)=>{1===t.index?this.$timeout(()=>this.showMap=!0,50):this.showMap=!1}),setTimeout(()=>{var e=document.getElementById("signUpAddress");e&&new google.maps.places.Autocomplete(e)},500)}onSubmitTempInfo(){this.isLoading=!0,this.$http.post("/api/SignUpWizard/TempNeighborhood",this.tempSignUpInfo).then(()=>{this.isLoading=!1,this.submitTempResult="Thank you for your submission. We'll be in touch shortly."},e=>{this.isLoading=!1,this.submitTempResult=`Submission failed: ${e.data.exceptionMessage}. Feel free to refresh the page to try again or use the contact form at the bottom of the Community Ally home page.`})}centerMap(e){e.viewport?this.map.fitBounds(e.viewport):(this.map.setCenter(e.location),this.map.setZoom(17)),this.mapMarker.setPosition(e.location),this.mapMarker.setVisible(!0)}initMapStep(){void 0!==window.analytics&&window.analytics.track("condoSignUpStarted"),this.showMap=!0;var e=document.getElementById("association-address-text-box");if(e&&(this.addressAutocomplete=new google.maps.places.Autocomplete(e),this.addressAutocomplete.bindTo("bounds",this.map)),this.mapMarker=new google.maps.Marker({map:this.map,position:null,anchorPoint:new google.maps.Point(41.969638,-87.657423),icon:"/assets/images/MapMarkers/MapMarker_Home.png"}),this.addressAutocomplete){const t=()=>{this.setPlaceWasSelected(),this.mapMarker.setVisible(!1);var e=this.addressAutocomplete.getPlace();let t=e.formatted_address;t.indexOf(", USA")===t.length-", USA".length&&(t=t.substring(0,t.length-", USA".length)),this.signUpInfo.streetAddress=t,e.geometry&&(this.setEditPolyForAddress(e.geometry.location),this.centerMap(e.geometry))};this.addressAutocomplete.addListener("place_changed",()=>{this.$scope.$apply(t)})}}onMapEditorReady(e){this.map=e,this.initMapStep()}checkAddress(){!this.placeWasSelected&&this.shouldCheckAddress&&(this.shouldCheckAddress=!1,this.refreshMapForAddress())}setPlaceWasSelected(){this.placeWasSelected=!0,this.shouldCheckAddress=!1,setTimeout(()=>{this.placeWasSelected=!0},500)}setEditPolyForAddress(e){var t=.0014;this.hoaPoly={vertices:[{lat:e.lat()-.001,lon:e.lng()-t},{lat:e.lat()+.001,lon:e.lng()-t},{lat:e.lat()+.001,lon:e.lng()+t},{lat:e.lat()-.001,lon:e.lng()+t}]}}refreshMapForAddress(){this.isLoadingMap=!0,HtmlUtil.geocodeAddress(this.signUpInfo.streetAddress,(t,e)=>{this.$scope.$apply(()=>{if(this.isLoadingMap=!1,e==google.maps.GeocoderStatus.OK){let e=t[0].formatted_address;e.indexOf(", USA")===e.length-", USA".length&&(e=e.substring(0,e.length-", USA".length)),this.signUpInfo.streetAddress=e,t[0].geometry&&(this.setEditPolyForAddress(t[0].geometry.location),this.centerMap(t[0].geometry))}})})}onFinishedWizard(){this.isLoading=!0,this.signUpInfo.boundsGpsVertices=this.hoaPoly.vertices,this.$http.post("/api/SignUpWizard/Hoa",this.signUpInfo).then(e=>{this.isLoading=!1;e=e.data;HtmlUtil.isNullOrWhitespace(e.errorMessage)?(void 0!==window.analytics&&window.analytics.track("condoSignUpComplete"),void 0!==window.goog_report_conversion&&window.goog_report_conversion(),HtmlUtil.isNullOrWhitespace(e.createUrl)?(this.hideWizard=!0,this.resultMessage="Great work! We just sent you an email with instructions on how access your new site."):window.location.href=e.createUrl):(alert("Failed to complete sign-up: "+e.errorMessage),this.WizardHandler.wizard().goTo(e.stepIndex))},e=>{this.isLoading=!1,alert("Failed to complete sign-up: "+e.data.exceptionMessage)})}}e.$inject=["$scope","$http","$timeout","WizardHandler"],a.NeighborhoodSignUpWizardController=e}(Ally=Ally||{}),CA.angularApp.component("neighborhoodSignUpWizard",{templateUrl:"/ngApp/chtn/public/neighborhood-sign-up-wizard.html",controller:Ally.NeighborhoodSignUpWizardController}),function(e){class n{}class t{constructor(e,t,i,s,a){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.$timeout=s,this.appCacheService=a,this.isLoading=!1,this.signUpInfo=new n,this.showInputForm=!0,this.showSchoolField=!1}$onInit(){this.groupName=this.siteInfo.publicSiteInfo.fullName,this.showSchoolField="pta"===AppConfig.appShortName,window.setTimeout(()=>this.hookupAddressAutocomplete(),300),this.$timeout(()=>grecaptcha.render("recaptcha-check-elem"),100)}hookupAddressAutocomplete(){var e=document.getElementById("member-home-address-text-box"),t=(this.addressAutocomplete=new google.maps.places.Autocomplete(e,void 0),this);google.maps.event.addListener(this.addressAutocomplete,"place_changed",function(){var e=t.addressAutocomplete.getPlace();t.signUpInfo.streetAddress=e.formatted_address})}submitInfo(){this.signUpInfo.recaptchaKey=grecaptcha.getResponse(),HtmlUtil.isNullOrWhitespace(this.signUpInfo.recaptchaKey)?this.errorMessage="Please complete the reCAPTCHA field":(this.isLoading=!0,this.errorMessage=null,this.$http.post("/api/PublicPendingUser",this.signUpInfo).then(e=>{this.isLoading=!1,this.showInputForm=!1},e=>{this.isLoading=!1,this.errorMessage="Failed to submit: "+e.data.exceptionMessage}))}}t.$inject=["$http","$rootScope","SiteInfo","$timeout","appCacheService"],e.PendingMemberSignUpController=t}(Ally=Ally||{}),CA.angularApp.component("pendingMemberSignUp",{templateUrl:"/ngApp/chtn/public/pending-member-sign-up.html",controller:Ally.PendingMemberSignUpController}),function(e){class t{constructor(e,t,i){this.siteInfo=e,this.fellowResidents=t,this.$routeParams=i,this.canManage=!1}$onInit(){this.canManage=this.siteInfo.userInfo.isAdmin||this.siteInfo.userInfo.isSiteManager,this.committee&&!this.canManage&&this.fellowResidents.isCommitteeMember(this.committee.committeeId).then(e=>this.canManage=e),this.$routeParams&&HtmlUtil.isNumericString(this.$routeParams.discussionThreadId)&&(this.autoOpenDiscussionThreadId=parseInt(this.$routeParams.discussionThreadId))}}t.$inject=["SiteInfo","fellowResidents","$routeParams"],e.CommitteeHomeController=t}(Ally=Ally||{}),CA.angularApp.component("committeeHome",{bindings:{committee:"<"},templateUrl:"/ngApp/committee/committee-home.html",controller:Ally.CommitteeHomeController}),function(e){class t{constructor(e,t,i,s){this.$http=e,this.fellowResidents=t,this.$cacheFactory=i,this.siteInfo=s,this.isLoading=!1,this.canManage=!1}$onInit(){this.populateAllMembers()}populateAllMembers(){this.isLoading=!0,this.fellowResidents.getResidents().then(e=>{this.allGroupMembers=e,this.getMembers()})}setContactMember(){this.isLoading=!0,this.$http.put(`/api/Committee/${this.committee.committeeId}/SetContactMember?userId=`+this.contactUser.userId,null).then(e=>{this.isLoading=!1,this.committee.contactMemberUserId=this.contactUser.userId,this.$cacheFactory.get("$http").remove("/api/Committee/"+this.committee.committeeId),this.fellowResidents.clearResidentCache()},e=>{this.isLoading=!1,alert("Failed to set contact member: "+e.data.exceptionMessage)})}getMembers(){this.isLoading=!0,this.fellowResidents.getCommitteeMembers(this.committee.committeeId).then(e=>{this.isLoading=!1,this.members=e,this.members=_.sortBy(this.members,e=>(e.fullName||"").toLowerCase());var t=t=>_.some(this.members,e=>e.userId===t.userId);this.filteredGroupMembers=_.filter(this.allGroupMembers,e=>!t(e)),this.filteredGroupMembers=_.sortBy(this.filteredGroupMembers,e=>(e.fullName||"").toLowerCase()),this.contactUser=_.find(this.members,e=>e.userId==this.committee.contactMemberUserId),this.canManage=this.siteInfo.userInfo.isAdmin||this.siteInfo.userInfo.isSiteManager||_.any(this.members,e=>e.userId===this.siteInfo.userInfo.userId)},e=>{this.isLoading=!1,alert("Failed to retrieve committee members, please refresh the page to try again")})}addSelectedMember(){this.userForAdd&&(this.isLoading=!0,this.$http.put(`/api/Committee/${this.committee.committeeId}/AddMember?userId=`+this.userForAdd.userId,null).then(e=>{this.isLoading=!1,this.getMembers()},e=>{this.isLoading=!1,alert("Failed to add member, please refresh the page to try again: "+e.data.exceptionMessage)}))}removeMember(e){confirm("Are you sure you want to remove this person from this committee?")&&(this.isLoading=!0,this.$http.put(`/api/Committee/${this.committee.committeeId}/RemoveMember?userId=`+e.userId,null).then(e=>{this.isLoading=!1,this.getMembers()},e=>{this.isLoading=!1,alert("Failed to remove member, please refresh the page to try again: "+e.data.exceptionMessage)}))}}t.$inject=["$http","fellowResidents","$cacheFactory","SiteInfo"],e.CommitteeMembersController=t}(Ally=Ally||{}),CA.angularApp.component("committeeMembers",{bindings:{committee:"<"},templateUrl:"/ngApp/committee/committee-members.html",controller:Ally.CommitteeMembersController}),function(e){class t{constructor(e,t,i,s,a){this.$http=e,this.siteInfo=t,this.$routeParams=i,this.$cacheFactory=s,this.$rootScope=a,this.canManage=!1,this.initialView="Home",this.selectedView=null,this.isLoading=!1,this.committeeId=this.$routeParams.committeeId,this.initialView=this.$routeParams.viewName||"Home"}$onInit(){this.canManage=this.siteInfo.userInfo.isAdmin||this.siteInfo.userInfo.isSiteManager,this.retrieveCommittee()}retrieveCommittee(){this.isLoading=!0,this.$rootScope.dontHandle403=!0,this.$http.get("/api/Committee/"+this.committeeId,{cache:!0}).then(e=>{this.$rootScope.dontHandle403=!1,this.isLoading=!1,this.committee=e.data,this.selectedView=this.initialView},e=>{this.$rootScope.dontHandle403=!1,this.isLoading=!1,403===e.status?(alert("You are not authorized to view this private committee. You must be a member of the committee to view its contents. Reach out to a board member to inquire about joining the committiee."),window.location.href="/#!/Home"):alert("Failed to load committee: "+e.data.exceptionMessage)})}onUpdateCommitteeName(){this.isLoading=!0;var e="/api/Committee/"+this.committeeId+"?name="+this.committee.name;this.$http.put(e,null).then(()=>{this.isLoading=!1,this.$cacheFactory.get("$http").remove("/api/Committee/"+this.committeeId)},e=>{this.isLoading=!1,alert("Failed to update the committee name: "+e.data.exceptionMessage)})}}t.$inject=["$http","SiteInfo","$routeParams","$cacheFactory","$rootScope"],e.CommitteeParentController=t}(Ally=Ally||{}),CA.angularApp.component("committeeParent",{templateUrl:"/ngApp/committee/committee-parent.html",controller:Ally.CommitteeParentController}),function(a){class e{constructor(e,t,i,s){this.$http=e,this.siteInfo=t,this.$timeout=i,this.$rootScope=s,this.isLoading=!1,this.multiSelectWriteInPlaceholder=new a.PollAnswer("write-in")}$onInit(){this.refreshPolls()}populatePollData(e){(this.polls=e)&&0<e.length&&this.$rootScope.$broadcast("homeHasActivePolls");for(let e=0;e<this.polls.length;++e){var t,i=this.polls[e];i.hasUsersUnitVoted&&i.canViewResults&&(t=a.FellowResidentsService.pollReponsesToChart(i,this.siteInfo),i.chartData=t.chartData,i.chartLabels=t.chartLabels)}}refreshPolls(){this.isLoading=!0,this.$http.get("/api/Poll?getActive=1").then(e=>{this.isLoading=!1,this.$timeout(()=>this.populatePollData(e.data),100)},()=>{this.isLoading=!1})}onPollAnswer(e,t){this.isLoading=!0;var t=t?t.pollAnswerId.toString():"",i=e.writeInAnswer?encodeURIComponent(e.writeInAnswer):"",e=`/api/Poll/PollResponse?pollId=${e.pollId}&answerIdsCsv=${t}&writeInAnswer=`+i;this.$http.put(e,null).then(()=>{this.isLoading=!1,this.refreshPolls()},e=>{this.isLoading=!1,alert("Failed to submit vote: "+e.data.exceptionMessage)})}onMultiResponseChange(e,t){var i="Abstain"===t.answerText;i&&t.isLocalMultiSelect&&(e.answers.filter(e=>"Abstain"!==e.answerText).forEach(e=>e.isLocalMultiSelect=!1),e.isWriteInMultiSelected=!1),i||(i=e.answers.find(e=>"Abstain"===e.answerText))&&(i.isLocalMultiSelect=!1);let s=e.answers.filter(e=>e.isLocalMultiSelect).length;e.isWriteInMultiSelected&&++s,s>e.maxNumResponses&&(alert(`You can only select at most ${e.maxNumResponses} answers`),t===this.multiSelectWriteInPlaceholder?e.isWriteInMultiSelected=!1:t.isLocalMultiSelect=!1),e.localMultiSelectedAnswers=e.answers.filter(e=>e.isLocalMultiSelect)}onSubmitMultiAnswer(e){var t;e.localMultiSelectedAnswers&&0!==e.localMultiSelectedAnswers.length?(t=e.localMultiSelectedAnswers.map(e=>e.pollAnswerId).join(","),this.isLoading=!0,t=`/api/Poll/PollResponse?pollId=${e.pollId}&answerIdsCsv=${t}&writeInAnswer=`+(e.isWriteInMultiSelected&&e.writeInAnswer?encodeURIComponent(e.writeInAnswer):""),this.$http.put(t,null).then(()=>{this.isLoading=!1,this.refreshPolls()},e=>{this.isLoading=!1,alert("Failed to submit vote: "+e.data.exceptionMessage)})):alert("Please select at least one reponse")}}e.$inject=["$http","SiteInfo","$timeout","$rootScope","fellowResidents"],a.ActivePollsController=e}(Ally=Ally||{}),CA.angularApp.component("activePolls",{templateUrl:"/ngApp/common/active-polls.html",controller:Ally.ActivePollsController}),function(r){class e{constructor(e,t,i,s,a,n,o){this.$http=e,this.siteInfo=t,this.$rootScope=i,this.$sce=s,this.$timeout=a,this.$q=n,this.$scope=o,this.isLoading_Payment=!1,this.isLoadingDwolla=!1,this.showParagon=!1,this.showParagonCheckingSignUpModal=!1,this.showParagonCreditSignUpModal=!1,this.dwollaSignUpInfo={dateOfBirth:"",ssnLast4:"",ssnFull:"",streetAddress:new r.FullAddress},this.isWePayPaymentActive=!1,this.isDwollaEnabledOnGroup=!1,this.isStripeEnabledOnGroup=!1,this.isDwollaReadyForPayment=!1,this.shouldShowDwollaAddAccountModal=!1,this.shouldShowDwollaModalClose=!1,this.hasComplexPassword=!1,this.didAgreeToDwollaTerms=!1,this.dwollaFeePercent=.5,this.dwollaStripeMaxFee=5,this.dwollaDocUploadType="license",this.dwollaDocUploadFile=null,this.dwollaBalance=-1,this.isDwollaIavDone=!1,this.shouldShowDwollaMicroDepositModal=!1,this.dwollaMicroDepositAmount1String="0.01",this.dwollaMicroDepositAmount2String="0.01",this.shouldShowOwnerFinanceTxn=!1,this.shouldShowDwollaAutoPayArea=!0,this.shouldShowStripeAutoPayArea=!1,this.currentDwollaAutoPayAmount=null,this.hasMultipleProviders=!1,this.allowDwollaSignUp=!1,this.stripePaymentSucceeded=!1,this.userHasStripeAutoPay=!1,this.hasStripePlaidPendingMicroDeposits=!1,this.hasStripeAchPendingMicroDeposits=!1,this.shouldShowStripeAchMandate=!1,this.shouldShowStripeAchRefresh=!1,this.isUpgradingStripePaymentForAutoPay=!1,this.pendingStripeAchClientSecret="seti_1Oju5yQZjs457rtswAZUdYR2_secret_PZ2A2ZWo6r5bFPc1yS4pRvVONjEP5Bg"}$onInit(){this.showParagon=!1,this.paragonPaymentParams=`&BillingAddress1=${encodeURIComponent("900 W Ainslie St")}&BillingState=Illinois&BillingCity=Chicago&BillingZip=60640&FirstName=${encodeURIComponent(this.siteInfo.userInfo.firstName)}&LastName=`+encodeURIComponent(this.siteInfo.userInfo.lastName),this.paragonCheckingLast4=this.siteInfo.userInfo.paragonCheckingLast4,this.paragonCardLast4=this.siteInfo.userInfo.paragonCardLast4,this.isWePayPaymentActive=this.siteInfo.privateSiteInfo.isWePayPaymentActive,28===this.siteInfo.publicSiteInfo.groupId&&(this.isWePayPaymentActive=!1),this.isWePayPaymentActive=!1;this.isDwollaEnabledOnGroup=!1,this.isStripeEnabledOnGroup=this.siteInfo.privateSiteInfo.isStripePaymentActive,this.isStripeEnabledOnGroup&&(this.stripeApi=Stripe(StripeApiKey,{stripeAccount:this.siteInfo.privateSiteInfo.stripeConnectAccountId})),this.dwollaFeePercent=this.siteInfo.privateSiteInfo.isPremiumPlanActive?.5:1,this.dwollaStripeMaxFee=this.siteInfo.privateSiteInfo.isPremiumPlanActive?5:10,this.shouldShowOwnerFinanceTxn=this.siteInfo.privateSiteInfo.shouldShowOwnerFinanceTxn,this.currentDwollaAutoPayAmount=this.siteInfo.userInfo.dwollaAutoPayAmount,this.siteInfo.privateSiteInfo.customFinancialInstructions&&(this.customFinancialInstructions=this.$sce.trustAsHtml(this.siteInfo.privateSiteInfo.customFinancialInstructions));let e=0;if(this.isWePayPaymentActive&&++e,this.isDwollaEnabledOnGroup&&++e,this.isStripeEnabledOnGroup&&++e,this.hasMultipleProviders=1<e,this.usersStripeBankAccountHint=this.siteInfo.userInfo.stripeBankAccountHint,this.usersStripeBankAccountId=this.siteInfo.userInfo.stripeBankAccountId,this.usersStripeAchPaymentMethodId=this.siteInfo.userInfo.stripeAchPaymentMethodId,this.userHasStripeAutoPay=!!this.siteInfo.userInfo.stripeAutoPayAmount,this.stripeAutoPayAmount=this.siteInfo.userInfo.stripeAutoPayAmount,this.hasStripePlaidPendingMicroDeposits=this.siteInfo.userInfo.hasStripePlaidPendingMicroDeposits,this.hasStripeAchPendingMicroDeposits=this.siteInfo.userInfo.hasStripeAchPendingMicroDeposits,this.isDwollaEnabledOnGroup)if(this.isDwollaUserAccountVerified=this.siteInfo.userInfo.isDwollaAccountVerified,this.isDwollaUserAccountVerified)this.dwollaUserStatus="verified",this.hasDwollaFundingSource=r.HtmlUtil2.isValidString(this.siteInfo.userInfo.dwollaFundingSourceName),this.hasDwollaFundingSource?(this.dwollaFundingSourceName=this.siteInfo.userInfo.dwollaFundingSourceName,this.dwollaFundingSourceIsVerified=this.siteInfo.userInfo.dwollaFundingSourceIsVerified,this.isDwollaReadyForPayment=this.isDwollaUserAccountVerified&&this.dwollaFundingSourceIsVerified&&this.siteInfo.privateSiteInfo.isDwollaPaymentActive,this.isDwollaReadyForPayment&&this.$timeout(()=>{this.$http.get("/api/Dwolla/DwollaBalance").then(e=>this.dwollaBalance=e.data.balanceAmount)},1e3)):this.$http.get("/api/Dwolla/HasComplexPassword").then(e=>this.hasComplexPassword=e.data);else{this.dwollaUserStatus="checking",this.userFullName=this.siteInfo.userInfo.fullName,this.userEmail=this.siteInfo.userInfo.emailAddress;const t=()=>{this.$http.get("/api/Dwolla/MyAccountStatus").then(e=>{this.dwollaUserStatus=e.data.status,this.dwollaSignUpInfo.streetAddress=e.data.streetAddress},e=>{this.dwollaUserStatus="error",console.log("Failed to get Dwolla account status: "+e.data.exceptionMessage)})};this.$timeout(()=>t(),500)}this.allyAppName=AppConfig.appName,this.isWePayAutoPayActive=this.siteInfo.userInfo.isAutoPayActive,this.wePayAssessmentCreditCardFeeLabel=this.siteInfo.privateSiteInfo.payerPaysCCFee?"Service fee applies":"No service fee",this.wePayAssessmentAchFeeLabel=this.siteInfo.privateSiteInfo.payerPaysAchFee?"$1.50 service fee applies":"No service fee",this.payerPaysAchFee=this.siteInfo.privateSiteInfo.payerPaysAchFee,this.errorPayInfoText="Is the amount incorrect?",this.isWePaySetup=this.siteInfo.privateSiteInfo.isPaymentEnabled,this.hasAssessments=this.siteInfo.privateSiteInfo.hasAssessments,this.assessmentFrequency=this.siteInfo.privateSiteInfo.assessmentFrequency,!this.isWePayAutoPayActive&&HtmlUtil.isNumericString(HtmlUtil.GetQueryStringParameter("preapproval_id"))&&(this.isWePayAutoPayActive=!0),this.isWePayAutoPayActive=!1,this.nextAutoPayText=this.siteInfo.userInfo.nextAutoPayText,null!=this.siteInfo.userInfo.usersUnits&&0<this.siteInfo.userInfo.usersUnits.length?this.assessmentAmount=this.siteInfo.userInfo.usersUnits.filter(e=>!e.isRenter).reduce((e,t)=>e+(t.assessment||0),0):this.assessmentAmount=0,this.shouldShowDwollaAutoPayArea=this.isDwollaReadyForPayment&&null!=this.siteInfo.privateSiteInfo.assessmentFrequency&&0<this.assessmentAmount||"number"==typeof this.currentDwollaAutoPayAmount&&!isNaN(this.currentDwollaAutoPayAmount)&&1<this.currentDwollaAutoPayAmount,this.shouldShowDwollaAutoPayArea=!1,this.shouldShowStripeAutoPayArea=this.isStripeEnabledOnGroup&&(!!this.siteInfo.userInfo.stripeBankAccountId||!!this.siteInfo.userInfo.stripeAchPaymentMethodId),(this.shouldShowDwollaAutoPayArea||this.shouldShowStripeAutoPayArea)&&(this.assessmentFrequencyInfo=PeriodicPaymentFrequencies.find(e=>e.id===this.siteInfo.privateSiteInfo.assessmentFrequency)),this.paymentInfo={paymentType:"other",amount:this.assessmentAmount,note:"",fundingType:null,paysFor:[]},this.onPaymentAmountChange(),this.stripeAutoPayFeeAmountString=this.stripeAchFeeAmountString;this.historicPayments=this.siteInfo.userInfo.recentPayments,this.historicPayments&&0<this.historicPayments.length&&24<this.historicPayments.length&&(this.historicPayments=this.historicPayments.slice(0,24)),null!=this.siteInfo.privateSiteInfo.assessmentFrequency&&null!=this.siteInfo.userInfo.usersUnits&&0<this.siteInfo.userInfo.usersUnits.length&&(this.paymentInfo.paymentType="periodic",this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled)&&(this.knowsNextPayment=!0,this.errorPayInfoText="Is the amount or date incorrect?",this.nextPaymentText=this.getNextPaymentText(this.siteInfo.userInfo.usersUnits[0].nextAssessmentDue,this.siteInfo.privateSiteInfo.assessmentFrequency),this.updatePaymentText())}showParagonSignUp(){this.showParagonCheckingSignUpModal=!0,this.paragonSignUpInfo||(this.isLoading_Payment=!0,this.$http.get("/api/Paragon/SignUpPrefill").then(e=>{this.isLoading_Payment=!1,this.paragonSignUpInfo=e.data},e=>{this.isLoading_Payment=!1,this.paragonSignUpInfo=new ParagonPayerSignUpInfo,console.log("Failed to SignUpPrefill: "+e.data.exceptionMessage)}))}showParagonCreditSignUp(){this.isLoading_Payment=!0,this.paragonCardTokenizedUrl=null,this.paragonCardTokenizationMessage="Connecting...",this.showParagonCreditSignUpModal=!0,this.$http.get("/api/Paragon/CardTokenizationKey").then(e=>{this.isLoading_Payment=!1,this.paragonCardTokenizedUrl=this.$sce.trustAsResourceUrl("https://stage.paragonsolutions.com/ws/hosted.aspx?Username=54cE7DU2p%2bBh7h9uwJWW8Q%3d%3d&Password=jYvmN41tt1lz%2bpiazUqQYK9Abl73Z%2bHoBG4vOZImo%2bYlKTbPeNPwOcMB0%2bmIS3%2bs&MerchantKey=1293&InvNum="+e.data),this.paragonCardTokenizationMessage=null},e=>{this.isLoading_Payment=!1,this.paragonCardTokenizationMessage="There was an error connecting to the server. Please close this window and try again. If this has happened more than once please contact support.",console.log("Failed in CardTokenizationKey: "+e.data.exceptionMessage)})}hideParagonCreditSignUp(){this.showParagonCreditSignUpModal=!1,this.paragonCardTokenizedUrl&&window.location.reload()}submitParagonSignUp(){this.isLoading_Payment=!0,this.paragonSignUpError=null,this.$http.post("/api/Paragon/CheckPaymentSignUp",this.paragonSignUpInfo).then(()=>{window.location.reload()},e=>{this.isLoading_Payment=!1,this.paragonSignUpError=e.data.exceptionMessage})}submitParagonPayment(e){var t;confirm("This will submit payment.")&&(this.paragonPaymentMessage=null,(t=new ParagonPaymentRequest).notes=this.paymentInfo.note,t.paymentAmount=this.paymentInfo.amount,t.paysFor=this.paymentInfo.paysFor,t.paySource=e,this.isLoading_Payment=!0,this.$http.post("/api/Paragon/MakePayment",t).then(()=>{this.isLoading_Payment=!1,this.paragonPaymentMessage="Payment Successfully Processed"},e=>{this.isLoading_Payment=!1,this.paragonPaymentMessage=e.data.exceptionMessage}))}unenrollParagonAccount(e){this.isLoading_Payment=!0,this.$http.get("/api/Paragon/UnenrollPayment?paySource="+e).then(()=>{window.location.reload()},e=>{this.isLoading_Payment=!1,alert("Failed to un-enroll: "+e.data.exceptionMessage),this.paragonPaymentMessage=e.data.exceptionMessage})}submitWePayPayment(e){this.isLoading_Payment=!0,this.paymentInfo.fundingType=e;var t=this.paymentInfo.amount;HtmlUtil.isValidString(t)&&"$"===t[0]&&(this.paymentInfo.amount=parseFloat(t.substr(1))),analytics.track("makePayment",{fundingType:e}),this.$http.post("/api/WePayPayment/MakeNewPayment",this.paymentInfo).then(e=>{e=e.data;null!==e&&"string"==typeof e.checkoutUri&&0<e.checkoutUri.length?window.location.href=e.checkoutUri:(this.isLoading_Payment=!1,alert("Unable to initiate WePay checkout"))},e=>{this.isLoading_Payment=!1,e.data&&e.data.exceptionMessage&&alert(e.data.exceptionMessage)})}getMyRecentPayments(){this.$http.get("/api/WePayPayment/MyRecentPayments").then(e=>{this.myRecentPayments=e.data},e=>{console.log("Failed to retrieve recent payments: "+e.data.exceptionMessage)})}onIncorrectPayDetails(){let e=this.assessmentAmount.toString(),t=e=Math.round(this.assessmentAmount)!=this.assessmentAmount?this.assessmentAmount.toFixed(2):e;this.knowsNextPayment&&HtmlUtil.isValidString(this.nextPaymentText)&&(t+="|"+this.nextPaymentText),this.$rootScope.$broadcast("prepAssessmentEmailToBoard",t)}updatePaymentText(){"periodic"===this.paymentInfo.paymentType&&this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled?HtmlUtil.isNullOrWhitespace(this.nextPaymentText)||(this.siteInfo.userInfo.usersUnits[0].includesLateFee?this.paymentInfo.note="Assessment payment with late fee for ":this.paymentInfo.note="Assessment payment for ",this.paymentInfo.note+=this.nextPaymentText):this.paymentInfo.note=""}onSelectPaymentType(e){this.paymentInfo.paymentType=e,this.paymentInfo.amount="periodic"==e?this.assessmentAmount:0,this.updatePaymentText(),this.onPaymentAmountChange()}getNextPaymentText(e,t){if(!e)return"";let i="";var t=FrequencyIdToInfo(t),s=GetLongPayPeriodNames(t.intervalName);return s&&(i=s[e.period-1]),"year"===t.intervalName?i=e.year.toString():i+=" "+e.year,this.paymentInfo.paysFor=[e],i}onSetupWePayAutoPay(e){this.isLoading_Payment=!0,this.$http.get("/api/WePayPayment/SetupAutoPay?fundingType="+e).then(e=>{e=e.data;"string"==typeof e&&0<e.length?window.location.href=e:(this.isLoading_Payment=!1,alert("Unable to initiate WePay auto-pay setup"))},e=>{this.isLoading_Payment=!1,e.data&&e.data.exceptionMessage&&alert(e.data.exceptionMessage)})}onDisableAutoPay(){confirm("Just to double check, this will disable your auto-payment. You need to make sure to manually make your regular payments to avoid any late fees your association may enforce.")&&(this.isLoading_Payment=!0,this.$http.get("/api/WePayPayment/DisableAutoPay").then(()=>{this.isLoading_Payment=!1,this.isWePayAutoPayActive=!1},e=>{this.isLoading_Payment=!1,e.data&&e.data.exceptionMessage&&alert(e.data.exceptionMessage)}))}dwollaSignUp(){this.didAgreeToDwollaTerms?(this.isLoading_Payment=!0,this.$http.post("/api/Dwolla/CreatePayer",this.dwollaSignUpInfo).then(()=>{window.location.reload()},e=>{this.isLoading_Payment=!1,e.data&&e.data.exceptionMessage&&alert(e.data.exceptionMessage)})):alert("Please agree to Dwolla's terms and privacy policy")}dwollaStartIAV(){this.shouldShowDwollaAddAccountModal=!0,this.shouldShowDwollaModalClose=!1,this.isDwollaIavDone=!1,this.isLoadingDwolla=!0;const t=e=>{dwolla.configure(r.AppConfigInfo.dwollaEnvironmentName),dwolla.iav.start(e,{container:"dwolla-iav-container",stylesheets:["https://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext"],microDeposits:!0,fallbackToMicroDeposits:!0},(e,t)=>{t&&t._links&&t._links["funding-source"]&&t._links["funding-source"].href&&(t=t._links["funding-source"].href,this.$http.put("/api/Dwolla/SetUserFundingSourceUri",{fundingSourceUri:t}).then(()=>{this.isDwollaIavDone=!0},e=>{this.isLoadingDwolla=!1,this.shouldShowDwollaModalClose=!0,alert("Failed to complete sign-up: "+e.data.exceptionMessage)}))})};this.$http.get("/api/Dwolla/UserIavToken").then(e=>{this.isLoadingDwolla=!1,window.setTimeout(()=>t(e.data.iavToken),150)},e=>{this.isLoadingDwolla=!1,alert("Failed to start IAV: "+e.data.exceptionMessage)})}hideDwollaAddAccountModal(){this.shouldShowDwollaAddAccountModal=!1,this.isDwollaIavDone&&(this.isLoading_Payment=!0,window.location.reload())}submitDwollaPayment(){this.dwollaPaymentMessage=null,this.isLoading_Payment=!0,this.$http.post("/api/Dwolla/MakePayment",this.paymentInfo).then(()=>{this.isLoading_Payment=!1,this.dwollaPaymentMessage="Payment Successfully Processed",this.refreshHistoricPayments()},e=>{this.isLoading_Payment=!1,this.dwollaPaymentMessage="Payment failed: "+e.data.exceptionMessage})}refreshHistoricPayments(){this.isLoading_Payment=!0,this.$http.get("/api/MyProfile/RecentPayments").then(e=>{this.isLoading_Payment=!1,this.historicPayments=e.data},e=>{this.isLoading_Payment=!1,console.log("Failed to refresh rescent payments: "+e.data.exceptionMessage)})}unlinkDwollaFundingSource(){confirm("Are you sure you want to disconnect the bank account? You will no longer be able to make payments.")&&(this.isLoading_Payment=!0,this.$http.put("/api/Dwolla/DisconnectUserFundingSource",null).then(()=>{window.location.reload()},e=>{this.isLoading_Payment=!1,alert("Failed to disconnect account"+e.data.exceptionMessage)}))}getDwollaFeeAmount(e){let t=Math.ceil(e*this.dwollaFeePercent)/100;return t=t>this.dwollaStripeMaxFee?this.dwollaStripeMaxFee:t}getStripeFeeAmount(e){return"string"==typeof e&&(e=parseFloat(e)),(e=isNaN(e)?0:e)?r.HtmlUtil2.getStripeFeeInfo(e,this.siteInfo.privateSiteInfo.payerPaysAchFee,this.siteInfo.privateSiteInfo.isPremiumPlanActive).payerFee:0}onPaymentAmountChange(){var e=this.getDwollaFeeAmount(this.paymentInfo.amount);this.dwollaFeeAmountString="$"+e.toFixed(2),this.paymentInfo.amount?(e=this.getStripeFeeAmount(this.paymentInfo.amount),this.stripeAchFeeAmountString=e?"Stripe fee: $"+e.toFixed(2):"No service fee"):this.stripeAchFeeAmountString=""}uploadDwollaDoc(){this.isLoading_Payment=!0,this.dwollaDocUploadMessage=null;var e=new FormData,t=(e.append("DocumentFile",this.dwollaDocUploadFile),e.append("DocumentType",this.dwollaDocUploadType),{headers:{"Content-Type":void 0}});this.$http.post("/api/Dwolla/UploadCustomerDocument",e,t).then(()=>{this.isLoading_Payment=!1,this.dwollaDocUploadFile=null,this.dwollaDocUploadMessage="Your document has been successfully uploaded. You will be notified when it is reviewed."},e=>{this.isLoading_Payment=!1,alert("Failed to upload document: "+e.data.exceptionMessage)})}onDwollaDocSelected(e){this.dwollaDocUploadFile=e?e.target.files[0]:null}withdrawDwollaBalance(){this.isLoading_Payment=!0,this.dwollaBalanceMessage=null,this.$http.get("/api/Dwolla/WithdrawDwollaBalance").then(()=>{this.isLoading_Payment=!1,this.dwollaBalanceMessage="Balance withdraw successfully initiated. Expect the transfer to complete in 1-2 business days."},e=>{this.isLoading_Payment=!1,alert("Failed to initiate withdraw: "+e.data.exceptionMessage)})}submitDwollaMicroDepositAmounts(){this.isLoading_Payment=!0;var e={amount1String:this.dwollaMicroDepositAmount1String,amount2String:this.dwollaMicroDepositAmount2String,isForGroup:!1};this.$http.post("/api/Dwolla/VerifyMicroDeposit",e).then(()=>{window.location.reload()},e=>{this.isLoading_Payment=!1,alert("Failed to verify: "+e.data.exceptionMessage)})}reloadPage(){this.isLoading_Payment=!0,window.location.reload()}enableDwollaAutoPay(){this.isLoading_Payment=!0,this.$http.put("/api/Dwolla/EnableAutoPay/"+encodeURIComponent(this.assessmentAmount.toString()),null).then(()=>{window.location.reload()},e=>{this.isLoading_Payment=!1,alert("Failed to enable Dwolla auto-pay: "+e.data.exceptionMessage)})}disableDwollaAutoPay(){this.isLoading_Payment=!0,this.$http.put("/api/Dwolla/DisableAutoPay",null).then(()=>{window.location.reload()},e=>{this.isLoading_Payment=!1,alert("Failed to disable Dwolla auto-pay: "+e.data.exceptionMessage)})}showStripeError(e){var t=document.getElementById("card-errors");HtmlUtil.isNullOrWhitespace(e)?t.textContent=null:t.textContent=e}async startStripeCardPayment(){this.stripeElements.update({amount:Math.floor(100*this.paymentInfo.amount)}),this.stripeElements.submit().then(()=>{this.isLoading_Payment=!0,this.$http.post("/api/StripePayments/StartPaymentIntent",this.paymentInfo).then(e=>{this.stripeApi.confirmPayment({elements:this.stripeElements,clientSecret:e.data,confirmParams:{return_url:this.siteInfo.publicSiteInfo.baseUrl+"/#!/Home"}})},e=>{this.isLoading_Payment=!1,console.log("Failed to SignUpPrefill: "+e.data.exceptionMessage),alert("Failed to start payment: "+e.data.exceptionMessage)})},e=>{console.log("Stripe error",e)})}completePlaidAchConnection(e,t){this.isLoading_Payment=!0,this.$http.post("/api/PlaidMember/ProcessUserStripeAccessToken",{accessToken:e,selectedAccountIds:[t]}).then(()=>{this.isLoading_Payment=!1,console.log("Account successfully linked, reloading..."),window.location.reload()},e=>{this.isLoading_Payment=!1,alert("Failed to link account: "+e.data.exceptionMessage)})}startPlaidAchConnection(){this.isLoading_Payment=!0,this.$http.get("/api/PlaidMember/StripeLinkToken").then(e=>{e.data?(e={token:e.data,onSuccess:(e,t)=>{this.completePlaidAchConnection(e,t.account_id)},onLoad:()=>{this.$scope.$apply(()=>{this.isLoading_Payment=!1})},onExit:(e,t)=>{this.$scope.$apply(()=>{this.isLoading_Payment=!1})},onEvent:(e,t)=>{console.log("update onEvent.eventName",e,t)},receivedRedirectUri:null},Plaid.create(e).open()):(this.isLoading_Payment=!1,alert("Failed to start Plaid connection. Please contact support."))},e=>{this.isLoading_Payment=!1,alert("Failed to start Plaid connection: "+e.data.exceptionMessage)})}submitStripeAchPayment(){let e=!1;if(this.historicPayments&&0<this.historicPayments.length){var t=this.historicPayments[0],i=moment(t.date),s=moment().subtract(30,"minutes");if(i.isAfter(s)){if(!confirm(`It looks like you already submitted a payment for $${t.amount.toFixed(2)} a few minutes ago. Are you sure you want to submit another payment?`))return;e=!0}}if(!e){let e=`Are you sure you want to submit payment for $${this.paymentInfo.amount}?`;if(this.userHasStripeAutoPay&&(e+=" YOU HAVE AUTO-PAY ENABLED, PLEASE MAKE SURE TO NOT SUBMIT DUPLICATE PAYMENTS, REFUNDS ARE SLOW."),!confirm(e))return}this.isLoading_Payment=!0,this.$http.post("/api/StripePayments/StartPaymentIntent",this.paymentInfo).then(e=>{e=e.data;this.stripeApi.confirmUsBankAccountPayment(e,{payment_method:this.siteInfo.userInfo.stripeBankAccountId}).then(e=>{this.$scope.$apply(()=>{this.isLoading_Payment=!1,this.stripePaymentSucceeded=!0,this.refreshHistoricPayments()}),e.error?console.log(e.error.message):(console.log("PaymentIntent ID: "+e.paymentIntent.id),console.log("PaymentIntent status: "+e.paymentIntent.status))},e=>{this.$scope.$apply(()=>{this.isLoading_Payment=!1}),console.log("Stripe Failed",e),alert("Stripe Failed: "+e)})},e=>{this.isLoading_Payment=!1,console.log("Failed to SignUpPrefill: "+e.data.exceptionMessage),alert("Failed to start payment: "+e.data.exceptionMessage)})}unlinkStripeFundingSource(){confirm("Are you sure you want to disconnect the bank account? You will no longer be able to make payments.")&&(this.isLoading_Payment=!0,this.$http.delete("/api/StripePayments/RemoveBankAccount").then(()=>{window.location.reload()},e=>{this.isLoading_Payment=!1,alert("Failed to disconnect account: "+e.data.exceptionMessage)}))}enableStripeAutoPay(){if(1===(new Date).getDate()){var e=this.historicPayments[0],t=moment(e.date),i=moment().subtract(30,"minutes"),t=t.isAfter(i);if(t&&!confirm(`It looks like you recently submitted a payment for $${e.amount.toFixed(2)}. Since it's the 1st of the month there's a chance enabling auto-pay will double charge you today. To avoid this simply wait until tomorrow to enable auto-pay. Would you still like to enable auto-pay right now?`))return}this.isLoading_Payment=!0,this.$http.put("/api/StripePayments/SetupUserAutoPay",null).then(()=>{this.isLoading_Payment=!1,this.userHasStripeAutoPay=!0,alert("Auto-pay successfully enabled"),this.isUpgradingStripePaymentForAutoPay&&window.location.reload()},e=>{this.isLoading_Payment=!1,alert("Failed to setup auto-pay: "+e.data.exceptionMessage)})}startEnableStripeAutoPay(){this.assessmentAmount<10?alert("Your auto-pay amount cannot be less than $10"):this.usersStripeAchPaymentMethodId||this.usersStripeBankAccountId?!this.usersStripeAchPaymentMethodId&&this.usersStripeBankAccountId?(this.isUpgradingStripePaymentForAutoPay=!0,this.upgradeBankAccountToPaymentMethod()):this.enableStripeAutoPay():alert("You don't appear to have a connected checking account. Please connect your account or contact support.")}disableStripeAutoPay(){this.isLoading_Payment=!0,this.$http.delete("/api/StripePayments/CancelUserAutoPay").then(()=>{this.isLoading_Payment=!1,this.userHasStripeAutoPay=!1},e=>{this.isLoading_Payment=!1,alert("Failed to cancel auto-pay: "+e.data.exceptionMessage)})}completeStripeMicroDeposits(){this.isLoading_Payment=!0,this.$http.get("/api/PlaidMember/MicroDepositLinkToken").then(e=>{this.isLoading_Payment=!1;e=e.data;e?Plaid.create({token:e,onSuccess:(e,t)=>{console.log("Plaid micro-deposits update onSuccess"),this.completePlaidAchConnection(e,t.account_id)},onLoad:()=>{},onExit:(e,t)=>{console.log("onExit.err",e,t)},onEvent:(e,t)=>{console.log("onEvent.eventName",e,t)},receivedRedirectUri:null}).open():alert("Something went wrong on the server. Please contact support.")},e=>{this.isLoading_Payment=!1,alert("Failed to start verification: "+e.data.exceptionMessage)})}cancelStripeAccountAddition(){confirm("Are you sure you want to cancel adding this bank account? You can restart the process at any time.")&&(this.isLoading_Payment=!0,this.$http.get("/api/PlaidMember/CancelStripeAccountAddition").then(()=>{this.isLoading_Payment=!1,this.hasStripePlaidPendingMicroDeposits=!1},e=>{this.isLoading_Payment=!1,alert("Failed to cancel account addition: "+e.data.exceptionMessage)}))}startStripeAchConnection(){this.isLoading_Payment=!0,this.$http.get("/api/StripePayments/StartUserBankSignUp").then(e=>{e.data?(this.pendingStripeAchClientSecret=e.data,e={clientSecret:this.pendingStripeAchClientSecret,params:{payment_method_type:"us_bank_account",payment_method_data:{billing_details:{name:this.siteInfo.userInfo.fullName,email:this.siteInfo.userInfo.emailAddress}}},expand:["payment_method"]},console.log("Starting Stripe connect ACH"),this.stripeApi.collectBankAccountForSetup(e).then(e=>{console.log("In Stripe connect then",e),this.$scope.$apply(()=>{this.isLoading_Payment=!1,e.error?console.error(e.error.message):"requires_payment_method"!==e.setupIntent.status&&"requires_confirmation"===e.setupIntent.status&&(this.isUpgradingStripePaymentForAutoPay=!1,this.shouldShowStripeAchMandate=!0)})})):(this.isLoading_Payment=!1,alert("Failed to start Stripe connection. Please contact support."))},e=>{this.isLoading_Payment=!1,alert("Failed to start Stripe connection: "+e.data.exceptionMessage)})}acceptStripeAchMandate(e){console.log("In acceptStripeAchMandate",e),e?(this.isLoading_Payment=!0,this.stripeApi.confirmUsBankAccountSetup(this.pendingStripeAchClientSecret).then(e=>{console.log("In acceptStripeAchMandate then",e),this.$scope.$apply(()=>{e.error?(this.isLoading_Payment=!1,this.shouldShowStripeAchMandate=!1,console.error(e.error.message),alert("Failed to confirm: "+e.error.message)):"requires_payment_method"===e.setupIntent.status?(this.isLoading_Payment=!1,this.shouldShowStripeAchMandate=!1):"verify_with_microdeposits"===e.setupIntent.next_action?.type?(this.shouldShowStripeAchMandate=!1,window.location.reload()):this.$http.get("/api/StripePayments/CompleteUserBankSignUp").then(()=>{this.isLoading_Payment=!1,this.shouldShowStripeAchMandate=!1,this.isUpgradingStripePaymentForAutoPay?this.enableStripeAutoPay():window.location.reload()},e=>{this.isLoading_Payment=!1,alert("Failed to cancel account addition: "+e.data.exceptionMessage)})})})):this.shouldShowStripeAchMandate=!1}cancelStripeAchMicroDeposits(){confirm("Are you sure you want to cancel adding your bank account?")&&(this.isLoading_Payment=!0,this.$http.get("/api/StripePayments/CancelUserBankSignUp").then(()=>{window.location.reload()},e=>{this.isLoading_Payment=!1,alert("Failed to cancel sign-up: "+e.data.exceptionMessage)}))}verifyStripeMicroDeposits(){this.isLoading_Payment=!0,this.$http.get("/api/StripePayments/MicroDepositsUrl").then(e=>{this.isLoading_Payment=!1,window.open(e.data,"_blank"),this.shouldShowStripeAchRefresh=!0},e=>{this.isLoading_Payment=!1,alert("Failed to get to verification step: "+e.data.exceptionMessage)})}refreshPageAfterStripeVerify(){this.$http.get("/api/StripePayments/RefreshStripeAchInfo").then(()=>window.location.reload(),e=>{this.isLoading_Payment=!1,alert("Failed to refresh status: "+e.data.exceptionMessage)})}upgradeBankAccountToPaymentMethod(){this.isLoading_Payment=!0,this.$http.get("/api/StripePayments/ConfirmExistingAch").then(e=>{this.isLoading_Payment=!1,this.pendingStripeAchClientSecret=e.data,this.shouldShowStripeAchMandate=!0},e=>{this.isLoading_Payment=!1,alert("Failed to get to verification step: "+e.data.exceptionMessage)})}}e.$inject=["$http","SiteInfo","$rootScope","$sce","$timeout","$q","$scope"],r.AssessmentPaymentFormController=e}(Ally=Ally||{}),CA.angularApp.component("assessmentPaymentForm",{templateUrl:"/ngApp/common/assessment-payment-form.html",controller:Ally.AssessmentPaymentFormController});class CreateDwollaUser{}class ParagonPayerSignUpInfo{constructor(){this.billingAddress=new Ally.FullAddress,this.checkType="PERSONAL",this.accountType="CHECKING"}}class ParagonPaymentRequest{}function ServiceBankInfoCtrl(e){}function ServiceBusinessInfoCtrl(e){}function ServiceJobsCtrl(e){}!function(t){class e{constructor(e,t,i,s){this.$http=e,this.siteInfo=t,this.$sce=i,this.$routeParams=s,this.isLoading=!1}$onInit(){this.isLoading=!0,this.$http.get("/api/PublicCustomPage/View/"+this.$routeParams.slug,{cache:!0}).then(e=>{this.isLoading=!1,this.customPage=e.data,this.markupHtml=this.$sce.trustAsHtml(this.customPage.markupHtml),setTimeout(()=>t.RichTextHelper.makeLinksOpenNewTab("custom-page-content"),500)},e=>{this.isLoading=!1,alert("Failed to load page, try refreshing the page. If the problem persists, contact support: "+e.data.exceptionMessage)})}}e.$inject=["$http","SiteInfo","$sce","$routeParams"],t.CustomPageViewController=e}(Ally=Ally||{}),CA.angularApp.component("customPageView",{templateUrl:"/ngApp/common/custom-page-view.html",controller:Ally.CustomPageViewController}),function(e){class t{constructor(e,t,i){this.appCacheService=e,this.$scope=t,this.$timeout=i,this.filterPresetDateRange="custom",this.lastChangeStart=null,this.lastChangeEnd=null,this.shouldSuppressCustom=!1,this.thisYearLabel=(new Date).getFullYear().toString(),this.lastYearLabel=((new Date).getFullYear()-1).toString()}$onInit(){this.startDate&&(this.startDate=moment(this.startDate).startOf("day").toDate()),this.endDate&&(this.endDate=moment(this.endDate).startOf("day").toDate()),this.startDate||this.endDate||this.selectPresetDateRange(!0),this.$scope.$watch("$ctrl.startDate",(e,t)=>{e&&e!==t&&!this.shouldSuppressCustom&&(this.filterPresetDateRange="custom")}),this.$scope.$watch("$ctrl.endDate",(e,t)=>{e&&e!==t&&!this.shouldSuppressCustom&&(this.filterPresetDateRange="custom")})}selectPresetDateRange(e=!1){var t;"last30days"===this.filterPresetDateRange?(this.startDate=moment().subtract(30,"days").toDate(),this.endDate=moment().toDate()):"thisMonth"===this.filterPresetDateRange?(this.startDate=moment().startOf("month").toDate(),this.endDate=moment().endOf("month").toDate()):"lastMonth"===this.filterPresetDateRange?(t=moment().subtract(1,"months"),this.startDate=t.startOf("month").toDate(),this.endDate=t.endOf("month").toDate()):"thisYear"===this.filterPresetDateRange?(this.startDate=moment().startOf("year").toDate(),this.endDate=moment().endOf("year").toDate()):"lastYear"===this.filterPresetDateRange?(t=moment().subtract(1,"years"),this.startDate=t.startOf("year").toDate(),this.endDate=t.endOf("year").toDate()):"oneYear"===this.filterPresetDateRange&&(this.startDate=moment().subtract(1,"years").toDate(),this.endDate=moment().toDate()),this.startDate=moment(this.startDate).startOf("day").toDate(),this.endDate=moment(this.endDate).startOf("day").toDate(),this.shouldSuppressCustom=!0,window.setTimeout(()=>this.shouldSuppressCustom=!1,25),!e&&this.onChange&&window.setTimeout(()=>this.onChange(),50)}onInternalChange(e=!1){if("string"==typeof this.startDate){if(10!==this.startDate.length)return;this.startDate=moment(this.startDate,"MM-DD-YYYY").toDate()}if("string"==typeof this.endDate){if(10!==this.endDate.length)return;this.endDate=moment(this.endDate,"MM-DD-YYYY").toDate()}this.lastChangeStart&&this.lastChangeEnd&&this.startDate.getTime()===this.lastChangeStart.getTime()&&this.endDate.getTime()===this.lastChangeEnd.getTime()||e||this.$timeout(()=>{this.onChange&&this.onChange(),this.lastChangeStart=this.startDate,this.lastChangeEnd=this.endDate},10)}}t.$inject=["appCacheService","$scope","$timeout"],e.DateRangePickerController=t}(Ally=Ally||{}),CA.angularApp.component("dateRangePicker",{bindings:{startDate:"=",endDate:"=",onChange:"&"},templateUrl:"/ngApp/common/date-range-picker.html",controller:Ally.DateRangePickerController}),function(n){n.DocumentTreeFile=class{};n.DocLinkInfo=class{};class a{getSubDirectoryByName(t){if(this.subdirectories)for(let e=0;e<this.subdirectories.length;++e)if(this.subdirectories[e].name===t)return this.subdirectories[e];return null}}n.DocumentDirectory=a;class r{constructor(e,t,i,s,a,n,o){this.$http=e,this.$rootScope=t,this.$cacheFactory=i,this.$scope=s,this.siteInfo=a,this.fellowResidents=n,this.$location=o,this.isLoading=!1,this.filesSortDescend=!1,this.title="Documents",this.getDocsUri="/api/ManageDocuments",this.showPopUpWarning=!1,this.shouldShowSubdirectories=!0,this.docsHttpCache=this.$cacheFactory.get("docs-http-cache")||this.$cacheFactory("docs-http-cache"),this.fileSortType=window.localStorage[r.LocalStorageKey_SortType],this.fileSortType||(this.fileSortType="title"),this.filesSortDescend="true"===window.localStorage[r.LocalStorageKey_SortDirection],this.fileSearch={all:""}}$onInit(){this.canManage=this.siteInfo.userInfo.isAdmin||this.siteInfo.userInfo.isSiteManager,this.committee&&!this.canManage&&this.fellowResidents.isCommitteeMember(this.committee.committeeId).then(e=>this.canManage=e),this.apiAuthToken=this.$rootScope.authToken,this.Refresh();setTimeout(()=>{$("#JQDocsFileUploader").fileupload({autoUpload:!0,pasteZone:null,add:(e,t)=>{var i;52428800<t.files[0].size?(i=Math.round(t.files[0].size/1048576)+1,alert(`The selected file is too large (${i}MB). The maximum file size allowed is 50MB.`)):(i=this.getSelectedDirectoryPath(),$("#FileUploadProgressContainer").show(),t.url="api/DocumentUpload?dirPath="+encodeURIComponent(i),this.siteInfo.publicSiteInfo.baseApiUrl&&(t.url=this.siteInfo.publicSiteInfo.baseApiUrl+"DocumentUpload?dirPath="+encodeURIComponent(i)),(i=t.submit()).done(()=>{this.docsHttpCache.removeAll(),$("#FileUploadProgressContainer").hide(),this.Refresh()}),i.error(e=>{alert("Upload failed: "+e.responseJSON.exceptionMessage)}))},beforeSend:e=>{this.siteInfo.publicSiteInfo.baseApiUrl?e.setRequestHeader("Authorization","Bearer "+this.apiAuthToken):e.setRequestHeader("ApiAuthToken",this.apiAuthToken)},progressall:(e,t)=>{t=parseInt((t.loaded/t.total*100).toString(),10);$("#FileUploadProgressBar").css("width",t+"%"),100===t?$("#FileUploadProgressLabel").text("Finalizing Upload..."):$("#FileUploadProgressLabel").text(t+"%")},fail:(e,t)=>{$("#FileUploadProgressContainer").hide(),alert("Failed to upload document"),console.log("Failed to upload document",t)}})},100),this.committee&&(this.title="Committee Documents")}getSelectedDirectoryPath(){return this.getDirectoryFullPath(this.selectedDirectory)}viewDoc(i,s){this.isLoading=!0,this.showPopUpWarning=!1;let a;".rtf"===this.getDisplayExtension(i)&&(s=!0),++i.numViews,s||(!(a=window.open("","_blank"))||a.closed||void 0===a.closed?(alert(`Looks like your browser may be blocking pop-ups which are required to view documents. Please see the right of the address bar or your browser settings to enable pop-ups for ${AppConfig.appName}.`),this.showPopUpWarning=!0):a.document.write("Loading document... (If the document cannot be viewed directly in your browser, it will be downloaded automatically)"));var e="/api/DocumentLink/"+i.docId;this.$http.get(e).then(e=>{this.isLoading=!1;let t=i.url+"?vid="+encodeURIComponent(e.data.vid);HtmlUtil.startsWith(t,"/api/")&&(t=t.substr("/api/".length)),t=this.siteInfo.publicSiteInfo.baseApiUrl+t,s?((e=document.createElement("a")).setAttribute("type","hidden"),e.href=t+"&dl="+encodeURIComponent(i.fileName),e.download=i.fileName,document.body.appendChild(e),e.click(),e.remove()):n.HtmlUtil2.isAndroid()?a.location.href="http://docs.google.com/gview?embedded=true&url="+encodeURIComponent(t):a.location.href=t},e=>{this.isLoading=!1,alert("Failed to open document: "+e.data.exceptionMessage)})}startZipGenDownload(){let t,i=0,e=(t=()=>{this.$http.get("/api/DocumentUpload/GetZipGenStatus?vid="+this.generatingZipId).then(e=>{++i,0===e.data.totalNumFiles?this.generatingZipStatus="Still waiting...":this.generatingZipStatus=`${e.data.numFilesProcessed} of ${e.data.totalNumFiles} files processed`,e.data.isReady?(this.generatingZipStatus="ready",this.downloadZipUrl=this.siteInfo.publicSiteInfo.baseApiUrl+"DocumentUpload/DownloadZipGen?vid="+this.generatingZipId):window.setTimeout(()=>t(),750)},e=>{this.generatingZipStatus=null,alert("Zip file generation failed: "+e.data.exceptionMessage)})},this.generatingZipStatus="Starting...","/api/DocumentUpload/StartFullZipGeneration");this.committee&&(e+="?committeeId="+this.committee.committeeId),this.$http.get(e).then(e=>{this.generatingZipId=e.data.statusId,this.generatingZipStatus="Waiting for update...",window.setTimeout(()=>t(),1250)},e=>{this.generatingZipStatus=null,alert("Failed to start zip generation: "+e.data.exceptionMessage)})}getDirectoryFullPath(e){let t=e.name,i=e.parentDirectory;for(;i;)t=i.name+"/"+t,i=i.parentDirectory;return t=this.committee?r.DirName_Committees+"/"+this.committee.committeeId+"/"+t:t}FindDirectoryByPath(e){if(this.documentTree){var i,s=(e=this.committee&&HtmlUtil.startsWith(e,r.DirName_Committees)&&-1!==(i=(e=e.substr(r.DirName_Committees.length+1)).indexOf("/"))?e.substr(i+1):e).split("/");let t=this.documentTree;for(let e=0;e<s.length&&(t=t.getSubDirectoryByName(s[e]));++e);return t}}updateFileFilter(){const t=(this.fileSearch.all||"").toLowerCase();this.searchFileList=_.filter(this.fullSearchFileList,e=>-1!==(e.localFilePath||"").toLowerCase().indexOf(t)||-1!==(e.uploadDateString||"").toLowerCase().indexOf(t)||-1!==(e.uploaderFullName||"").toLowerCase().indexOf(t)),setTimeout(()=>{var e=document.getElementById("documents-area"),t=e.style.display;e.style.display="none",e.offsetHeight;e.style.display=t},50)}hookUpFileDragging(){this.canManage&&setTimeout(()=>{$(".droppable").droppable({drop:(e,t)=>{const i=this.getSelectedDirectoryPath();$(t.draggable).draggable("option","revert","false");const s=$(e.target).attr("data-folder-path").trim();this.$scope.$apply(()=>{this.isLoading=!0;var e={relativeS3Path:this.selectedFile.relativeS3Path,action:"move",newFileName:"",sourceFolderPath:i,destinationFolderPath:s};this.selectedFile=null,this.$http.put("/api/ManageDocuments/MoveFile",e).then(()=>{this.isLoading=!1,this.docsHttpCache.removeAll(),this.Refresh()},e=>{this.isLoading=!1;e=e.exceptionMessage||e.message||e;alert("Failed to move file: "+e)})})},hoverClass:"Document_Folder_DropHover"}),$(".draggable").draggable({distance:10,revert:!0,helper:"clone",opacity:1,containment:"document",appendTo:"body",start:e=>{e=$(e.target).attr("id").substring("File_".length);const t=parseInt(e);this.$scope.$apply(()=>{var e=this.selectedDirectory.files[t];this.selectedFile=e})}})},250)}onDirectoryClicked(e){var t;this.selectedDirectory===e?this.shouldShowSubdirectories=!this.shouldShowSubdirectories:this.shouldShowSubdirectories=!0,this.selectedDirectory=e,this.selectedFile=null,this.fileSearch.all=null,this.hookUpFileDragging(),this.SortFiles(),this.committee?(t=r.DirName_Committees+"/"+this.committee.committeeId+"/",this.$location.search("directory",e.fullDirectoryPath.substring(t.length))):this.$location.search("directory",e.fullDirectoryPath)}createDirectory(){this.createUnderParentDirName=null,this.committee&&(this.createUnderParentDirName=r.DirName_Committees+"/"+this.committee.committeeId),this.shouldShowCreateFolderModal=!0,setTimeout(()=>$("#CreateDirectoryNameTextBox").focus(),50)}createSubDirectory(){this.createUnderParentDirName=this.selectedDirectory.fullDirectoryPath,this.shouldShowCreateFolderModal=!0,setTimeout(()=>$("#CreateDirectoryNameTextBox").focus(),50)}SetFileSortType(e){this.fileSortType===e?this.filesSortDescend=!this.filesSortDescend:this.filesSortDescend=!1,this.fileSortType=e,window.localStorage[r.LocalStorageKey_SortType]=this.fileSortType,window.localStorage[r.LocalStorageKey_SortDirection]=this.filesSortDescend,this.SortFiles()}SortFiles(){this.selectedDirectory&&this.selectedDirectory.files&&("title"!==this.fileSortType&&"uploadDate"!==this.fileSortType||(this.selectedDirectory.files=_.sortBy(this.selectedDirectory.files,this.fileSortType)),this.filesSortDescend)&&this.selectedDirectory.files.reverse()}onCreateDirectoryClicked(){this.isLoading=!0;let e="/api/ManageDocuments/CreateDirectory?folderName="+encodeURIComponent(this.newDirectoryName);e+="&parentFolderPath=",this.createUnderParentDirName&&(e+=encodeURIComponent(this.createUnderParentDirName)),this.$http.put(e,null).then(()=>{this.docsHttpCache.removeAll(),this.newDirectoryName="",this.Refresh(),this.shouldShowCreateFolderModal=!1},e=>{alert("Failed to create the folder: "+e.data.exceptionMessage),this.isLoading=!1})}onCancelAddDirectory(){this.shouldShowCreateFolderModal=!1,this.newDirectoryName=""}onFileClicked(e){this.selectedFile=e}RenameDocument(t){if(t){let e=prompt("Enter the new name for the file",t.title);null!==e&&(64<e.length&&(e=e.substr(0,64)),this.isLoading=!0,t={relativeS3Path:t.relativeS3Path,action:"rename",newTitle:e,sourceFolderPath:this.getSelectedDirectoryPath(),destinationFolderPath:""},this.$http.put("/api/ManageDocuments/RenameFile",t).then(()=>{this.docsHttpCache.removeAll(),this.Refresh()},e=>{this.isLoading=!1,alert("Failed to rename: "+e.data.exceptionMessage),this.Refresh()}))}}DeleteDocument(e){confirm("Are you sure you want to delete this file?")&&(this.isLoading=!0,this.$http.delete("/api/ManageDocuments?docPath="+e.relativeS3Path).then(()=>{this.docsHttpCache.removeAll(),this.Refresh()},e=>{this.isLoading=!1,alert("Failed to delete file: "+e.data.exceptionMessage),this.Refresh()}))}RenameSelectedDirectory(){if(this.selectedDirectory){let e=prompt("Enter the new name for the directory",this.selectedDirectory.name);var t,i;null!==e&&(32<e.length&&(e=e.substr(0,32)),this.isLoading=!0,t=encodeURIComponent(this.getSelectedDirectoryPath()),i=encodeURIComponent(e),this.$http.put("/api/ManageDocuments/RenameDirectory?directoryPath="+t+"&newDirectoryName="+i,null).then(()=>{this.docsHttpCache.removeAll(),this.selectedDirectory.name=e,this.Refresh()},e=>{this.isLoading=!1,alert("Failed to rename directory: "+e.data.exceptionMessage)}))}}DeleteSelectedDirectory(){var e;this.selectedDirectory&&(0<this.selectedDirectory.files.length?alert("You can not delete a folder that contains files. Please delete or move all files from the folder."):confirm("Are you sure you want to delete this folder?")&&(this.isLoading=!0,e=this.getSelectedDirectoryPath(),this.$http.delete("/api/ManageDocuments/DeleteDirectory?directoryPath="+encodeURIComponent(e)).then(()=>{this.docsHttpCache.removeAll(),this.Refresh()},e=>{this.isLoading=!1,alert("Failed to delete the folder: "+e.data.exceptionMessage)})))}getFileIcon(e){return n.HtmlUtil2.getFileIcon(e)}isGenericIcon(e){return"/assets/images/FileIcons/GenericFileIcon.png"===n.HtmlUtil2.getFileIcon(e.fileName)}getDisplayExtension(e){return"."+e.fileName.split(".").pop().toLowerCase()}hookupParentDirs(t){t.fullDirectoryPath=this.getDirectoryFullPath(t),t.getSubDirectoryByName=a.prototype.getSubDirectoryByName,t.subdirectories&&t.subdirectories.forEach(e=>{e.parentDirectory=t,e.directoryDepth=t.directoryDepth+1,this.hookupParentDirs(e)})}Refresh(){let t=null;this.selectedDirectory?t=this.getSelectedDirectoryPath():HtmlUtil.isNullOrWhitespace(this.$location.search().directory)||(t=this.committee?r.DirName_Committees+"/"+this.committee.committeeId+"/"+this.$location.search().directory:this.$location.search().directory),this.isLoading=!0,this.selectedDirectory=null,this.selectedFile=null,this.getDocsUri="/api/ManageDocuments",this.committee&&(this.getDocsUri+="/Committee/"+this.committee.committeeId),this.$http.get(this.getDocsUri,{cache:this.docsHttpCache}).then(e=>{this.isLoading=!1,this.documentTree=e.data,this.documentTree.getSubDirectoryByName=a.prototype.getSubDirectoryByName,this.documentTree.subdirectories.forEach(e=>{e.directoryDepth=0,this.hookupParentDirs(e)});const i=[],s=t=>{_.each(t.files,e=>{e.localFilePath=t.name+"/"+e.title,e.uploadDateString=moment(e.uploadDate).format("MMMM D, YYYY")}),Array.prototype.push.apply(i,t.files),_.each(t.subdirectories,s)};s(this.documentTree),this.fullSearchFileList=i,t&&(this.selectedDirectory=this.FindDirectoryByPath(t),this.SortFiles()),this.hookUpFileDragging()},e=>{alert("Failed to retrieve documents, please contact technical support. No need to worry, no documents have been lost."),this.isLoading=!1,console.log("Failed to retrieve docs: "+e.data.exceptionMessage)})}}r.$inject=["$http","$rootScope","$cacheFactory","$scope","SiteInfo","fellowResidents","$location"],r.LocalStorageKey_SortType="DocsInfo_FileSortType",r.LocalStorageKey_SortDirection="DocsInfo_FileSortDirection",r.DirName_Committees="Committees_Root",r.ViewableExtensions=["jpg","jpeg","png","pdf","txt"],n.DocumentsController=r}(Ally=Ally||{}),CA.angularApp.component("documents",{bindings:{committee:"<"},templateUrl:"/ngApp/common/documents.html",controller:Ally.DocumentsController}),function(e){class n{}e.InfoItem=n;class t{constructor(e,t,i,s,a){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.$cacheFactory=s,this.fellowResidents=a,this.isBodyMissing=!1,this.canManage=!1,this.headerText="Information and Frequently Asked Questions (FAQs)",this.tinyMceDidNotLoad=!1,this.editingInfoItem=new n,"home"===AppConfig.appShortName&&(this.headerText="Home Notes")}$onInit(){this.hideDocuments=this.$rootScope.userInfo.isRenter&&!this.siteInfo.privateSiteInfo.rentersCanViewDocs,this.canManage=this.siteInfo.userInfo.isAdmin||this.siteInfo.userInfo.isSiteManager,this.committee&&!this.canManage&&this.fellowResidents.isCommitteeMember(this.committee.committeeId).then(e=>this.canManage=e),this.faqsHttpCache=this.$cacheFactory.get("faqs-http-cache")||this.$cacheFactory("faqs-http-cache"),this.retrieveInfo(),e.HtmlUtil2.initTinyMce("tiny-mce-editor",500).then(e=>{this.tinyMceEditor=e,this.tinyMceDidNotLoad=!e})}retrieveInfo(){this.isLoadingInfo=!0,this.getUri||(this.getUri="/api/InfoItem",this.committee&&(this.getUri="/api/InfoItem/Committee/"+this.committee.committeeId)),this.$http.get(this.getUri,{cache:this.faqsHttpCache}).then(e=>{this.isLoadingInfo=!1,this.infoItems=e.data,setTimeout(()=>{for(let e=0;e<this.infoItems.length;++e)i.makeLinksOpenNewTab("info-item-body-"+e)},500)})}scrollToInfo(e){document.getElementById("info-item-title-"+e).scrollIntoView()}onStartEditInfoItem(e){this.editingInfoItem=jQuery.extend({},e),this.tinyMceEditor&&this.tinyMceEditor.setContent(this.editingInfoItem.body),window.scrollTo(0,document.body.scrollHeight)}onSubmitItem(){this.tinyMceEditor&&(this.editingInfoItem.body=this.tinyMceEditor.getContent()),this.isBodyMissing=HtmlUtil.isNullOrWhitespace(this.editingInfoItem.body);var e=$("#info-item-edit-form");e.validate(),e.valid()&&!this.isBodyMissing&&(this.committee&&(this.editingInfoItem.committeeId=this.committee.committeeId),this.isLoadingInfo=!0,e=()=>{this.isLoadingInfo=!1,this.tinyMceEditor&&this.tinyMceEditor.setContent(""),this.editingInfoItem=new n,this.faqsHttpCache.removeAll(),this.retrieveInfo()},("number"==typeof this.editingInfoItem.infoItemId?this.$http.put("/api/InfoItem",this.editingInfoItem):this.$http.post("/api/InfoItem",this.editingInfoItem)).then(e))}onDeleteInfoItem(e){confirm("Are you sure you want to delete this information?")&&(this.isLoadingInfo=!0,this.$http.delete("/api/InfoItem/"+e.infoItemId).then(()=>{this.isLoadingInfo=!1,this.faqsHttpCache.removeAll(),this.retrieveInfo(),"number"==typeof this.editingInfoItem.infoItemId&&this.editingInfoItem.infoItemId===e.infoItemId&&(this.editingInfoItem=new n,this.tinyMceEditor)&&this.tinyMceEditor.setContent("")}))}cancelInfoItemEdit(){this.editingInfoItem=new n,this.tinyMceEditor&&this.tinyMceEditor.setContent("")}}t.$inject=["$http","$rootScope","SiteInfo","$cacheFactory","fellowResidents"],e.FAQsController=t;class i{static showFileUploadAlert(e,t){let i="";"unsupported-file-type"===e?i="Unsupported format "+t:console.log("error uploading file",e,t),$('<div class="alert"> <button type="button" class="close" data-dismiss="alert">&times;</button><strong>File upload error</strong> '+i+" </div>").prependTo("#alerts")}static makeLinksOpenNewTab(e){window.setTimeout(()=>{$("a","#"+e).each((e,t)=>{t.href&&("#"===t.href[0]||-1<t.href.indexOf(AppConfig.baseTld))||$(t).attr("target","_blank")})},100)}}e.RichTextHelper=i}(Ally=Ally||{}),CA.angularApp.component("faqs",{bindings:{committee:"<?"},templateUrl:"/ngApp/common/FAQs.html",controller:Ally.FAQsController}),function(t){class e{constructor(e,t,i,s,a){this.$http=e,this.siteInfo=t,this.$timeout=i,this.uiGridConstants=s,this.$scope=a,this.shouldShowModal=!1,this.isLoading=!1,this.HistoryPageSize=50,this.isUnitColVisible=!1}$onInit(){this.homeName=AppConfig.homeName||"Unit";this.transactionGridOptions={columnDefs:[{field:"transactionDate",displayName:"Date",width:70,type:"date",cellFilter:"date:'shortDate'",enableFiltering:!1},{field:"description",displayName:"Description",enableFiltering:!0,filter:{placeholder:"search"}},{field:"categoryDisplayName",editModelField:"financialCategoryId",displayName:"Category",width:170,editDropdownOptionsArray:[],enableFiltering:!0},{field:"unitGridLabel",editModelField:"associatedUnitId",displayName:this.homeName,width:120,enableFiltering:!0},{field:"amount",displayName:"Amount",width:140,type:"number",cellFilter:"currency",enableFiltering:!0,aggregationType:()=>{var e=this.transactionGridApi.grid.rows.filter(e=>e.visible&&e.entity&&!isNaN(e.entity.amount));let t=0;return e.forEach(e=>t+=e.entity.amount||0),t},footerCellTemplate:'<div class="ui-grid-cell-contents">Total: {{col.getAggregationValue() | currency }}</div>'}],enableFiltering:!0,enableSorting:!0,showColumnFooter:!0,enableHorizontalScrollbar:window.innerWidth<640?this.uiGridConstants.scrollbars.ALWAYS:this.uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:this.uiGridConstants.scrollbars.NEVER,enableColumnMenus:!1,enablePaginationControls:!0,minRowsToShow:this.HistoryPageSize,paginationPageSize:this.HistoryPageSize,paginationPageSizes:[this.HistoryPageSize],enableRowHeaderSelection:!1,onRegisterApi:e=>{this.transactionGridApi=e}}}populateGridUnitLabels(){return this.$http.get("/api/MemberUnit/NamesOnly").then(e=>{const i=e.data;_.each(this.allFinancialTxns,t=>{var e;t.associatedUnitId&&(e=i.find(e=>e.unitId===t.associatedUnitId))&&(t.unitGridLabel=e.name)})},e=>{console.log("Failed to load units")})}showModal(){this.shouldShowModal=!0,this.refreshEntries()}refreshEntries(){this.isLoading=!0,this.$http.get("/api/OwnerLedger/MyTransactions").then(e=>{this.isLoading=!1,this.allFinancialTxns=e.data.entries,this.ownerFinanceTxNote=e.data.ownerFinanceTxNote,this.ownerBalance=e.data.ownerBalance;var e=this.allFinancialTxns.map(e=>e.associatedUnitId).filter((e,t,i)=>i.indexOf(e)===t),t=this.transactionGridOptions.columnDefs.find(e=>"unitGridLabel"===e.field);t&&(t.visible=1<e.length||1<this.siteInfo.userInfo.usersUnits.length,this.isUnitColVisible=t.visible);const i=()=>{1<this.allFinancialTxns.length&&(this.filterEndDate=this.allFinancialTxns[0].transactionDate,this.filterStartDate=this.allFinancialTxns[this.allFinancialTxns.length-1].transactionDate),this.onFilterDateRangeChange()};this.$timeout(()=>{this.isUnitColVisible?this.populateGridUnitLabels().then(i,i):i()},100)},()=>{this.isLoading=!1})}exportTransactionsCsv(){var e=[{headerText:"Date",fieldName:"transactionDate",dataMapper:function(e){return e?moment(e).format("YYYY-MM-DD"):""}},{headerText:"Description",fieldName:"description"},{headerText:"Category",fieldName:"categoryDisplayName"},{headerText:AppConfig.homeName,fieldName:"unitGridLabel"},{headerText:"Amount",fieldName:"amount"}],e=t.createCsvString(this.transactionGridOptions.data,e);t.HtmlUtil2.downloadCsv(e,"Owner-Transactions.csv")}onFilterDateRangeChange(){this.filterStartDate&&this.filterEndDate&&this.$timeout(()=>{var e=this.allFinancialTxns.filter(e=>e.transactionDate>=this.filterStartDate&&e.transactionDate<=this.filterEndDate);this.transactionGridOptions.data=e,this.transactionGridOptions.virtualizationThreshold=e.length+1,this.transactionGridOptions.data.length<=this.HistoryPageSize&&(this.transactionGridOptions.enablePagination=!1,this.transactionGridOptions.enablePaginationControls=!1)},10)}}e.$inject=["$http","SiteInfo","$timeout","uiGridConstants","$scope"],t.ResidentTransactionsController=e}(Ally=Ally||{}),CA.angularApp.component("residentTransactions",{templateUrl:"/ngApp/common/financial/resident-transactions.html",controller:Ally.ResidentTransactionsController}),function(e){class t{constructor(e){this.$routeParams=e}$onInit(){var t=(this.$routeParams.appName||"").toLowerCase(),i=[CondoAllyAppConfig,HomeAppConfig,HOAAppConfig,NeighborhoodAppConfig,BlockClubAppConfig];let s=null;for(let e=0;e<i.length;++e)if(i[e].appShortName.toLowerCase()===t){s=i[e].baseTld;break}s=s||"condoally.com",s="myhoaally.org";var e=`https://${this.$routeParams.shortName}.${s}/`;window.location.href=e}}t.$inject=["$routeParams"],e.GroupRedirectController=t}(Ally=Ally||{}),CA.angularApp.component("groupRedirect",{templateUrl:"/ngApp/common/group-redirect.html",controller:Ally.GroupRedirectController}),function(a){class e{constructor(){this.recipientType="board"}}class t{constructor(e,t,i,s,a){this.$http=e,this.fellowResidents=t,this.$rootScope=i,this.siteInfo=s,this.$scope=a,this.isLoadingEmail=!1,this.showDiscussionEveryoneWarning=!1,this.showDiscussionLargeWarning=!1,this.showUseDiscussSuggestion=!1,this.showSendConfirmation=!1,this.showEmailForbidden=!1,this.showRestrictedGroupWarning=!1,this.defaultSubject="A message from your neighbor",this.memberLabel="resident",this.memberPageName="Residents",this.shouldShowSendAsBoard=!1}$onInit(){this.groupEmailDomain="inmail."+AppConfig.baseTld,this.messageObject=new e,this.showSendEmail=!0,this.committee?(this.messageObject.committeeId=this.committee.committeeId,this.defaultSubject="A message from a committee member"):(this.loadGroupEmails(),this.$scope.$on("prepAssessmentEmailToBoard",(e,t)=>this.prepBadAssessmentEmailForBoard(t)),"pta"===AppConfig.appShortName?(this.defaultSubject="A message from a PTA member",this.memberLabel="member",this.memberPageName="Members"):this.defaultSubject="A message from your neighbor"),this.messageObject.subject=this.defaultSubject}loadGroupEmails(){this.isLoadingEmail=!0,this.fellowResidents.getGroupEmailObject().then(e=>{this.isLoadingEmail=!1,this.availableEmailGroups=e.filter(e=>"Treasurer"!==e.recipientType),0<this.availableEmailGroups.length&&(this.defaultMessageRecipient=this.availableEmailGroups[0],this.selectedRecipient=this.availableEmailGroups[0],this.onSelectEmailGroup())})}prepBadAssessmentEmailForBoard(e){var e=e.split("|"),t=e[0];let i=null;1<e.length&&(i=e[1]),this.messageObject.recipientType="board",this.messageObject.subject="Question About Assessment Amount",i?this.messageObject.message="Hello Boardmembers,\n\nOur association's home page says my next payment of $"+t+" will cover "+i+", but I believe that is incorrect. My records indicate my next payment of $"+t+" should pay for [INSERT PROPER DATE HERE]. What do you need from me to resolve the issue?\n\n- "+this.siteInfo.userInfo.firstName:this.messageObject.message="Hello Boardmembers,\n\nOur association's home page says my assessment payment is $"+t+", but I believe that is incorrect. My records indicate my assessment payments should be $INSERT_PROPER_AMOUNT_HERE. What do you need from me to resolve the issue?\n\n- "+this.siteInfo.userInfo.firstName,document.getElementById("send-email-panel").scrollIntoView()}onSendEmail(){$("#message-form").validate(),$("#message-form").valid()&&(this.isLoadingEmail=!0,this.$rootScope.dontHandle403=!0,analytics.track("sendEmail",{recipientId:this.messageObject.recipientType}),this.$http.post("/api/Email/v2",this.messageObject).then(()=>{this.$rootScope.dontHandle403=!1,this.isLoadingEmail=!1,this.messageObject=new e,this.selectedRecipient=this.defaultMessageRecipient,this.messageObject.recipientType=this.defaultMessageRecipient.recipientType,this.messageObject.subject=this.defaultSubject,this.onSelectEmailGroup(),this.committee&&(this.messageObject.committeeId=this.committee.committeeId),this.showSendConfirmation=!0,this.showSendEmail=!1},e=>{this.isLoadingEmail=!1,this.$rootScope.dontHandle403=!1,403===e.status?this.showEmailForbidden=!0:alert("Unable to send email: "+e.data.exceptionMessage)}))}onSelectEmailGroup(){var e,t,i,s;this.selectedRecipient&&(this.messageObject.recipientType=this.selectedRecipient.recipientType,e=this.messageObject.recipientType.toUpperCase()===a.FellowResidentsService.CustomRecipientType,this.messageObject.customRecipientShortName=e?this.selectedRecipient.recipientTypeName:null,this.groupEmailAddress=(e?this.selectedRecipient.recipientTypeName:this.selectedRecipient.recipientType)+"."+this.siteInfo.publicSiteInfo.shortName+"@inmail."+AppConfig.baseTld,this.showDiscussionEveryoneWarning=!1,t=-1!==this.messageObject.recipientType.toLowerCase().indexOf("owners"),!this.showDiscussionEveryoneWarning&&t&&30<this.siteInfo.privateSiteInfo.numUnits?this.showDiscussionLargeWarning=!0:this.showDiscussionLargeWarning=!1,t=-1!==this.messageObject.recipientType.toLowerCase().indexOf("discussion"),i=-1!==this.messageObject.recipientType.toLowerCase().indexOf("board"),s=-1!==this.messageObject.recipientType.toLowerCase().indexOf("propertymanagers"),this.showDiscussionEveryoneWarning=!1,this.showDiscussionLargeWarning=!1,this.showUseDiscussSuggestion=!t&&!i&&!s&&AppConfig.isChtnSite&&!e,this.showRestrictedGroupWarning=this.selectedRecipient.isRestrictedGroup,this.shouldShowSendAsBoard=a.FellowResidentsService.isNonPropMgrBoardPosition(this.siteInfo.userInfo.boardPosition)&&!i)}}t.$inject=["$http","fellowResidents","$rootScope","SiteInfo","$scope"],a.GroupSendEmailController=t}(Ally=Ally||{}),CA.angularApp.component("groupSendEmail",{bindings:{committee:"<?"},templateUrl:"/ngApp/common/group-send-email.html",controller:Ally.GroupSendEmailController}),function(e){class t{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.$timeout=i,this.isLoading=!1}$onInit(){this.isLoading=!0,this.$timeout(()=>this.loadNewsStories(),200)}loadNewsStories(){HtmlUtil.getSubdomain(window.location.host);this.isLoading=!0;let e,t;t="US"===this.siteInfo.privateSiteInfo.country?(e="https://localnewsally.azurewebsites.net/api/LocalNews",{clientId:"1001A194-B686-4C45-80BC-ECC0BB4916B4",chicagoWard:this.siteInfo.privateSiteInfo.chicagoWard,zipCode:this.siteInfo.privateSiteInfo.zipCode,cityNeighborhood:this.siteInfo.privateSiteInfo.localNewsNeighborhoodQuery,city:this.siteInfo.privateSiteInfo.groupAddress.city,state2Char:this.siteInfo.privateSiteInfo.groupAddress.state}):(e="https://localnewsally.azurewebsites.net/api/LocalNews/International/MajorCity",{clientId:"1001A194-B686-4C45-80BC-ECC0BB4916B4",countryCode:this.siteInfo.privateSiteInfo.country,city:this.siteInfo.privateSiteInfo.groupAddress.city}),this.$http.get(e,{cache:!0,params:t}).then(e=>{this.isLoading=!1,this.localNewStories=e.data})}}t.$inject=["$http","SiteInfo","$timeout"],e.LocalNewsFeedController=t}(Ally=Ally||{}),CA.angularApp.component("localNewsFeed",{templateUrl:"/ngApp/common/local-news-feed.html",controller:Ally.LocalNewsFeedController}),function(e){class t{}class i{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.$timeout=i,this.isLoading=!1,this.viewingResults=null,this.historyGridOptions={data:[],columnDefs:[{field:"sendDateUtc",displayName:"Sent",cellFilter:"date:'short'",type:"date"},{field:"numPaperLettersSent",displayName:"# Letters",type:"number",width:100},{field:"numEmailsSent",displayName:"# Emails",type:"number",width:100},{field:"amountPaid",displayName:"Mailing Fee",cellFilter:"currency",type:"number",width:130},{field:"sendingReason",displayName:"Reason",width:150},{field:"mailingResultObject",displayName:"",width:130,cellTemplate:'<div class="ui-grid-cell-contents"><span data-ng-click="grid.appScope.$ctrl.showMailingResults( row.entity )" class="text-link">View Results</span></div>'}],enableSorting:!0,enableHorizontalScrollbar:0,enableVerticalScrollbar:0,enableColumnMenus:!1,minRowsToShow:5,onRegisterApi:e=>{this.historyGridApi=e,HtmlUtil.uiGridFixScroll()}},this.resultsGridOptions={data:[],columnDefs:[{field:"mailingType",displayName:"Type",width:100,type:"string"},{field:"recipientLabel",displayName:"Recipient",width:300,type:"string"},{field:"didSuccessfullySend",displayName:"Did Send",width:100,type:"boolean"},{field:"resultMessage",displayName:"Result Message",cellTemplate:'<div class="ui-grid-cell-contents"><span title="{{row.entity.resultMessage}}">{{row.entity.resultMessage}}</span></div>',type:"string"},{field:"amount",displayName:"Amount",cellFilter:"currency",type:"number"},{field:"balanceForward",displayName:"Balance Fwd",width:130,cellFilter:"currency",type:"number"},{field:"lateFee",displayName:"Late Fee",cellFilter:"currency",type:"number"}],enableSorting:!0,enableHorizontalScrollbar:0,enableVerticalScrollbar:0,enableColumnMenus:!1,minRowsToShow:5,onRegisterApi:e=>{HtmlUtil.uiGridFixScroll()}}}$onInit(){this.refreshHistory()}showMailingResults(t){this.$timeout(()=>{_.forEach(t.mailingResultObject.emailResults,e=>e.mailingType="E-mail"),_.forEach(t.mailingResultObject.paperMailResults,e=>e.mailingType="Paper Letter");let e=[];(e=e.concat(t.mailingResultObject.emailResults,t.mailingResultObject.paperMailResults)).forEach(e=>e.recipientLabel=e.recipientEmail||(e.recipientStreetAddress?e.recipientStreetAddress.oneLiner:"")),this.resultsGridOptions.data=e,this.resultsGridOptions.minRowsToShow=e.length,this.resultsGridOptions.virtualizationThreshold=e.length,this.resultsGridheight=(e.length+1)*this.resultsGridOptions.rowHeight,this.$timeout(()=>{this.viewingResults=t.mailingResultObject},10)},0)}refreshHistory(){this.isLoading=!0,this.$http.get("/api/Mailing/History").then(e=>{this.isLoading=!1,this.historyGridOptions.data=e.data,this.historyGridOptions.minRowsToShow=e.data.length,this.historyGridOptions.virtualizationThreshold=e.data.length},e=>{this.isLoading=!1,alert("Failed to load mailing history: "+e.data.exceptionMessage)})}}i.$inject=["$http","SiteInfo","$timeout"],e.MailingHistoryController=i}(Ally=Ally||{}),CA.angularApp.component("mailingHistory",{templateUrl:"/ngApp/common/mailing/mailing-history.html",controller:Ally.MailingHistoryController}),function(r){class i{}class s{constructor(e,t,i,s,a,n,o){this.$http=e,this.siteInfo=t,this.fellowResidents=i,this.wizardHandler=s,this.$scope=a,this.$timeout=n,this.$location=o,this.isLoading=!1,this.selectedEntries=[],this.numEmailsToSend=0,this.numPaperLettersToSend=0,this.paperInvoiceDollars=2,this.isAdmin=!1,this.numInvalidMailingAddresses=0,this.numAddressesToBulkValidate=0,this.shouldShowAutoUnselect=!1,this.paymentType="creditCard",this.settings=new r.ChtnSiteSettings,this.stripeApi=null,this.stripeCardElement=null,this.payButtonText="Pay $10";e='<div class="ui-grid-cell-contents">$<input type="number" style="width: 90%;" data-ng-model="row.entity[col.field]" autocomplete="off" data-lpignore="true" data-form-type="other" /></div>';this.homesGridOptions={data:[],columnDefs:[{field:"homeNames",displayName:AppConfig.homeName,width:210},{field:"ownerNames",displayName:"Owners"},{field:"amountDue",displayName:"Amount Due",width:120,cellTemplate:e},{field:"balanceForward",displayName:"Balance Forward",width:140,cellTemplate:e},{field:"lateFee",displayName:"Late Fee",width:120,cellTemplate:e},{field:"total",displayName:"Total",width:90,cellTemplate:'<div class="ui-grid-cell-contents">{{ row.entity.amountDue + (row.entity.balanceForward || 0) + (row.entity.lateFee || 0) | currency }}</div>'}],enableSorting:!0,enableHorizontalScrollbar:0,enableVerticalScrollbar:0,enableColumnMenus:!1,minRowsToShow:5,enableRowHeaderSelection:!0,multiSelect:!0,enableSelectAll:!0,onRegisterApi:t=>{this.gridApi=t;const e=()=>{var e=t.selection.getSelectedRows();this.selectedEntries=e};t.selection.on.rowSelectionChanged(a,()=>e()),t.selection.on.rowSelectionChangedBatch(a,()=>e()),HtmlUtil.uiGridFixScroll()}}}$onInit(){this.authToken=this.siteInfo.authToken,this.isAdmin=this.siteInfo.userInfo.isAdmin,this.loadMailingInfo(),this.$scope.$on("wizard:stepChanged",(e,t)=>{this.activeStepIndex=t.index,console.log("wizard:stepChanged, step "+this.activeStepIndex),1===this.activeStepIndex&&this.$timeout(()=>{for(const e of this.selectedEntries)this.gridApi.selection.selectRow(e)},250),2===this.activeStepIndex?window.setTimeout(()=>document.getElementById("delivery-method-header").scrollIntoView(!0),50):3===this.activeStepIndex&&(this.numEmailsToSend=_.filter(this.selectedEntries,e=>e.shouldSendEmail).length,this.numPaperLettersToSend=_.filter(this.selectedEntries,e=>e.shouldSendPaperMail).length,0<this.numPaperLettersToSend)&&this.$timeout(()=>this.initStripePayment(),100)}),this.shouldShowAutoUnselect=this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled&&50<=this.siteInfo.privateSiteInfo.assessmentFrequency,this.shouldShowAutoUnselect&&(this.autoUnselectLabel=s.getCurrentPayPeriodLabel(this.siteInfo.privateSiteInfo.assessmentFrequency),this.autoUnselectLabel||(this.shouldShowAutoUnselect=!1));try{this.stripeApi=Stripe(StripeApiKey)}catch(e){console.log(e)}}static getCurrentPayPeriod(e){var t,i,e=FrequencyIdToInfo(e);return e?(i={year:(t=new Date).getFullYear(),period:-1,period1Based:-1},"month"===e.intervalName?i.period=t.getMonth():"quarter"===e.intervalName?i.period=Math.floor(t.getMonth()/3):"half-year"===e.intervalName?i.period=Math.floor(t.getMonth()/6):"year"===e.intervalName&&(i.period=0),i.period1Based=i.period+1,i):null}static getCurrentPayPeriodLabel(e){var t,i=FrequencyIdToInfo(e);return i?(i=GetLongPayPeriodNames(i.intervalName))?(t=(e=s.getCurrentPayPeriod(e)).year.toString(),i[e.period]+" "+t):(new Date).getFullYear().toString():null}customizeNotes(e){e.overrideNotes=this.fullMailingInfo.notes||" "}uncustomizeNotes(e){e.overrideNotes=null}setAllDues(){_.forEach(this.fullMailingInfo.mailingEntries,e=>e.amountDue=this.allDuesSetAmount)}getTotalDue(e){return e.amountDue-Math.abs(e.balanceForward||0)+(e.lateFee||0)}onShouldSendPaperMailChange(e){e.shouldSendPaperMail?this.testAddressRequiredFields(e):(e.isValidMailingAddress=e.validationMessage=null,this.numInvalidMailingAddresses=_.filter(this.selectedEntries,e=>!1===e.isValidMailingAddress).length)}onAddressChanged(e){e.shouldSendPaperMail&&this.testAddressRequiredFields(e)}testAddressRequiredFields(t){return t.isValidating=!0,t.isValidMailingAddress=null,t.validationMessage=null,this.$http.post("/api/Mailing/TestMailability",t.streetAddressObject).then(e=>{t.isValidating=!1,t.isValidMailingAddress=e.data.isValid,t.validationMessage=e.data.verificationMessage,this.numInvalidMailingAddresses=_.filter(this.selectedEntries,e=>!1===e.isValidMailingAddress).length},e=>{t.isValidating=!1,t.isValidMailingAddress=!1,t.validatedAddress=null,t.validationMessage="Address validation failed: "+e.data.exceptionMessage})}validateAddress(t){t.isValidating=!0,t.isValidMailingAddress=null;var e="/api/Mailing/VerifyAddress?address="+encodeURIComponent(JSON.stringify(t.streetAddressObject));return this.$http.get(e).then(e=>{t.isValidating=!1,t.isValidMailingAddress=e.data.isValid,t.validationMessage=e.data.verificationMessage,t.isValidMailingAddress&&(t.validatedAddress=e.data.parsedStreetAddress.multiLiner)},e=>{t.isValidating=!1,t.isValidMailingAddress=!1,t.validatedAddress=null,t.validationMessage=e.data.exceptionMessage})}previewInvoice(t){var e=new i;e.invoiceTitleString=this.fullMailingInfo.invoiceTitleString,e.dueDateString=this.fullMailingInfo.dueDateString,e.duesLabel=this.fullMailingInfo.duesLabel,e.fromAddress=this.fullMailingInfo.fromStreetAddress,e.mailingInfo=t,e.notes=t.overrideNotes||this.fullMailingInfo.notes,this.isLoading=!0,t.wasPopUpBlocked=!1,this.$http.post("/api/Mailing/Preview/Invoice",e).then(e=>{this.isLoading=!1;e=this.siteInfo.publicSiteInfo.baseApiUrl+"PublicMailing/Preview/Invoice/"+e.data.previewId,e=window.open(e,"_blank");t.wasPopUpBlocked=!e||e.closed||void 0===e.closed},e=>{this.isLoading=!1,alert("Failed to preview invoice: "+e.data.exceptionMessage)})}onFinishedWizard(){0===this.numPaperLettersToSend?0===this.numEmailsToSend?alert("No emails or paper letters selected to send."):this.submitFullMailingAfterCharge():this.submitCardToStripe()}submitFullMailingAfterCharge(){this.isLoading=!0,this.$http.post("/api/Mailing/Send/Invoice",this.fullMailingInfo).then(e=>{this.isLoading=!1;e=`Your invoices have been successfully sent${e.data.hadErrors?", but there were errors":""}. You can view the status in the history tab.`;alert(e),this.$location.path("/Mailing/History")},e=>{this.isLoading=!1,alert("There was a problem sending your mailing, none were sent and you were not charged. Error: "+e.data.exceptionMessage)})}loadMailingInfo(){this.isLoading=!0,this.$http.get("/api/Mailing/RecipientInfo").then(e=>{this.isLoading=!1,this.fullMailingInfo=e.data,this.homesGridOptions.data=e.data.mailingEntries,this.homesGridOptions.minRowsToShow=e.data.mailingEntries.length,this.homesGridOptions.virtualizationThreshold=e.data.mailingEntries.length,this.selectedEntries=_.clone(e.data.mailingEntries)})}scrollToFirstAddressError(){var e=_.find(this.selectedEntries,e=>!1===e.isValidMailingAddress);e&&-1!==(e=_.indexOf(this.selectedEntries,e))&&document.getElementById("recipient-entry-"+e).scrollIntoView()}toggleAllSending(e){if(0!==this.selectedEntries.length)if("email"===e){var t=!this.selectedEntries[0].shouldSendEmail;for(let e=0;e<this.selectedEntries.length;++e)HtmlUtil.isNullOrWhitespace(this.selectedEntries[e].emailAddresses)||!this.selectedEntries[e].amountDue?this.selectedEntries[e].shouldSendEmail=!1:this.selectedEntries[e].shouldSendEmail=t}else{var i=!this.selectedEntries[0].shouldSendPaperMail;for(let e=0;e<this.selectedEntries.length;++e)this.selectedEntries[e].streetAddressObject&&this.selectedEntries[e].amountDue?this.selectedEntries[e].shouldSendPaperMail=i:this.selectedEntries[e].shouldSendPaperMail=!1;if(i){if(0<this.selectedEntries.length){const s=_.clone(this.selectedEntries),a=(this.numAddressesToBulkValidate=s.length,()=>{this.testAddressRequiredFields(s[0]).then(()=>{for(s.splice(0,1);0<s.length&&!s[0].amountDue;)s.splice(0,1);this.numAddressesToBulkValidate=s.length,0<s.length&&a()})});a()}}else _.each(this.selectedEntries,e=>e.isValidMailingAddress=e.validationMessage=null),this.numInvalidMailingAddresses=0}}autoUnselectPaidOwners(){this.isLoading=!0;var e=s.getCurrentPayPeriod(this.siteInfo.privateSiteInfo.assessmentFrequency),e=`/api/PaymentHistory/RecentPayPeriod/${e.year}/`+e.period1Based;this.$http.get(e).then(e=>{this.isLoading=!1;for(const t of this.homesGridOptions.data)0<e.data.filter(e=>-1!==t.unitIds.indexOf(e.unitId)).length?this.gridApi.selection.unSelectRow(t,null):this.gridApi.selection.selectRow(t,null)},e=>{this.isLoading=!1,alert("Failed to retrieve assessment status: "+e.data.exceptionMessage)})}initStripePayment(){var e=this.stripeApi.elements();this.stripeCardElement=e.create("card",{style:{base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}}}),this.stripeCardElement.mount("#stripe-card-element");this.stripeCardElement.on("change",e=>{e.error?this.showStripeError(e.error.message):this.showStripeError(null)})}showStripeError(e){var t=document.getElementById("card-errors");HtmlUtil.isNullOrWhitespace(e)?t.textContent=null:t.textContent=e}async submitCardToStripe(){this.isLoading=!0;var{token:e,error:t}=await this.stripeApi.createToken(this.stripeCardElement);this.isLoading=!1,t?document.getElementById("card-errors").textContent=t.message:(this.fullMailingInfo.stripePaymentToken=e.id,this.submitFullMailingAfterCharge(),this.$scope.$apply())}}s.$inject=["$http","SiteInfo","fellowResidents","WizardHandler","$scope","$timeout","$location"],r.MailingInvoiceController=s}(Ally=Ally||{}),CA.angularApp.component("mailingInvoice",{templateUrl:"/ngApp/common/mailing/mailing-invoice.html",controller:Ally.MailingInvoiceController}),function(e){class t{constructor(e,t,i,s,a){this.$http=e,this.siteInfo=t,this.$routeParams=i,this.$cacheFactory=s,this.$rootScope=a,this.selectedView=null,this.selectedView=this.$routeParams.viewName||"Invoice"}$onInit(){}}t.$inject=["$http","SiteInfo","$routeParams","$cacheFactory","$rootScope"],e.MailingParentController=t}(Ally=Ally||{}),CA.angularApp.component("mailingParent",{templateUrl:"/ngApp/common/mailing/mailing-parent.html",controller:Ally.MailingParentController}),function(i){class t{}i.MaintenanceProject=t;class s{}i.VendorListItem=class{};class n{constructor(e,t,i,s,a){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.maintenanceService=s,this.fellowResidents=a,this.isSiteManager=!1,this.shouldShowEditEquipmentModal=!1,this.shouldShowManageEquipmentModal=!1,this.maintenanceEntries=[],this.assigneeOptions=[],this.entriesSortAscending=!0,this.equipmentTypeOptions=_.map(n.AutocompleteEquipmentTypeOptions,e=>e.text),this.equipmentLocationOptions=_.map(n.AutocompleteLocationOptions,e=>e.text),this.maintenanceTodoListId=i.privateSiteInfo.maintenanceTodoListId}$onInit(){this.equipmentGridOptions={data:[],columnDefs:[{field:"name",displayName:"Name",cellTemplate:'<div class="ui-grid-cell-contents"><span class="text-link" data-ng-if="grid.appScope.$ctrl.isSiteManager" data-ng-click="grid.appScope.$ctrl.editEquipment( row.entity )">{{ row.entity.name }}</span><span data-ng-if="!grid.appScope.$ctrl.isSiteManager">{{ row.entity.name }}</span></div>'},{field:"type",displayName:"Type",width:150},{field:"installDate",displayName:"Installed",width:90,cellFilter:"date:'shortDate'",type:"date"},{field:"initialCost",displayName:"Cost",width:90,cellFilter:"currency",type:"number"},{field:"addedDateUtc",displayName:"Added",width:90,cellFilter:"date:'shortDate'",type:"date"}],multiSelect:!1,enableSorting:!0,enableHorizontalScrollbar:0,enableVerticalScrollbar:1,enableFullRowSelection:!1,enableColumnMenus:!1,enableRowHeaderSelection:!1,onRegisterApi:function(e){HtmlUtil.uiGridFixScroll()}},this.isSiteManager=this.siteInfo.userInfo.isSiteManager,this.fellowResidents.getResidents().then(e=>this.assigneeOptions=_.clone(e)),this.entriesSortField=window.localStorage[n.StorageKey_SortField],this.entriesSortField?this.entriesSortAscending="true"===window.localStorage[n.StorageKey_SortDir]:(this.entriesSortField="entryDate",this.entriesSortAscending=!0),this.loadEquipment().then(()=>this.loadVendors()).then(()=>this.loadProjects()).then(()=>this.loadMaintenanceTodos()).then(()=>this.rebuildMaintenanceEntries())}rebuildMaintenanceEntries(){this.maintenanceEntries=[],_.forEach(this.projects,e=>{var t=new i.MaintenanceEntry;t.project=e,this.maintenanceEntries.push(t)}),_.forEach(this.maintenanceTodos.todoItems,e=>{var t=new i.MaintenanceEntry;t.todo=e,this.maintenanceEntries.push(t)}),this.sortEntries()}loadEquipment(){return this.isLoading=!0,this.$http.get("/api/Maintenance/Equipment").then(e=>{this.isLoading=!1,this.equipmentOptions=e.data,this.equipmentGridOptions.data=JSON.parse(JSON.stringify(this.equipmentOptions));e=new s;e.name="Add New...",e.equipmentId=n.EquipmentId_AddNew,this.equipmentOptions.push(e),_.forEach(this.equipmentOptions,e=>{e.typeTags=[{text:e.type}],e.locationTags=[{text:e.location}]}),this.editingProject&&this.editingProject.equipmentId===n.EquipmentId_AddNew&&0<this.equipmentOptions.length&&(this.editingProject.equipmentId=_.max(this.equipmentOptions,e=>e.equipmentId).equipmentId)},e=>{this.isLoading=!1,alert("Failed to retrieve equipment: "+e.data.exceptionMessage)})}deleteEquipment(){confirm("Are you sure you want to delete this equipment? This action cannot be undone.")&&(this.isLoading=!0,this.$http.delete("/api/Maintenance/Equipment/"+this.editingEquipment.equipmentId).then(()=>{this.isLoading=!1,this.editingEquipment=null,this.shouldShowEditEquipmentModal=!1,this.loadEquipment().then(()=>this.loadProjects()).then(()=>this.rebuildMaintenanceEntries())},e=>{this.isLoading=!1,alert("Failed to delete the equipment: "+e.data.exceptionMessage)}))}loadVendors(){return this.isLoading=!0,this.$http.get("/api/PreferredVendors/ListItems").then(e=>{this.isLoading=!1,this.vendorOptions=e.data},e=>{this.isLoading=!1,alert("Failed to retrieve vendors: "+e.data.exceptionMessage)})}onEquipmentSelectionChange(){this.editingProject.equipmentId===n.EquipmentId_AddNew&&this.openAddNewEquipment()}loadProjects(){return this.isLoading=!0,this.maintenanceService.loadProjects().then(e=>{this.isLoading=!1,this.projects=e},e=>{this.isLoading=!1,alert("Failed to retrieve projects: "+e.exceptionMessage)})}loadMaintenanceTodos(){return this.isLoading=!0,this.$http.get("/api/Todo/MaintenanceList").then(e=>{this.isLoading=!1,this.maintenanceTodos=e.data})}onProjectStartDateChange(){this.editingProject.endDate||(this.editingProject.endDate=this.editingProject.startDate)}openAddNewProject(){this.editingProject=new t,setTimeout(()=>$("#project-title-text-box").focus(),100)}openAddNewEquipment(){this.shouldShowEditEquipmentModal=!0,this.editingEquipment=new s,setTimeout(()=>$("#equipment-name-text-box").focus(),100)}saveProject(){this.isLoading=!0;let e;(e=this.editingProject.maintenanceProjectId?this.$http.put:this.$http.post)("/api/Maintenance/Project",this.editingProject).then(()=>{this.isLoading=!1,this.editingProject=null,this.loadProjects().then(()=>this.rebuildMaintenanceEntries())},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})}onEntryTypeChange(e){"todo"===e?(this.editingTodo=new i.TodoItem,this.editingTodo.owningTodoListId=this.maintenanceTodoListId,this.selectedAssignee=[],this.editingProject&&(this.editingTodo.description=this.editingProject.title),this.editingProject=null,setTimeout(()=>$("#edit-todo-name-text-box").focus(),50)):(this.editingProject=new t,this.editingTodo&&(this.editingProject.title=this.editingTodo.description),this.editingTodo=null,setTimeout(()=>$("#project-title-text-box").focus(),50))}saveTodo(){this.isLoading=!0,this.selectedAssignee&&0<this.selectedAssignee.length&&(this.editingTodo.assignedToUserId=this.selectedAssignee[0].userId);let e;(e=this.editingTodo.todoItemId?this.$http.put:this.$http.post)("/api/Todo/Item",this.editingTodo).then(()=>{this.isLoading=!1,this.editingTodo=null,this.selectedAssignee=[],this.loadMaintenanceTodos().then(()=>this.rebuildMaintenanceEntries())},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})}saveEquipment(){this.isLoading=!0;let e;(e=this.editingEquipment.equipmentId?this.$http.put:this.$http.post)("/api/Maintenance/Equipment",this.editingEquipment).then(()=>{this.isLoading=!1,this.shouldShowEditEquipmentModal=!1,this.loadEquipment()},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})}getEquipmentLocationAutocomplete(t){return HtmlUtil.isNullOrWhitespace(t)?n.AutocompleteLocationOptions:_.where(n.AutocompleteLocationOptions,e=>-1!==e.text.toLowerCase().indexOf(t.toLowerCase()))}getEquipmentTypeAutocomplete(t){return this.editingEquipment.typeTags&&0<this.editingEquipment.typeTags.length&&!HtmlUtil.isNullOrWhitespace(this.editingEquipment.typeTags[0].text)?[]:HtmlUtil.isNullOrWhitespace(t)?n.AutocompleteEquipmentTypeOptions:_.where(n.AutocompleteEquipmentTypeOptions,e=>-1!==e.text.toLowerCase().indexOf(t.toLowerCase()))}editEquipment(e){this.shouldShowEditEquipmentModal=!0,this.editingEquipment=_.clone(e),setTimeout(()=>$("#equipment-name-text-box").focus(),100)}onEditEntry(e){if(e.project)this.editProject(e.project);else{this.editingTodo=_.clone(e.todo);for(let e=0;e<this.assigneeOptions.length;++e)this.assigneeOptions[e].isSelectedAssignee=!1;e=_.find(this.assigneeOptions,e=>e.userId===this.editingTodo.assignedToUserId);e?(e.isSelectedAssignee=!0,this.selectedAssignee=[e]):this.selectedAssignee=[],setTimeout(()=>$("#edit-todo-name-text-box").focus(),100)}}onDeleteEntry(e){confirm("Are you sure you want to delete this entry? This action cannot be undone.")&&(e.project?this.onDeleteProject(e.project):(this.isLoading=!0,this.$http.delete("/api/Todo/Item/"+e.todo.todoItemId).then(()=>{this.isLoading=!1,this.loadMaintenanceTodos().then(()=>this.rebuildMaintenanceEntries())},e=>{this.isLoading=!1,alert("Failed to delete to-do: "+e.data.exceptionMessage)})))}editProject(e){this.editingProject=_.clone(e),setTimeout(()=>$("#project-title-text-box").focus(),100)}onDeleteProject(e){this.isLoading=!0,this.$http.delete("/api/Maintenance/Project/"+e.maintenanceProjectId).then(()=>{this.isLoading=!1,this.loadProjects().then(()=>this.rebuildMaintenanceEntries())},e=>{this.isLoading=!1,alert("Failed to delete: "+e.data.exceptionMessage)})}exportMaintenanceCsv(){"undefined"!=typeof analytics&&analytics.track("exportMaintenanceCsv");var e=[{headerText:"Title",fieldName:"title"},{headerText:"Start Date",fieldName:"startDate",dataMapper:function(e){return e?moment(e).format("YYYY-MM-DD"):""}},{headerText:"End Date",fieldName:"endDate",dataMapper:function(e){return e?moment(e).format("YYYY-MM-DD"):""}},{headerText:"Description",fieldName:"descriptionText"},{headerText:"Cost",fieldName:"cost"},{headerText:"Vendor",fieldName:"vendorCompanyName"},{headerText:"Related Equipment",fieldName:"equipmentName"},{headerText:"Entered By",fieldName:"creatorFullName"},{headerText:"Status",fieldName:"status"},{headerText:"Assigned To",fieldName:"assignedTo"}],t=_.map(_.filter(this.maintenanceEntries,e=>!!e.project),e=>e.project),t=i.createCsvString(t,e);i.HtmlUtil2.downloadCsv(t,"Maintenance.csv")}sortEntries(){this.maintenanceEntries=_.sortBy(this.maintenanceEntries,e=>"status"===this.entriesSortField?e.project?e.project.status:"ZZZZZ":"startDate"===this.entriesSortField?e.project?e.project.startDate:new Date(1001,12,30):e.getCreatedDate());var e="status"===this.entriesSortField?this.entriesSortAscending:!this.entriesSortAscending;e&&this.maintenanceEntries.reverse()}updateEntriesSort(e){this.entriesSortField===(e=e||"entryDate")?this.entriesSortAscending=!this.entriesSortAscending:(this.entriesSortField=e,this.entriesSortAscending=!1),window.localStorage[n.StorageKey_SortField]=this.entriesSortField,window.localStorage[n.StorageKey_SortDir]=this.entriesSortAscending,this.sortEntries()}}n.$inject=["$http","$rootScope","SiteInfo","maintenance","fellowResidents"],n.StorageKey_SortField="maintenance_entriesSortField",n.StorageKey_SortDir="maintenance_entriesSortAscending",n.EquipmentId_AddNew=-5,n.AutocompleteLocationOptions=[{text:"Attic"},{text:"Back Yard"},{text:"Basement"},{text:"Front Yard"},{text:"Garage"},{text:"Interior"},{text:"Kitchen"},{text:"Exterior"},{text:"Side of Building"},{text:"Structural"}],n.AutocompleteEquipmentTypeOptions=[{text:"Appliance"},{text:"Deck"},{text:"Driveway"},{text:"HVAC"},{text:"Patio"},{text:"Plumbing"},{text:"Roof"},{text:"Siding"},{text:"Structural"}],i.MaintenanceController=n}(Ally=Ally||{}),CA.angularApp.component("maintenance",{bindings:{},templateUrl:"/ngApp/common/maintenance.html",controller:Ally.MaintenanceController}),function(e){class t{constructor(e,t,i){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.isLoading=!1,this.upcomingWork=[],this.recentProjects=[]}$onInit(){this.loadProjects()}loadProjects(){return this.isLoading=!0,this.$http.get("/api/Maintenance/Projects").then(e=>{this.isLoading=!1,this.recentProjects=_.take(e.data,3)},e=>{this.isLoading=!1,alert("Failed to retrieve projects: "+e.data.exceptionMessage)})}}t.$inject=["$http","$rootScope","SiteInfo"],e.MaintenanceWidgetController=t}(Ally=Ally||{}),CA.angularApp.component("maintenanceWidget",{templateUrl:"/ngApp/common/maintenance-widget.html",controller:Ally.MaintenanceWidgetController}),function(e){class n{}e.SplitAddress=n;e.GpsPoint=class{};e.GpsPolygon=class{};e.FullAddress=class{};e.MapUtil=class{static parseAddressComponents(e){var t,i=new n;let s="",a="";for(t of e)-1!==t.types.indexOf("street_number")?s=t.short_name:-1!==t.types.indexOf("route")?a=t.short_name:-1!==t.types.indexOf("locality")?i.city=t.short_name:-1!==t.types.indexOf("administrative_area_level_1")?i.state=t.short_name:-1!==t.types.indexOf("postal_code")?i.zip=t.short_name:-1!==t.types.indexOf("country")&&(i.country=t.short_name);return i.street=s+" "+a,i}static gpsBoundsToGooglePoly(e){return _.map(e.vertices,function(e){return new google.maps.LatLng(e.lat,e.lon)})}}}(Ally=Ally||{}),function(e){class t{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.$rootScope=i,this.isLoading=!1,this.returnUrl="https://localtest.mycondoally.com/#!/Home"}$onInit(){null!=this.siteInfo.userInfo.usersUnits&&0<this.siteInfo.userInfo.usersUnits.length?this.assessmentAmount=this.siteInfo.userInfo.usersUnits[0].assessment:this.assessmentAmount=0,this.errorPayInfoText="Is the amount incorrect?",this.paymentInfo={paymentType:"other",amount:this.assessmentAmount,note:"",fundingType:null,paysFor:null};if(this.recentPayments=this.siteInfo.userInfo.recentPayments,this.recentPayments&&0<this.recentPayments.length)for(6<this.recentPayments.length&&(this.recentPayments=this.recentPayments.slice(0,6));this.recentPayments.length<6;)this.recentPayments.push({});null!=this.siteInfo.privateSiteInfo.assessmentFrequency&&null!=this.siteInfo.userInfo.usersUnits&&0<this.siteInfo.userInfo.usersUnits.length&&(this.paymentInfo.paymentType="periodic",this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled)&&(this.knowsNextPayment=!0,this.errorPayInfoText="Is the amount or date incorrect?",this.nextPaymentText=this.getNextPaymentText([this.siteInfo.userInfo.usersUnits[0].nextAssessmentDue],this.siteInfo.privateSiteInfo.assessmentFrequency),this.updatePaymentText()),setTimeout(()=>{$("#btn_view_pay_history").click(function(){$("#pm_info").collapse("hide"),$("#payment_history").collapse("show")}),$("#btn_view_pay_info").click(function(){$("#payment_history").collapse("hide"),$("#pm_info").collapse("show")}),$(".hide").click(function(){$(this).parent().hide("")})},400),paypal.Button.render({env:"sandbox",commit:!0,style:{color:"gold",size:"medium"},client:{sandbox:null,production:"AW51-dH9dRrczrhVVf1kZyavtifN8z23Q0BTJwpWcTJQL6YoqGCTwOb0JfbCHTJIA_usIXAgrxwQ7osQ"},payment:(e,t)=>(this.isLoading=!0,t.payment.create({payment:{transactions:[{amount:{total:this.paymentInfo.amount.toString(),currency:"USD"}}]}})),onAuthorize:(e,t)=>t.payment.execute().then(e=>{e={PayPalCheckoutId:e.id,Memo:this.paymentInfo.note};this.isLoading=!0,this.$http.put("/api/OnlinePayment/SetMemo",e).then(e=>{this.isLoading=!1},e=>{this.isLoading=!1,alert("Failed to save: "+e.data.exceptionMessage)})}),onCancel:(e,t)=>{this.isLoading=!1},onError:e=>{this.isLoading=!1}},"#paypal-button")}onIncorrectPayDetails(){let e=this.assessmentAmount.toString(),t=e=Math.round(this.assessmentAmount)!=this.assessmentAmount?this.assessmentAmount.toFixed(2):e;this.knowsNextPayment&&HtmlUtil.isValidString(this.nextPaymentText)&&(t+="|"+this.nextPaymentText),this.$rootScope.$broadcast("prepAssessmentEmailToBoard",t)}getNextPaymentText(e,t){if(null==e)return"";e.constructor!==Array&&(e=[e]);for(var i="",s=FrequencyIdToInfo(t),a=0;a<e.length;++a){var n=e[a];"month"===s.intervalName?i=["January","February","March","April","May","June","July","August","September","October","November","December"][n.period-1]:"quarter"===s.intervalName?i=["Q1","Q2","Q3","Q4"][n.period-1]:"half-year"===s.intervalName&&(i=["First Half","Second Half"][n.period-1]),i+=" "+n.year,this.paymentInfo.paysFor=[n]}return i}onSelectPaymentType(e){this.paymentInfo.paymentType=e,this.paymentInfo.amount="periodic"==e?this.assessmentAmount:0,this.updatePaymentText()}updatePaymentText(){"periodic"===this.paymentInfo.paymentType&&this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled?HtmlUtil.isNullOrWhitespace(this.nextPaymentText)||(this.siteInfo.userInfo.usersUnits[0].includesLateFee?this.paymentInfo.note="Assessment payment with late fee for ":this.paymentInfo.note="Assessment payment for ",this.paymentInfo.note+=this.nextPaymentText):this.paymentInfo.note=""}}t.$inject=["$http","SiteInfo","$rootScope"],e.PayPalPaymentFormController=t}(Ally=Ally||{}),CA.angularApp.component("paypalPaymentForm",{templateUrl:"/ngApp/common/paypal-payment-form.html",controller:Ally.PayPalPaymentFormController}),function(i){class e{constructor(e,t){this.$http=e,this.siteInfo=t,this.isLoading=!1,this.isSiteManager=!1,this.isInEditMode=!1}$onInit(){this.isSiteManager=this.siteInfo.userInfo.isSiteManager,this.isAddForm=null==this.vendorItem,this.isAddForm&&(this.isInEditMode=!0,this.vendorItem=new i.PreferredVendor,this.editVendorItem=new i.PreferredVendor,window.setTimeout(()=>this.hookupAddressAutocomplete(),500))}hookupAddressAutocomplete(){"US"!==this.siteInfo.privateSiteInfo.country&&"CA"!==this.siteInfo.privateSiteInfo.country||$(".mask-phone").mask("(999) 999-9999? x999",{autoclear:!1});let e=void 0;this.siteInfo.privateSiteInfo.googleGpsPosition&&(t=new google.maps.Circle({center:this.siteInfo.privateSiteInfo.googleGpsPosition,radius:40234}),e={bounds:t.getBounds()});var t=document.getElementById("vendor-"+(this.vendorItem.preferredVendorId||"")+"-address-text-box");this.addressAutocomplete=new google.maps.places.Autocomplete(t,e),google.maps.event.addListener(this.addressAutocomplete,"place_changed",()=>{var e=this.addressAutocomplete.getPlace();this.editVendorItem.fullAddress||(this.editVendorItem.fullAddress=new i.FullAddress),this.editVendorItem.fullAddress.oneLiner=e.formatted_address})}onSaveVendor(){if(HtmlUtil.isNullOrWhitespace(this.editVendorItem.companyName))alert("Please enter a company name");else if(this.editVendorItem.servicesTagArray&&0!==this.editVendorItem.servicesTagArray.length){HtmlUtil.isNullOrWhitespace(this.editVendorItem.companyWeb)||0!==this.editVendorItem.companyWeb.indexOf("http")&&(this.editVendorItem.companyWeb="http://"+this.editVendorItem.companyWeb);var e=null==this.editVendorItem.preferredVendorId?this.$http.post:this.$http.put;this.isLoading=!0;let t="";_.each(this.editVendorItem.servicesTagArray,e=>{t+="|"+e.text}),t+="|",this.editVendorItem.servicesProvided=t,e("/api/PreferredVendors",this.editVendorItem).then(()=>{this.isLoading=!1,this.isAddForm?(this.editVendorItem=new i.PreferredVendor,this.onAddNewVendor&&this.onAddNewVendor()):this.isInEditMode=!1,this.onParentDataNeedsRefresh&&this.onParentDataNeedsRefresh()},e=>{this.isLoading=!1,alert("Failed to save the vendor information: "+e.exceptionMessage)})}else alert("Please enter at least one service provided")}onCancelEdit(){this.isInEditMode=!1}onEditItem(){this.editVendorItem=JSON.parse(JSON.stringify(this.vendorItem)),this.isInEditMode=!0,window.setTimeout(()=>this.hookupAddressAutocomplete(),500)}deleteItem(){confirm("Are you sure you want to remove this vendor?")&&(this.isLoading=!0,this.$http.delete("/api/PreferredVendors/"+this.vendorItem.preferredVendorId).then(()=>{this.isLoading=!1,this.onParentDataNeedsRefresh&&this.onParentDataNeedsRefresh()},e=>{this.isLoading=!1,alert("Failed to delete the vendor: "+e.data.exceptionMessage)}))}getServiceAutocomplete(t){return _.where(e.AutocompleteServiceOptions,e=>-1!==e.text.toLowerCase().indexOf(t.toLowerCase()))}}e.$inject=["$http","SiteInfo"],e.AutocompleteServiceOptions=[{text:"Additions & Remodels"},{text:"Appliances"},{text:"Cabinets & Countertops"},{text:"Cleaning"},{text:"Concrete & Masonry"},{text:"Deck, Porch, & Gazebo"},{text:"Drywall & Insulation"},{text:"Electrical"},{text:"Fencing"},{text:"Flooring"},{text:"Garages"},{text:"Gutters"},{text:"Handy Man"},{text:"HVAC"},{text:"Landscaping, Lawn Care & Sprinklers"},{text:"Painting & Staining"},{text:"Pest Control"},{text:"Plumbing"},{text:"Remodeling"},{text:"Roofing"},{text:"Siding"},{text:"Snow Removal"},{text:"Solar Electric, Heating & Cooling"},{text:"Swimming Pools"},{text:"Windows & Doors"}],i.PreferredVendorItemController=e}(Ally=Ally||{}),CA.angularApp.component("preferredVendorItem",{bindings:{vendorItem:"=?",onParentDataNeedsRefresh:"&?",onAddNewVendor:"&?"},templateUrl:"/ngApp/common/preferred-vendor-item.html",controller:Ally.PreferredVendorItemController}),function(t){class i{constructor(){this.fullAddress=new t.FullAddress}}t.PreferredVendor=i;class s{constructor(e,t){this.$http=e,this.siteInfo=t,this.allVendors=[],this.filteredVendors=[],this.editVendor=new i,this.isLoading=!1,this.isSiteManager=!1,this.usedServiceTags=[],this.filterTags=[],this.entriesSortAscending=!0}$onInit(){this.isSiteManager=this.siteInfo.userInfo.isSiteManager,this.entriesSortField=window.localStorage[s.StorageKey_SortField],this.entriesSortField?this.entriesSortAscending="true"===window.localStorage[s.StorageKey_SortDir]:(this.entriesSortField="name",this.entriesSortAscending=!1),this.retrieveVendors()}retrieveVendors(){this.isLoading=!0,this.$http.get("/api/PreferredVendors").then(e=>{e=e.data;this.isLoading=!1,this.allVendors=e,this.filteredVendors=e,this.sortEntries(),this.usedServiceTags=[],_.each(this.allVendors,t=>{t.servicesTagArray=[],_.each(t.servicesProvidedSplit,e=>t.servicesTagArray.push({text:e})),this.usedServiceTags=this.usedServiceTags.concat(t.servicesProvidedSplit),t.addedDateUtc=moment.utc(t.addedDateUtc).toDate()}),this.usedServiceTags=_.uniq(this.usedServiceTags),this.usedServiceTags.sort()})}exportVendorCsv(){"undefined"!=typeof analytics&&analytics.track("exportResidentCsv");var e=t.createCsvString(this.allVendors,[{headerText:"Company Name",fieldName:"companyName"},{headerText:"Company Phone",fieldName:"companyPhone"},{headerText:"Company Website",fieldName:"companyWeb"},{headerText:"Address",fieldName:"fullAddress",dataMapper:e=>e?e.oneLiner:""},{headerText:"Contact Name",fieldName:"contactName"},{headerText:"Contact Phone",fieldName:"contactPhone"},{headerText:"Contact Email",fieldName:"contactEmail"},{headerText:"Services",fieldName:"servicesProvided",dataMapper:function(e){return HtmlUtil.isNullOrWhitespace(e)||(HtmlUtil.startsWith(e,"|")&&(e=e.substr(1)),HtmlUtil.endsWith(e,"|")&&(e=e.substr(0,e.length-1))),e}},{headerText:"Notes",fieldName:"notes"}]);t.HtmlUtil2.downloadCsv(e,"Vendors.csv")}onTagFilterToggle(e){var t=this.filterTags.indexOf(e);-1===t?this.filterTags.push(e):this.filterTags.splice(t,1),0===this.filterTags.length?this.filteredVendors=this.allVendors:(this.filteredVendors=[],_.each(this.allVendors,e=>{0<_.intersection(e.servicesProvidedSplit,this.filterTags).length&&this.filteredVendors.push(e)}))}onAddedNewVendor(){this.retrieveVendors()}sortEntries(){this.filteredVendors=_.sortBy(this.filteredVendors,e=>"name"===this.entriesSortField?e.companyName.trim().toLocaleUpperCase():e.addedDateUtc),this.entriesSortAscending&&this.filteredVendors.reverse()}updateEntriesSort(e){this.entriesSortField===(e=e||"entryDate")?this.entriesSortAscending=!this.entriesSortAscending:(this.entriesSortField=e,this.entriesSortAscending=!1),window.localStorage[s.StorageKey_SortField]=this.entriesSortField,window.localStorage[s.StorageKey_SortDir]=this.entriesSortAscending,this.sortEntries()}}s.$inject=["$http","SiteInfo"],s.StorageKey_SortField="vendors_entriesSortField",s.StorageKey_SortDir="vendors_entriesSortAscending",t.PreferredVendorsController=s}(Ally=Ally||{}),CA.angularApp.component("preferredVendors",{templateUrl:"/ngApp/common/preferred-vendors.html",controller:Ally.PreferredVendorsController}),function(e){class t{constructor(e,t){this.$http=e,this.siteInfo=t}$onInit(){this.shouldHideName=!!this.shouldHideName}onComponentChange(){this.onChange&&this.onChange()}}t.$inject=["$http","SiteInfo"],e.StreetAddressFormController=t}(Ally=Ally||{}),CA.angularApp.component("streetAddressForm",{bindings:{streetAddress:"=",onChange:"&",shouldHideName:"<",useCareOf:"<"},templateUrl:"/ngApp/common/street-address-form.html",controller:Ally.StreetAddressFormController}),function(e){class t{constructor(e,t,i,s,a){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.$timeout=s,this.appCacheService=a}$onInit(){this.welcomeMessage=this.siteInfo.privateSiteInfo.welcomeMessage,this.isFirstVisit=null===this.siteInfo.userInfo.lastLoginDateUtc,this.isSiteManager=this.siteInfo.userInfo.isSiteManager,this.showFirstVisitModal=this.isFirstVisit&&!this.$rootScope.hasClosedFirstVisitModal&&null===this.siteInfo.privateSiteInfo.siteLaunchedDateUtc,this.homeRightColumnType=this.siteInfo.privateSiteInfo.homeRightColumnType,this.homeRightColumnType||(this.homeRightColumnType="localnews");HtmlUtil.getSubdomain(window.location.host);this.allyAppName=AppConfig.appName,this.messageObject={},null!==this.siteInfo.privateSiteInfo.assessmentFrequency&&null!==this.siteInfo.userInfo.usersUnits&&0<this.siteInfo.userInfo.usersUnits.length&&(this.paymentInfo.paymentType="periodic",this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled)&&(this.knowsNextPayment=!0,this.errorPayInfoText="Is the amount or date incorrect?",this.nextPaymentText=this.getNextPaymentText([this.siteInfo.userInfo.usersUnits[0].nextAssessmentDue],this.siteInfo.privateSiteInfo.assessmentFrequency),this.updatePaymentText()),this.refreshData()}updatePaymentText(){"periodic"===this.paymentInfo.paymentType&&this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled?HtmlUtil.isNullOrWhitespace(this.nextPaymentText)||(this.siteInfo.userInfo.usersUnits[0].includesLateFee?this.paymentInfo.note="Assessment payment with late fee for ":this.paymentInfo.note="Assessment payment for ",this.paymentInfo.note+=this.nextPaymentText):this.paymentInfo.note=""}onSelectPaymentType(e){this.paymentInfo.paymentType=e,this.paymentInfo.amount="periodic"===e?this.siteInfo.userInfo.assessmentAmount:0,this.updatePaymentText()}getNextPaymentText(e,t){if(null===e)return"";e.constructor!==Array&&(e=[e]);for(var i="",s=FrequencyIdToInfo(t),a=0;a<e.length;++a){var n=e[a];"month"===s.intervalName?i=["January","February","March","April","May","June","July","August","September","October","November","December"][n.period-1]:"quarter"===s.intervalName?i=["Q1","Q2","Q3","Q4"][n.period-1]:"half-year"===s.intervalName&&(i=["First Half","Second Half"][n.period-1]),i+=" "+n.year,this.paymentInfo.paysFor=[n]}return i}hideFirstVisit(){this.$rootScope.hasClosedFirstVisitModal=!0,this.showFirstVisitModal=!1}onIncorrectPayDetails(){this.messageObject.recipientType="board",this.knowsNextPayment?this.messageObject.message="Hello Board Members,\n\nOur association's home page says my next payment of $"+this.siteInfo.userInfo.assessmentAmount+" will cover "+this.nextPaymentText+", but I believe that is incorrect. My records indicate my next payment of $"+this.siteInfo.userInfo.assessmentAmount+" should pay for [INSERT PROPER DATE HERE]. What do you need from me to resolve the issue?\n\n- "+this.siteInfo.userInfo.firstName:this.messageObject.message="Hello Board Members,\n\nOur association's home page says my assessment payment is $"+this.siteInfo.userInfo.assessmentAmount+", but I believe that is incorrect. My records indicate my assessment payments should be $[INSERT PROPER AMOUNT HERE]. What do you need from me to resolve the issue?\n\n- "+this.siteInfo.userInfo.firstName,document.getElementById("send-email-panel").scrollIntoView()}refreshData(){var e,t,i;HtmlUtil.getSubdomain(window.location.host);"localnews"===this.homeRightColumnType&&(this.isLoading_LocalNews=!0,t="US"===this.siteInfo.privateSiteInfo.country?(e="https://localnewsally.azurewebsites.net/api/LocalNews",{clientId:"1001A194-B686-4C45-80BC-ECC0BB4916B4",chicagoWard:this.siteInfo.privateSiteInfo.chicagoWard,zipCode:this.siteInfo.privateSiteInfo.zipCode,cityNeighborhood:this.siteInfo.privateSiteInfo.localNewsNeighborhoodQuery}):(e="https://localnewsally.azurewebsites.net/api/LocalNews/International/MajorCity",{clientId:"1001A194-B686-4C45-80BC-ECC0BB4916B4",countryCode:this.siteInfo.privateSiteInfo.country,city:this.siteInfo.privateSiteInfo.groupAddress.city}),(i=this).$http.get(e,{cache:!0,params:t}).then(function(e){i.localNews=e.data,i.isLoading_LocalNews=!1}))}}t.$inject=["$http","$rootScope","SiteInfo","$timeout","appCacheService"],e.HomeGroupHomeController=t}(Ally=Ally||{}),CA.angularApp.component("homeGroupHome",{templateUrl:"/ngApp/home/home-group-home.html",controller:Ally.HomeGroupHomeController}),function(e){class t{constructor(e,t,i){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.isLoading=!1,this.shouldShowWidget=!1}$onInit(){this.retrieveInfo()}retrieveInfo(){this.isLoading=!0,this.$http.get("/api/HomeValue/ZillowInfo").then(e=>{this.isLoading=!1,this.shouldShowWidget=!!e.data&&!!e.data.chartImageUri,this.shouldShowWidget&&(this.valueInfo=e.data)},e=>{this.isLoading=!1,this.shouldShowWidget=!1})}}t.$inject=["$http","$rootScope","SiteInfo"],e.HomeValueWidgetController=t}(Ally=Ally||{}),CA.angularApp.component("homeValueWidget",{templateUrl:"/ngApp/home/home-value-widget.html",controller:Ally.HomeValueWidgetController}),function(e){class t{constructor(e,t,i){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.isLoading=!1,this.isAdmin=!1}$onInit(){}}t.$inject=["$http","$rootScope","SiteInfo"],e.HomeUsersController=t}(Ally=Ally||{}),CA.angularApp.component("homeUsers",{templateUrl:"/ngApp/home/manager/home-users.html",controller:Ally.HomeUsersController}),function(s){class e{}class t{}s.HomeInfo=t;class a{constructor(){this.signerUpInfo=new e,this.streetAddress="",this.homeInfo=new t}}class i{constructor(e,t,i){this.$http=e,this.$scope=t,this.WizardHandler=i,this.lotSizeUnit="Acres",this.lotSquareUnits=0,this.signUpInfo=new a,this.isLoadingHomeInfo=!1,this.didLoadHomeInfo=!1,this.isLoading=!1,this.hideWizard=!1,this.hasAlreadyCheckedForHomeInfo=!1}$onInit(){this.$scope.$on("wizard:stepChanged",(e,t)=>{1===t.index&&this.retrieveHomeInfoForAddress()});setTimeout(()=>{this.initMap()},300)}retrieveHomeInfoForAddress(){var e;HtmlUtil.isNullOrWhitespace(this.signUpInfo.streetAddress)||this.hasAlreadyCheckedForHomeInfo||(this.hasAlreadyCheckedForHomeInfo=!0,e="/api/HomeSignUp/HomeInfo?streetAddress="+encodeURIComponent(this.signUpInfo.streetAddress),this.$http.get(e,{cache:!0}).then(e=>{e.data&&(this.signUpInfo.homeInfo=e.data,this.didLoadHomeInfo=!0,this.processLotSizeHint(this.signUpInfo.homeInfo.lotSquareFeet))}))}processLotSizeHint(e){e&&(43560<e?(this.lotSizeUnit="Acres",this.lotSquareUnits=e/43560,this.lotSquareUnits=parseFloat((Math.round(4*this.lotSquareUnits)/4).toFixed(2))):(this.lotSizeUnit="SquareFeet",this.lotSquareUnits=e))}initMap(){var e=document.getElementById("address-map"),e=(this.map=new google.maps.Map(e,{center:{lat:41.869638,lng:-87.657423},zoom:9}),this.mapMarker=new google.maps.Marker({map:this.map,anchorPoint:new google.maps.Point(41.969638,-87.657423),icon:"/assets/images/MapMarkers/MapMarker_Home.png",position:null}),document.getElementById("home-address-text-box")),i=(this.addressAutocomplete=new google.maps.places.Autocomplete(e),this.addressAutocomplete.bindTo("bounds",this.map),this);this.addressAutocomplete.addListener("place_changed",function(){i.mapMarker.setVisible(!1);var e=i.addressAutocomplete.getPlace(),t=e.formatted_address;t.indexOf(", USA")===t.length-", USA".length&&(t=t.substring(0,t.length-", USA".length)),i.signUpInfo.streetAddress=t,i.selectedSplitAddress=s.MapUtil.parseAddressComponents(e.address_components),e.geometry&&i.centerMap(e.geometry),$("#association-name-text-box").focus()})}goNextStep(){this.WizardHandler.wizard().next()}onFinishedWizard(){this.isLoading=!0;var t=this;this.$http.post("/api/HomeSignUp",this.signUpInfo).then(function(e){t.isLoading=!1;e=e.data;HtmlUtil.isNullOrWhitespace(e.errorMessage)?HtmlUtil.isNullOrWhitespace(e.createUrl)?(t.hideWizard=!0,t.resultMessage="Great work! We just sent you an email with instructions on how access your new site."):window.location.href=e.createUrl:(alert("Failed to complete sign-up: "+e.errorMessage),0<=e.stepIndex&&t.WizardHandler.wizard().goTo(e.stepIndex))},function(e){t.isLoading=!1;e=e.data.exceptionMessage||e.data;alert("Failed to complete sign-up: "+e)})}onHomeAddressChanged(){var s=this;HtmlUtil.geocodeAddress(this.signUpInfo.streetAddress,function(t,i){s.$scope.$apply(function(){var e;i==google.maps.GeocoderStatus.OK&&((e=t[0].formatted_address).indexOf(", USA")===e.length-", USA".length&&(e=e.substring(0,e.length-", USA".length)),s.signUpInfo.streetAddress=e,s.centerMap(t[0].geometry))})})}centerMap(e){e.viewport?this.map.fitBounds(e.viewport):(this.map.setCenter(e.location),this.map.setZoom(17)),this.mapMarker.setPosition(e.location),this.mapMarker.setVisible(!0)}prepopulateHomeInfo(){var e,t;this.selectedSplitAddress&&(this.isLoadingHomeInfo=!0,e=`/api/PropertyResearch/HomeInfo?street=${encodeURIComponent(this.selectedSplitAddress.street)}&city=${encodeURIComponent(this.selectedSplitAddress.city)}&state=${this.selectedSplitAddress.state}&zip=`+this.selectedSplitAddress.zip,(t=this).$http.get(e).then(e=>{t.isLoadingHomeInfo=!1;e=e.data;e&&(t.didLoadHomeInfo=!0,t.signUpInfo.homeInfo=e,t.processLotSizeHint(e.lotSquareFeet))},()=>{t.isLoadingHomeInfo=!1}))}}i.$inject=["$http","$scope","WizardHandler"],s.HomeSignUpController=i}(Ally=Ally||{}),CA.angularApp.component("homeSignUp",{templateUrl:"/ngApp/home/public/home-sign-up.html",controller:Ally.HomeSignUpController}),function(e){class t{constructor(e,t,i,s,a){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.$timeout=s,this.appCacheService=a}$onInit(){this.welcomeMessage=this.siteInfo.privateSiteInfo.welcomeMessage,this.isFirstVisit=null===this.siteInfo.userInfo.lastLoginDateUtc,this.isSiteManager=this.siteInfo.userInfo.isSiteManager,this.showFirstVisitModal=this.isFirstVisit&&!this.$rootScope.hasClosedFirstVisitModal&&null===this.siteInfo.privateSiteInfo.siteLaunchedDateUtc,this.homeRightColumnType=this.siteInfo.privateSiteInfo.homeRightColumnType,this.homeRightColumnType||(this.homeRightColumnType="localnews");HtmlUtil.getSubdomain(window.location.host);this.allyAppName=AppConfig.appName,this.messageObject={},null!==this.siteInfo.privateSiteInfo.assessmentFrequency&&null!==this.siteInfo.userInfo.usersUnits&&0<this.siteInfo.userInfo.usersUnits.length&&(this.paymentInfo.paymentType="periodic",this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled)&&(this.knowsNextPayment=!0,this.errorPayInfoText="Is the amount or date incorrect?",this.nextPaymentText=this.getNextPaymentText([this.siteInfo.userInfo.usersUnits[0].nextAssessmentDue],this.siteInfo.privateSiteInfo.assessmentFrequency),this.updatePaymentText())}updatePaymentText(){"periodic"===this.paymentInfo.paymentType&&this.siteInfo.privateSiteInfo.isPeriodicPaymentTrackingEnabled?HtmlUtil.isNullOrWhitespace(this.nextPaymentText)||(this.siteInfo.userInfo.usersUnits[0].includesLateFee?this.paymentInfo.note="Assessment payment with late fee for ":this.paymentInfo.note="Assessment payment for ",this.paymentInfo.note+=this.nextPaymentText):this.paymentInfo.note=""}onSelectPaymentType(e){this.paymentInfo.paymentType=e,this.paymentInfo.amount="periodic"===e?this.siteInfo.userInfo.assessmentAmount:0,this.updatePaymentText()}getNextPaymentText(e,t){if(null===e)return"";e.constructor!==Array&&(e=[e]);for(var i="",s=FrequencyIdToInfo(t),a=0;a<e.length;++a){var n=e[a];"month"===s.intervalName?i=["January","February","March","April","May","June","July","August","September","October","November","December"][n.period-1]:"quarter"===s.intervalName?i=["Q1","Q2","Q3","Q4"][n.period-1]:"half-year"===s.intervalName&&(i=["First Half","Second Half"][n.period-1]),i+=" "+n.year,this.paymentInfo.paysFor=[n]}return i}hideFirstVisit(){this.$rootScope.hasClosedFirstVisitModal=!0,this.showFirstVisitModal=!1}onIncorrectPayDetails(){this.messageObject.recipientType="board",this.knowsNextPayment?this.messageObject.message="Hello Boardmembers,\n\nOur association's home page says my next payment of $"+this.siteInfo.userInfo.assessmentAmount+" will cover "+this.nextPaymentText+", but I believe that is incorrect. My records indicate my next payment of $"+this.siteInfo.userInfo.assessmentAmount+" should pay for [INSERT PROPER DATE HERE]. What do you need from me to resolve the issue?\n\n- "+this.siteInfo.userInfo.firstName:this.messageObject.message="Hello Boardmembers,\n\nOur association's home page says my assessment payment is $"+this.siteInfo.userInfo.assessmentAmount+", but I believe that is incorrect. My records indicate my assessment payments should be $[INSERT PROPER AMOUNT HERE]. What do you need from me to resolve the issue?\n\n- "+this.siteInfo.userInfo.firstName,document.getElementById("send-email-panel").scrollIntoView()}}t.$inject=["$http","$rootScope","SiteInfo","$timeout","appCacheService"],e.PtaGroupHomeController=t}(Ally=Ally||{}),CA.angularApp.component("ptaGroupHome",{templateUrl:"/ngApp/pta/pta-group-home.html",controller:Ally.PtaGroupHomeController}),ServiceBankInfoCtrl.$inject=["$http"],ServiceBusinessInfoCtrl.$inject=["$http"],ServiceJobsCtrl.$inject=["$http"];class AppCacheService{set(e,t){window.sessionStorage[AppCacheService.KeyPrefix+e]=t}get(e){return window.sessionStorage[AppCacheService.KeyPrefix+e]}clear(e){window.sessionStorage[AppCacheService.KeyPrefix+e]=void 0,delete window.sessionStorage[AppCacheService.KeyPrefix+e]}getAndClear(e){var t=this.get(e);return this.clear(e),t}}function ManageMembersCtrl(i,s,e,t,s){i.members=[],i.newMember={boardPosition:0,isRenter:!1},i.editUser=null,i.setEdit=function(e){i.sentWelcomeEmail=!1,null===e?i.editUser=null:(i.editUserForm.$setPristine(),e=jQuery.extend({},e),i.editUser=e,i.memberGridOptions.selectAll(!1),setTimeout("$( '#edit-user-first-text-box' ).focus();",100))},i.onSendWelcome=function(){i.isSavingUser=!0,s.put("/api/Member/"+i.editUser.userId+"/SendWelcome").then(function(){i.isSavingUser=!1,i.sentWelcomeEmail=!0},function(){alert("Failed to send the welcome e-mail, please contact support if this problem persists."),i.isSavingUser=!1})},$resource("/api/Member",null,{update:{method:"PUT"}});var a,n={fields:["lastName"],directions:["asc"]},o=n;window.localStorage&&(0===(o=(a=window.localStorage.getItem("memberSort"))?JSON.parse(a):o).fields.length&&(o=n),t(function(){var e={fields:i.memberGridOptions.sortInfo.fields,directions:i.memberGridOptions.sortInfo.directions};window.localStorage.setItem("memberSort",JSON.stringify(e))},2e3)),i.memberGridOptions={data:"members",plugins:[new ngGridFlexibleHeightPlugin],columnDefs:[{field:"firstName",displayName:"First Name",cellClass:"resident-cell-first"},{field:"lastName",displayName:"Last Name",cellClass:"resident-cell-last"},{field:"email",displayName:"E-mail",cellClass:"resident-cell-email"},{field:"isSiteManager",displayName:"Admin",width:60,cellClass:"resident-cell-site-manager",cellTemplate:'<div style="text-align:center; padding-top: 8px;"><input type="checkbox" disabled="disabled" ng-checked="row.getProperty(col.field)"></div>'},{field:"phoneNumber",displayName:"Phone Number",width:150,cellClass:"resident-cell-phone",cellTemplate:'<div class="ngCellText" ng-class="col.colIndex()"><span ng-cell-text>{{ row.getProperty(col.field) | tel }}</span></div>'}],afterSelectionChange:function(e){e.selected&&i.setEdit(e.entity)},sortInfo:o,multiSelect:!1},i.refresh=function(){i.isLoading=!0,s.get("/api/Member/Watch").then(function(e){i.members=e.data,_.forEach(i.members,function(e){e.fullName=e.firstName+" "+e.lastName,"string"==typeof e.email&&-1!==e.email.indexOf("@condoally.com")&&(e.email="")}),i.isLoading=!1})},i.onSaveMember=function(){var e,t;null!=i.editUser&&($("#editUserForm").validate(),$("#editUserForm").valid())&&(i.isSavingUser=!0,t=e=function(){i.editUser=null,i.isSavingUser=!1,i.refresh()},(i.editUser.userId?s.put("/api/Member",i.editUser):s.post("/api/Member",i.editUser)).then(e,t))},i.OnAdminSetPassword=function(){var e={userName:i.adminSetPass_Username,password:i.adminSetPass_Password};s.post("/api/AdminHelper/SetPassword",e).then(function(e){i.adminSetPass_ResultMessage=e.data},function(){})},i.onDeleteMember=function(){confirm("Are you sure you want to remove this person from your neighborhood watch group?")&&s.delete("/api/Member",{userId:i.editUser.userId,unitId:i.editUser.unitId}).then(function(){i.editUser=null,i.refresh()})},i.onSendAllWelcome=function(){i.isLoading=!0,s.put("/api/Member?userId&action=launchsite").then(function(){i.isLoading=!1,i.sentWelcomeEmail=!0,i.allEmailsSent=!0},function(){alert("Failed to send welcome e-mail, please contact support if this problem persists."),i.isLoading=!1})},i.refresh()}function WatchSettingsCtrl(e,t,i,s){var a=this,n=(a.settings={},a.defaultBGImage=$(document.documentElement).css("background-image"),a.showQaButton="president@mycondoally.com"===t.userInfo.emailAddress,i("/api/Settings",null,{update:{method:"PUT"}}));a.refreshData=function(){a.isLoading=!0,a.settings=n.get(function(){a.isLoading=!1})},a.onSiteTitleChange=function(){a.isLoading=!0,n.update({siteTitle:a.settings.siteTitle},function(){location.reload(),a.isLoading=!1})},a.onWelcomeMessageUpdate=function(){a.isLoading=!0,n.update({welcomeMessage:a.settings.welcomeMessage},function(){s.privateSiteInfo.welcomeMessage=a.settings.welcomeMessage,a.isLoading=!1})},a.onImageClick=function(e){a.settings.bgImageFileName=e,SettingsJS._defaultBG=e,n.update({BGImageFileName:a.settings.bgImageFileName},function(){$(".test-bg-image").removeClass("test-bg-image-selected"),$("img[src='"+t.bgImagePath+e+"']").addClass("test-bg-image-selected"),a.isLoading=!1})},a.onImageHoverOver=function(e){$(document.documentElement).css("background-image","url("+t.bgImagePath+e+")")},a.onImageHoverOut=function(){"string"==typeof a.settings.bgImageFileName&&0<a.settings.bgImageFileName.length?$(document.documentElement).css("background-image","url("+t.bgImagePath+a.settings.bgImageFileName+")"):$(document.documentElement).css("background-image",a.defaultBGImage)},a.onQaDeleteSite=function(){e.get("/api/QA/DeleteThisAssociation").then(function(){location.reload()},function(e){alert("Failed to delete site: "+e.data.message)})},a.mapInstance=new google.maps.Map(document.getElementById("map-canvas"),a.mapInfo),a.refreshData()}function WatchCalendarCtrl(n,e,s,i,t){var o="YYYY-MM-DD",r="h:mma",l="12:37am",a=(n.today=new Date,{height:600,editable:!1,header:{left:"month agendaWeek",center:"title",right:"today prev,next"},viewRender:function(e,t){i.isSiteManager&&$(t).css("cursor","pointer")},dayClick:function(e){var t;i.isSiteManager&&(t=moment(moment.utc(e).format(o)).toDate(),n.$apply(function(){n.setEditEvent({date:t,dateOnly:t,associatedUserIds:[]})}))},eventClick:function(e){n.$apply(function(){e.calendarEventObject&&n.setEditEvent(e.calendarEventObject,!0)})},eventRender:function(e,t){$(t).css("cursor","default"),$(t).qtip({style:{classes:"qtip-light qtip-shadow"},content:{text:e.fullDescription,title:e.toolTipTitle}})},eventSources:[{events:function(e,t,i,a){n.isLoadingCalendarEvents=!0;e=e.format(o),t=t.format(o);s.get("/api/CalendarEvent?startDate="+e+"&endDate="+t).then(function(e){var s=[],e=e.data;n.isLoadingCalendarEvents=!1,_.each(e,function(e){e.timeOnly=moment.utc(e.date).format(r),e.dateOnly=e.date,e.timeOnly==l&&(e.timeOnly="");var t=e.title,i=(17<t.length&&(t=t.substring(0,17)+"..."),"Posted by: "+e.authorName+"<br><p>"+e.title+"</p>");s.push({title:t,start:e.date.substring(0,10),toolTipTitle:"Event",fullDescription:i,calendarEventObject:e})}),a(s)},function(){n.isLoadingCalendarEvents=!1})}}]});$(document).ready(function(){$(".EditableEntry").editable("<%= Request.Url %>",{id:"EditEntryId",type:"textarea",cancel:"Cancel",submit:"Ok"}),$("#log-calendar").fullCalendar(a)}),n.onResidentClicked=function(e){_.contains(n.editEvent.associatedUserIds,e)?n.editEvent.associatedUserIds=_.without(n.editEvent.associatedUserIds,e):n.editEvent.associatedUserIds.push(e)},n.isUserAssociated=function(e){return!(!n.editEvent||!n.editEvent.associatedUserIds)&&_.contains(n.editEvent.associatedUserIds,e)},n.expandCalendarEventModel=function(){n.showExpandedCalendarEventModel=!0},n.setEditEvent=function(e,t){n.showExpandedCalendarEventModel=t||!1,(n.editEvent=e)&&setTimeout(function(){$("#calendar-event-title").focus()},10)},n.deleteCalendarEvent=function(e){confirm("Are you sure you want to remove this calendar event?")&&(n.isLoadingCalendarEvents=!0,s.delete("/api/CalendarEvent?eventId="+e).then(function(){n.isLoadingCalendarEvents=!1,n.editEvent=null,n.onlyRefreshCalendarEvents=!0,$("#log-calendar").fullCalendar("refetchEvents")},function(){n.isLoadingCalendarEvents=!1,alert("Failed to delete the calendar event.")}))},n.saveCalendarEvent=function(){var e="",e="string"==typeof n.editEvent.timeOnly&&1<n.editEvent.timeOnly.length?moment.utc(n.editEvent.date).format(o)+" "+n.editEvent.timeOnly:moment.utc(n.editEvent.date).format(o)+" "+l;n.editEvent.date=moment.utc(e,o+" "+r).toDate(),e=n.editEvent.eventId?s.put:s.post,n.isLoadingCalendarEvents=!0,e("/api/CalendarEvent",n.editEvent).then(function(){n.isLoadingCalendarEvents=!1,n.editEvent=null,n.onlyRefreshCalendarEvents=!0,$("#log-calendar").fullCalendar("refetchEvents")},function(){n.isLoadingCalendarEvents=!1})},n.onDeleteItem=function(e){confirm("Are you sure you want to delete this information?")&&(n.isLoading=!0,LogEntryResource.delete({logEntryId:e.logEntryId},function(){n.RetrieveItems()}))},$("#calendar-event-time").timepicker({scrollDefault:"10:00am"})}function WatchHomeCtrl(e,t,i){var s=this,a=t("/api/Watch/Home"),t=t("https://localnewsally.azurewebsites.net/api/LocalNews",null,{cache:!0});s.refreshData=function(){s.isLoading=!0,s.watchMembers=a.get(function(){s.isLoading=!1})},t.query({clientId:"1001A194-B686-4C45-80BC-ECC0BB4916B4",chicagoWard:i.publicSiteInfo.chicagoWard,zipCode:i.privateSiteInfo.zipCode,cityNeighborhood:i.publicSiteInfo.localNewsNeighborhoodQuery},function(e){s.localNews=e,s.isLoading_LocalNews=!1})}function WatchMembersCtrl(e,t,i){var a=this,s=t("/api/Watch/MemberList");a.refreshData=function(){a.isLoading=!0,a.memberList=s.query(function(){var e,i,s;a.isLoading=!1,a.housePolys=(e=a.memberList,i=[],s=[],_.each(e,function(t){t.houseGpsBounds&&!_.some(i,function(e){return e==t.addressId})&&(i.push(t.addressId),s.push(t.houseGpsBounds))}),s)})},a.mapCenter=i.privateSiteInfo.gpsPosition,a.groupBounds=i.publicSiteInfo.gpsBounds,a.refreshData()}AppCacheService.Key_WasLoggedIn403="wasLoggedIn403",AppCacheService.Key_WasLoggedIn401="wasLoggedIn401",AppCacheService.Key_AfterLoginRedirect="afterLoginRedirect",AppCacheService.KeyPrefix="AppCacheService_",angular.module("CondoAlly").service("appCacheService",[AppCacheService]),function(e){function o(e){if(!e)return"";let t=e.toString();return HtmlUtil.isNullOrWhitespace(t)?"":(e=-1!==t.indexOf('"')||-1!==t.indexOf(",")||-1!==t.indexOf("\r")||-1!==t.indexOf("\n"),t=e?'"'+(t=t.replace(/"/g,'""'))+'"':t)}e.CsvColumnDescriptor=class{},e.ValueToCsvValue=o,e.createCsvString=function(t,i,e=!0){let s="";if(e){for(let e=0;e<i.length;++e)0<e&&(s+=","),s+=o(i[e].headerText);s+="\n"}for(let e=0;e<t.length;++e){var a=t[e];for(let t=0;t<i.length;++t){0<t&&(s+=",");var n=i[t];let e=a[n.fieldName];n.dataMapper&&(e=n.dataMapper(e)),s+=o(e)}s+="\n"}return s}}(Ally=Ally||{}),function(e){e.GroupEmailInfo=class{};e.GroupEmailGroups=class{};e.CustomEmailGroup=class{};e.CustomEmailGroupMember=class{};class t extends e.SimpleUserEntry{}e.FellowChtnResident=t;e.CommitteeListingInfo=class{};e.UnitListing=class{};e.FellowResidents=class{};class i{constructor(e,t,i){this.$http=e,this.$q=t,this.$cacheFactory=i,this.httpCache=i("FellowResidentsService")}getResidents(){return this.$http.get("/api/BuildingResidents",{cache:this.httpCache}).then(e=>e.data.residents,e=>this.$q.reject(e))}getCommitteeMembers(e){return this.$http.get(`/api/Committee/${e}/Members`).then(e=>e.data,function(e){return this.$q.reject(e)})}isCommitteeMember(e){return this.$http.get(`/api/Committee/${e}/IsMember`,{cache:this.httpCache}).then(e=>e.data,e=>this.$q.reject(e))}getByUnits(){return this.$http.get("/api/BuildingResidents",{cache:this.httpCache}).then(e=>e.data.byUnit,e=>this.$q.reject(e))}getByUnitsAndResidents(){return this.$http.get("/api/BuildingResidents",{cache:this.httpCache}).then(e=>e.data,e=>this.$q.reject(e))}getGroupEmailObject(){return this.$http.get("/api/BuildingResidents/EmailGroups",{cache:this.httpCache}).then(function(e){return e.data},function(e){return this.$q.reject(e)})}getAllGroupEmails(){return this.$http.get("/api/BuildingResidents/AllEmailGroups",{cache:this.httpCache}).then(e=>e.data,e=>this.$q.reject(e))}sendMessage(e,t,i,s){return this.$http.post("/api/BuildingResidents/SendMessage",{recipientUserId:e,messageBody:t,messageSubject:i,shouldSendAsBoard:s})}clearResidentCache(){this.httpCache.removeAll()}static isOfficerBoardPosition(e){return-1!==[1,2,4,16,64].indexOf(e)}static isNonPropMgrBoardPosition(e){return!(e<1||e===i.BoardPos_None||e===i.BoardPos_PropertyManager)}static pollReponsesToChart(e,t){const s=[],i=e=>e.forEach(t=>{{var i=t;let e=s.find(e=>e.answerId===i);e||(e=new r(i),s.push(e)),++e.numVotes}});e.responses.forEach(e=>i(e.answerIds));var a={chartData:[],chartLabels:[]};for(const o of s){var n=_.find(e.answers,e=>e.pollAnswerId===o.answerId);n?(a.chartLabels.push(n.answerText),a.chartData.push(o.numVotes)):console.log("Unknown answer ID found: "+o.answerId)}return e.responses&&e.responses.length<t.privateSiteInfo.numUnits&&(a.chartLabels.push("No Response"),"neighborhood"===AppConfig.appShortName||"block-club"===AppConfig.appShortName||"pta"===AppConfig.appShortName?a.chartData.push(t.privateSiteInfo.numMembers-e.responses.length):a.chartData.push(t.privateSiteInfo.numUnits-e.responses.length)),a}}i.BoardPos_None=0,i.BoardPos_PropertyManager=32,i.CustomRecipientType="CUSTOM",i.BoardPositionNames=[{id:i.BoardPos_None,name:"None"},{id:1,name:"President"},{id:2,name:"Treasurer"},{id:4,name:"Secretary"},{id:8,name:"Director/Member at Large"},{id:16,name:"Vice President"},{id:i.BoardPos_PropertyManager,name:"Property Manager"},{id:64,name:"Secretary + Treasurer"}],e.FellowResidentsService=i;class r{constructor(e){this.numVotes=0,this.answerId=e}}}(Ally=Ally||{}),angular.module("CondoAlly").service("fellowResidents",["$http","$q","$cacheFactory",Ally.FellowResidentsService]),CA.angularApp.directive("googleMapPolyEditor",["$http",function(e){return{scope:{editPolyVerts:"=",visiblePolys:"=",visiblePoints:"=",groupBoundsPoly:"=",mapCenter:"=",onMapEditorReady:"&",enableMapControls:"=",enableClustering:"="},restrict:"E",replace:"true",templateUrl:"/ngApp/services/GoogleMapPolyEditorTemplate.html",link:function(s,e,t){s.mapInfo={center:{lat:39.5,lng:-98.35},zoom:4,disableDefaultUI:!s.enableMapControls,mapTypeId:google.maps.MapTypeId.HYBRID,events:{tilesloaded:function(e,t,i){google.maps.event.clearListeners(e,"tilesloaded")}}},s.markerClusterer=null,s.googlePolyToGpsBounds=function(e){return e=_.map(e,function(e){return{lat:e.lat(),lon:e.lng()}})},s.centerMapOnPoly=function(e){var t;e&&0!==e.length&&(t=new google.maps.LatLngBounds,_.map(e,function(e){t.extend(e)}),s.mapInstance.fitBounds(t))},s.setGroupBounds=function(e){e?(e={paths:Ally.MapUtil.gpsBoundsToGooglePoly(e),map:s.mapInstance,strokeColor:"#0000FF",strokeOpacity:.5,strokeWeight:1,fillColor:"#0000FF",fillOpacity:.15,zIndex:-1},s.activeShape&&s.activeShape.setMap(null),s.groupBoundsShape=new google.maps.Polygon(e)):s.groupBoundsShape&&(s.groupBoundsShape.setMap(null),s.groupBoundsShape=null)},s.fitBoundsForPolys=function(){var t=new google.maps.LatLngBounds;(s.groupBoundsShape||s.currentVisiblePolys&&0!==s.currentVisiblePolys.length)&&(s.groupBoundsShape&&_.each(s.groupBoundsShape.getPath().getArray(),function(e){t.extend(e)}),_.each(s.currentVisiblePolys,function(e){_.each(e.getPath().getArray(),function(e){t.extend(e)})}),s.mapInstance.fitBounds(t))},s.fitBoundsForPoints=function(){var t;s.currentVisiblePoints&&0!==s.currentVisiblePoints.length&&(t=new google.maps.LatLngBounds,_.each(s.currentVisiblePoints,function(e){t.extend(e.position)}),s.mapInstance.fitBounds(t))};function a(e){function t(e){return $("img[src$='"+e+"']")}var i,s=this,a=t(s.btnDeleteImageUrl);0===a.length&&((i=$("img[src$='http://maps.gstatic.com/mapfiles/undo_poly.png']")).parent().css("height","21px !important"),i.parent().parent().append('<div style="overflow-x: hidden; overflow-y: hidden; position: absolute; width: 30px; height: 27px;top:21px;"><img src="'+s.btnDeleteImageUrl+'" class="deletePoly" style="height:auto; width:auto; position: absolute; left:0;"/></div>'),(a=t(s.btnDeleteImageUrl)).hover(function(){return $(this).css("left","-30px"),!1},function(){return $(this).css("left","0px"),!1}),a.mousedown(function(){return $(this).css("left","-60px"),!1})),s.btnDeleteClickHandler&&a.unbind("click",s.btnDeleteClickHandler),s.btnDeleteClickHandler=function(){return s.removeAt(e),!1},a.click(s.btnDeleteClickHandler)}s.currentVisiblePolys=[],s.currentVisiblePoints=[],s.onVisiblePolysChange=function(e){_.each(s.currentVisiblePolys,function(e){e.setMap(null)}),s.currentVisiblePolys=[],_.each(e,function(e){var t={paths:Ally.MapUtil.gpsBoundsToGooglePoly(e),clickable:"function"==typeof e.onClick,map:s.mapInstance,strokeColor:"#0000FF",strokeOpacity:.8,strokeWeight:2,fillColor:"#0000FF",fillOpacity:.35},i=new google.maps.Polygon(t);(i.polyInfo=e).mapShapeObject=i,s.currentVisiblePolys.push(i),t.clickable&&google.maps.event.addListener(i,"click",function(){i.polyInfo.onClick()})}),s.fitBoundsForPolys()},s.onVisiblePointsChange=function(e){_.each(s.currentVisiblePoints,function(e){e.setMap(null)}),s.currentVisiblePoints=[],_.each(e,function(e){var t=new google.maps.Marker({position:{lat:e.lat,lng:e.lon},map:s.mapInstance,title:e.fullAddress});t.pointSource=e,s.currentVisiblePoints.push(t),"function"==typeof e.onClick&&google.maps.event.addListener(t,"click",function(){t.pointSource.onClick()})}),s.fitBoundsForPoints(),s.enableClustering&&(s.markerClusterer&&markerCluster.setMap(null),s.markerCluster=new markerClusterer.MarkerClusterer({markers:s.currentVisiblePoints,map:s.mapInstance}))},s.onEditPolyChange=function(e){var t,i;if(e)return e=_.map(e.vertices,function(e){return new google.maps.LatLng(e.lat,e.lon)}),s.centerMapOnPoly(e),e={paths:e,editable:!0,draggable:!0,clickable:!0,map:s.mapInstance,strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.35},s.activeShape&&s.activeShape.setMap(null),s.activeShape=new google.maps.Polygon(e),e=function(){s.editPolyVerts.vertices=s.googlePolyToGpsBounds(s.activeShape.getPath().getArray())},google.maps.event.addListener(s.activeShape.getPath(),"set_at",e),google.maps.event.addListener(s.activeShape.getPath(),"insert_at",e),e=s.activeShape,t="http://i.imgur.com/RUrKV.png",(i=e.getPath()).btnDeleteClickHandler={},i.btnDeleteImageUrl=t,google.maps.event.addListener(e.getPath(),"set_at",a),google.maps.event.addListener(e.getPath(),"insert_at",a),s.activeShape;s.activeShape&&s.activeShape.setMap(null),s.activeShape=null},s.$watch("editPolyVerts",function(e){s.onEditPolyChange(e)}),s.$watch("visiblePolys",function(e){s.onVisiblePolysChange(e)}),s.$watch("visiblePoints",function(e){s.onVisiblePointsChange(e)}),s.$watch("groupBoundsPoly",function(e){s.setGroupBounds(e)}),s.$watch("mapCenter",function(e){e&&(e=new google.maps.LatLng(e.lat,e.lon),s.mapInstance.setCenter(e))}),s.mapInstance=new google.maps.Map($(e).children(".google-map-canvas")[0],s.mapInfo),s.onMapEditorReady&&s.onMapEditorReady({mapInstance:s.mapInstance}),google.maps.event.addListener(s.mapInstance,"click",function(e){var t={lat:e.latLng.lat(),lon:e.latLng.lng()},e={lat:e.latLng.lat()+.01,lon:e.latLng.lng()+.01};s.editPolyVerts&&(s.editPolyVerts.vertices=[t,{lat:e.lat,lon:t.lon},e,{lat:t.lat,lon:e.lon}]),s.onEditPolyChange(s.editPolyVerts)})}}}]),function(i){class e{constructor(e,t,i,s,a){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.$scope=s,this.$sce=a,this.isLoading=!1,this.editCommentShouldRemoveAttachment=!1,this.shouldShowAdminControls=!1,this.digestFrequency=null,this.shouldShowAddComment=!0,this.canEditTitle=!1}$onInit(){this.defaultDigestFrequency=this.siteInfo.userInfo.defaultDigestFrequency,this.shouldShowAdminControls=this.siteInfo.userInfo.isSiteManager,this.threadUrl=this.siteInfo.publicSiteInfo.baseUrl+"/#!/Home/DiscussionThread/"+this.thread.commentThreadId,this.isPremiumPlanActive=this.siteInfo.privateSiteInfo.isPremiumPlanActive,this.canEditTitle=this.siteInfo.userInfo.isSiteManager||this.thread.authorUserId===this.siteInfo.userInfo.userId,this.retrieveComments(),this.thread.isReadOnly||this.thread.archiveDateUtc||this.initCommentTinyMce("new-comment-tiny-mce-editor")}initCommentTinyMce(t){return!t||0!==t.indexOf("reply-tiny-mce-editor-")&&0!==t.indexOf("edit-tiny-mce-editor-")?e.TinyMceSettings.autoFocusElemId=void 0:e.TinyMceSettings.autoFocusElemId=t,i.HtmlUtil2.initTinyMce(t,200,e.TinyMceSettings).then(e=>(t&&0===t.indexOf("reply-tiny-mce-editor-")?this.replyTinyMceEditor=e:t&&0===t.indexOf("edit-tiny-mce-editor")?this.editTinyMceEditor=e:this.newCommentTinyMceEditor=e,e?(e.shortcuts.add("ctrl+13","CTRL ENTER to submit comment",()=>{this.$scope.$apply(()=>{t&&0===t.indexOf("reply-tiny-mce-editor-")?this.submitReplyComment():t&&0===t.indexOf("edit-tiny-mce-editor-")?this.submitCommentEdit():this.submitNewComment()})}),e):null))}onTextAreaKeyDown(e,t){13==e.keyCode&&(e.preventDefault(),"new"===t?this.submitNewComment():"edit"===t?this.submitCommentEdit():"reply"===t&&this.submitReplyComment())}onChangeDigestFrequency(){this.isLoading=!0;var e=`/api/CommentThread/${this.thread.commentThreadId}/DigestFrequency/`+this.commentsState.digestFrequency;this.$http.put(e,null).then(()=>{this.isLoading=!1},e=>{this.isLoading=!1,alert("Failed to change: "+e.data.exceptionMessage)})}retrieveComments(){this.isLoading=!0,this.$http.get(`/api/CommentThread/${this.thread.commentThreadId}/Comments`).then(e=>{this.isLoading=!1,this.commentsState=e.data;const t=e=>{e.isMyComment=e.authorUserId===this.$rootScope.userInfo.userId,e.commentText=this.$sce.trustAsHtml(e.commentText),e.replies&&_.each(e.replies,t)};_.forEach(this.commentsState.comments,t),this.commentsState.comments=_.sortBy(this.commentsState.comments,e=>e.postDateUtc).reverse()},e=>{this.isLoading=!1,alert("Failed to retrieve comments: "+e.data.exceptionMessage)})}startReplyToComment(e){this.replyToCommentId=e.commentId,this.replyCommentText="",this.editCommentId=-1,this.shouldShowAddComment=!1;const t="reply-tiny-mce-editor-"+e.commentId;this.initCommentTinyMce("reply-tiny-mce-editor-"+e.commentId).then(e=>{console.log("startReplyToComment",e),e||document.getElementById(t).focus()})}startEditComment(e){this.editCommentId=e.commentId,this.editCommentText=e.commentText,this.editCommentShouldRemoveAttachment=!1,this.replyToCommentId=-1,this.shouldShowAddComment=!1,this.initCommentTinyMce("edit-tiny-mce-editor-"+e.commentId)}deleteComment(e){let t="Are you sure you want to delete this comment?";1===this.commentsState.comments.length&&(t="Since there is only one comment, if you delete this comment you'll delete the thread. Are you sure you want to delete this comment?"),confirm(t)&&(this.isLoading=!0,this.$http.delete(`/api/CommentThread/${this.thread.commentThreadId}/`+e.commentId).then(()=>{this.isLoading=!1,1===this.commentsState.comments.length?(this.$rootScope.$broadcast("refreshCommentThreadList"),this.closeModal(!1)):this.retrieveComments()},e=>{this.isLoading=!1,alert("Failed to post comment: "+e.data.exceptionMessage)}))}archiveThread(e=!0){this.isLoading=!0;let t="/api/CommentThread/Archive/"+this.thread.commentThreadId;e||(t="/api/CommentThread/Unarchive/"+this.thread.commentThreadId),this.$http.put(t,null).then(()=>{this.isLoading=!1,this.$rootScope.$broadcast("refreshCommentThreadList"),this.closeModal(!1)},e=>{this.isLoading=!1,alert("Failed to archive: "+e.data.exceptionMessage)})}submitCommentEdit(){var e={commentId:this.editCommentId,newCommentText:this.editTinyMceEditor?this.editTinyMceEditor.getContent():this.editCommentText,shouldRemoveAttachment:this.editCommentShouldRemoveAttachment};e.newCommentText?(this.isLoading=!0,this.$http.put(`/api/CommentThread/${this.thread.commentThreadId}/EditComment`,e).then(()=>{this.isLoading=!1,this.editCommentId=-1,this.editCommentText="",this.editCommentShouldRemoveAttachment=!1,this.editTinyMceEditor&&this.editTinyMceEditor.setContent(""),this.removeAttachment(),this.retrieveComments()},e=>{this.isLoading=!1,alert("Failed to edit comment: "+e.data.exceptionMessage)})):alert("Comments cannot be empty. If you want to delete the comment, click the delete button.")}submitReplyComment(){var e,t=this.replyTinyMceEditor?this.replyTinyMceEditor.getContent():this.replyCommentText;t?((e=new FormData).append("commentText",t),e.append("replyToCommentId",this.replyToCommentId.toString()),t={headers:{"Content-Type":void 0}},this.isLoading=!0,this.$http.put(`/api/CommentThread/${this.thread.commentThreadId}/AddCommentFromForm`,e,t).then(()=>{this.isLoading=!1,this.replyToCommentId=-1,this.replyCommentText="",this.replyTinyMceEditor&&this.replyTinyMceEditor.setContent(""),this.removeAttachment(),this.retrieveComments()},e=>{this.isLoading=!1,alert("Failed to add comment: "+e.data.exceptionMessage)})):alert("Please enter some text to add a reply")}submitNewComment(){var e,t=this.newCommentTinyMceEditor?this.newCommentTinyMceEditor.getContent():this.newCommentText;t?((e=new FormData).append("commentText",t),this.attachmentFile&&e.append("attachedFile",this.attachmentFile),t={headers:{"Content-Type":void 0}},this.isLoading=!0,this.$http.put(`/api/CommentThread/${this.thread.commentThreadId}/AddCommentFromForm`,e,t).then(()=>{this.isLoading=!1,this.newCommentText="",this.newCommentTinyMceEditor&&this.newCommentTinyMceEditor.setContent(""),this.removeAttachment(),this.retrieveComments()},e=>{this.isLoading=!1,alert("Failed to add comment: "+e.data.exceptionMessage)})):alert("You must enter text to submit a comment")}closeModal(e){this.onClosed&&this.onClosed()}copyThreadLink(e){return e.stopPropagation(),e.preventDefault(),i.HtmlUtil2.copyTextToClipboard(this.threadUrl)?i.HtmlUtil2.showTooltip(e.target,"Copied!"):i.HtmlUtil2.showTooltip(e.target,"Auto-copy failed, right-click and copy link address"),!1}showAddComment(){this.shouldShowAddComment=!0,this.removeAttachment(),this.editCommentId=-1,this.initCommentTinyMce("new-comment-tiny-mce-editor")}cancelCommentEdit(){this.editCommentId=-1,this.removeAttachment(),this.showAddComment()}cancelCommentReply(){this.replyToCommentId=-1,this.removeAttachment(),this.showAddComment()}onFileAttached(e){this.attachmentFile=e.target.files[0]}removeAttachment(){this.attachmentFile=null;var e=document.getElementById("comment-attachment-input");e&&(e.value=null)}getFileIcon(e){return i.HtmlUtil2.getFileIcon(e)}onViewAttachedDoc(t){this.isLoading=!0;const i=window.open("","_blank");!i||i.closed||void 0===i.closed?alert(`Looks like your browser may be blocking pop-ups which are required to view documents. Please see the right of the address bar or your browser settings to enable pop-ups for ${AppConfig.appName}.`):i.document.write("Loading document... (If the document cannot be viewed directly in your browser, it will be downloaded automatically)");var e="/api/DocumentLink/DiscussionAttachment/"+t.commentId;this.$http.get(e).then(e=>{this.isLoading=!1;e=`Documents/${t.attachedDocPath.substring("s3:".length)}?vid=`+encodeURIComponent(e.data.vid),e=this.siteInfo.publicSiteInfo.baseApiUrl+e;i.location.href=e},e=>{this.isLoading=!1,alert("Failed to open document: "+e.data.exceptionMessage)})}updateThreadTitle(){this.isLoading=!0;var e=`/api/CommentThread/${this.thread.commentThreadId}/EditTitle?newTitle=`+encodeURIComponent(this.thread.title);this.$http.put(e,null).then(()=>{this.isLoading=!1},e=>{this.isLoading=!1,alert("Failed to update title: "+e.data.exceptionMessage)})}}e.$inject=["$http","$rootScope","SiteInfo","$scope","$sce"],e.TinyMceSettings={menubar:!1,toolbar:"bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link emoticons"},i.GroupCommentThreadViewController=e}(Ally=Ally||{}),CA.angularApp.component("groupCommentThreadView",{bindings:{thread:"<",onClosed:"&"},templateUrl:"/ngApp/services/group-comment-thread-view.html",controller:Ally.GroupCommentThreadViewController}),function(t){t.CommentThread=class{};class e{constructor(e,t,i,s,a,n){this.$http=e,this.$rootScope=t,this.siteInfo=i,this.$scope=s,this.fellowResidents=a,this.$timeout=n,this.isLoading=!1,this.viewingThread=null,this.showCreateNewModal=!1,this.showBoardOnly=!1,this.archivedThreads=null,this.canCreateThreads=!1,this.isDiscussionEmailEnabled=!0,this.isPremiumPlanActive=!1,this.newThreadBodyText=""}$onInit(){this.isPremiumPlanActive=this.siteInfo.privateSiteInfo.isPremiumPlanActive,this.canCreateThreads=this.siteInfo.userInfo.isAdmin||this.siteInfo.userInfo.isSiteManager,this.canCreateThreads||(this.committeeId?this.fellowResidents.isCommitteeMember(this.committeeId).then(e=>this.canCreateThreads=e):this.siteInfo.privateSiteInfo.whoCanCreateDiscussionThreads&&"everyone"!==this.siteInfo.privateSiteInfo.whoCanCreateDiscussionThreads?"board"===this.siteInfo.privateSiteInfo.whoCanCreateDiscussionThreads&&(this.canCreateThreads=this.siteInfo.userInfo.isSiteManager||0!==this.siteInfo.userInfo.boardPosition):this.canCreateThreads=!0),this.showBoardOnly=this.siteInfo.userInfo.isSiteManager||0!==this.siteInfo.userInfo.boardPosition,this.editComment={commentText:"",replyToCommentId:null},this.$scope.$on("refreshCommentThreadList",(e,t)=>this.refreshCommentThreads(!1)),this.refreshCommentThreads(!1)}setDisplayCreateModal(e){this.showCreateNewModal=e,this.newThreadTitle="",this.newThreadIsBoardOnly=!1,this.newThreadIsReadOnly=!1,this.shouldSendNoticeForNewThread=!0,this.newThreadErrorMessage="",t.HtmlUtil2.initTinyMce("new-thread-body-rte",200,t.GroupCommentThreadViewController.TinyMceSettings).then(e=>this.newBodyMceEditor=e),e&&setTimeout(()=>$("#new-thread-title-text-box").focus(),100)}displayDiscussModal(e){this.viewingThread=e}hideDiscussModal(){this.viewingThread=null}onClickPin(e){this.isLoading=!0,this.$http.put("/api/CommentThread/TogglePinned/"+e.commentThreadId,null).then(e=>{this.isLoading=!1,this.refreshCommentThreads()},e=>{this.isLoading=!1,alert("Failed to toggle: "+e.data.exceptionMessage)})}createNewThread(){console.log("In createNewThread"),this.isLoading=!0,this.newThreadErrorMessage=null;var e=new FormData,t=(e.append("title",this.newThreadTitle),this.newBodyMceEditor?e.append("body",this.newBodyMceEditor.getContent()):e.append("body",this.newThreadBodyText),e.append("isBoardOnly",this.newThreadIsBoardOnly.toString()),e.append("isReadOnly",this.newThreadIsReadOnly.toString()),e.append("shouldSendNotice",this.shouldSendNoticeForNewThread.toString()),this.committeeId&&e.append("committeeId",this.committeeId.toString()),this.attachmentFile&&e.append("attachedFile",this.attachmentFile),{headers:{"Content-Type":void 0}});this.$http.post("/api/CommentThread/CreateThreadFromForm",e,t).then(()=>{this.isLoading=!1,this.showCreateNewModal=!1,this.removeAttachment(),this.refreshCommentThreads(!1)},e=>{this.isLoading=!1,this.newThreadErrorMessage=e.data.exceptionMessage})}refreshCommentThreads(i=!1){this.isLoading=!0;let e="/api/CommentThread";i&&(e+="/Archived"),this.committeeId&&(e+="?committeeId="+this.committeeId),this.$http.get(e).then(e=>{if(this.isLoading=!1,e.data=_.sortBy(e.data,e=>e.pinnedDateUtc||moment(e.lastCommentDateUtc).subtract(100,"years").toDate()).reverse(),i)this.archivedThreads=e.data;else if(this.commentThreads=e.data,this.archivedThreads=null,this.autoOpenThreadId){const t=_.find(this.commentThreads,e=>e.commentThreadId===this.autoOpenThreadId);t&&this.$timeout(()=>this.displayDiscussModal(t),125),this.autoOpenThreadId=null}},e=>{this.isLoading=!1})}onFileAttached(e){this.attachmentFile=e.target.files[0]}removeAttachment(){this.attachmentFile=null;var e=document.getElementById("comment-attachment-input");e&&(e.value=null)}}e.$inject=["$http","$rootScope","SiteInfo","$scope","fellowResidents","$timeout"],t.GroupCommentThreadsController=e}(Ally=Ally||{}),CA.angularApp.component("groupCommentThreads",{bindings:{committeeId:"<?",autoOpenThreadId:"<?"},templateUrl:"/ngApp/services/group-comment-threads.html",controller:Ally.GroupCommentThreadsController}),function(e){e.Comment=class{};class t{constructor(e,t){this.$http=e,this.$rootScope=t,this.isLoading=!1,this.showDiscussModal=!1}$onInit(){this.isQaSite=!1,this.threadId||(this.threadId="Home"),this.editComment={threadId:this.threadId,commentText:"",replyToCommentId:null},this.refreshComments()}displayDiscussModal(){this.showDiscussModal=!0}hideDiscussModal(){this.showDiscussModal=!1}refreshComments(){this.isLoading=!0,this.$http.get("/api/Comment?threadId="+this.threadId).then(e=>{this.isLoading=!1,this.commentList=e.data;const t=e=>{e.isMyComment=e.authorUserId===this.$rootScope.userInfo.userId,e.replies&&_.each(e.replies,t)};_.each(this.commentList,t)},e=>{this.isLoading=!1,alert("Failed to refresh comments: "+e.data.exceptionMessage)})}postComment(e){this.isLoading=!0;let t=this.$http.post;(t="number"==typeof e.existingCommentId?this.$http.put:t)("/api/Comment",e).then(()=>{this.isLoading=!1,this.editComment={},this.showReplyBoxId=-1,this.refreshComments()},e=>{this.isLoading=!1,alert("Failed to post comment: "+e.data.exceptionMessage)})}onPostCommentClicked(){var e;0!==this.editComment.commentText.length&&(e={threadId:this.threadId,commentText:this.editComment.commentText,replyToCommentId:null,existingCommentId:this.editComment.existingCommentId},this.postComment(e))}editMyComment(e){this.editComment={commentText:e.commentText,existingCommentId:e.commentId}}deleteMyComment(e){this.isLoading=!0,this.$http.delete("/api/Comment?commentId="+e.commentId).then(()=>{this.isLoading=!1,this.refreshComments()},e=>{this.isLoading=!1;e=e.data.exceptionMessage||e.data;alert("Failed to post comment: "+e)})}onPostReplyCommentClicked(){var e;0!==this.editComment.replyText.length&&(e={threadId:this.threadId,commentText:this.editComment.replyText,replyToCommentId:this.editComment.replyToCommentId},this.postComment(e))}clickReplyToComment(e){this.showReplyBoxId=e,this.editComment={commentText:"",replyToCommentId:e}}}t.$inject=["$http","$rootScope"],e.GroupCommentsController=t}(Ally=Ally||{}),CA.angularApp.component("groupComments",{bindings:{threadId:"@?"},templateUrl:"/ngApp/services/group-comments.html",controller:Ally.GroupCommentsController}),function(e){class h{static convertStringsToDates(t){if($.isArray(t)&&h.convertDatesFromArray(t),h.isObject(t))for(const s in t){var i=t[s];if(h.isObject(i))h.convertStringsToDates(i);else if($.isArray(i))h.convertDatesFromArray(i);else if(h.isString(i)&&10<i.length&&h.dotNetTimeRegEx2.test(i)){let e;e=HtmlUtil.endsWith(s,"_UTC")||HtmlUtil.endsWith(s,"Utc")?h.serverUtcDateToLocal(i):new Date(i),t[s]=e}}}static convertDatesFromArray(t){for(let e=0;e<t.length;e++){var i=t[e];h.isObject(i)?h.convertStringsToDates(i):h.isString(i)&&h.iso8601RegEx.test(i)&&(t[e]=new Date(i))}}static isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}static isString(e){return"[object String]"===Object.prototype.toString.call(e)}static isValidString(e){return!(!e||"string"!=typeof e)&&"null"!==e&&0<e.length}static serverUtcDateToLocal(e){return"string"!=typeof e?e:HtmlUtil.isNullOrWhitespace(e)?null:moment.utc(e).toDate()}static showTooltip(e,t){$(e).qtip({style:{classes:"qtip-light qtip-shadow"},position:{my:"leftMiddle",at:"rightMiddle"},content:{text:t},events:{hide:function(e){$(e.originalEvent.currentTarget).qtip("destroy")}}}),$(e).qtip("show")}static removeNonAlphanumeric(e){return e.replace(/\W/g,"")}static downloadCsv(e,t){h.downloadFile(e,t,"text/csv")}static downloadXml(e,t){h.downloadFile(e,t,"text/xml")}static downloadFile(e,t,i){if("undefined"!=typeof Blob){var s=document.createElement("a"),a=(document.body.appendChild(s),s.style.display="none",new Blob([e],{type:i})),a=window.URL.createObjectURL(a);s.href=a,s.download=t,s.click(),window.URL.revokeObjectURL(a)}else{s=encodeURI("data:"+i+";charset=utf-8,"+e);const n=document.createElement("a");n.setAttribute("href",s),n.setAttribute("download",t),document.body.appendChild(n),n.click(),setTimeout(function(){document.body.removeChild(n)},500)}}static startsWithNumber(e,t=!0){if(HtmlUtil.isNullOrWhitespace(e))return!1;let i=(e=t?e.trim():e).search(/[\s,]/);return-1===i&&(i=e.length),e=e.substring(0,i),HtmlUtil.isNumericString(e)}static endsWithNumber(e,t=!0){return!HtmlUtil.isNullOrWhitespace(e)&&(t&&(e=e.trim()),/[0-9]+$/.test(e))}static getNumberAtEnd(e){return h.endsWithNumber(e)?parseInt(e.match(/[0-9]+$/)[0]):null}static getNumberAtStart(e){return h.startsWithNumber(e)?parseInt(e.match(/^[0-9]+/)[0]):null}static isAndroid(){return-1<navigator.userAgent.toLowerCase().indexOf("android")}static copyTextToClipboard(e){var t=document.createElement("textarea");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="2em",t.style.height="2em",t.style.padding="0",t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",t.value=e,document.body.appendChild(t),t.focus(),t.select();let i=!1;try{var s=document.execCommand("copy"),a=s?"successful":"unsuccessful";console.log("Copying text command was "+a),i=s}catch(e){console.log("Oops, unable to copy")}return document.body.removeChild(t),i}static smartSortStreetAddresses(e,a){if(!e||0===e.length)return e;if(_.every(e,e=>HtmlUtil.isNumericString(e[a])))return _.sortBy(e,e=>+e[a]);var t=e[0][a];const i=t.substr(t.indexOf(" "));var s=_.every(e,e=>h.startsWithNumber(e[a])),n=_.every(e,e=>HtmlUtil.endsWith(e[a],i));if(s&&n)return _.sortBy(e,e=>parseInt(e[a].substr(0,e[a].indexOf(" "))));n=t.search(/[0-9]/);if(0<=n){const r=t.substr(0,n);var n=_.every(e,e=>HtmlUtil.startsWith(e[a],r)),o=_.every(e,e=>h.endsWithNumber(e[a]));if(n&&o)return _.sortBy(e,e=>h.getNumberAtEnd(e[a]))}if(s){const l=e=>e.substring(e.search(/\s/)+1);return e.sort((e,t)=>{return e=e[a],t=t[a],i=l(e),s=l(t),i===s?parseInt(e.substr(0,e.search(/\s/)))-parseInt(t.substr(0,t.search(/\s/))):i.localeCompare(s);var i,s})}let r=null;if(r=t.includes(" ")?t.substr(0,t.indexOf(" ")+1):r){n=_.every(e,e=>HtmlUtil.startsWith(e[a],r));if(n)if(_.every(e,e=>h.startsWithNumber(e[a].substr(r.length))))return _.sortBy(e,e=>h.getNumberAtStart(e[a].substr(r.length)))}return _.sortBy(e,e=>(e[a]||"").toLowerCase())}static resizeBase64Img(n,o,r){return new Promise((e,t)=>{const i=document.createElement("canvas"),s=(i.width=o,i.height=r,i.getContext("2d")),a=document.createElement("img");a.onload=function(){s.drawImage(a,0,0,a.width,a.height,0,0,o,r),e(i.toDataURL())},a.src=n})}static resizeFromImg(a,n,o){return new Promise((e,t)=>{var i=document.createElement("canvas"),s=(i.width=n,i.height=o,i.getContext("2d"));s.scale(n/a.width,o/a.height),s.drawImage(a,0,0),e(i.toDataURL())})}static resizeFromImgToBlob(s,a,n,o="image/jpeg"){return new Promise((t,e)=>{var i=document.createElement("canvas");i.width=a,i.height=n,i.getContext("2d").drawImage(s,0,0,s.width,s.height,0,0,a,n),i.toBlob(e=>{t(e)},o,.75)})}static initTinyMce(a="tiny-mce-editor",n=400,o=null){return new Promise((s,e)=>{const t=()=>{var e,t,i;"undefined"==typeof tinymce?s(null):(tinymce.remove(),e=o&&void 0!==o.menubar?o.menubar:"edit insert format table",t=o&&void 0!==o.toolbar?o.toolbar:"styleselect | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | checklist code formatpainter table",i=o&&void 0!==o.toolbar?o.autoFocusElemId:void 0,tinymce.init({selector:"#"+a,auto_focus:i,statusbar:!0,elementpath:!1,wordcount:!0,resize:!0,menubar:e,plugins:"image link autolink lists media table code emoticons",toolbar:t,height:n,file_picker_types:"image",image_description:!1,file_picker_callback:function(r,e,t){var i=document.createElement("input");i.setAttribute("type","file"),i.setAttribute("accept","image/*"),i.onchange=function(e){const o=e.target.files[0],i=new FileReader;i.onload=function(e){const a="blobid"+(new Date).getTime(),n=tinymce.activeEditor.editorUpload.blobCache;var t=i.result.split(",")[1];if(1048576<t.length){const s=new Image;s.onload=function(){var e=1e3/s.width,t=1e3/s.height;let i=t<e?t:e;h.resizeFromImgToBlob(s,Math.round(s.width*i),Math.round(s.height*i),o.type).then(i=>{const s=new FileReader;s.readAsDataURL(i),s.onloadend=function(){var e=new File([i],o.name,i),t=s.result.split(",")[1],e=n.create(a,e,t);n.add(e),r(e.blobUri(),{title:o.name})}})},s.src=e.target.result}else{e=n.create(a,o,t);n.add(e),r(e.blobUri(),{title:o.name})}},i.readAsDataURL(o)},i.click()}}).then(e=>{s(e[0])}))};setTimeout(()=>{"undefined"==typeof tinymce?setTimeout(()=>t(),400):t()},100)})}static getFileIcon(e){let t=null;switch((e=e||"").split(".").pop().toLowerCase()){case"pdf":t="PdfIcon.png";break;case"doc":case"docx":t="WordIcon.png";break;case"xls":case"xlsx":t="ExcelIcon.png";break;case"ppt":case"pptx":t="PptxIcon.png";break;case"jpeg":case"jpe":case"jpg":case"png":case"bmp":t="ImageIcon.png";break;case"zip":t="ZipIcon.png";break;case"txt":t="TxtIcon.png";break;case"mp4":t="Mp4Icon.png";break;default:t="GenericFileIcon.png"}return"/assets/images/FileIcons/"+t}static getStripeFeeInfo(e,t,i){let s,a,n,o;return t?(n=e,a=e/.992,(t=5<(s=a-e))&&(s=5,a=e+s),i||(t?a=e+10:a/=.992,10<(s=a-e)&&(s=10)),o=s):(a=e,o=0,5<(s=.008*e)&&(s=5),i||(s*=2),n=e-s),{totalAmountPaid:a,feeAmount:s,groupReceives:n,payerFee:o}}static globalRedirect(e){window.location.href=e}static getCssRule(t){t=t.toLowerCase();let i=null;const s=Array.prototype.find;return s.call(document.styleSheets,e=>{try{i=s.call(e.cssRules,e=>e instanceof CSSStyleRule&&e.selectorText.toLowerCase()==t)}catch{}return null!=i}),i}static getAllCssRules(i){i=i.toLowerCase();var s=[];Array.prototype.forEach;for(let t=0;t<document.styleSheets.length;++t){var a=document.styleSheets[t];let e;try{e=Array.prototype.filter.call(a.cssRules,e=>e instanceof CSSStyleRule&&e.selectorText.toLowerCase()==i)}catch{e=[]}s.push(...e)}return s}}h.iso8601RegEx=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?Z$/,h.dotNetTimeRegEx2=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?$/,h.NoTinyMceErrorMsg="It appears the TinyMCE rich text editor failed to initialize. Please try refreshing the page. If the problem persists, TinyMCE may be down and you'll need to wait until it's up and running again.",e.HtmlUtil2=h;e.ExceptionResult=class{}}(Ally=Ally||{}),function(e){e.MaintenanceEntry=class{getTitle(){return this.project?this.project.title:this.todo.description}getTypeName(){return this.project?"Maintenance Record":"To-Do"}getAuthorName(){return this.project?this.project.creatorFullName:this.todo.addedByFullName}getCreatedDate(){return this.project?this.project.createDateUtc:this.todo.addedDateUtc}};e.MaintenanceService=class{constructor(e,t,i){this.$http=e,this.$q=t,this.$cacheFactory=i}loadProjects(){return this.$http.get("/api/Maintenance/Projects").then(e=>e.data,e=>this.$q.reject(e.data))}}}(Ally=Ally||{}),angular.module("CondoAlly").service("maintenance",["$http","$q","$cacheFactory",Ally.MaintenanceService]),function(t){class e{constructor(e,t,i){this.$rootScope=e,this.fellowResidents=t,this.siteInfo=i,this.shouldShowSendModal=!1,this.shouldShowButtons=!1,this.isSending=!1,this.messageBody="",this.messageSubject="",this.sendResultIsError=!1,this.isPremiumPlanActive=!1,this.isSendingToSelf=!1,this.shouldShowSendAsBoard=!1,this.shouldSendAsBoard=!1,this.messageSubject=`${i.userInfo.fullName} has sent you a message via your ${AppConfig.appName} site`}$onInit(){this.isPremiumPlanActive=this.siteInfo.privateSiteInfo.isPremiumPlanActive,this.isSendingToSelf=this.recipientInfo.userId===this.siteInfo.userInfo.userId;var e=this.recipientInfo.userId===t.GroupMembersController.AllBoardUserId;this.shouldShowSendAsBoard=t.FellowResidentsService.isNonPropMgrBoardPosition(this.siteInfo.userInfo.boardPosition)&&!e}showSendModal(){this.shouldShowSendModal=!0,this.sendResultMessage="",this.shouldShowButtons=!0,this.isPremiumPlanActive&&setTimeout(()=>document.getElementById("message-text-box").focus(),100)}hideModal(){this.shouldShowSendModal=!1,this.messageBody=""}sendMessage(){this.shouldShowButtons=!1,this.isSending=!0,this.sendResultMessage="",this.fellowResidents.sendMessage(this.recipientInfo.userId,this.messageBody,this.messageSubject,this.shouldSendAsBoard).then(e=>{this.isSending=!1,this.sendResultIsError=!1,this.messageBody="",this.sendResultMessage="Message sent successfully!"},e=>{this.shouldShowButtons=!0,this.isSending=!1,this.sendResultIsError=!0,this.sendResultMessage="Failed to send: "+e.data.exceptionMessage})}onSendAsBoardChanged(){this.shouldSendAsBoard?this.messageSubject=`Your ${this.siteInfo.publicSiteInfo.fullName} board has sent you a message via your ${AppConfig.appName} site`:this.messageSubject=`${this.siteInfo.userInfo.fullName} has sent you a message via your ${AppConfig.appName} site`}}e.$inject=["$rootScope","fellowResidents","SiteInfo"],t.SendMessageController=e}(Ally=Ally||{}),CA.angularApp.component("sendMessage",{bindings:{recipientInfo:"="},templateUrl:"/ngApp/services/send-message.html",controller:Ally.SendMessageController}),angular.module("CondoAlly").directive("ngEnter",function(){return function(t,e,i){e.bind("keydown keypress",function(e){13===e.which&&(t.$apply(function(){t.$eval(i.ngEnter,{$event:e})}),e.preventDefault())})}}),angular.module("CondoAlly").directive("ngCtrlEnter",function(){return function(t,e,i){e.bind("keydown keypress",function(e){13===e.which&&e.ctrlKey&&(console.log("Detected ngCtrlEnter",i.ngCtrlEnter),t.$apply(function(){t.$eval(i.ngCtrlEnter,{$event:e})}),e.preventDefault())})}}),angular.module("CondoAlly").directive("ngEscape",function(){return function(t,e,i){e.bind("keydown keypress",function(e){27===e.which&&(t.$apply(function(){t.$eval(i.ngEscape,{$event:e})}),e.preventDefault())})}}),angular.module("CondoAlly").directive("imageonload",function(){return{restrict:"A",link:function(t,e,i){e.bind("load",function(e){i.imageonload&&t.$apply(i.imageonload)})}}}),angular.module("CondoAlly").directive("imageonerror",function(){return{restrict:"A",link:function(t,e,i){e.bind("error",function(e){i.imageonerror&&t.$apply(i.imageonerror)})}}}),angular.module("CondoAlly").directive("onFileChange",function(){return{restrict:"A",link:function(t,e,i){e.bind("change",function(e){t.$apply(function(){t.$eval(i.onFileChange,{$event:e})}),e.preventDefault()})}}}),CA.angularApp.filter("iif",function(){return function(e,t,i){return e?t:i}}),CA.angularApp.filter("tel",function(){return function(e){if(!e)return"";var t,i,s,a=e.toString().trim().replace(/^\+/,"");if(a.match(/[^0-9]/))return e;switch(a.length){case 7:t=1,i="",s=a;break;case 10:t=1,i=a.slice(0,3),s=a.slice(3);break;case 11:t=a[0],i=a.slice(1,4),s=a.slice(4);break;case 12:t=a.slice(0,3),i=a.slice(3,5),s=a.slice(5);break;default:return i="",e}return 1===t&&(t=""),s=s.slice(0,3)+"-"+s.slice(3),(t+" "+(i=0<i.length?"("+i+")":i)+" "+s).trim()}}),CA.angularApp.filter("filesize",function(){return function(e){return(e=isNaN(e)?0:e)<1024?e+" bytes":(e/=1024)<1024?e.toFixed(2)+" KB":(e/=1024)<1024?e.toFixed(2)+" MB":(e/=1024)<1024?e.toFixed(2)+" GB":(e/=1024).toFixed(2)+" TB"}}),function(n){class o{constructor(){this.fontFamily="'Open Sans', sans-serif",this.bodyFontColor="#212529"}static GetDefault(){return{presetTemplateName:"default",fontFamily:"'Open Sans', sans-serif",bodyFontColor:"#212529",iconColor:"#007bff",headerBg:o.HeaderBgClassic,footerBg:"#404040",footerLinkColor:"#f7941d",panelsHaveBoxShadow:!0,background:"#f3f3f3",buttonBgColor:"#0d6efd",bodyLinkColor:"#007cbc",navLinkColor:"white",navBg:"#60a2c8",headerBgSize:"auto 100%",panelsHaveRoundedCorners:!0,listItemShadeColor:"#EBF3FE"}}static GetPreset(e){let t=null;switch(e){case"default":return o.GetDefault();case"modern":t={presetTemplateName:e,fontFamily:"'Open Sans', sans-serif",bodyFontColor:"#212529",iconColor:"#353535",headerBg:"#353535",footerBg:"#353535",footerLinkColor:"white",panelsHaveBoxShadow:!1,background:"url(/assets/images/ui-style-settings/pinstripes.png)",buttonBgColor:"#353535",bodyLinkColor:"#212529",navLinkColor:"white",navBg:"#000",headerBgSize:"auto",panelsHaveRoundedCorners:!1,listItemShadeColor:"#F5F5F5"};break;case"peacefulPink":t={presetTemplateName:e,fontFamily:"'Open Sans', sans-serif",bodyFontColor:"#212529",iconColor:"#EB5757",headerBg:o.HeaderBgPink,footerBg:"#404040",footerLinkColor:"white",panelsHaveBoxShadow:!0,background:"linear-gradient(0deg, rgba(255,255,255,1) 0%, rgba(245,171,171,1) 100%)",buttonBgColor:"black",bodyLinkColor:"#007cbc",navLinkColor:"white",navBg:"black",headerBgSize:"auto",panelsHaveRoundedCorners:!0,listItemShadeColor:"#FDEFEF"};break;case"gatedCommunity":t={presetTemplateName:e,fontFamily:"serif",bodyFontColor:"#1e5168",iconColor:"#1e5168",headerBg:"#1e5168",footerBg:"#1e5168",footerLinkColor:"white",panelsHaveBoxShadow:!0,background:"#DBE5E9 url(/assets/images/ui-style-settings/fancy-hexes.png)",buttonBgColor:"#1e5168",bodyLinkColor:"#1e5168",navLinkColor:"#F3F6F7",navBg:"#1e5168",headerBgSize:"auto",panelsHaveRoundedCorners:!1,listItemShadeColor:"#F2F6F7"}}return t}static ApplySiteDesignSettingsFromJson(e,t){try{var i=JSON.parse(t);i.headerBgSize?e.siteDesignSettings=i:i.presetTemplateName&&"custom"!==i.presetTemplateName&&(e.siteDesignSettings=n.SiteDesignSettings.GetPreset(i.presetTemplateName))}catch{console.log("Failed to parse site design settings"),e.siteDesignSettings=o.GetDefault()}o.ApplySiteDesignSettingsDelayed(e.siteDesignSettings)}static ApplySiteDesignSettingsDelayed(e){n.SiteDesignSettings.ApplySiteDesignSettings(e),window.setTimeout(()=>n.SiteDesignSettings.ApplySiteDesignSettings(e),50),window.setTimeout(()=>n.SiteDesignSettings.ApplySiteDesignSettings(e),100),window.setTimeout(()=>n.SiteDesignSettings.ApplySiteDesignSettings(e),250),window.setTimeout(()=>n.SiteDesignSettings.ApplySiteDesignSettings(e),750)}static ApplySiteDesignSettings(e){var t="12px",i=n.HtmlUtil2.getCssRule(".btn-primary"),i=(i&&(i.style.backgroundColor=e.buttonBgColor),n.HtmlUtil2.getAllCssRules("a"));for(const a of i)a.style.color=e.bodyLinkColor;var i=n.HtmlUtil2.getCssRule(".text-button, .text-link"),i=(i&&(i.style.color=e.bodyLinkColor),n.HtmlUtil2.getCssRule("section.header-pill-menu-section nav a")),i=(i&&(i.style.color=e.bodyLinkColor),n.HtmlUtil2.getCssRule(".ally-active-nav")),i=(i&&i.style.setProperty("color",e.navLinkColor,"important"),n.HtmlUtil2.getCssRule(".ally-inactive-nav")),i=(i&&i.style.setProperty("color",e.navLinkColor,"important"),n.HtmlUtil2.getCssRule("footer a")),i=(i&&i.style.setProperty("color",e.footerLinkColor,"important"),n.HtmlUtil2.getCssRule("section.header-pill-menu-section")),i=(i&&(i.style.background=e.navBg,i.style.borderRadius=e.panelsHaveRoundedCorners?t:"0"),"0 10px 10px rgba(134, 134, 135, 0.3)"),s=n.HtmlUtil2.getCssRule(".box-shadow"),s=(s&&(s.style.boxShadow=e.panelsHaveBoxShadow?i:""),n.HtmlUtil2.getCssRule(".page")),i=(s&&(s.style.boxShadow=e.panelsHaveBoxShadow?i:"",s.style.borderRadius=e.panelsHaveRoundedCorners?t:"0"),n.HtmlUtil2.getCssRule("header")),s=(i&&(i.style.boxShadow=e.panelsHaveBoxShadow?"0 10px 10px #eaeaeb":"inherit"),n.HtmlUtil2.getCssRule('input[type="radio"]')),i=(s&&(s.style.accentColor=e.buttonBgColor,s.style.setProperty("border-color",e.buttonBgColor,"important")),n.HtmlUtil2.getCssRule('input[type="radio"]:checked')),s=(i&&i.style.setProperty("background-color",e.buttonBgColor,"important"),n.HtmlUtil2.getCssRule('input[type="checkbox"]')),i=(s&&(s.style.accentColor=e.buttonBgColor,s.style.setProperty("background-color",e.buttonBgColor,"important")),n.HtmlUtil2.getCssRule("header .logo-container")),s=(i&&(i.style.background=e.headerBg,i.style.backgroundSize=e.headerBgSize,e.headerBg===o.HeaderBgClassic?i.style.borderBottom="12px solid #83c476":i.style.borderBottom="inherit"),n.HtmlUtil2.getCssRule(".portlet-box")),i=(s&&(s.style.borderRadius=e.panelsHaveRoundedCorners?t:"0"),n.HtmlUtil2.getCssRule(".ally-portlet-icon")),s=(i&&(i.style.color=e.iconColor),n.HtmlUtil2.getCssRule(".ally-shaded-item"));s&&(s.style.backgroundColor=e.listItemShadeColor)}}o.SettingsCacheKey="cachedSiteDesignSettingsJson",o.HeaderBgClassic="#60a2c8 url(/assets/images/header-img-condo.jpg) no-repeat center center",o.HeaderBgPink="#eb5757 url(/assets/images/ui-style-settings/pink-neighborhood.jpg) no-repeat center center",n.SiteDesignSettings=o}(Ally=Ally||{}),function(o){o.UsersHome=class{};o.PayPeriod=class{};o.UserInfo=class{};class r{}o.PublicSiteInfo=r;o.RecentPayment=class{};class l{}o.PrivateSiteInfo=l;class e extends l{}o.ChtnPrivateSiteInfo=e;class t{constructor(){this.publicSiteInfo=new r,this.privateSiteInfo=new e,this.userInfo=new o.UserInfo,this.isLoggedIn=!1}refreshSiteInfo(t,i,e){this._rootScope=t;const s=e.defer();if(t.isLoadingSite=!0,"login"===HtmlUtil.getSubdomain())t.isLoadingSite=!1,this.handleSiteInfo(null,t),s.resolve();else{const a=e=>{t.isLoadingSite=!1,this.handleSiteInfo(e,t),s.resolve(e)},n=e=>{t.isLoadingSite=!1,s.reject(e)},o="https://0.webappapi.communityally.org/api/GroupSite";i.get(o).then(t=>{t.data&&!t.data.userInfo?this.xdLocalStorage.getItem("allyApiAuthToken").then(e=>{e&&HtmlUtil.isValidString(e.value)?(this.setAuthToken(e.value),i.get(o).then(e=>{a(e.data)},n)):a(t.data)},()=>{a(t.data)}):a(t.data)},e=>{n(e.data)})}return s.promise}testIfIsNeutralPage(t){return!!HtmlUtil.startsWith(t,"#!/")&&(t="/"+t.substring("#!/".length),"object"==typeof _.find(AppConfig.menu,e=>e.path===t))}handleSiteInfo(e,i){const t=HtmlUtil.getSubdomain(window.location.host);if(!this.authToken&&i.authToken&&this.setAuthToken(i.authToken),!e){var s=null===t||"www"===t||"login"===t,a=this.testIfIsNeutralPage(window.location.hash);if(!s||!a)return o.HtmlUtil2.globalRedirect("https://login."+AppConfig.baseTld+"/#!/Login"),!0;(e=new d).publicSiteInfo=new r,e.publicSiteInfo.fullName=AppConfig.appName,e.publicSiteInfo.siteLogo="<span style='font-size: 22pt; color: #FFF;'>Welcome to "+AppConfig.appName+"</span>",e.publicSiteInfo.baseApiUrl="https://0.webappapi.communityally.org/api/"}i.publicSiteInfo=e.publicSiteInfo,this.publicSiteInfo=e.publicSiteInfo,i.populatePublicPageMenu();let n=e.privateSiteInfo;n=n||new l,this.privateSiteInfo=n,this.privateSiteInfo.gpsPosition&&"undefined"!=typeof google&&(this.privateSiteInfo.googleGpsPosition=new google.maps.LatLng(this.privateSiteInfo.gpsPosition.lat,this.privateSiteInfo.gpsPosition.lon)),document.title=this.publicSiteInfo.fullName,i.isPremiumPlanActive=this.privateSiteInfo.isPremiumPlanActive,i.isPremiumPlanTrial=moment().isBefore(moment(this.privateSiteInfo.creationDate).add(3,"months")),this.userInfo=e.userInfo,i.userInfo=e.userInfo,HtmlUtil.isLocalStorageAllowed()&&window.localStorage.setItem("siteInfo",angular.toJson(this.publicSiteInfo)),this.isLoggedIn=null!==i.userInfo&&void 0!==i.userInfo;s=this.isLoggedIn&&!i.isLoggedIn;if(i.isLoggedIn=this.isLoggedIn,this.isLoggedIn){const t=HtmlUtil.getSubdomain(window.location.host);a="themaples"===t;setTimeout(()=>{if(void 0!==window.FreshworksWidget){let e=i.userInfo.firstName??"",t=(i.userInfo.lastName&&(e+=" "+i.userInfo.lastName),null);i.userInfo.emailAddress&&-1!==i.userInfo.emailAddress.indexOf("@")&&(t=i.userInfo.emailAddress),window.FreshworksWidget("identify","ticketForm",{name:e,email:t}),window.FreshworksWidget("prefill","ticketForm",{subject:AppConfig.appName+" Support Request "+(new Date).toLocaleDateString()}),window.FreshworksWidget("hide","ticketForm",["subject"])}"undefined"!=typeof $zopim&&$zopim(()=>{i.userInfo&&($zopim.livechat.setName(i.userInfo.firstName+" "+i.userInfo.lastName),i.userInfo.emailAddress)&&-1!==i.userInfo.emailAddress.indexOf("@")&&$zopim.livechat.setEmail(i.userInfo.emailAddress)})},a?24e3:8e3),i.isAdmin=i.userInfo.isAdmin,i.isSiteManager=i.userInfo.isSiteManager,"undefined"!=typeof analytics&&analytics.identify(i.userInfo.emailAddress,{name:i.userInfo.fullName})}else{i.userInfo=null;e="#!/Login";if(window.location.hash!=e&&!AppConfig.isPublicRoute(window.location.hash))return this.publicSiteInfo&&this.publicSiteInfo.baseUrl?(window.location.hash&&"#!/Home"!==window.location.hash&&(window.sessionStorage[AppCacheService.KeyPrefix+AppCacheService.Key_AfterLoginRedirect]=window.location.hash.substr(2),window.sessionStorage[AppCacheService.KeyPrefix+AppCacheService.Key_WasLoggedIn401]="true"),this.publicSiteInfo.customLandingPagePath?window.location.hash=this.publicSiteInfo.customLandingPagePath:window.location.hash=e):o.HtmlUtil2.globalRedirect("https://login."+AppConfig.baseTld+e),!0}return!(!this.publicSiteInfo.baseUrl||"login"!==t||null!==t&&t===this.publicSiteInfo.shortName||!HtmlUtil.isNullOrWhitespace(OverrideBaseApiPath)||(s&&(i.isLoggedIn=!1),o.HtmlUtil2.globalRedirect(this.publicSiteInfo.baseUrl+"/#!/Home"),0))}setAuthToken(e){window.localStorage&&window.localStorage.setItem("ApiAuthToken",e),this._rootScope.authToken=e,this.xdLocalStorage.setItem("allyApiAuthToken",e).then(()=>{console.log("Set cross domain auth token")},e=>{console.log("Failed to set cross domain auth token",e)}),this.authToken=e}}t.AlwaysDiscussDate=new Date(2018,7,1),o.SiteInfoService=t;o.SiteInfoHelper=class{static loginInit(e,t,i,s,a){const n=e.defer();return h.siteInfo.xdLocalStorage=a,h.isSiteInfoLoaded?n.resolve(h.siteInfo):h.siteInfo.refreshSiteInfo(i,t,e).then(()=>{h.isSiteInfoLoaded=!0,i.isSiteInfoLoaded=!0,i.siteTitle={text:i.publicSiteInfo.siteTitleText},i.publicSiteInfo.siteLogo&&(i.siteTitle.logoHtml=s.trustAsHtml(i.publicSiteInfo.siteLogo)),i.onUpdateSiteTitleText=()=>{analytics.track("updateSiteTitle"),t.put("/api/Settings",{siteTitle:i.siteTitle.text})},i.publicSiteInfo.siteDesignSettingsJson&&o.SiteDesignSettings.ApplySiteDesignSettingsFromJson(i,i.publicSiteInfo.siteDesignSettingsJson),n.resolve(h.siteInfo)},e=>{o.HtmlUtil2.globalRedirect("https://login."+AppConfig.baseTld+"/#!/Login")}),n.promise}};class h{$get(){return h.isSiteInfoLoaded||console.log("Not yet loaded!"),h.siteInfo}}h.isSiteInfoLoaded=!1,h.siteInfo=new o.SiteInfoService,o.SiteInfoProvider=h;class d{}o.AllySiteInfo=d;o.LoginResults=class{}}(Ally=Ally||{}),angular.module("CondoAlly").provider("SiteInfo",Ally.SiteInfoProvider),function(a){class t{}a.TodoItem=t;a.TodoList=class{};class e{constructor(e,t,i){this.$http=e,this.siteInfo=t,this.fellowResidents=i,this.todoLists=[],this.isLoading=!1,this.newListName="",this.isFixedList=!1,this.shouldExpandTodoItemModal=!1,this.canManage=!1}$onInit(){this.isFixedList=!!this.fixedTodoListId,this.isFixedList?this.loadFixedTodoList():this.loadAllTodoLists(),this.canManage=this.siteInfo.userInfo.isAdmin||this.siteInfo.userInfo.isSiteManager,this.committee&&!this.canManage&&this.fellowResidents.isCommitteeMember(this.committee.committeeId).then(e=>this.canManage=e)}loadFixedTodoList(){this.isLoading=!0,this.$http.get("/api/Todo/List/"+this.fixedTodoListId).then(e=>{this.isLoading=!1,this.todoLists=[e.data]})}loadAllTodoLists(){this.isLoading=!0;let e="/api/Todo";this.committee&&(e="/api/Todo/ListsForCommittee/"+this.committee.committeeId),this.$http.get(e).then(e=>{this.isLoading=!1,this.todoLists=e.data})}onAddList(){this.isLoading=!0;let e="/api/Todo/newList?listName="+encodeURIComponent(this.newListName);this.committee&&(e+="&committeeId="+this.committee.committeeId),this.$http.post(e,null).then(()=>{this.isLoading=!1,this.newListName="",this.loadAllTodoLists()},e=>{this.isLoading=!1,alert("Failed to create: "+e.data.exceptionMessage)})}onAddItem(e){this.isLoading=!0;e="/api/Todo/newItem/"+e+"?description="+encodeURIComponent(this.newItemDescription);this.$http.post(e,null).then(()=>{this.isLoading=!1,this.newItemDescription="",this.loadAllTodoLists()},e=>{this.isLoading=!1,alert("Failed to create: "+e.data.exceptionMessage)})}addNewItem(e){this.editTodoItem=new t,this.editTodoItem.owningTodoListId=e,this.committee&&(this.editTodoItem.owningTodoListId=e),this.shouldExpandTodoItemModal=!1,window.setTimeout(()=>$("#edit-todo-name-text-box").focus(),100)}saveTodoItem(){this.isLoading=!0;this.$http.post("/api/Todo/Item",this.editTodoItem).then(()=>{this.isLoading=!1,this.newItemDescription="",this.editTodoItem=null,this.loadAllTodoLists()},e=>{this.isLoading=!1,alert("Failed to create: "+e.data.exceptionMessage)})}onToggleComplete(e,t){this.isLoading=!0,this.$http.put("/api/Todo/toggleComplete/"+e+"/"+t,null).then(()=>{this.isLoading=!1,this.loadAllTodoLists()},e=>{this.isLoading=!1,alert("Failed to toggle: "+e.data.exceptionMessage)})}deleteTodoItem(e){this.isLoading=!0,this.$http.delete("/api/Todo/Item/"+e.todoItemId).then(()=>{this.isLoading=!1,this.loadAllTodoLists()},e=>{this.isLoading=!1,alert("Failed to delete: "+e.data.exceptionMessage)})}deleteTodoList(e){0<e.todoItems.length&&!confirm("Are you sure you want to delete this list with active to-dos?")||(this.isLoading=!0,this.$http.delete("/api/Todo/List/"+e.todoListId).then(()=>{this.isLoading=!1,this.loadAllTodoLists()},e=>{this.isLoading=!1,alert("Failed to delete: "+e.data.exceptionMessage)}))}exportAllToCsv(){"undefined"!=typeof analytics&&analytics.track("exportTodoListCsv");this.todoLists[0].todoItems[0].completedByFullName;var t=[{headerText:"List",fieldName:"owningTodoListName"},{headerText:"Description",fieldName:"description"},{headerText:"Due Date",fieldName:"dueDate",dataMapper:function(e){return e?moment(e).format("YYYY-MM-DD"):""}},{headerText:"Added On",fieldName:"addedDateUtc"},{headerText:"Added By",fieldName:"addedByFullName"},{headerText:"Completed On",fieldName:"completedDateUtc"},{headerText:"Completed By",fieldName:"completedByFullName"}];let i="";for(let e=0;e<this.todoLists.length;++e){var s=this.todoLists[e];for(let e=0;e<s.todoItems.length;++e)s.todoItems[e].owningTodoListName=s.name;i+=a.createCsvString(s.todoItems,t,0===e)}let e="ToDos.csv";this.committee&&(e=this.committee.name.replace(/\W/g,"")+"_"+e),a.HtmlUtil2.downloadCsv(i,e)}}e.$inject=["$http","SiteInfo","fellowResidents"],a.TodoListCtrl=e}(Ally=Ally||{}),CA.angularApp.component("todoList",{bindings:{fixedTodoListId:"<?",committee:"<?"},templateUrl:"/ngApp/services/todo-list.html",controller:Ally.TodoListCtrl}),(Ally||(Ally={})).ExceptionResult=function(){},ManageMembersCtrl.$inject=["$scope","$http","$rootScope","$interval","$http"],WatchSettingsCtrl.$inject=["$http","$rootScope","$resource","SiteInfo"],WatchCalendarCtrl.$inject=["$scope","$timeout","$http","$rootScope","$q"],WatchHomeCtrl.$inject=["$rootScope","$resource","SiteInfo"],WatchMembersCtrl.$inject=["$rootScope","$resource","SiteInfo"];